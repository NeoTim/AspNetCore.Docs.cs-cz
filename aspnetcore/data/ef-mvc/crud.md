---
title: 'Kurz: implementace funkce CRUD – ASP.NET MVC pomocí EF Core'
description: V tomto kurzu zkontrolujete a upravíte kód CRUD (vytvořit, číst, aktualizovat, odstranit), který pro vás automaticky vytvoří generování uživatelského rozhraní MVC v řadičích a zobrazeních.
author: rick-anderson
ms.author: riande
ms.custom: mvc
ms.date: 02/04/2019
ms.topic: tutorial
no-loc:
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: data/ef-mvc/crud
ms.openlocfilehash: c33ff357ec6b467435325578047ac851a39e533e
ms.sourcegitcommit: 50e7c970f327dbe92d45eaf4c21caa001c9106d0
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 07/10/2020
ms.locfileid: "86212724"
---
# <a name="tutorial-implement-crud-functionality---aspnet-mvc-with-ef-core"></a><span data-ttu-id="44c2c-103">Kurz: implementace funkce CRUD – ASP.NET MVC pomocí EF Core</span><span class="sxs-lookup"><span data-stu-id="44c2c-103">Tutorial: Implement CRUD Functionality - ASP.NET MVC with EF Core</span></span>

<span data-ttu-id="44c2c-104">V předchozím kurzu jste vytvořili aplikaci MVC, která ukládá a zobrazuje data pomocí Entity Framework a SQL Server LocalDB.</span><span class="sxs-lookup"><span data-stu-id="44c2c-104">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="44c2c-105">V tomto kurzu zkontrolujete a upravíte kód CRUD (vytvořit, číst, aktualizovat, odstranit), který pro vás automaticky vytvoří generování uživatelského rozhraní MVC v řadičích a zobrazeních.</span><span class="sxs-lookup"><span data-stu-id="44c2c-105">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="44c2c-106">Je běžný postup implementace vzoru úložiště, aby bylo možné vytvořit vrstvu abstrakce mezi řadičem a vrstvou přístupu k datům.</span><span class="sxs-lookup"><span data-stu-id="44c2c-106">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="44c2c-107">Aby byly tyto kurzy jednoduché a zaměřené na výuku, jak Entity Framework sebe sama, nepoužívají úložiště.</span><span class="sxs-lookup"><span data-stu-id="44c2c-107">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="44c2c-108">Informace o úložištích s EF najdete v [posledním kurzu této série](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="44c2c-108">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="44c2c-109">V tomto kurzu jste:</span><span class="sxs-lookup"><span data-stu-id="44c2c-109">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="44c2c-110">Přizpůsobení stránky s podrobnostmi</span><span class="sxs-lookup"><span data-stu-id="44c2c-110">Customize the Details page</span></span>
> * <span data-ttu-id="44c2c-111">Aktualizace stránky pro vytvoření</span><span class="sxs-lookup"><span data-stu-id="44c2c-111">Update the Create page</span></span>
> * <span data-ttu-id="44c2c-112">Aktualizace stránky pro úpravy</span><span class="sxs-lookup"><span data-stu-id="44c2c-112">Update the Edit page</span></span>
> * <span data-ttu-id="44c2c-113">Aktualizace stránky pro odstranění</span><span class="sxs-lookup"><span data-stu-id="44c2c-113">Update the Delete page</span></span>
> * <span data-ttu-id="44c2c-114">Zavřít databázová připojení</span><span class="sxs-lookup"><span data-stu-id="44c2c-114">Close database connections</span></span>

## <a name="prerequisites"></a><span data-ttu-id="44c2c-115">Požadavky</span><span class="sxs-lookup"><span data-stu-id="44c2c-115">Prerequisites</span></span>

* [<span data-ttu-id="44c2c-116">Začínáme s EF Core a ASP.NET Core MVC</span><span class="sxs-lookup"><span data-stu-id="44c2c-116">Get started with EF Core and ASP.NET Core MVC</span></span>](intro.md)

## <a name="customize-the-details-page"></a><span data-ttu-id="44c2c-117">Přizpůsobení stránky s podrobnostmi</span><span class="sxs-lookup"><span data-stu-id="44c2c-117">Customize the Details page</span></span>

<span data-ttu-id="44c2c-118">Vygenerovaný kód stránky indexu studentů opustil `Enrollments` vlastnost, protože tato vlastnost obsahuje kolekci.</span><span class="sxs-lookup"><span data-stu-id="44c2c-118">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="44c2c-119">Na stránce **Podrobnosti** zobrazíte obsah kolekce v tabulce HTML.</span><span class="sxs-lookup"><span data-stu-id="44c2c-119">In the **Details** page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="44c2c-120">V části *Controllers/StudentsController. cs*metoda Action pro zobrazení podrobností používá `SingleOrDefaultAsync` metodu k načtení jedné `Student` entity.</span><span class="sxs-lookup"><span data-stu-id="44c2c-120">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="44c2c-121">Přidejte kód, který volá `Include` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-121">Add code that calls `Include`.</span></span> <span data-ttu-id="44c2c-122">`ThenInclude`a `AsNoTracking` metody, jak je znázorněno v následujícím zvýrazněném kódu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-122">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]

<span data-ttu-id="44c2c-123">`Include`Metody a `ThenInclude` způsobují, že kontext načte `Student.Enrollments` vlastnost navigace a v rámci každé registrace `Enrollment.Course` vlastnost navigace.</span><span class="sxs-lookup"><span data-stu-id="44c2c-123">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="44c2c-124">Další informace o těchto metodách najdete v kurzu [související data pro čtení](read-related-data.md) .</span><span class="sxs-lookup"><span data-stu-id="44c2c-124">You'll learn more about these methods in the [read related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="44c2c-125">`AsNoTracking`Metoda zvyšuje výkon ve scénářích, kdy vrácené entity nebudou aktualizovány v životním cyklu aktuálního kontextu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-125">The `AsNoTracking` method improves performance in scenarios where the entities returned won't be updated in the current context's lifetime.</span></span> <span data-ttu-id="44c2c-126">`AsNoTracking`Na konci tohoto kurzu se dozvíte víc.</span><span class="sxs-lookup"><span data-stu-id="44c2c-126">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="44c2c-127">Směrování dat</span><span class="sxs-lookup"><span data-stu-id="44c2c-127">Route data</span></span>

<span data-ttu-id="44c2c-128">Hodnota klíče, která je předána `Details` metodě, přichází z *dat trasy*.</span><span class="sxs-lookup"><span data-stu-id="44c2c-128">The key value that's passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="44c2c-129">Data směrování jsou data, která modelový pořadač nalezl v segmentu adresy URL.</span><span class="sxs-lookup"><span data-stu-id="44c2c-129">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="44c2c-130">Například výchozí trasa určuje segmenty kontroleru, akce a ID:</span><span class="sxs-lookup"><span data-stu-id="44c2c-130">For example, the default route specifies controller, action, and id segments:</span></span>

[!code-csharp[](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]

<span data-ttu-id="44c2c-131">V následující adrese URL výchozí trasa mapuje jako kontroler, index jako akci a 1 jako ID; Jedná se o hodnoty dat tras.</span><span class="sxs-lookup"><span data-stu-id="44c2c-131">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="44c2c-132">Poslední část adresy URL ("? courseID = 2021") je hodnota řetězce dotazu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-132">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="44c2c-133">Pořadač modelů také předává hodnotu ID `Index` parametru metody, `id` Pokud jej předáte jako hodnotu řetězce dotazu:</span><span class="sxs-lookup"><span data-stu-id="44c2c-133">The model binder will also pass the ID value to the `Index` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="44c2c-134">Na stránce index jsou adresy URL hypertextového odkazu vytvořeny pomocí příkazů pomocníka značek v Razor zobrazení.</span><span class="sxs-lookup"><span data-stu-id="44c2c-134">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="44c2c-135">V následujícím Razor kódu je `id` parametr shodný s výchozí trasou, takže `id` se přidá do dat trasy.</span><span class="sxs-lookup"><span data-stu-id="44c2c-135">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="44c2c-136">Tato akce generuje následující kód HTML, pokud `item.ID` je 6:</span><span class="sxs-lookup"><span data-stu-id="44c2c-136">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="44c2c-137">V následujícím Razor kódu se `studentID` neshoduje s parametrem ve výchozí trase, takže se přidá jako řetězec dotazu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-137">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="44c2c-138">Tato akce generuje následující kód HTML, pokud `item.ID` je 6:</span><span class="sxs-lookup"><span data-stu-id="44c2c-138">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="44c2c-139">Další informace o pomocníkech značek naleznete v tématu <xref:mvc/views/tag-helpers/intro> .</span><span class="sxs-lookup"><span data-stu-id="44c2c-139">For more information about tag helpers, see <xref:mvc/views/tag-helpers/intro>.</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="44c2c-140">Přidat registrace do zobrazení podrobností</span><span class="sxs-lookup"><span data-stu-id="44c2c-140">Add enrollments to the Details view</span></span>

<span data-ttu-id="44c2c-141">Otevřete *zobrazení/studenty/podrobnosti. cshtml*.</span><span class="sxs-lookup"><span data-stu-id="44c2c-141">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="44c2c-142">Každé pole se zobrazí pomocí `DisplayNameFor` a `DisplayFor` pomocníků, jak je znázorněno v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="44c2c-142">Each field is displayed using `DisplayNameFor` and `DisplayFor` helpers, as shown in the following example:</span></span>

[!code-cshtml[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="44c2c-143">Po posledním poli a bezprostředně před uzavírací `</dl>` značkou přidejte následující kód, který zobrazí seznam zápisů:</span><span class="sxs-lookup"><span data-stu-id="44c2c-143">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-cshtml[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="44c2c-144">Pokud po vložení kódu není odsazení kódu správné, opravte jej stisknutím kombinace kláves CTRL + K-D.</span><span class="sxs-lookup"><span data-stu-id="44c2c-144">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="44c2c-145">Tento kód projde entitami v `Enrollments` navigační vlastnosti.</span><span class="sxs-lookup"><span data-stu-id="44c2c-145">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="44c2c-146">U každého zápisu se zobrazí titul kurzu a stupeň.</span><span class="sxs-lookup"><span data-stu-id="44c2c-146">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="44c2c-147">Název kurzu se načte z entity kurzu, která je uložená v `Course` navigační vlastnosti entity registrace.</span><span class="sxs-lookup"><span data-stu-id="44c2c-147">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="44c2c-148">Spusťte aplikaci, vyberte kartu **Students** a klikněte na odkaz **Podrobnosti** pro studenta.</span><span class="sxs-lookup"><span data-stu-id="44c2c-148">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="44c2c-149">Zobrazí se seznam kurzů a stupňů pro vybraného studenta:</span><span class="sxs-lookup"><span data-stu-id="44c2c-149">You see the list of courses and grades for the selected student:</span></span>

![Stránka s podrobnostmi studenta](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="44c2c-151">Aktualizace stránky pro vytvoření</span><span class="sxs-lookup"><span data-stu-id="44c2c-151">Update the Create page</span></span>

<span data-ttu-id="44c2c-152">V *StudentsController.cs*upravte `Create` metodu HTTPPOST přidáním bloku try-catch a odebráním ID z `Bind` atributu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-152">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]

<span data-ttu-id="44c2c-153">Tento kód přidá entitu Student vytvořenou modelem ASP.NET Core MVC modelu do sady entit Students a následně uloží změny do databáze.</span><span class="sxs-lookup"><span data-stu-id="44c2c-153">This code adds the Student entity created by the ASP.NET Core MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="44c2c-154">(Modelový pořadač odkazuje na funkci ASP.NET Core MVC, která usnadňuje práci s daty odesílanými formulářem. modelový pořadač převádí zaúčtované hodnoty formuláře na typy CLR a předá je metodě akcí v parametrech.</span><span class="sxs-lookup"><span data-stu-id="44c2c-154">(Model binder refers to the ASP.NET Core MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="44c2c-155">V tomto případě vytvoří pořadač modelů entitu studenta za použití hodnot vlastností z kolekce formulářů.)</span><span class="sxs-lookup"><span data-stu-id="44c2c-155">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="44c2c-156">Odebrali jste `ID` z `Bind` atributu, protože ID je hodnota primárního klíče, kterou SQL Server automaticky nastaví při vložení řádku.</span><span class="sxs-lookup"><span data-stu-id="44c2c-156">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="44c2c-157">Vstup od uživatele nenastavuje hodnotu ID.</span><span class="sxs-lookup"><span data-stu-id="44c2c-157">Input from the user doesn't set the ID value.</span></span>

<span data-ttu-id="44c2c-158">Kromě `Bind` atributu je blok try-catch jedinou změnou, kterou jste provedli v kódu generování.</span><span class="sxs-lookup"><span data-stu-id="44c2c-158">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="44c2c-159">Pokud `DbUpdateException` je při ukládání změn zachycena výjimka, která je odvozena, zobrazí se obecná chybová zpráva.</span><span class="sxs-lookup"><span data-stu-id="44c2c-159">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="44c2c-160">`DbUpdateException`výjimky jsou někdy způsobeny něčím externě pro aplikaci, nikoli při programování, takže se uživateli doporučuje akci opakovat.</span><span class="sxs-lookup"><span data-stu-id="44c2c-160">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="44c2c-161">I když v této ukázce není implementované, aplikace produkční kvality by tuto výjimku zaznamenala.</span><span class="sxs-lookup"><span data-stu-id="44c2c-161">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="44c2c-162">Další informace najdete v části **Log for Insight** v tématu [monitorování a telemetrie (vytváření skutečných cloudových aplikací s Azure)](/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span><span class="sxs-lookup"><span data-stu-id="44c2c-162">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="44c2c-163">`ValidateAntiForgeryToken`Atribut pomáhá zabránit útokům na CSRF (mezi lokalitami).</span><span class="sxs-lookup"><span data-stu-id="44c2c-163">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="44c2c-164">Token je automaticky vložen do zobrazení podle [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) a je obsažena v případě, že formulář odešle uživatel.</span><span class="sxs-lookup"><span data-stu-id="44c2c-164">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="44c2c-165">Token je ověřen `ValidateAntiForgeryToken` atributem.</span><span class="sxs-lookup"><span data-stu-id="44c2c-165">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="44c2c-166">Další informace o CSRF najdete v tématu [Ochrana proti padělání požadavků](../../security/anti-request-forgery.md).</span><span class="sxs-lookup"><span data-stu-id="44c2c-166">For more information about CSRF, see [Anti-Request Forgery](../../security/anti-request-forgery.md).</span></span>

<a id="overpost"></a>

### <a name="security-note-about-overposting"></a><span data-ttu-id="44c2c-167">Bezpečnostní Poznámka týkající se přestavování</span><span class="sxs-lookup"><span data-stu-id="44c2c-167">Security note about overposting</span></span>

<span data-ttu-id="44c2c-168">`Bind`Atribut, který obsahuje generovaný kód v `Create` metodě, je jedním ze způsobů, jak chránit před přeúčtováním ve scénářích vytváření.</span><span class="sxs-lookup"><span data-stu-id="44c2c-168">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="44c2c-169">Předpokládejme například, že entita student obsahuje `Secret` vlastnost, kterou nechcete, aby tato webová stránka nastavila.</span><span class="sxs-lookup"><span data-stu-id="44c2c-169">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="44c2c-170">I v případě, že nemáte `Secret` pole na webové stránce, hacker by mohl k odeslání hodnoty formuláře použít nějaký nástroj, například Fiddler, nebo napsaný kód JavaScript `Secret` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-170">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="44c2c-171">Bez `Bind` atributu, který omezuje pole, která používá pořadač modelů při vytváření instance studenta, vytvoří pořadač modelů tuto `Secret` hodnotu formuláře a použije ji k vytvoření instance entity studenta.</span><span class="sxs-lookup"><span data-stu-id="44c2c-171">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="44c2c-172">V databázi se pak aktualizuje bez ohledu na hodnotu, kterou zadal počítačový podvodník pro `Secret` pole formuláře.</span><span class="sxs-lookup"><span data-stu-id="44c2c-172">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="44c2c-173">Následující obrázek znázorňuje nástroj Fiddler, který přidá `Secret` pole (s hodnotou "Repost") do publikovaných hodnot formuláře.</span><span class="sxs-lookup"><span data-stu-id="44c2c-173">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Fiddler přidání tajného pole](crud/_static/fiddler.png)

<span data-ttu-id="44c2c-175">Hodnota "" přeúčtování "by se pak úspěšně přidala do `Secret` Vlastnosti vloženého řádku, i když jste nikdy nezamýšleli, že webová stránka bude moct tuto vlastnost nastavit.</span><span class="sxs-lookup"><span data-stu-id="44c2c-175">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="44c2c-176">Je možné zabránit v úpravách v situacích, kdy nejprve přečtete entitu z databáze a potom zavoláte `TryUpdateModel` a předáte seznam explicitně povolených vlastností.</span><span class="sxs-lookup"><span data-stu-id="44c2c-176">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="44c2c-177">To je metoda použitá v těchto kurzech.</span><span class="sxs-lookup"><span data-stu-id="44c2c-177">That's the method used in these tutorials.</span></span>

<span data-ttu-id="44c2c-178">Alternativní způsob, jak zabránit předávání, které upřednostňuje mnoho vývojářů, je použít modely zobrazení spíše než třídy entit s vazbou modelu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-178">An alternative way to prevent overposting that's preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="44c2c-179">Do modelu zobrazení zahrňte pouze vlastnosti, které chcete aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="44c2c-179">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="44c2c-180">Po dokončení pořadače modelu MVC zkopírujte vlastnosti zobrazení modelu do instance entity, volitelně pomocí nástroje, jako je například automapper.</span><span class="sxs-lookup"><span data-stu-id="44c2c-180">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="44c2c-181">Použijte `_context.Entry` v instanci entity k nastavení jeho stavu na `Unchanged` a pak nastavte `Property("PropertyName").IsModified` na hodnotu true u každé vlastnosti entity, která je obsažena v modelu zobrazení.</span><span class="sxs-lookup"><span data-stu-id="44c2c-181">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that's included in the view model.</span></span> <span data-ttu-id="44c2c-182">Tato metoda funguje ve scénářích úpravy a vytváření.</span><span class="sxs-lookup"><span data-stu-id="44c2c-182">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="44c2c-183">Testování stránky pro vytvoření</span><span class="sxs-lookup"><span data-stu-id="44c2c-183">Test the Create page</span></span>

<span data-ttu-id="44c2c-184">Kód v *zobrazeních/Students/Create. cshtml* používá `label` `input` `span` pro každé pole nápovědu značek, a (pro zprávy ověření).</span><span class="sxs-lookup"><span data-stu-id="44c2c-184">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="44c2c-185">Spusťte aplikaci, vyberte kartu **Students** a klikněte na **vytvořit novou**.</span><span class="sxs-lookup"><span data-stu-id="44c2c-185">Run the app, select the **Students** tab, and click **Create New**.</span></span>

<span data-ttu-id="44c2c-186">Zadejte jména a datum.</span><span class="sxs-lookup"><span data-stu-id="44c2c-186">Enter names and a date.</span></span> <span data-ttu-id="44c2c-187">Pokud to váš prohlížeč umožňuje, zkuste zadat neplatné datum.</span><span class="sxs-lookup"><span data-stu-id="44c2c-187">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="44c2c-188">(Některé prohlížeče vynutí použití ovládacího prvku pro výběr data.) Pak kliknutím na **vytvořit** zobrazíte chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-188">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Chyba ověření data](crud/_static/date-error.png)

<span data-ttu-id="44c2c-190">Toto je ověřování na straně serveru, které se ve výchozím nastavení zobrazí. v pozdějším kurzu se dozvíte, jak přidat atributy, které budou generovat kód pro ověřování na straně klienta také.</span><span class="sxs-lookup"><span data-stu-id="44c2c-190">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="44c2c-191">Následující zvýrazněný kód ukazuje kontrolu ověřování modelu v `Create` metodě.</span><span class="sxs-lookup"><span data-stu-id="44c2c-191">The following highlighted code shows the model validation check in the `Create` method.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]

<span data-ttu-id="44c2c-192">Změňte datum na platnou hodnotu a kliknutím na tlačítko **vytvořit** zobrazíte nového studenta na stránce **Rejstřík** .</span><span class="sxs-lookup"><span data-stu-id="44c2c-192">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="44c2c-193">Aktualizace stránky pro úpravy</span><span class="sxs-lookup"><span data-stu-id="44c2c-193">Update the Edit page</span></span>

<span data-ttu-id="44c2c-194">V *StudentController.cs* `Edit` Metoda HttpGet (ta bez `HttpPost` atributu) používá `SingleOrDefaultAsync` metodu pro načtení vybrané entity studenta, jak jste viděli v `Details` metodě.</span><span class="sxs-lookup"><span data-stu-id="44c2c-194">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="44c2c-195">Tuto metodu nemusíte měnit.</span><span class="sxs-lookup"><span data-stu-id="44c2c-195">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="44c2c-196">Doporučené upravit kód HttpPost: číst a aktualizovat</span><span class="sxs-lookup"><span data-stu-id="44c2c-196">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="44c2c-197">Nahraďte metodu HttpPost Edit Action následujícím kódem.</span><span class="sxs-lookup"><span data-stu-id="44c2c-197">Replace the HttpPost Edit action method with the following code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]

<span data-ttu-id="44c2c-198">Tyto změny implementují osvědčené postupy zabezpečení, které zabrání přestavení.</span><span class="sxs-lookup"><span data-stu-id="44c2c-198">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="44c2c-199">Generování uživatelského rozhraní vygenerovalo `Bind` atribut a přidalo entitu vytvořenou pořadačem modelu do sady entit s `Modified` příznakem.</span><span class="sxs-lookup"><span data-stu-id="44c2c-199">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="44c2c-200">Tento kód není doporučen pro mnoho scénářů, protože `Bind` atribut vymaže všechna dříve existující data v polích, která nejsou uvedena v `Include` parametru.</span><span class="sxs-lookup"><span data-stu-id="44c2c-200">That code isn't recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="44c2c-201">Nový kód přečte existující entitu a volání `TryUpdateModel` pro aktualizaci polí v načtené entitě [na základě vstupu uživatele v publikovaných datech formuláře](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="44c2c-201">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="44c2c-202">Automatické sledování změn Entity Framework nastaví `Modified` příznak pro pole, která jsou změněna vstupem formuláře.</span><span class="sxs-lookup"><span data-stu-id="44c2c-202">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="44c2c-203">Při `SaveChanges` volání metody Entity Framework vytvoří příkazy SQL pro aktualizaci řádku databáze.</span><span class="sxs-lookup"><span data-stu-id="44c2c-203">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="44c2c-204">Konflikty souběžnosti jsou ignorovány a v databázi se aktualizují pouze sloupce tabulky, které byly aktualizovány uživatelem.</span><span class="sxs-lookup"><span data-stu-id="44c2c-204">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="44c2c-205">(V dalším kurzu se dozvíte, jak zvládnout konflikty souběžnosti.)</span><span class="sxs-lookup"><span data-stu-id="44c2c-205">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="44c2c-206">Jako osvědčený postup bráníte přeúčtování, pole, která chcete aktualizovat pomocí stránky pro **Úpravy** , jsou deklarována v `TryUpdateModel` parametrech.</span><span class="sxs-lookup"><span data-stu-id="44c2c-206">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are declared in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="44c2c-207">(Prázdný řetězec uvedený před seznamem polí v seznamu parametrů je určen pro předponu, která má být použita v názvech polí formuláře.) V současné době nejsou k dispozici žádná doplňková pole, která chráníte, ale seznam polí, ke kterým má pořadač modelů navazovat vazby, zajišťuje, že pokud přidáte pole do datového modelu v budoucnosti, budou automaticky chráněny, dokud je nepřidáte sem.</span><span class="sxs-lookup"><span data-stu-id="44c2c-207">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="44c2c-208">V důsledku těchto změn je signatura metody HttpPost `Edit` shodná s `Edit` metodou HttpGet; proto jste přejmenovali metodu `EditPost` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-208">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="44c2c-209">Alternativní HttpPost upravit kód: vytvořit a připojit</span><span class="sxs-lookup"><span data-stu-id="44c2c-209">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="44c2c-210">Doporučený HttpPost úpravový kód zajišťuje aktualizaci pouze změněných sloupců a zachovává data ve vlastnostech, které nechcete zahrnout do vazby modelu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-210">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="44c2c-211">Přístup pro čtení prvního vyžaduje navíc čtení databáze a může mít za následek složitější kód pro zpracování konfliktů souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="44c2c-211">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="44c2c-212">Alternativou je připojit entitu vytvořenou pořadačem modelu do kontextu EF a označit ji jako upravenou.</span><span class="sxs-lookup"><span data-stu-id="44c2c-212">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="44c2c-213">(Projekt neaktualizujte tímto kódem, zobrazuje se jenom pro ilustraci volitelného přístupu.)</span><span class="sxs-lookup"><span data-stu-id="44c2c-213">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]

<span data-ttu-id="44c2c-214">Tento přístup můžete použít, pokud uživatelské rozhraní webové stránky zahrnuje všechna pole v entitě a může je aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="44c2c-214">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="44c2c-215">Generovaný kód používá přístup k vytvoření a připojení, ale zachycuje pouze `DbUpdateConcurrencyException` výjimky a vrací kódy chyb 404.</span><span class="sxs-lookup"><span data-stu-id="44c2c-215">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="44c2c-216">Příklad zobrazuje zachycení jakékoli výjimky aktualizace databáze a zobrazí chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-216">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="44c2c-217">Stavy entit</span><span class="sxs-lookup"><span data-stu-id="44c2c-217">Entity States</span></span>

<span data-ttu-id="44c2c-218">Kontext databáze uchovává informace o tom, zda jsou entity v paměti synchronizovány s odpovídajícími řádky v databázi, a tyto informace určují, co se stane při volání `SaveChanges` metody.</span><span class="sxs-lookup"><span data-stu-id="44c2c-218">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="44c2c-219">Například když do metody předáte novou entitu `Add` , stav této entity je nastaven na `Added` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-219">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="44c2c-220">Poté při volání `SaveChanges` metody kontext databáze vydá příkaz SQL INSERT.</span><span class="sxs-lookup"><span data-stu-id="44c2c-220">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="44c2c-221">Entita může být v jednom z následujících stavů:</span><span class="sxs-lookup"><span data-stu-id="44c2c-221">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="44c2c-222">`Added`.</span><span class="sxs-lookup"><span data-stu-id="44c2c-222">`Added`.</span></span> <span data-ttu-id="44c2c-223">Entita zatím v databázi neexistuje.</span><span class="sxs-lookup"><span data-stu-id="44c2c-223">The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="44c2c-224">`SaveChanges`Metoda vydá příkaz INSERT.</span><span class="sxs-lookup"><span data-stu-id="44c2c-224">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="44c2c-225">`Unchanged`.</span><span class="sxs-lookup"><span data-stu-id="44c2c-225">`Unchanged`.</span></span> <span data-ttu-id="44c2c-226">Tuto entitu není v této entitě potřeba dělat `SaveChanges` metodou.</span><span class="sxs-lookup"><span data-stu-id="44c2c-226">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="44c2c-227">Při čtení entity z databáze se entita spouští s tímto stavem.</span><span class="sxs-lookup"><span data-stu-id="44c2c-227">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="44c2c-228">`Modified`.</span><span class="sxs-lookup"><span data-stu-id="44c2c-228">`Modified`.</span></span> <span data-ttu-id="44c2c-229">Některé nebo všechny hodnoty vlastností entity byly změněny.</span><span class="sxs-lookup"><span data-stu-id="44c2c-229">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="44c2c-230">`SaveChanges`Metoda vydá příkaz Update.</span><span class="sxs-lookup"><span data-stu-id="44c2c-230">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="44c2c-231">`Deleted`.</span><span class="sxs-lookup"><span data-stu-id="44c2c-231">`Deleted`.</span></span> <span data-ttu-id="44c2c-232">Entita byla označena pro odstranění.</span><span class="sxs-lookup"><span data-stu-id="44c2c-232">The entity has been marked for deletion.</span></span> <span data-ttu-id="44c2c-233">`SaveChanges`Metoda vydá příkaz DELETE.</span><span class="sxs-lookup"><span data-stu-id="44c2c-233">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="44c2c-234">`Detached`.</span><span class="sxs-lookup"><span data-stu-id="44c2c-234">`Detached`.</span></span> <span data-ttu-id="44c2c-235">Entita není sledována kontextem databáze.</span><span class="sxs-lookup"><span data-stu-id="44c2c-235">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="44c2c-236">V aplikaci klasické pracovní plochy se obvykle automaticky nastaví změny stavu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-236">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="44c2c-237">Načetli jste entitu a provedete změny jejích hodnot vlastností.</span><span class="sxs-lookup"><span data-stu-id="44c2c-237">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="44c2c-238">To způsobí, že se stav jeho entity automaticky změní na `Modified` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-238">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="44c2c-239">Poté při volání `SaveChanges` Entity Framework vygeneruje příkaz SQL Update, který aktualizuje pouze skutečné vlastnosti, které jste změnili.</span><span class="sxs-lookup"><span data-stu-id="44c2c-239">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="44c2c-240">Ve webové aplikaci, `DbContext` která zpočátku čte entitu a zobrazuje data, která se mají upravit, se po vykreslení stránky odstraní.</span><span class="sxs-lookup"><span data-stu-id="44c2c-240">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="44c2c-241">Když `Edit` je volána metoda akce HTTPPOST, je vytvořena nová webová žádost a máte novou instanci `DbContext` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-241">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="44c2c-242">Pokud znovu načtete entitu v tomto novém kontextu, simulujete tím zpracování plochy.</span><span class="sxs-lookup"><span data-stu-id="44c2c-242">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="44c2c-243">Pokud ale nechcete provádět operaci čtení navíc, je nutné použít objekt entity vytvořený pořadačem modelu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-243">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="44c2c-244">Nejjednodušší způsob, jak to provést, je nastavit stav entity na hodnotu změněno, jak je provedeno v alternativním HttpPost úpravě kódu zobrazeném výše.</span><span class="sxs-lookup"><span data-stu-id="44c2c-244">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="44c2c-245">Když potom zavoláte `SaveChanges` , Entity Framework aktualizuje všechny sloupce řádku databáze, protože kontext nemá žádný způsob, jak zjistit, které vlastnosti jste změnili.</span><span class="sxs-lookup"><span data-stu-id="44c2c-245">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="44c2c-246">Pokud se chcete vyhnout prvnímu přístupu, ale také chcete, aby příkaz SQL UPDATE aktualizoval pouze ta pole, která uživatel skutečně změnil, kód je složitější.</span><span class="sxs-lookup"><span data-stu-id="44c2c-246">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="44c2c-247">Původní hodnoty je nutné uložit nějakým způsobem (například pomocí skrytých polí), aby byly k dispozici při `Edit` volání metody HTTPPOST.</span><span class="sxs-lookup"><span data-stu-id="44c2c-247">You have to save the original values in some way (such as by using hidden fields) so that they're available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="44c2c-248">Pak můžete vytvořit entitu Student pomocí původních hodnot, zavolat `Attach` metodu s touto původní verzí entity, aktualizovat hodnoty entity na nové hodnoty a potom zavolat `SaveChanges` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-248">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="44c2c-249">Test stránky pro úpravy</span><span class="sxs-lookup"><span data-stu-id="44c2c-249">Test the Edit page</span></span>

<span data-ttu-id="44c2c-250">Spusťte aplikaci, vyberte kartu **Students** a pak klikněte na hypertextový odkaz **Upravit** .</span><span class="sxs-lookup"><span data-stu-id="44c2c-250">Run the app, select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Stránka pro úpravy studentů](crud/_static/student-edit.png)

<span data-ttu-id="44c2c-252">Změňte některá data a klikněte na **Uložit**.</span><span class="sxs-lookup"><span data-stu-id="44c2c-252">Change some of the data and click **Save**.</span></span> <span data-ttu-id="44c2c-253">Otevře se stránka **index** a uvidíte změněná data.</span><span class="sxs-lookup"><span data-stu-id="44c2c-253">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="44c2c-254">Aktualizace stránky pro odstranění</span><span class="sxs-lookup"><span data-stu-id="44c2c-254">Update the Delete page</span></span>

<span data-ttu-id="44c2c-255">V *StudentController.cs*kód šablony pro `Delete` metodu HttpGet používá `SingleOrDefaultAsync` metodu k načtení vybrané entity studenta, jak jste viděli v metodách Details a Edit.</span><span class="sxs-lookup"><span data-stu-id="44c2c-255">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="44c2c-256">Chcete-li však implementovat vlastní chybovou zprávu v případě, že volání bude `SaveChanges` neúspěšné, přidáte k této metodě a příslušnému zobrazení některé funkce.</span><span class="sxs-lookup"><span data-stu-id="44c2c-256">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="44c2c-257">Jak jste viděli pro operace aktualizace a vytváření, vyžadují operace odstranění dvě metody akcí.</span><span class="sxs-lookup"><span data-stu-id="44c2c-257">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="44c2c-258">Metoda, která je volána jako odpověď na požadavek GET, zobrazuje zobrazení, které uživateli umožňuje schválit nebo zrušit operaci odstranění.</span><span class="sxs-lookup"><span data-stu-id="44c2c-258">The method that's called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="44c2c-259">Pokud ho uživatel schválí, vytvoří se požadavek POST.</span><span class="sxs-lookup"><span data-stu-id="44c2c-259">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="44c2c-260">V takovém případě se `Delete` zavolá metoda HTTPPOST a pak tato metoda skutečně provede operaci odstranění.</span><span class="sxs-lookup"><span data-stu-id="44c2c-260">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="44c2c-261">Do metody HttpPost přidáte blok try-catch, který bude `Delete` zpracovávat chyby, ke kterým může dojít při aktualizaci databáze.</span><span class="sxs-lookup"><span data-stu-id="44c2c-261">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="44c2c-262">Pokud dojde k chybě, metoda HttpPost Delete zavolá metodu HttpGet DELETE a předá jí parametr, který indikuje, že došlo k chybě.</span><span class="sxs-lookup"><span data-stu-id="44c2c-262">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="44c2c-263">Metoda HttpGet DELETE potom znovu zobrazí potvrzovací stránku spolu s chybovou zprávou, takže uživatel může příležitost zrušit nebo zkusit znovu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-263">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="44c2c-264">Nahraďte `Delete` metodu akce HttpGet následujícím kódem, který spravuje zasílání zpráv o chybách.</span><span class="sxs-lookup"><span data-stu-id="44c2c-264">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]

<span data-ttu-id="44c2c-265">Tento kód akceptuje volitelný parametr, který označuje, zda byla metoda volána po neúspěšném uložení změn.</span><span class="sxs-lookup"><span data-stu-id="44c2c-265">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="44c2c-266">Tento parametr má hodnotu false, pokud `Delete` je metoda HttpGet volána bez předchozí chyby.</span><span class="sxs-lookup"><span data-stu-id="44c2c-266">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="44c2c-267">Pokud je volána `Delete` metodou HTTPPOST v reakci na chybu aktualizace databáze, je parametr true a do zobrazení se předává chybová zpráva.</span><span class="sxs-lookup"><span data-stu-id="44c2c-267">When it's called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="44c2c-268">Přístup pro čtení, který se má HttpPost odstranit</span><span class="sxs-lookup"><span data-stu-id="44c2c-268">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="44c2c-269">Nahraďte `Delete` metodu akce HTTPPOST (s názvem `DeleteConfirmed` ) následujícím kódem, který provede skutečnou operaci odstranění a zachytí všechny chyby aktualizace databáze.</span><span class="sxs-lookup"><span data-stu-id="44c2c-269">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6-9,11-12,16-21)]

<span data-ttu-id="44c2c-270">Tento kód načte vybranou entitu a pak zavolá `Remove` metodu pro nastavení stavu entity na `Deleted` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-270">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="44c2c-271">Při `SaveChanges` volání metody je vygenerován příkaz SQL DELETE.</span><span class="sxs-lookup"><span data-stu-id="44c2c-271">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="44c2c-272">Postup vytvoření a připojení k HttpPost odstranění</span><span class="sxs-lookup"><span data-stu-id="44c2c-272">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="44c2c-273">Pokud je lepší výkon v aplikaci s vysokým objemem, je možné vyhnout se zbytečnému dotazu SQL vytvořením instance entity studenta s použitím pouze hodnoty primárního klíče a nastavením stavu entity na `Deleted` .</span><span class="sxs-lookup"><span data-stu-id="44c2c-273">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="44c2c-274">To je vše, co Entity Framework potřebuje, aby se entita odstranila.</span><span class="sxs-lookup"><span data-stu-id="44c2c-274">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="44c2c-275">(Tento kód neumísťujte do projektu; je tu jenom k ilustraci alternativy.)</span><span class="sxs-lookup"><span data-stu-id="44c2c-275">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]

<span data-ttu-id="44c2c-276">Pokud má entita související data, která by se měla taky odstranit, ujistěte se, že je v databázi nakonfigurované kaskádové odstranění.</span><span class="sxs-lookup"><span data-stu-id="44c2c-276">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="44c2c-277">V případě tohoto přístupu k odstranění entit nemusí EF vědět, že existují související entity, které by se měly odstranit.</span><span class="sxs-lookup"><span data-stu-id="44c2c-277">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="44c2c-278">Aktualizace zobrazení pro odstranění</span><span class="sxs-lookup"><span data-stu-id="44c2c-278">Update the Delete view</span></span>

<span data-ttu-id="44c2c-279">V *zobrazení/student/odstranit. cshtml*přidejte chybovou zprávu mezi nadpisem H2 a záhlavím H3, jak je znázorněno v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="44c2c-279">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-cshtml[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="44c2c-280">Spusťte aplikaci, vyberte kartu **Students** a klikněte na **Odstranit** hypertextový odkaz:</span><span class="sxs-lookup"><span data-stu-id="44c2c-280">Run the app, select the **Students** tab, and click a **Delete** hyperlink:</span></span>

![Stránka pro potvrzení odstranění](crud/_static/student-delete.png)

<span data-ttu-id="44c2c-282">Klikněte na **Odstranit**.</span><span class="sxs-lookup"><span data-stu-id="44c2c-282">Click **Delete**.</span></span> <span data-ttu-id="44c2c-283">Stránka index se zobrazí bez odstraněného studenta.</span><span class="sxs-lookup"><span data-stu-id="44c2c-283">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="44c2c-284">(Příklad kódu pro zpracování chyb v akci v kurzu souběžnosti najdete v tématu.)</span><span class="sxs-lookup"><span data-stu-id="44c2c-284">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="close-database-connections"></a><span data-ttu-id="44c2c-285">Zavřít databázová připojení</span><span class="sxs-lookup"><span data-stu-id="44c2c-285">Close database connections</span></span>

<span data-ttu-id="44c2c-286">Chcete-li uvolnit prostředky, které připojení k databázi obsahuje, je nutné instanci kontextu uvolnit co nejdříve, jakmile s ní budete hotovi.</span><span class="sxs-lookup"><span data-stu-id="44c2c-286">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="44c2c-287">ASP.NET Core vestavěné [závislosti](../../fundamentals/dependency-injection.md) se postará o tento úkol za vás.</span><span class="sxs-lookup"><span data-stu-id="44c2c-287">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="44c2c-288">V *Startup.cs*zavoláte [metodu rozšíření AddDbContext](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) pro zřízení `DbContext` třídy v kontejneru ASP.NET Core di.</span><span class="sxs-lookup"><span data-stu-id="44c2c-288">In *Startup.cs*, you call the [AddDbContext extension method](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET Core DI container.</span></span> <span data-ttu-id="44c2c-289">Tato metoda nastavuje dobu platnosti služby na `Scoped` výchozí hodnotu.</span><span class="sxs-lookup"><span data-stu-id="44c2c-289">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="44c2c-290">`Scoped`znamená, že doba života objektu kontextu se shoduje s časem životnosti webové žádosti a `Dispose` Metoda bude na konci webového požadavku volána automaticky.</span><span class="sxs-lookup"><span data-stu-id="44c2c-290">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handle-transactions"></a><span data-ttu-id="44c2c-291">Zpracování transakcí</span><span class="sxs-lookup"><span data-stu-id="44c2c-291">Handle transactions</span></span>

<span data-ttu-id="44c2c-292">Ve výchozím nastavení Entity Framework implicitně implementuje transakce.</span><span class="sxs-lookup"><span data-stu-id="44c2c-292">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="44c2c-293">Ve scénářích, kdy provedete změny více řádků nebo tabulek a potom zavoláte `SaveChanges` , Entity Framework automaticky zajistěte, aby všechny změny byly úspěšné nebo všechny selžou.</span><span class="sxs-lookup"><span data-stu-id="44c2c-293">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="44c2c-294">Pokud se nějaké změny provedly a pak dojde k chybě, změny se automaticky vrátí zpět.</span><span class="sxs-lookup"><span data-stu-id="44c2c-294">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="44c2c-295">V případě scénářů, kde potřebujete větší kontrolu – například pokud chcete zahrnout operace provedené mimo Entity Framework v transakci – viz [transakce](/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="44c2c-295">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="44c2c-296">Žádné dotazy pro sledování</span><span class="sxs-lookup"><span data-stu-id="44c2c-296">No-tracking queries</span></span>

<span data-ttu-id="44c2c-297">Když kontext databáze načte řádky tabulky a vytvoří objekty entit, které je reprezentují, ve výchozím nastavení udržuje přehled o tom, zda jsou entity v paměti synchronizovány s těmi, které jsou v databázi.</span><span class="sxs-lookup"><span data-stu-id="44c2c-297">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="44c2c-298">Data v paměti fungují jako mezipaměť a používají se při aktualizaci entity.</span><span class="sxs-lookup"><span data-stu-id="44c2c-298">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="44c2c-299">Toto ukládání do mezipaměti je často zbytečné v rámci webové aplikace, protože instance kontextu jsou obvykle krátkodobé – neuvolňuje (nové je vytvořeno a odstraněno pro každý požadavek) a kontext, který čte entitu, je obvykle uvolněn předtím, než se entita znovu použije.</span><span class="sxs-lookup"><span data-stu-id="44c2c-299">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="44c2c-300">Sledování objektů entit v paměti lze zakázat voláním `AsNoTracking` metody.</span><span class="sxs-lookup"><span data-stu-id="44c2c-300">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="44c2c-301">Mezi obvyklé scénáře, které byste mohli chtít udělat, patří následující:</span><span class="sxs-lookup"><span data-stu-id="44c2c-301">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="44c2c-302">Během životnosti kontextu nemusíte aktualizovat žádné entity a nepotřebujeme EF pro [Automatické načítání navigačních vlastností s entitami načtenými pomocí samostatných dotazů](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="44c2c-302">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="44c2c-303">Často se tyto podmínky splní v metodách HttpGetch akcí kontroleru.</span><span class="sxs-lookup"><span data-stu-id="44c2c-303">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="44c2c-304">Spouštíte dotaz, který načte velký objem dat a aktualizuje se jenom malá část vrácených dat.</span><span class="sxs-lookup"><span data-stu-id="44c2c-304">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="44c2c-305">Může být efektivnější vypnout sledování pro velký dotaz a spustit dotaz později pro několik entit, které je potřeba aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="44c2c-305">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="44c2c-306">Chcete připojit entitu, abyste ji mohli aktualizovat, ale dříve jste získali stejnou entitu pro jiný účel.</span><span class="sxs-lookup"><span data-stu-id="44c2c-306">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="44c2c-307">Vzhledem k tomu, že entita je již sledována kontextem databáze, nelze připojit entitu, kterou chcete změnit.</span><span class="sxs-lookup"><span data-stu-id="44c2c-307">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="44c2c-308">Jedním ze způsobů, jak tuto situaci zpracovat, je zavolat `AsNoTracking` na předchozí dotaz.</span><span class="sxs-lookup"><span data-stu-id="44c2c-308">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="44c2c-309">Další informace najdete v tématu [sledování vs. bez sledování](/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="44c2c-309">For more information, see [Tracking vs. No-Tracking](/ef/core/querying/tracking).</span></span>

## <a name="get-the-code"></a><span data-ttu-id="44c2c-310">Získání kódu</span><span class="sxs-lookup"><span data-stu-id="44c2c-310">Get the code</span></span>

[<span data-ttu-id="44c2c-311">Stažení nebo zobrazení dokončené aplikace.</span><span class="sxs-lookup"><span data-stu-id="44c2c-311">Download or view the completed application.</span></span>](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/data/ef-mvc/intro/samples/cu-final)

## <a name="next-steps"></a><span data-ttu-id="44c2c-312">Další kroky</span><span class="sxs-lookup"><span data-stu-id="44c2c-312">Next steps</span></span>

<span data-ttu-id="44c2c-313">V tomto kurzu jste:</span><span class="sxs-lookup"><span data-stu-id="44c2c-313">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="44c2c-314">Přizpůsobení stránky podrobností</span><span class="sxs-lookup"><span data-stu-id="44c2c-314">Customized the Details page</span></span>
> * <span data-ttu-id="44c2c-315">Aktualizace stránky pro vytvoření</span><span class="sxs-lookup"><span data-stu-id="44c2c-315">Updated the Create page</span></span>
> * <span data-ttu-id="44c2c-316">Aktualizace stránky pro úpravy</span><span class="sxs-lookup"><span data-stu-id="44c2c-316">Updated the Edit page</span></span>
> * <span data-ttu-id="44c2c-317">Aktualizace stránky odstranění</span><span class="sxs-lookup"><span data-stu-id="44c2c-317">Updated the Delete page</span></span>
> * <span data-ttu-id="44c2c-318">Uzavřená databázová připojení</span><span class="sxs-lookup"><span data-stu-id="44c2c-318">Closed database connections</span></span>

<span data-ttu-id="44c2c-319">Přejděte k dalšímu kurzu, kde se dozvíte, jak rozšířit funkčnost stránky **indexu** přidáním řazení, filtrování a stránkování.</span><span class="sxs-lookup"><span data-stu-id="44c2c-319">Advance to the next tutorial to learn how to expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="44c2c-320">Další: řazení, filtrování a stránkování</span><span class="sxs-lookup"><span data-stu-id="44c2c-320">Next: Sorting, filtering, and paging</span></span>](sort-filter-page.md)
