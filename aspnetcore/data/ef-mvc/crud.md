---
title: "Jádro ASP.NET MVC s EF Core - CRUD - 2 10"
author: tdykstra
description: 
manager: wpickett
ms.author: tdykstra
ms.date: 03/15/2017
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: get-started-article
uid: data/ef-mvc/crud
ms.openlocfilehash: a7e0d4ff3d57e42dd7e33ffb5f26f2143520be87
ms.sourcegitcommit: 18d1dc86770f2e272d93c7e1cddfc095c5995d9e
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 01/31/2018
---
# <a name="create-read-update-and-delete---ef-core-with-aspnet-core-mvc-tutorial-2-of-10"></a><span data-ttu-id="78cdf-102">Vytvářet, číst, aktualizovat a odstraňovat – základní EF s kurz k ASP.NET MVC jádra (2 10)</span><span class="sxs-lookup"><span data-stu-id="78cdf-102">Create, Read, Update, and Delete - EF Core with ASP.NET Core MVC tutorial (2 of 10)</span></span>

<span data-ttu-id="78cdf-103">Podle [tní Dykstra](https://github.com/tdykstra) a [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="78cdf-103">By [Tom Dykstra](https://github.com/tdykstra) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="78cdf-104">Contoso univerzity ukázkovou webovou aplikaci ukazuje, jak vytvářet webové aplikace ASP.NET MVC základní pomocí Entity Framework Core a Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="78cdf-104">The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio.</span></span> <span data-ttu-id="78cdf-105">Informace o kurzu řady najdete v tématu [z prvního kurzu řady](intro.md).</span><span class="sxs-lookup"><span data-stu-id="78cdf-105">For information about the tutorial series, see [the first tutorial in the series](intro.md).</span></span>

<span data-ttu-id="78cdf-106">V předchozích kurzu jste vytvořili aplikaci MVC, která uchovává a zobrazí data pomocí rozhraní Entity Framework a SQL Server LocalDB.</span><span class="sxs-lookup"><span data-stu-id="78cdf-106">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="78cdf-107">V tomto kurzu budete zkontrolujte a přizpůsobit CRUD (vytvořit, číst, aktualizovat, odstraňovat) kód, který generování uživatelského rozhraní MVC pro vás automaticky vytvoří v kontrolery a zobrazení.</span><span class="sxs-lookup"><span data-stu-id="78cdf-107">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE] 
> <span data-ttu-id="78cdf-108">Je běžnou praxí implementovat vzor úložiště před vytvořením vrstvu abstrakce mezi řadiči a vrstva přístupu k datům.</span><span class="sxs-lookup"><span data-stu-id="78cdf-108">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="78cdf-109">Tyto kurzy zachovat jednoduché a zaměřují se na výuky použití rozhraní Entity Framework, samotné, nepoužívejte úložiště.</span><span class="sxs-lookup"><span data-stu-id="78cdf-109">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="78cdf-110">Informace o úložiště s EF najdete v tématu [poslední kurzu této série](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="78cdf-110">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="78cdf-111">V tomto kurzu budete pracovat s následujících webových stránek:</span><span class="sxs-lookup"><span data-stu-id="78cdf-111">In this tutorial, you'll work with the following web pages:</span></span>

![Stránka Podrobnosti studenty](crud/_static/student-details.png)

![Stránka pro vytvoření studenty](crud/_static/student-create.png)

![Stránka upravit studenty](crud/_static/student-edit.png)

![Odstranit stránky studenty](crud/_static/student-delete.png)

## <a name="customize-the-details-page"></a><span data-ttu-id="78cdf-116">Stránce s podrobnostmi o přizpůsobení</span><span class="sxs-lookup"><span data-stu-id="78cdf-116">Customize the Details page</span></span>

<span data-ttu-id="78cdf-117">Automaticky generovaný kód pro studenty indexovou stránku vynecháno `Enrollments` vlastnost, protože tato vlastnost obsahuje kolekci.</span><span class="sxs-lookup"><span data-stu-id="78cdf-117">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="78cdf-118">V **podrobnosti** stránky, budete zobrazení obsahu kolekce do tabulky HTML.</span><span class="sxs-lookup"><span data-stu-id="78cdf-118">In the **Details** page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="78cdf-119">V *Controllers/StudentsController.cs*, metoda akce podrobnosti o zobrazení používá `SingleOrDefaultAsync` metoda pro načtení jedné `Student` entity.</span><span class="sxs-lookup"><span data-stu-id="78cdf-119">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="78cdf-120">Přidejte kód, který volá `Include`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-120">Add code that calls `Include`.</span></span> <span data-ttu-id="78cdf-121">`ThenInclude`, a `AsNoTracking` metod, jak je znázorněno v následující zvýrazněný kód.</span><span class="sxs-lookup"><span data-stu-id="78cdf-121">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]

<span data-ttu-id="78cdf-122">`Include` a `ThenInclude` metody způsobit kontext k načtení `Student.Enrollments` navigační vlastnost a v rámci každé registrace `Enrollment.Course` navigační vlastnost.</span><span class="sxs-lookup"><span data-stu-id="78cdf-122">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="78cdf-123">Dozvíte více o těchto metodách v [čtení souvisejících dat](read-related-data.md) kurzu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-123">You'll learn more about these methods in the [reading related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="78cdf-124">`AsNoTracking` Metoda zlepšuje výkon v situacích, kde entity vrátil nebude aktualizován v aktuálním kontextu životnosti.</span><span class="sxs-lookup"><span data-stu-id="78cdf-124">The `AsNoTracking` method improves performance in scenarios where the entities returned won't be updated in the current context's lifetime.</span></span> <span data-ttu-id="78cdf-125">Získáte další informace o `AsNoTracking` na konci tohoto kurzu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-125">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="78cdf-126">Data trasy</span><span class="sxs-lookup"><span data-stu-id="78cdf-126">Route data</span></span>

<span data-ttu-id="78cdf-127">Hodnota klíče, který je předán `Details` metoda pochází z *směrování dat*.</span><span class="sxs-lookup"><span data-stu-id="78cdf-127">The key value that's passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="78cdf-128">Data trasy, která jsou data, která vazač modelu nalezen v segment adresy URL.</span><span class="sxs-lookup"><span data-stu-id="78cdf-128">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="78cdf-129">Například výchozí trasa určuje kontroler, akci a id segmenty:</span><span class="sxs-lookup"><span data-stu-id="78cdf-129">For example, the default route specifies controller, action, and id segments:</span></span>

[!code-csharp[Main](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]

<span data-ttu-id="78cdf-130">V následující adresu URL výchozí trasu mapuje lektorem jako řadič, Index jako akce a 1, jako je id; Toto jsou hodnot dat trasy.</span><span class="sxs-lookup"><span data-stu-id="78cdf-130">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="78cdf-131">Poslední část adresy URL ("? courseID = 2021") je hodnotu řetězce dotazu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-131">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="78cdf-132">Hodnota ID, která má také předá vazač modelu `Details` metoda `id` parametru předat jako hodnotu řetězce dotazu:</span><span class="sxs-lookup"><span data-stu-id="78cdf-132">The model binder will also pass the ID value to the `Details` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="78cdf-133">Na stránce Index adresy URL hyperlink vytváří značky příkazy pomocných objektů v zobrazení syntaxe Razor.</span><span class="sxs-lookup"><span data-stu-id="78cdf-133">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="78cdf-134">V následujícím kódu Razor `id` parametr odpovídá výchozí trasu, takže `id` se přidá do data trasy.</span><span class="sxs-lookup"><span data-stu-id="78cdf-134">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="78cdf-135">Tím se vygeneruje následující HTML při `item.ID` 6:</span><span class="sxs-lookup"><span data-stu-id="78cdf-135">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="78cdf-136">V následujícím kódu Razor `studentID` neodpovídá parametr ve výchozí trasu, přidá se jako řetězec dotazu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-136">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="78cdf-137">Tím se vygeneruje následující HTML při `item.ID` 6:</span><span class="sxs-lookup"><span data-stu-id="78cdf-137">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="78cdf-138">Další informace o značky pomocné rutiny najdete v tématu [značky pomocné rutiny v ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span><span class="sxs-lookup"><span data-stu-id="78cdf-138">For more information about tag helpers, see [Tag helpers in ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="78cdf-139">Přidat registrace k zobrazení podrobností</span><span class="sxs-lookup"><span data-stu-id="78cdf-139">Add enrollments to the Details view</span></span>

<span data-ttu-id="78cdf-140">Otevřete *Views/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="78cdf-140">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="78cdf-141">Každé pole se zobrazí pomocí `DisplayNameFor` a `DisplayFor` pomocné rutiny, jak je znázorněno v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="78cdf-141">Each field is displayed using `DisplayNameFor` and `DisplayFor` helpers, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="78cdf-142">Po poslední pole a bezprostředně před uzavírací `</dl>` značky, přidejte následující kód k zobrazení seznamu registrace:</span><span class="sxs-lookup"><span data-stu-id="78cdf-142">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="78cdf-143">Pokud kód odsazení nesprávný po vložte kód, stiskněte CTRL-tisíc-D opravte ho.</span><span class="sxs-lookup"><span data-stu-id="78cdf-143">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="78cdf-144">Tento kód projde entity v `Enrollments` navigační vlastnost.</span><span class="sxs-lookup"><span data-stu-id="78cdf-144">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="78cdf-145">Pro každou registraci zobrazí název kurzu a úrovni.</span><span class="sxs-lookup"><span data-stu-id="78cdf-145">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="78cdf-146">Název postupu načten z kurzu entita, která je uložena v `Course` navigační vlastnost entity registrace.</span><span class="sxs-lookup"><span data-stu-id="78cdf-146">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="78cdf-147">Spuštění aplikace, vyberte **studenty** a klikněte **podrobnosti** odkaz pro student.</span><span class="sxs-lookup"><span data-stu-id="78cdf-147">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="78cdf-148">Zobrazí seznam kurzů a tříd pro vybrané student:</span><span class="sxs-lookup"><span data-stu-id="78cdf-148">You see the list of courses and grades for the selected student:</span></span>

![Stránka Podrobnosti studenty](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="78cdf-150">Vytvořit stránku aktualizace</span><span class="sxs-lookup"><span data-stu-id="78cdf-150">Update the Create page</span></span>

<span data-ttu-id="78cdf-151">V *StudentsController.cs*, upravte HttpPost `Create` metoda pomocí bloku try-catch – přidávání a odebírání ID z `Bind` atribut.</span><span class="sxs-lookup"><span data-stu-id="78cdf-151">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]

<span data-ttu-id="78cdf-152">Tento kód přidá Student entity vytvořené vazač modelu ASP.NET MVC v entitě studenty nastavení a pak uloží změny do databáze.</span><span class="sxs-lookup"><span data-stu-id="78cdf-152">This code adds the Student entity created by the ASP.NET MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="78cdf-153">(Vazač modelu odkazuje funkce ASP.NET MVC, která usnadňuje práci s data odeslaná formuláře; vazač modelu převádí hodnoty odeslaného formuláře pro typy CLR a předává je na metodu akce v parametrech.</span><span class="sxs-lookup"><span data-stu-id="78cdf-153">(Model binder refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="78cdf-154">V tomto případě vazač modelu vytvoří instanci Student entity můžete pomocí hodnoty vlastností z kolekce formuláře.)</span><span class="sxs-lookup"><span data-stu-id="78cdf-154">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="78cdf-155">Můžete odebrat `ID` z `Bind` atributů, protože ID má hodnotu primárního klíče, který systému SQL Server bude nastavení automaticky při vložit řádek.</span><span class="sxs-lookup"><span data-stu-id="78cdf-155">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="78cdf-156">Vstup od uživatele nemá nastavit hodnotu ID.</span><span class="sxs-lookup"><span data-stu-id="78cdf-156">Input from the user doesn't set the ID value.</span></span>

<span data-ttu-id="78cdf-157">Jiné než `Bind` atribut try-catch – blok je pouze změny, které jste udělali automaticky generovaný kód.</span><span class="sxs-lookup"><span data-stu-id="78cdf-157">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="78cdf-158">Pokud se výjimka, která je odvozena z `DbUpdateException` je zachycena, zatímco se ukládají změny, se zobrazí obecnou chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-158">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="78cdf-159">`DbUpdateException`výjimky jsou někdy způsobeny něco externí do aplikací, nikoli chybě programování, takže uživatel se doporučuje a zkuste to znovu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-159">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="78cdf-160">I když není implementována v této ukázce, produkční kvality aplikace by zaprotokolování výjimky.</span><span class="sxs-lookup"><span data-stu-id="78cdf-160">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="78cdf-161">Další informace najdete v tématu **protokolu přehledy** kapitoly [monitorování a Telemetrie (vytváření reálných cloudových aplikací s Azure)](https://docs.microsoft.com/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span><span class="sxs-lookup"><span data-stu-id="78cdf-161">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](https://docs.microsoft.com/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="78cdf-162">`ValidateAntiForgeryToken` Atribut pomáhá zabránit útokům (proti útokům CSRF) padělání požadavku posílaného mezi weby.</span><span class="sxs-lookup"><span data-stu-id="78cdf-162">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="78cdf-163">Token je automaticky vloženy do zobrazení pomocí [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) a je součástí formulář je odeslán uživatelem.</span><span class="sxs-lookup"><span data-stu-id="78cdf-163">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="78cdf-164">Token je ověřen `ValidateAntiForgeryToken` atribut.</span><span class="sxs-lookup"><span data-stu-id="78cdf-164">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="78cdf-165">Další informace o proti útokům CSRF najdete v tématu [požadavek proti padělání](../../security/anti-request-forgery.md).</span><span class="sxs-lookup"><span data-stu-id="78cdf-165">For more information about CSRF, see [Anti-Request Forgery](../../security/anti-request-forgery.md).</span></span>

<a id="overpost"></a>
### <a name="security-note-about-overposting"></a><span data-ttu-id="78cdf-166">Poznámka k zabezpečení o overposting</span><span class="sxs-lookup"><span data-stu-id="78cdf-166">Security note about overposting</span></span>

<span data-ttu-id="78cdf-167">`Bind` Atribut, který obsahuje automaticky generovaný kód na `Create` metoda je jedním ze způsobů pro ochranu proti overposting v vytvářet scénáře.</span><span class="sxs-lookup"><span data-stu-id="78cdf-167">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="78cdf-168">Předpokládejme například, zahrnuje Student entity `Secret` vlastnost, která nechcete, aby tato webová stránka nastavení.</span><span class="sxs-lookup"><span data-stu-id="78cdf-168">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="78cdf-169">I v případě, že nemáte `Secret` pole na webové stránce, se hacker může použijte například nástroj Fiddler, nebo si napsat určitého kódu JavaScript ke zveřejnění `Secret` formuláři hodnotu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-169">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="78cdf-170">Bez `Bind` atribut omezení pole, která při vytváření instance studenty, vazač modelu používá vazač modelu se vyzvedávat, `Secret` tvoří hodnotu a použít ho k vytvoření Student entity instance.</span><span class="sxs-lookup"><span data-stu-id="78cdf-170">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="78cdf-171">Pak ať hacker zadaný pro hodnotu `Secret` pole formuláře by aktualizována v databázi.</span><span class="sxs-lookup"><span data-stu-id="78cdf-171">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="78cdf-172">Následující obrázek ukazuje přidání nástroj Fiddler `Secret` pole (s hodnotou "OverPost") na hodnoty odeslaného formuláře.</span><span class="sxs-lookup"><span data-stu-id="78cdf-172">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Přidání tajný pole Fiddler](crud/_static/fiddler.png)

<span data-ttu-id="78cdf-174">Hodnota "OverPost" by poté byl úspěšně přidán do `Secret` vlastnost vloženého řádku, i když nikdy určený, že webová stránka mohli nastavit tuto vlastnost.</span><span class="sxs-lookup"><span data-stu-id="78cdf-174">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="78cdf-175">Můžete zabránit overposting ve scénářích upravit tak, že nejprve čtení entity z databáze a pak volání `TryUpdateModel`, předejte v seznamu povolených explicitní vlastností.</span><span class="sxs-lookup"><span data-stu-id="78cdf-175">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="78cdf-176">To je metoda použitá v těchto kurzech.</span><span class="sxs-lookup"><span data-stu-id="78cdf-176">That's the method used in these tutorials.</span></span>

<span data-ttu-id="78cdf-177">Alternativní způsob zabránit overposting, je mnoho vývojáři preferované je použití Zobrazit modely spíše než tříd entit s vazby modelu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-177">An alternative way to prevent overposting that's preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="78cdf-178">Zahrnout pouze vlastnosti, které chcete aktualizovat v zobrazení modelu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-178">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="78cdf-179">Po dokončení vazač modelu MVC, zkopírujte do instance entity, volitelně pomocí nástroje, jako je AutoMapper zobrazit vlastnosti modelu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-179">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="78cdf-180">Použití `_context.Entry` na instanci entity k nastavení jeho stavu `Unchanged`a poté nastavte `Property("PropertyName").IsModified` na hodnotu true v každé vlastnosti entity, která je součástí modelu zobrazení.</span><span class="sxs-lookup"><span data-stu-id="78cdf-180">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that's included in the view model.</span></span> <span data-ttu-id="78cdf-181">Tato metoda funguje v obou upravovat a vytvářet scénáře.</span><span class="sxs-lookup"><span data-stu-id="78cdf-181">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="78cdf-182">Testovací stránka pro vytvoření</span><span class="sxs-lookup"><span data-stu-id="78cdf-182">Test the Create page</span></span>

<span data-ttu-id="78cdf-183">Kód v *Views/Students/Create.cshtml* používá `label`, `input`, a `span` (pro ověřovacích zpráv) značky pomocníci pro každé pole.</span><span class="sxs-lookup"><span data-stu-id="78cdf-183">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="78cdf-184">Spuštění aplikace, vyberte **studenty** a klikněte na **vytvořit nový**.</span><span class="sxs-lookup"><span data-stu-id="78cdf-184">Run the app, select the **Students** tab, and click **Create New**.</span></span>

<span data-ttu-id="78cdf-185">Zadejte názvy a datum.</span><span class="sxs-lookup"><span data-stu-id="78cdf-185">Enter names and a date.</span></span> <span data-ttu-id="78cdf-186">Zkuste zadat neplatné datum, pokud prohlížeč umožňuje udělat.</span><span class="sxs-lookup"><span data-stu-id="78cdf-186">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="78cdf-187">(Některé prohlížeče vynutit použijte Výběr data.) Pak klikněte na tlačítko **vytvořit** zobrazíte chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-187">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Chyba ověření datum](crud/_static/date-error.png)

<span data-ttu-id="78cdf-189">Toto je ověřování na straně serveru, kterou můžete získat ve výchozím nastavení; novější kurzu uvidíte, jak přidat atributy, které bude také generovat kód pro ověřování na straně klienta.</span><span class="sxs-lookup"><span data-stu-id="78cdf-189">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="78cdf-190">Následující zvýrazněný kód ukazuje kontrolu ověření modelu v `Create` metoda.</span><span class="sxs-lookup"><span data-stu-id="78cdf-190">The following highlighted code shows the model validation check in the `Create` method.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]

<span data-ttu-id="78cdf-191">Změňte na platnou hodnotu data a klikněte na tlačítko **vytvořit** zobrazíte nové student se zobrazí v **Index** stránky.</span><span class="sxs-lookup"><span data-stu-id="78cdf-191">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="78cdf-192">Upravit stránku aktualizace</span><span class="sxs-lookup"><span data-stu-id="78cdf-192">Update the Edit page</span></span>

<span data-ttu-id="78cdf-193">V *StudentController.cs*, třídy MetadataExchangeClientMode `Edit` – metoda (, aniž byste `HttpPost` atribut) používá `SingleOrDefaultAsync` metoda pro načtení vybrané Student entity, jako jste viděli v `Details` metoda.</span><span class="sxs-lookup"><span data-stu-id="78cdf-193">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="78cdf-194">Nemusíte tuto metodu změnit.</span><span class="sxs-lookup"><span data-stu-id="78cdf-194">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="78cdf-195">Doporučená HttpPost upravit kód: čtení a aktualizaci</span><span class="sxs-lookup"><span data-stu-id="78cdf-195">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="78cdf-196">Metoda HttpPost upravit akce nahraďte následujícím kódem.</span><span class="sxs-lookup"><span data-stu-id="78cdf-196">Replace the HttpPost Edit action method with the following code.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]

<span data-ttu-id="78cdf-197">Tyto změny implementovat zabránit overposting osvědčeným postupem zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="78cdf-197">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="78cdf-198">Scaffolder generované `Bind` atribut a přidat entity vytvořené vazač modelu pro sadu s entit `Modified` příznak.</span><span class="sxs-lookup"><span data-stu-id="78cdf-198">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="78cdf-199">Pro mnoho scénářů není doporučeno kódu, protože `Bind` atribut vymaže všechny existující data v polích není uvedený v `Include` parametr.</span><span class="sxs-lookup"><span data-stu-id="78cdf-199">That code isn't recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="78cdf-200">Nový kód načte existující entity a volání `TryUpdateModel` aktualizovat pole v načtenou entitu [založené na vstup uživatele v datech odeslaného formuláře](xref:mvc/models/model-binding#how-model-binding-works).</span><span class="sxs-lookup"><span data-stu-id="78cdf-200">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding#how-model-binding-works).</span></span> <span data-ttu-id="78cdf-201">Rozhraní Entity Framework Automatická změna sledování nastaví `Modified` příznak na pole, které se mění vstup formuláře.</span><span class="sxs-lookup"><span data-stu-id="78cdf-201">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="78cdf-202">Když `SaveChanges` metoda je volána, rozhraní Entity Framework vytvoří příkazy SQL pro aktualizaci řádku databáze.</span><span class="sxs-lookup"><span data-stu-id="78cdf-202">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="78cdf-203">Konflikty souběžnosti jsou ignorovány a pouze sloupců tabulky, které byly aktualizovány uživatelem se aktualizují v databázi.</span><span class="sxs-lookup"><span data-stu-id="78cdf-203">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="78cdf-204">(Novější kurz ukazuje, jak pro zpracování konfliktů souběžnosti.)</span><span class="sxs-lookup"><span data-stu-id="78cdf-204">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="78cdf-205">Jako osvědčený postup, aby se zabránilo overposting pole, která mají být možné aktualizovat pomocí **upravit** stránky jsou seznam povolených adres v `TryUpdateModel` parametry.</span><span class="sxs-lookup"><span data-stu-id="78cdf-205">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="78cdf-206">(Prázdný řetězec v seznamu polí v seznamu parametrů předcházející je pro předponu pro použití s názvy pole formuláře.) Aktuálně neexistují žádná další pole, které chcete chránit, ale seznam polí, které chcete vazač modelu pro vazbu zajistí, že pokud přidáte pole do datového modelu v budoucnu, že jsou automaticky chráněné až je přidáte sem.</span><span class="sxs-lookup"><span data-stu-id="78cdf-206">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="78cdf-207">V důsledku těchto změn podpis metoda HttpPost `Edit` metoda je stejná jako třídy MetadataExchangeClientMode `Edit` metoda; proto jste přejmenovali metodu `EditPost`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-207">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="78cdf-208">Alternativní HttpPost upravit kód: Vytvořte a připojte</span><span class="sxs-lookup"><span data-stu-id="78cdf-208">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="78cdf-209">Doporučené upravit kód HttpPost zajistí aktualizovat pouze změněné sloupce a uchovává data ve vlastnosti, které nechcete, aby zahrnuté pro vazbu modelu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-209">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="78cdf-210">Přístup pro čtení první však vyžaduje další databáze pro čtení a může mít za následek složitější kód pro zpracování konfliktů souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="78cdf-210">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="78cdf-211">Alternativou je připojit entity vytvořené vazač modelu pro kontext EF a označte ji jako upravená.</span><span class="sxs-lookup"><span data-stu-id="78cdf-211">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="78cdf-212">(Neaktualizovat projekt s tímto kódem, ho se zobrazují pouze pro ilustraci volitelné přístup.)</span><span class="sxs-lookup"><span data-stu-id="78cdf-212">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span> 

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]

<span data-ttu-id="78cdf-213">Tento postup můžete použít, pokud webová stránka uživatelského rozhraní obsahuje všechna pole v entitě a můžete aktualizovat některý z nich.</span><span class="sxs-lookup"><span data-stu-id="78cdf-213">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="78cdf-214">Automaticky generovaný kód používá metodu vytvořit a připojit, ale pouze zachytí `DbUpdateConcurrencyException` výjimky a vrátí 404 kódy chyb.</span><span class="sxs-lookup"><span data-stu-id="78cdf-214">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="78cdf-215">Ukazuje příklad zachytí všechny výjimky aktualizace databáze a zobrazí chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-215">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="78cdf-216">Stav entity</span><span class="sxs-lookup"><span data-stu-id="78cdf-216">Entity States</span></span>

<span data-ttu-id="78cdf-217">Uchovává informace o kontextu databáze, zda jsou synchronizována s jejich odpovídající řádky v databázi entity v paměti, a tyto informace Určuje, co se stane, když zavoláte `SaveChanges` metoda.</span><span class="sxs-lookup"><span data-stu-id="78cdf-217">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="78cdf-218">Například když předat do nové entity `Add` metoda, která je nastavena do stavu entity `Added`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-218">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="78cdf-219">Potom při volání `SaveChanges` metoda, kontext databáze problémy příkazu INSERT jazyka SQL.</span><span class="sxs-lookup"><span data-stu-id="78cdf-219">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="78cdf-220">Entita může být v jednom z následujících stavů:</span><span class="sxs-lookup"><span data-stu-id="78cdf-220">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="78cdf-221">`Added`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-221">`Added`.</span></span> <span data-ttu-id="78cdf-222">Entita ještě neexistuje v databázi.</span><span class="sxs-lookup"><span data-stu-id="78cdf-222">The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="78cdf-223">`SaveChanges` Metoda problémy příkazu INSERT.</span><span class="sxs-lookup"><span data-stu-id="78cdf-223">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="78cdf-224">`Unchanged`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-224">`Unchanged`.</span></span> <span data-ttu-id="78cdf-225">Nic je nutné provést k této entitě pomocí `SaveChanges` metoda.</span><span class="sxs-lookup"><span data-stu-id="78cdf-225">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="78cdf-226">Při čtení entity z databáze, entity začíná se tento stav.</span><span class="sxs-lookup"><span data-stu-id="78cdf-226">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="78cdf-227">`Modified`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-227">`Modified`.</span></span> <span data-ttu-id="78cdf-228">Některé nebo všechny hodnoty vlastností entity byly upraveny.</span><span class="sxs-lookup"><span data-stu-id="78cdf-228">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="78cdf-229">`SaveChanges` Metoda problémy příkazu UPDATE.</span><span class="sxs-lookup"><span data-stu-id="78cdf-229">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="78cdf-230">`Deleted`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-230">`Deleted`.</span></span> <span data-ttu-id="78cdf-231">Entita byla označena pro odstranění.</span><span class="sxs-lookup"><span data-stu-id="78cdf-231">The entity has been marked for deletion.</span></span> <span data-ttu-id="78cdf-232">`SaveChanges` Metoda problémy příkazech DELETE.</span><span class="sxs-lookup"><span data-stu-id="78cdf-232">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="78cdf-233">`Detached`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-233">`Detached`.</span></span> <span data-ttu-id="78cdf-234">Entity není sledována aplikací kontext databáze.</span><span class="sxs-lookup"><span data-stu-id="78cdf-234">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="78cdf-235">V aplikaci pracovní plochy změny stavu se obvykle nastavuje automaticky.</span><span class="sxs-lookup"><span data-stu-id="78cdf-235">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="78cdf-236">Přečtěte si entitou a proveďte změny na některé jeho vlastnosti hodnoty.</span><span class="sxs-lookup"><span data-stu-id="78cdf-236">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="78cdf-237">To způsobí, že stav entity automaticky změnit tak, aby `Modified`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-237">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="78cdf-238">Potom při volání `SaveChanges`, rozhraní Entity Framework vytvoří která aktualizuje jenom skutečné vlastnosti, které jste změnili prohlášení aktualizace SQL.</span><span class="sxs-lookup"><span data-stu-id="78cdf-238">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="78cdf-239">Ve webové aplikaci `DbContext` , který původně čte entity a zobrazí jeho data k provádění úprav je zrušen po vykreslení stránky.</span><span class="sxs-lookup"><span data-stu-id="78cdf-239">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="78cdf-240">Když HttpPost `Edit` akce metoda je volána, Přišla žádost o nový web a máte novou instanci třídy `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-240">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="78cdf-241">Pokud znovu načíst entita v tomto kontextu nové, můžete simulovat plochy zpracování.</span><span class="sxs-lookup"><span data-stu-id="78cdf-241">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="78cdf-242">Ale pokud nechcete provést operace čtení nadbytečné, budete muset použít objekt entity vytvořené vazač modelu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-242">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="78cdf-243">Nejjednodušší způsob, jak to udělat je nastavení stavu entity na změněné, jak se provádí v dříve uvedeném alternativní HttpPost úpravy kódu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-243">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="78cdf-244">Potom při volání `SaveChanges`, rozhraní Entity Framework aktualizuje všechny sloupce řádku databáze, protože kontext nemá žádný způsob, jak zjistit vlastnosti, které jste změnili.</span><span class="sxs-lookup"><span data-stu-id="78cdf-244">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="78cdf-245">Pokud chcete, aby se zabránilo přístup pro čtení první, ale také chcete aktualizovat SQL příkaz k aktualizaci pouze pole, která uživatel ve skutečnosti změnit, je složitější kód.</span><span class="sxs-lookup"><span data-stu-id="78cdf-245">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="78cdf-246">Budete muset uložit původní hodnoty nějakým způsobem (například pomocí skrytá pole) tak, že jsou k dispozici při HttpPost `Edit` metoda je volána.</span><span class="sxs-lookup"><span data-stu-id="78cdf-246">You have to save the original values in some way (such as by using hidden fields) so that they're available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="78cdf-247">Potom můžete vytvořit Student entitu pomocí původní hodnoty, volání `Attach` metoda tento původní verzi entity, aktualizujte hodnoty entity na nové hodnoty a pak zavolají `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-247">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="78cdf-248">Testovací stránka upravit</span><span class="sxs-lookup"><span data-stu-id="78cdf-248">Test the Edit page</span></span>

<span data-ttu-id="78cdf-249">Spuštění aplikace, vyberte **studenty** a potom klikněte na tlačítko **upravit** hypertextový odkaz.</span><span class="sxs-lookup"><span data-stu-id="78cdf-249">Run the app, select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Stránka upravit studenty](crud/_static/student-edit.png)

<span data-ttu-id="78cdf-251">Některé dat a klikněte na tlačítko Změnit **Uložit**.</span><span class="sxs-lookup"><span data-stu-id="78cdf-251">Change some of the data and click **Save**.</span></span> <span data-ttu-id="78cdf-252">**Index** otevře se stránka a zobrazí změněná data.</span><span class="sxs-lookup"><span data-stu-id="78cdf-252">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="78cdf-253">Odstranit stránku aktualizace</span><span class="sxs-lookup"><span data-stu-id="78cdf-253">Update the Delete page</span></span>

<span data-ttu-id="78cdf-254">V *StudentController.cs*, kód šablony pro třídy MetadataExchangeClientMode `Delete` metoda používá `SingleOrDefaultAsync` metoda pro načtení vybrané Student entity, jako jste viděli v podrobnosti a úpravy metody.</span><span class="sxs-lookup"><span data-stu-id="78cdf-254">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="78cdf-255">Ale implementovat vlastní chybová zpráva při volání `SaveChanges` selže, přidáte některé funkce pro tuto metodu a jeho odpovídající zobrazení.</span><span class="sxs-lookup"><span data-stu-id="78cdf-255">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="78cdf-256">Protože jste viděli pro aktualizaci a vytvoření operací, operacemi odstranění vyžadují dvě metody akce.</span><span class="sxs-lookup"><span data-stu-id="78cdf-256">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="78cdf-257">Metoda, která je volána v odpovědi na požadavek GET zobrazí zobrazení, které umožňuje uživateli možnost schválit nebo zrušit operaci odstranění.</span><span class="sxs-lookup"><span data-stu-id="78cdf-257">The method that's called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="78cdf-258">Pokud uživatel schválí jeho, vytvoří se požadavek POST.</span><span class="sxs-lookup"><span data-stu-id="78cdf-258">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="78cdf-259">Pokud k tomu dojde, HttpPost `Delete` metoda je volána, a pak dané metody ve skutečnosti provádí operaci odstranění.</span><span class="sxs-lookup"><span data-stu-id="78cdf-259">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="78cdf-260">Blok try-catch – přidáte do HttpPost `Delete` metodu ke zpracování všechny chyby, které mohou nastat při aktualizaci databáze.</span><span class="sxs-lookup"><span data-stu-id="78cdf-260">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="78cdf-261">Pokud dojde k chybě, volá metodu HttpPost Delete metodu Delete třídy MetadataExchangeClientMode, předání parametru, která určuje, že došlo k chybě.</span><span class="sxs-lookup"><span data-stu-id="78cdf-261">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="78cdf-262">Metodu Delete třídy MetadataExchangeClientMode pak znovu zobrazí potvrzovací stránku spolu s chybovou zprávu, umožní uživateli možnost zrušit nebo akci opakujte.</span><span class="sxs-lookup"><span data-stu-id="78cdf-262">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="78cdf-263">Nahraďte třídy MetadataExchangeClientMode `Delete` metoda akce s následující kód, který spravuje zasílání zpráv o chybách.</span><span class="sxs-lookup"><span data-stu-id="78cdf-263">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]

<span data-ttu-id="78cdf-264">Tento kód je možné zadat volitelný parametr, který označuje, zda byla volána metoda po selhání uložte změny.</span><span class="sxs-lookup"><span data-stu-id="78cdf-264">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="78cdf-265">Tento parametr je false, pokud třídy MetadataExchangeClientMode `Delete` metoda je volána bez předchozí chybě.</span><span class="sxs-lookup"><span data-stu-id="78cdf-265">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="78cdf-266">Když je volána metodou HttpPost `Delete` metoda v odpovědi na chybu aktualizace databáze, tento parametr hodnotu true a chybovou zprávu, je předaná do zobrazení.</span><span class="sxs-lookup"><span data-stu-id="78cdf-266">When it's called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="78cdf-267">Přístup pro čtení první k odstranění HttpPost</span><span class="sxs-lookup"><span data-stu-id="78cdf-267">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="78cdf-268">Nahraďte HttpPost `Delete` metoda akce (s názvem `DeleteConfirmed`) s následujícím kódem, který provede operaci skutečného odstranění a zachytí všechny chyby aktualizace databáze.</span><span class="sxs-lookup"><span data-stu-id="78cdf-268">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]

<span data-ttu-id="78cdf-269">Tento kód načte vybrané entity, pak zavolá `Remove` metodu a nastavit stav entity `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-269">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="78cdf-270">Když `SaveChanges` nazývá SQL odstranit se vygeneruje příkaz.</span><span class="sxs-lookup"><span data-stu-id="78cdf-270">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="78cdf-271">Vytvořit a připojit přístup k odstranění HttpPost</span><span class="sxs-lookup"><span data-stu-id="78cdf-271">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="78cdf-272">Pokud je zvýšení výkonu v aplikaci vysoký počet prioritu, se můžete vyhnout nepotřebných dotazů SQL vytváření instancí Student entitu pomocí pouze primární klíč, hodnotu a pak nastavení stavu entity na `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="78cdf-272">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="78cdf-273">To je všechno, která rozhraní Entity Framework potřebuje, aby odstranit entitu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-273">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="78cdf-274">(Neuvádějte tento kód ve vašem projektu, se zde pouze k objasnění alternativu.)</span><span class="sxs-lookup"><span data-stu-id="78cdf-274">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]

<span data-ttu-id="78cdf-275">Pokud entita má související data, která má být rovněž odstraněn, ujistěte se, že kaskádové odstranění je nakonfigurovaný v databázi.</span><span class="sxs-lookup"><span data-stu-id="78cdf-275">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="78cdf-276">S tímto přístupem k odstranění entity nemusí EF Uvědomte si, že se entit v relaci k odstranění.</span><span class="sxs-lookup"><span data-stu-id="78cdf-276">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="78cdf-277">Aktualizace zobrazení odstranění</span><span class="sxs-lookup"><span data-stu-id="78cdf-277">Update the Delete view</span></span>

<span data-ttu-id="78cdf-278">V *Views/Student/Delete.cshtml*, přidejte chybovou zprávu mezi záhlaví h2 a h3 záhlaví, jak je znázorněno v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="78cdf-278">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="78cdf-279">Spuštění aplikace, vyberte **studenty** a klikněte **odstranit** hypertextový odkaz:</span><span class="sxs-lookup"><span data-stu-id="78cdf-279">Run the app, select the **Students** tab, and click a **Delete** hyperlink:</span></span>

![Odstranit potvrzovací stránku](crud/_static/student-delete.png)

<span data-ttu-id="78cdf-281">Klikněte na tlačítko **odstranit**.</span><span class="sxs-lookup"><span data-stu-id="78cdf-281">Click **Delete**.</span></span> <span data-ttu-id="78cdf-282">Bez odstraněné student se zobrazí stránka indexu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-282">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="78cdf-283">(Uvidíte příklad kód v akci v tomto kurzu souběžnosti pro zpracování chyb.)</span><span class="sxs-lookup"><span data-stu-id="78cdf-283">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="closing-database-connections"></a><span data-ttu-id="78cdf-284">Ukončením připojení databáze</span><span class="sxs-lookup"><span data-stu-id="78cdf-284">Closing database connections</span></span>

<span data-ttu-id="78cdf-285">Tím se uvolní prostředky, které obsahuje připojení k databázi, instance kontextu je nutné odstranit co nejdříve po dokončení s ním.</span><span class="sxs-lookup"><span data-stu-id="78cdf-285">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="78cdf-286">Předdefinované ASP.NET Core [vkládání závislostí](../../fundamentals/dependency-injection.md) postará tuto úlohu pro vás.</span><span class="sxs-lookup"><span data-stu-id="78cdf-286">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="78cdf-287">V *Startup.cs*, zavoláte [metoda rozšíření AddDbContext](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) zřídit `DbContext` třídy v kontejneru ASP.NET DI.</span><span class="sxs-lookup"><span data-stu-id="78cdf-287">In *Startup.cs*, you call the [AddDbContext extension method](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET DI container.</span></span> <span data-ttu-id="78cdf-288">Že metoda nastaví životnost služby `Scoped` ve výchozím nastavení.</span><span class="sxs-lookup"><span data-stu-id="78cdf-288">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="78cdf-289">`Scoped`Doba života objektu kontextu se shoduje s webovou žádost životnosti znamená a `Dispose` automaticky volání metody na konci webový požadavek.</span><span class="sxs-lookup"><span data-stu-id="78cdf-289">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handling-transactions"></a><span data-ttu-id="78cdf-290">Zpracování transakcí</span><span class="sxs-lookup"><span data-stu-id="78cdf-290">Handling Transactions</span></span>

<span data-ttu-id="78cdf-291">Ve výchozím nastavení implementuje rozhraní Entity Framework implicitně transakce.</span><span class="sxs-lookup"><span data-stu-id="78cdf-291">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="78cdf-292">Ve scénářích, kde více řádků nebo tabulky provést změny a pak zavolají `SaveChanges`, rozhraní Entity Framework automaticky zajišťuje, že všechny změny úspěšné nebo se budou všechny nezdaří.</span><span class="sxs-lookup"><span data-stu-id="78cdf-292">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="78cdf-293">Pokud jsou nejprve provést některé změny a pak se stane chyba, tyto změny jsou automaticky vrácena zpět.</span><span class="sxs-lookup"><span data-stu-id="78cdf-293">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="78cdf-294">Scénáře, kde můžete potřebovat více řídit – například pokud chcete takové operace, provést v transakci – mimo Entity Framework najdete v tématu [transakce](https://docs.microsoft.com/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="78cdf-294">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](https://docs.microsoft.com/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="78cdf-295">Ne sledování dotazy</span><span class="sxs-lookup"><span data-stu-id="78cdf-295">No-tracking queries</span></span>

<span data-ttu-id="78cdf-296">Když kontext databáze načítá řádky tabulky, vytvoří objekty entity, které představují je ve výchozím nastavení se uchovává informace o jestli entity v paměti jsou synchronizované s co je v databázi.</span><span class="sxs-lookup"><span data-stu-id="78cdf-296">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="78cdf-297">Data v paměti funguje jako mezipaměť a používá se při aktualizaci entity.</span><span class="sxs-lookup"><span data-stu-id="78cdf-297">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="78cdf-298">Toto použití mezipaměti se často nepotřebné ve webové aplikaci protože kontextu instance jsou obvykle krátkodobou (nový jeden se vytvoří a uvolnění pro každý požadavek) a objektem context, který čte entitu je obvykle zveřejněn. před použitím dané entity znovu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-298">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="78cdf-299">Zakážete sledování objekty entity v paměti voláním `AsNoTracking` metoda.</span><span class="sxs-lookup"><span data-stu-id="78cdf-299">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="78cdf-300">Typické scénáře, ve kterých můžete chtít udělat, patří:</span><span class="sxs-lookup"><span data-stu-id="78cdf-300">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="78cdf-301">Během životního cyklu kontextu není nutné aktualizovat všechny entity a nepotřebujete EF k [automaticky načíst navigační vlastnosti s entity načíst samostatné dotazy](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="78cdf-301">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="78cdf-302">Často splnění těchto podmínek v metody akce třídy MetadataExchangeClientMode kontroleru.</span><span class="sxs-lookup"><span data-stu-id="78cdf-302">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="78cdf-303">Spustíte dotaz, který načte velký objem dat a bude aktualizován pouze malou část vrácená data.</span><span class="sxs-lookup"><span data-stu-id="78cdf-303">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="78cdf-304">To může být efektivnější vypnout sledování pro velké dotaz a spusťte dotaz později na několik entit, které je nutné aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="78cdf-304">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="78cdf-305">Chcete připojit entity aktualizujte ji, ale starší načíst stejné entity pro jiný účel.</span><span class="sxs-lookup"><span data-stu-id="78cdf-305">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="78cdf-306">Vzhledem k tomu, že entita je již sledován kontext databáze, nemůžete připojit entity, který chcete změnit.</span><span class="sxs-lookup"><span data-stu-id="78cdf-306">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="78cdf-307">Jedním ze způsobů ke zpracování této situace je volání `AsNoTracking` na dřívější dotazu.</span><span class="sxs-lookup"><span data-stu-id="78cdf-307">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="78cdf-308">Další informace najdete v tématu [sledování vs. Ne sledování](https://docs.microsoft.com/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="78cdf-308">For more information, see [Tracking vs. No-Tracking](https://docs.microsoft.com/ef/core/querying/tracking).</span></span>

## <a name="summary"></a><span data-ttu-id="78cdf-309">Souhrn</span><span class="sxs-lookup"><span data-stu-id="78cdf-309">Summary</span></span>

<span data-ttu-id="78cdf-310">Nyní máte úplnou sadu stránek, které provádějí jednoduché operace CRUD pro studenty entity.</span><span class="sxs-lookup"><span data-stu-id="78cdf-310">You now have a complete set of pages that perform simple CRUD operations for Student entities.</span></span> <span data-ttu-id="78cdf-311">V dalším kurzu budete rozbalte funkce **Index** tak, že přidáte řazení, filtrování a stránkování.</span><span class="sxs-lookup"><span data-stu-id="78cdf-311">In the next tutorial you'll expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="78cdf-312">[Předchozí](intro.md)
[další](sort-filter-page.md)</span><span class="sxs-lookup"><span data-stu-id="78cdf-312">[Previous](intro.md)
[Next](sort-filter-page.md)</span></span>  
