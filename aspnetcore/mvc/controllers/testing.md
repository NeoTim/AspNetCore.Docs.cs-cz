---
title: Testovací kontroler logiku v ASP.NET Core
author: ardalis
description: Zjistěte, jak otestovat logice kontroleru v ASP.NET Core s Moq a xUnit.
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 08/18/2018
ms.locfileid: "41756745"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="dc45b-103">Testovací kontroler logiku v ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="dc45b-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="dc45b-104">Podle [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="dc45b-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="dc45b-105">Kontrolery jsou klíčovou součást všech aplikací ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="dc45b-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="dc45b-106">V důsledku toho byste měli mít jistotu, které se chovají se tak, jak má pro vaši aplikaci.</span><span class="sxs-lookup"><span data-stu-id="dc45b-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="dc45b-107">Automatizované testy vám můžou poskytnout tento spolehlivosti a dokáže detekovat chyby dřív, než dorazí produkčního prostředí.</span><span class="sxs-lookup"><span data-stu-id="dc45b-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="dc45b-108">Je důležité předejde zbytečné povinnosti v rámci vašich řadičů a zajistit vaše testy se zaměřují jen na kontroleru odpovědnosti.</span><span class="sxs-lookup"><span data-stu-id="dc45b-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="dc45b-109">Logice kontroleru by měl být minimální nelze zaměřit se na obchodní logiku nebo infrastrukturu otázky (například přístup k datům).</span><span class="sxs-lookup"><span data-stu-id="dc45b-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="dc45b-110">Testovací kontroler logiku, není rozhraní.</span><span class="sxs-lookup"><span data-stu-id="dc45b-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="dc45b-111">Test jak kontroler *chová* založené na vstupech platný nebo neplatný.</span><span class="sxs-lookup"><span data-stu-id="dc45b-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="dc45b-112">Testovací kontroler odpovědi na základě výsledku obchodní operace, které provádí.</span><span class="sxs-lookup"><span data-stu-id="dc45b-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="dc45b-113">Odpovědnosti typické kontroleru:</span><span class="sxs-lookup"><span data-stu-id="dc45b-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="dc45b-114">Ověřte `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="dc45b-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="dc45b-115">Vrátí reakce na chybu, pokud `ModelState` je neplatný.</span><span class="sxs-lookup"><span data-stu-id="dc45b-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="dc45b-116">Obchodní entity načtete z trvalého úložiště.</span><span class="sxs-lookup"><span data-stu-id="dc45b-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="dc45b-117">Provedení akce na obchodní entitě.</span><span class="sxs-lookup"><span data-stu-id="dc45b-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="dc45b-118">Uložte do trvalého obchodní entitě.</span><span class="sxs-lookup"><span data-stu-id="dc45b-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="dc45b-119">Vrátí odpovídající `IActionResult`.</span><span class="sxs-lookup"><span data-stu-id="dc45b-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="dc45b-120">[Zobrazení nebo stažení ukázkového kódu](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([stažení](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="dc45b-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="dc45b-121">Testy jednotek logice kontroleru</span><span class="sxs-lookup"><span data-stu-id="dc45b-121">Unit tests of controller logic</span></span>

<span data-ttu-id="dc45b-122">[Testy jednotek](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) zahrnovat testování částí aplikace v izolaci od jeho infrastrukturu a závislosti.</span><span class="sxs-lookup"><span data-stu-id="dc45b-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="dc45b-123">Při testování logice kontroleru, jenom obsah jedné akce testování částí, není chování z jejich závislých nebo samotného rozhraní.</span><span class="sxs-lookup"><span data-stu-id="dc45b-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="dc45b-124">Jako jednotku můžete testovat vaše akce kontroleru, ujistěte se, že se že zaměříte jenom na jeho chování.</span><span class="sxs-lookup"><span data-stu-id="dc45b-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="dc45b-125">Řadič testu jednotek se vyhnete věci, jako je [filtry](xref:mvc/controllers/filters), [směrování](xref:fundamentals/routing), nebo [vazby modelu](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="dc45b-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="dc45b-126">Díky zaměření na testování pouze jednou z věcí, testování jednotek je obecně k zápisu snadné a rychlé spuštění.</span><span class="sxs-lookup"><span data-stu-id="dc45b-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="dc45b-127">Kvalitně napsané sady testů jednotek můžete často spustit bez spojená tak velká režie.</span><span class="sxs-lookup"><span data-stu-id="dc45b-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="dc45b-128">Však není částí detekovat problémy v interakci mezi součástmi, což je účelem [integrační testy](xref:test/integration-tests).</span><span class="sxs-lookup"><span data-stu-id="dc45b-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="dc45b-129">Pokud píšete vlastní filtry a tras, měli byste jednotky testování v izolaci, nikoli jako součást testy na určitý kontroler akce.</span><span class="sxs-lookup"><span data-stu-id="dc45b-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="dc45b-130">[Vytváření a spouštění testování částí pomocí sady Visual Studio](/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="dc45b-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="dc45b-131">Abychom si předvedli testování částí, projděte si následující kontroler.</span><span class="sxs-lookup"><span data-stu-id="dc45b-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="dc45b-132">Zobrazí seznam debaty relací a umožňuje nové debaty relace má být vytvořen s příspěvek:</span><span class="sxs-lookup"><span data-stu-id="dc45b-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="dc45b-133">Následující kontroler [explicitní závislosti Princip](http://deviq.com/explicit-dependencies-principle/), očekává se vkládání závislostí poskytnout instance `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="dc45b-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="dc45b-134">Díky tomu je poměrně snadné testovat pomocí mock objektu rozhraní, jako je třeba [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="dc45b-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="dc45b-135">`HTTP GET Index` Metoda nemá žádný nebo větvení a smyček pouze volání metod.</span><span class="sxs-lookup"><span data-stu-id="dc45b-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="dc45b-136">Abyste to mohli otestovat `Index` metoda, potřebujeme si ověřit, která `ViewResult` se vrátí, s `ViewModel` z úložiště `List` – metoda.</span><span class="sxs-lookup"><span data-stu-id="dc45b-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="dc45b-137">`HomeController` `HTTP POST Index` – Metoda (popsaný výš) by měl ověřit:</span><span class="sxs-lookup"><span data-stu-id="dc45b-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="dc45b-138">Metoda akce vrací chybnou žádost `ViewResult` s příslušnými daty při `ModelState.IsValid` je `false`.</span><span class="sxs-lookup"><span data-stu-id="dc45b-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="dc45b-139">`Add` Volání metody v daném úložišti a `RedirectToActionResult` je vrácen s správné argumenty při `ModelState.IsValid` má hodnotu true.</span><span class="sxs-lookup"><span data-stu-id="dc45b-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="dc45b-140">Neplatný stav modelu můžete otestovat přidáním chyb s použitím `AddModelError` jak je znázorněno v následujícím prvního testu.</span><span class="sxs-lookup"><span data-stu-id="dc45b-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="dc45b-141">První test potvrdí při `ModelState` není platný, stejné `ViewResult` se vrátí jako `GET` požadavku.</span><span class="sxs-lookup"><span data-stu-id="dc45b-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="dc45b-142">Všimněte si, že test nebude se pokoušet a zajistěte tak předání modelu je neplatný.</span><span class="sxs-lookup"><span data-stu-id="dc45b-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="dc45b-143">Který nebude fungovat i přesto protože neběží vazby modelu (i když [test integrace](xref:test/integration-tests) byste použili vazby cvičení modelu).</span><span class="sxs-lookup"><span data-stu-id="dc45b-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="dc45b-144">V takovém případě není právě testováno vazby modelu.</span><span class="sxs-lookup"><span data-stu-id="dc45b-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="dc45b-145">Tyto testy jednotek jenom testujete, čemu kód v metodě akce.</span><span class="sxs-lookup"><span data-stu-id="dc45b-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="dc45b-146">Druhý test ověří, že `ModelState` platná, nový `BrainstormSession` přidá (prostřednictvím úložiště), a vrátí metodu `RedirectToActionResult` s očekávané vlastnosti.</span><span class="sxs-lookup"><span data-stu-id="dc45b-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="dc45b-147">Imitaci volání, které nejsou volány jsou obvykle ignoruje, ale volání `Verifiable` na konci instalace volání díky tomu se dá ověřit v testu.</span><span class="sxs-lookup"><span data-stu-id="dc45b-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="dc45b-148">To provedete pomocí volání `mockRepo.Verify`, který se test nezdaří, pokud nebyla volána metoda očekávané.</span><span class="sxs-lookup"><span data-stu-id="dc45b-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="dc45b-149">Knihovna Moq používané v tomto příkladu usnadňuje kombinovat mocks ověřitelný nebo "přísné", s neověřitelného mocks (také nazývané "dojde ke ztrátě" mocks nebo zástupné procedury).</span><span class="sxs-lookup"><span data-stu-id="dc45b-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="dc45b-150">Další informace o [přizpůsobení chování model s využitím Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="dc45b-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="dc45b-151">Jiné řadiče v aplikaci zobrazí informace týkající se konkrétní debaty.</span><span class="sxs-lookup"><span data-stu-id="dc45b-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="dc45b-152">Obsahuje nějaké logiky se neplatné id hodnoty:</span><span class="sxs-lookup"><span data-stu-id="dc45b-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="dc45b-153">Akce kontroleru má tři případy otestovat, jeden pro každou `return` – příkaz:</span><span class="sxs-lookup"><span data-stu-id="dc45b-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="dc45b-154">Aplikace zpřístupňuje funkce jako webové rozhraní API (seznam nápadů přidružené k relaci debaty a metoda pro přidání nové nápady týkající se k relaci):</span><span class="sxs-lookup"><span data-stu-id="dc45b-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="dc45b-155">`ForSession` Metoda vrátí seznam hodnot `IdeaDTO` typy.</span><span class="sxs-lookup"><span data-stu-id="dc45b-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="dc45b-156">Vyhněte se vracení vaše obchodní entity domény přímo prostřednictvím volání rozhraní API, protože často zahrnují více dat, než klient rozhraní API vyžaduje, a se zbytečně spárovat model interní domény vaší aplikace pomocí rozhraní API můžete zveřejnit externě.</span><span class="sxs-lookup"><span data-stu-id="dc45b-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="dc45b-157">Mapování mezi domény subjekty a typy, budete přesměrováni zpět při přenosu můžete provést ručně (pomocí LINQ `Select` jak je znázorněno zde) nebo pomocí knihovny jako [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="dc45b-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="dc45b-158">Pro testování částí `Create` a `ForSession` metody rozhraní API:</span><span class="sxs-lookup"><span data-stu-id="dc45b-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="dc45b-159">Jak bylo uvedeno dříve, k otestování chování metody při `ModelState` je neplatný, přidejte chybu modelu do řadiče testu v rámci.</span><span class="sxs-lookup"><span data-stu-id="dc45b-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="dc45b-160">Nepokoušejte testovací ověření nebo model vazby modelu v testech jednotky – testování chování metody akce, když čelí konkrétní `ModelState` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="dc45b-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="dc45b-161">Druhý test závisí na úložiště, který vrací hodnotu null, takže mock úložiště je nakonfigurovaný k vrácení hodnoty null.</span><span class="sxs-lookup"><span data-stu-id="dc45b-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="dc45b-162">Není nutné vytvořit testovací databáze (v paměti nebo jinak) a vytvořit dotaz, který vrátí tento výsledek - ji pak lze provést v jediném příkazu, jak je znázorněno.</span><span class="sxs-lookup"><span data-stu-id="dc45b-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="dc45b-163">Poslední test ověří, zda úložiště `Update` metoda je volána.</span><span class="sxs-lookup"><span data-stu-id="dc45b-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="dc45b-164">Jako jsme to udělali dříve, model se nazývá s `Verifiable` a potom imitaci v úložišti `Verify` metoda je volána k potvrzení ověřitelné metody se spustil.</span><span class="sxs-lookup"><span data-stu-id="dc45b-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="dc45b-165">Není jednotka testu odpovědnost zajistit, aby `Update` metoda uložit data; to jde udělat pomocí o test integrace.</span><span class="sxs-lookup"><span data-stu-id="dc45b-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="dc45b-166">Další zdroje</span><span class="sxs-lookup"><span data-stu-id="dc45b-166">Additional resources</span></span>

* <xref:test/integration-tests>
