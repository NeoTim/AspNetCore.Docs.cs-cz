---
title: Správa verzí služeb gRPC
author: jamesnk
description: Přečtěte si, jak verzi gRPC služby.
monikerRange: '>= aspnetcore-3.0'
ms.author: jamesnk
ms.date: 01/09/2020
uid: grpc/versioning
ms.openlocfilehash: 9bd76009ba28a1abef25a98686afea6753d4a8f4
ms.sourcegitcommit: f7886fd2e219db9d7ce27b16c0dc5901e658d64e
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 04/06/2020
ms.locfileid: "78664113"
---
# <a name="versioning-grpc-services"></a><span data-ttu-id="4d653-103">Správa verzí služeb gRPC</span><span class="sxs-lookup"><span data-stu-id="4d653-103">Versioning gRPC services</span></span>

<span data-ttu-id="4d653-104">Podle [James Newton-King](https://twitter.com/jamesnk)</span><span class="sxs-lookup"><span data-stu-id="4d653-104">By [James Newton-King](https://twitter.com/jamesnk)</span></span>

<span data-ttu-id="4d653-105">Nové funkce přidané do aplikace mohou vyžadovat, aby se služby gRPC poskytované klientům měnilo, někdy neočekávanými a neočekávanými způsoby.</span><span class="sxs-lookup"><span data-stu-id="4d653-105">New features added to an app can require gRPC services provided to clients to change, sometimes in unexpected and breaking ways.</span></span> <span data-ttu-id="4d653-106">Když se změní služby gRPC:</span><span class="sxs-lookup"><span data-stu-id="4d653-106">When gRPC services change:</span></span>

* <span data-ttu-id="4d653-107">Je třeba zvážit, jaký dopad mají změny na klienty.</span><span class="sxs-lookup"><span data-stu-id="4d653-107">Consideration should be given on how changes impact clients.</span></span>
* <span data-ttu-id="4d653-108">Měla by být implementována strategie správy verzí pro podporu změn.</span><span class="sxs-lookup"><span data-stu-id="4d653-108">A versioning strategy to support changes should be implemented.</span></span>

## <a name="backwards-compatibility"></a><span data-ttu-id="4d653-109">Zpětná kompatibilita</span><span class="sxs-lookup"><span data-stu-id="4d653-109">Backwards compatibility</span></span>

<span data-ttu-id="4d653-110">Protokol gRPC je určen pro podporu služeb, které se v průběhu času mění.</span><span class="sxs-lookup"><span data-stu-id="4d653-110">The gRPC protocol is designed to support services that change over time.</span></span> <span data-ttu-id="4d653-111">Obecně platí, že dodatky ke službám a metodám gRPC jsou nenarušující.</span><span class="sxs-lookup"><span data-stu-id="4d653-111">Generally, additions to gRPC services and methods are non-breaking.</span></span> <span data-ttu-id="4d653-112">Nenarušující změny umožňují stávajícím klientům pokračovat v práci beze změn.</span><span class="sxs-lookup"><span data-stu-id="4d653-112">Non-breaking changes allow existing clients to continue working without changes.</span></span> <span data-ttu-id="4d653-113">Změna nebo odstranění služeb gRPC narušují změny.</span><span class="sxs-lookup"><span data-stu-id="4d653-113">Changing or deleting gRPC services are breaking changes.</span></span> <span data-ttu-id="4d653-114">Pokud mají služby gRPC narušující změny, klienti používající tuto službu musí být aktualizováni a znovu nasazeni.</span><span class="sxs-lookup"><span data-stu-id="4d653-114">When gRPC services have breaking changes, clients using that service have to be updated and redeployed.</span></span>

<span data-ttu-id="4d653-115">Provádění nenarušujících změn ve službě má řadu výhod:</span><span class="sxs-lookup"><span data-stu-id="4d653-115">Making non-breaking changes to a service has a number of benefits:</span></span>

* <span data-ttu-id="4d653-116">Stávající klienti nadále běží.</span><span class="sxs-lookup"><span data-stu-id="4d653-116">Existing clients continue to run.</span></span>
* <span data-ttu-id="4d653-117">Vyhne se práci spojené s upozorňováním klientů na narušující změny a jejich aktualizací.</span><span class="sxs-lookup"><span data-stu-id="4d653-117">Avoids work involved with notifying clients of breaking changes, and updating them.</span></span>
* <span data-ttu-id="4d653-118">Je třeba dokumentovat a udržovat pouze jednu verzi služby.</span><span class="sxs-lookup"><span data-stu-id="4d653-118">Only one version of the service needs to be documented and maintained.</span></span>

### <a name="non-breaking-changes"></a><span data-ttu-id="4d653-119">Nenarušující změny</span><span class="sxs-lookup"><span data-stu-id="4d653-119">Non-breaking changes</span></span>

<span data-ttu-id="4d653-120">Tyto změny jsou nenarušující na úrovni protokolu gRPC a na binární úrovni .NET.</span><span class="sxs-lookup"><span data-stu-id="4d653-120">These changes are non-breaking at a gRPC protocol level and .NET binary level.</span></span>

* <span data-ttu-id="4d653-121">**Přidání nové služby**</span><span class="sxs-lookup"><span data-stu-id="4d653-121">**Adding a new service**</span></span>
* <span data-ttu-id="4d653-122">**Přidání nové metody do služby**</span><span class="sxs-lookup"><span data-stu-id="4d653-122">**Adding a new method to a service**</span></span>
* <span data-ttu-id="4d653-123">**Přidání pole do zprávy požadavku** - Pole přidaná ke zprávě požadavku jsou v případě, že nejsou nastavena, rekonstruována s výchozí [hodnotou](https://developers.google.com/protocol-buffers/docs/proto3#default) na serveru.</span><span class="sxs-lookup"><span data-stu-id="4d653-123">**Adding a field to a request message** - Fields added to a request message are deserialized with the [default value](https://developers.google.com/protocol-buffers/docs/proto3#default) on the server when not set.</span></span> <span data-ttu-id="4d653-124">Chcete-li být nerozdělitelné změny, musí služba uspět, pokud nové pole není nastaveno staršími klienty.</span><span class="sxs-lookup"><span data-stu-id="4d653-124">To be a non-breaking change, the service must succeed when the new field isn't set by older clients.</span></span>
* <span data-ttu-id="4d653-125">**Přidání pole do zprávy odpovědi** - Pole přidaná ke zprávě odpovědi jsou dekonstruována do kolekce [neznámých polí](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) zprávy v klientovi.</span><span class="sxs-lookup"><span data-stu-id="4d653-125">**Adding a field to a response message** - Fields added to a response message are deserialized into the message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) collection on the client.</span></span>
* <span data-ttu-id="4d653-126">**Přidání hodnoty do výčtu** - výčty jsou serializovány jako číselná hodnota.</span><span class="sxs-lookup"><span data-stu-id="4d653-126">**Adding a value to an enum** - Enums are serialized as a numeric value.</span></span> <span data-ttu-id="4d653-127">Nové hodnoty výčtu jsou deserializovány na straně klienta na hodnotu výčtu bez názvu výčtu.</span><span class="sxs-lookup"><span data-stu-id="4d653-127">New enum values are deserialized on the client to the enum value without an enum name.</span></span> <span data-ttu-id="4d653-128">Chcete-li být nenarušující změny, starší klienti musí pracovat správně při příjmu nové hodnoty výčtu.</span><span class="sxs-lookup"><span data-stu-id="4d653-128">To be a non-breaking change, older clients must run correctly when receiving the new enum value.</span></span>

### <a name="binary-breaking-changes"></a><span data-ttu-id="4d653-129">Binární změny rozdělení</span><span class="sxs-lookup"><span data-stu-id="4d653-129">Binary breaking changes</span></span>

<span data-ttu-id="4d653-130">Následující změny jsou nerozdělitelné na úrovni protokolu gRPC, ale klient musí být aktualizován, pokud upgraduje na nejnovější *.proto* smlouvy nebo sestavení klienta .NET.</span><span class="sxs-lookup"><span data-stu-id="4d653-130">The following changes are non-breaking at a gRPC protocol level, but the client needs to be updated if it upgrades to the latest *.proto* contract or client .NET assembly.</span></span> <span data-ttu-id="4d653-131">Binární kompatibilita je důležité, pokud máte v plánu publikovat knihovnu gRPC nuget.</span><span class="sxs-lookup"><span data-stu-id="4d653-131">Binary compatibility is important if you plan to publish a gRPC library to NuGet.</span></span>

* <span data-ttu-id="4d653-132">**Odebrání pole** - Hodnoty z odebrané pole jsou rekonstruovány do [neznámých polí](https://developers.google.com/protocol-buffers/docs/proto3#unknowns)zprávy .</span><span class="sxs-lookup"><span data-stu-id="4d653-132">**Removing a field** - Values from a removed field are deserialized to a message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns).</span></span> <span data-ttu-id="4d653-133">Toto není změna porušení protokolu gRPC, ale klient musí být aktualizován, pokud upgraduje na nejnovější smlouvu.</span><span class="sxs-lookup"><span data-stu-id="4d653-133">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span> <span data-ttu-id="4d653-134">Je důležité, aby odstraněné číslo pole nebylo v budoucnu omylem znovu použito.</span><span class="sxs-lookup"><span data-stu-id="4d653-134">It's important that a removed field number isn't accidentally reused in the future.</span></span> <span data-ttu-id="4d653-135">Chcete-li zajistit, aby k tomu nedošlo, zadejte odstraněná čísla polí a názvy ve zprávě pomocí [vyhrazeného](https://developers.google.com/protocol-buffers/docs/proto3#reserved) klíčového slova Protobuf.</span><span class="sxs-lookup"><span data-stu-id="4d653-135">To ensure this doesn't happen, specify deleted field numbers and names on the message using Protobuf's [reserved](https://developers.google.com/protocol-buffers/docs/proto3#reserved) keyword.</span></span>
* <span data-ttu-id="4d653-136">**Přejmenování zprávy** – názvy zpráv se obvykle neposílají v síti, takže se nejedná o změnu protokolu gRPC.</span><span class="sxs-lookup"><span data-stu-id="4d653-136">**Renaming a message** - Message names aren't typically sent on the network, so this isn't a gRPC protocol breaking change.</span></span> <span data-ttu-id="4d653-137">Klient bude muset být aktualizován, pokud upgraduje na nejnovější smlouvu.</span><span class="sxs-lookup"><span data-stu-id="4d653-137">The client will need to be updated if it upgrades to the latest contract.</span></span> <span data-ttu-id="4d653-138">Jedna situace, kdy **jsou** v síti odesílány názvy zpráv, je s [libovolnými](https://developers.google.com/protocol-buffers/docs/proto3#any) poli, pokud je název zprávy použit k identifikaci typu zprávy.</span><span class="sxs-lookup"><span data-stu-id="4d653-138">One situation where message names **are** sent on the network is with [Any](https://developers.google.com/protocol-buffers/docs/proto3#any) fields, when the message name is used to identify the message type.</span></span>
* <span data-ttu-id="4d653-139">**Změna csharp_namespace** `csharp_namespace` – Změna změní obor názvů generovaných typů .NET.</span><span class="sxs-lookup"><span data-stu-id="4d653-139">**Changing csharp_namespace** - Changing `csharp_namespace` will change the namespace of generated .NET types.</span></span> <span data-ttu-id="4d653-140">Toto není změna porušení protokolu gRPC, ale klient musí být aktualizován, pokud upgraduje na nejnovější smlouvu.</span><span class="sxs-lookup"><span data-stu-id="4d653-140">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span>

### <a name="protocol-breaking-changes"></a><span data-ttu-id="4d653-141">Změny porušující protokol</span><span class="sxs-lookup"><span data-stu-id="4d653-141">Protocol breaking changes</span></span>

<span data-ttu-id="4d653-142">Následující položky jsou změny protokolu a binární horečné změny:</span><span class="sxs-lookup"><span data-stu-id="4d653-142">The following items are protocol and binary breaking changes:</span></span>

* <span data-ttu-id="4d653-143">**Přejmenování pole** - S obsahem Protobuf se názvy polí používají pouze v generovaném kódu.</span><span class="sxs-lookup"><span data-stu-id="4d653-143">**Renaming a field** - With Protobuf content, the field names are only used in generated code.</span></span> <span data-ttu-id="4d653-144">Číslo pole slouží k identifikaci polí v síti.</span><span class="sxs-lookup"><span data-stu-id="4d653-144">The field number is used to identify fields on the network.</span></span> <span data-ttu-id="4d653-145">Přejmenování pole není pro Protobufa změnou porušení protokolu.</span><span class="sxs-lookup"><span data-stu-id="4d653-145">Renaming a field isn't a protocol breaking change for Protobuf.</span></span> <span data-ttu-id="4d653-146">Pokud však server používá obsah JSON, je přejmenování pole narušující změnou.</span><span class="sxs-lookup"><span data-stu-id="4d653-146">However, if a server is using JSON content then renaming a field is a breaking change.</span></span>
* <span data-ttu-id="4d653-147">**Změna datového typu pole** - Změna datového typu pole na [nekompatibilní typ](https://developers.google.com/protocol-buffers/docs/proto3#updating) způsobí chyby při rekonstrukci zprávy.</span><span class="sxs-lookup"><span data-stu-id="4d653-147">**Changing a field data type** - Changing a field's data type to an [incompatible type](https://developers.google.com/protocol-buffers/docs/proto3#updating) will cause errors when deserializing the message.</span></span> <span data-ttu-id="4d653-148">I v případě, že nový datový typ je kompatibilní, je pravděpodobné, že klient musí být aktualizovány na podporu nového typu, pokud upgraduje na nejnovější smlouvy.</span><span class="sxs-lookup"><span data-stu-id="4d653-148">Even if the new data type is compatible, it's likely the client needs to be updated to support the new type if it upgrades to the latest contract.</span></span>
* <span data-ttu-id="4d653-149">**Změna čísla pole** – U datových částí Protobuf se číslo pole používá k identifikaci polí v síti.</span><span class="sxs-lookup"><span data-stu-id="4d653-149">**Changing a field number** - With Protobuf payloads, the field number is used to identify fields on the network.</span></span>
* <span data-ttu-id="4d653-150">**Přejmenování balíčku, služby nebo metody** - gRPC používá název balíčku, název služby a název metody k vytvoření adresy URL.</span><span class="sxs-lookup"><span data-stu-id="4d653-150">**Renaming a package, service or method** - gRPC uses the package name, service name, and method name to build the URL.</span></span> <span data-ttu-id="4d653-151">Klient získá *stav UNIMPLEMENTED* ze serveru.</span><span class="sxs-lookup"><span data-stu-id="4d653-151">The client gets an *UNIMPLEMENTED* status from the server.</span></span>
* <span data-ttu-id="4d653-152">**Odebrání služby nebo metody** - Klient získá *stav UNIMPLEMENTED* ze serveru při volání odebrané metody.</span><span class="sxs-lookup"><span data-stu-id="4d653-152">**Removing a service or method** - The client gets an *UNIMPLEMENTED* status from the server when calling the removed method.</span></span>

### <a name="behavior-breaking-changes"></a><span data-ttu-id="4d653-153">Změny narušující chování</span><span class="sxs-lookup"><span data-stu-id="4d653-153">Behavior breaking changes</span></span>

<span data-ttu-id="4d653-154">Při provádění nenarušujících změn je také nutné zvážit, zda starší klienti mohou pokračovat v práci s novým chováním služby.</span><span class="sxs-lookup"><span data-stu-id="4d653-154">When making non-breaking changes, you must also consider whether older clients can continue working with the new service behavior.</span></span> <span data-ttu-id="4d653-155">Například přidání nového pole do zprávy požadavku:</span><span class="sxs-lookup"><span data-stu-id="4d653-155">For example, adding a new field to a request message:</span></span>

* <span data-ttu-id="4d653-156">Není změna protokolu, která porušuje protokol.</span><span class="sxs-lookup"><span data-stu-id="4d653-156">Isn't a protocol breaking change.</span></span>
* <span data-ttu-id="4d653-157">Vrácení chybového stavu na serveru, pokud není nastaveno nové pole, způsobí, že je pro staré klienty narušující změnu.</span><span class="sxs-lookup"><span data-stu-id="4d653-157">Returning an error status on the server if the new field isn't set makes it a breaking change for old clients.</span></span>

<span data-ttu-id="4d653-158">Kompatibilita chování je určena kódem specifickým pro aplikaci.</span><span class="sxs-lookup"><span data-stu-id="4d653-158">Behavior compatibility is determined by your app-specific code.</span></span>

## <a name="version-number-services"></a><span data-ttu-id="4d653-159">Služby s číslem verze</span><span class="sxs-lookup"><span data-stu-id="4d653-159">Version number services</span></span>

<span data-ttu-id="4d653-160">Služby by měly usilovat o to, aby zůstaly zpětně kompatibilní se starými klienty.</span><span class="sxs-lookup"><span data-stu-id="4d653-160">Services should strive to remain backwards compatible with old clients.</span></span> <span data-ttu-id="4d653-161">Změny aplikace mohou nakonec vyžadovat změny.</span><span class="sxs-lookup"><span data-stu-id="4d653-161">Eventually changes to your app may require breaking changes.</span></span> <span data-ttu-id="4d653-162">Rozbití starých klientů a jejich vynucení k aktualizaci spolu s vaší službou není dobrým uživatelským prostředím.</span><span class="sxs-lookup"><span data-stu-id="4d653-162">Breaking old clients and forcing them to be updated along with your service isn't a good user experience.</span></span> <span data-ttu-id="4d653-163">Způsob, jak zachovat zpětnou kompatibilitu při provádění narušujících změn, je publikovat více verzí služby.</span><span class="sxs-lookup"><span data-stu-id="4d653-163">A way to maintain backwards compatibility while making breaking changes is to publish multiple versions of a service.</span></span>

<span data-ttu-id="4d653-164">gRPC podporuje volitelný specifikátor [balíčku,](https://developers.google.com/protocol-buffers/docs/proto3#packages) který funguje podobně jako obor názvů .NET.</span><span class="sxs-lookup"><span data-stu-id="4d653-164">gRPC supports an optional [package](https://developers.google.com/protocol-buffers/docs/proto3#packages) specifier, which functions much like a .NET namespace.</span></span> <span data-ttu-id="4d653-165">Ve skutečnosti `package` bude použit jako obor názvů .NET pro generované `option csharp_namespace` typy .NET, pokud není nastaven v souboru *.proto.*</span><span class="sxs-lookup"><span data-stu-id="4d653-165">In fact, the `package` will be used as the .NET namespace for generated .NET types if `option csharp_namespace` is not set in the *.proto* file.</span></span> <span data-ttu-id="4d653-166">Balíček lze zadat číslo verze pro vaši službu a její zprávy:</span><span class="sxs-lookup"><span data-stu-id="4d653-166">The package can be used to specify a version number for your service and its messages:</span></span>

[!code-protobuf[](versioning/sample/greet.v1.proto?highlight=3)]

<span data-ttu-id="4d653-167">Název balíčku je kombinován s názvem služby k identifikaci adresy služby.</span><span class="sxs-lookup"><span data-stu-id="4d653-167">The package name is combined with the service name to identify a service address.</span></span> <span data-ttu-id="4d653-168">Adresa služby umožňuje hostovat více verzí služby vedle sebe:</span><span class="sxs-lookup"><span data-stu-id="4d653-168">A service address allows multiple versions of a service to be hosted side-by-side:</span></span>

* `greet.v1.Greeter`
* `greet.v2.Greeter`

<span data-ttu-id="4d653-169">Implementace služby s verzí jsou registrovány v *Startup.cs*:</span><span class="sxs-lookup"><span data-stu-id="4d653-169">Implementations of the versioned service are registered in *Startup.cs*:</span></span>

```csharp
app.UseEndpoints(endpoints =>
{
    // Implements greet.v1.Greeter
    endpoints.MapGrpcService<GreeterServiceV1>();

    // Implements greet.v2.Greeter
    endpoints.MapGrpcService<GreeterServiceV2>();
});
```

<span data-ttu-id="4d653-170">Zahrnutí čísla verze do názvu balíčku vám dává možnost publikovat verzi *služby v2* s nejnovějšími změnami a zároveň nadále podporovat starší klienty, kteří volají verzi *v1.*</span><span class="sxs-lookup"><span data-stu-id="4d653-170">Including a version number in the package name gives you the opportunity to publish a *v2* version of your service with breaking changes, while continuing to support older clients who call the *v1* version.</span></span> <span data-ttu-id="4d653-171">Jakmile klienti aktualizovali, aby používali službu *v2,* můžete odebrat starou verzi.</span><span class="sxs-lookup"><span data-stu-id="4d653-171">Once clients have updated to use the *v2* service, you can choose to remove the old version.</span></span> <span data-ttu-id="4d653-172">Při plánování publikování více verzí služby:</span><span class="sxs-lookup"><span data-stu-id="4d653-172">When planning to publish multiple versions of a service:</span></span>

* <span data-ttu-id="4d653-173">Vyhněte se porušení změn, pokud je to rozumné.</span><span class="sxs-lookup"><span data-stu-id="4d653-173">Avoid breaking changes if reasonable.</span></span>
* <span data-ttu-id="4d653-174">Neaktualizujte číslo verze, pokud neprovedete změny.</span><span class="sxs-lookup"><span data-stu-id="4d653-174">Don't update the version number unless making breaking changes.</span></span>
* <span data-ttu-id="4d653-175">Aktualizujte číslo verze při provádění změn.</span><span class="sxs-lookup"><span data-stu-id="4d653-175">Do update the version number when you make breaking changes.</span></span>

<span data-ttu-id="4d653-176">Publikování více verzí služby ji duplikuje.</span><span class="sxs-lookup"><span data-stu-id="4d653-176">Publishing multiple versions of a service duplicates it.</span></span> <span data-ttu-id="4d653-177">Chcete-li snížit duplicitu, zvažte přesunutí obchodní logiky z implementace služby do centralizovaného umístění, které může být znovu použito starými a novými implementacemi:</span><span class="sxs-lookup"><span data-stu-id="4d653-177">To reduce duplication, consider moving business logic from the service implementations to a centralized location that can be reused by the old and new implementations:</span></span>

[!code-csharp[](versioning/sample/GreeterServiceV1.cs?highlight=10,19)]

<span data-ttu-id="4d653-178">Služby a zprávy generované různými názvy balíčků se **liší typy rozhraní .NET**.</span><span class="sxs-lookup"><span data-stu-id="4d653-178">Services and messages generated with different package names are **different .NET types**.</span></span> <span data-ttu-id="4d653-179">Přesunutí obchodní logiky do centralizovaného umístění vyžaduje mapování zpráv na běžné typy.</span><span class="sxs-lookup"><span data-stu-id="4d653-179">Moving business logic to a centralized location requires mapping messages to common types.</span></span>
