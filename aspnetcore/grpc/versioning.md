---
title: Správa verzí gRPC Services
author: jamesnk
description: Naučte se, jak verze služeb gRPC Services.
monikerRange: '>= aspnetcore-3.0'
ms.author: jamesnk
ms.date: 01/09/2020
uid: grpc/versioning
ms.openlocfilehash: 61dd5dfca4064af3ae58ac288a1ee636450ff56b
ms.sourcegitcommit: 79850db9e79b1705b89f466c6f2c961ff15485de
ms.translationtype: HT
ms.contentlocale: cs-CZ
ms.lasthandoff: 01/07/2020
ms.locfileid: "75694206"
---
# <a name="versioning-grpc-services"></a><span data-ttu-id="394d4-103">Správa verzí gRPC Services</span><span class="sxs-lookup"><span data-stu-id="394d4-103">Versioning gRPC services</span></span>

<span data-ttu-id="394d4-104">Od [James Newton – král](https://twitter.com/jamesnk)</span><span class="sxs-lookup"><span data-stu-id="394d4-104">By [James Newton-King](https://twitter.com/jamesnk)</span></span>

<span data-ttu-id="394d4-105">Nové funkce přidané do aplikace můžou vyžadovat, aby se služby gRPC mohly změnit, někdy v neočekávaných a rozlomených způsobech.</span><span class="sxs-lookup"><span data-stu-id="394d4-105">New features added to an app can require gRPC services provided to clients to change, sometimes in unexpected and breaking ways.</span></span> <span data-ttu-id="394d4-106">Když se změní služba gRPC Services:</span><span class="sxs-lookup"><span data-stu-id="394d4-106">When gRPC services change:</span></span>

* <span data-ttu-id="394d4-107">Je třeba věnovat pozornost vlivu změn na klienty.</span><span class="sxs-lookup"><span data-stu-id="394d4-107">Consideration should be given on how changes impact clients.</span></span>
* <span data-ttu-id="394d4-108">Měla by se implementovat strategie správy verzí, která podporuje změny.</span><span class="sxs-lookup"><span data-stu-id="394d4-108">A versioning strategy to support changes should be implemented.</span></span>

## <a name="backwards-compatibility"></a><span data-ttu-id="394d4-109">Zpětná kompatibilita</span><span class="sxs-lookup"><span data-stu-id="394d4-109">Backwards compatibility</span></span>

<span data-ttu-id="394d4-110">Protokol gRPC je navržený tak, aby podporoval služby, které se v průběhu času mění.</span><span class="sxs-lookup"><span data-stu-id="394d4-110">The gRPC protocol is designed to support services that change over time.</span></span> <span data-ttu-id="394d4-111">Obecně se doplňují služby a metody gRPC, které nejsou v chodu.</span><span class="sxs-lookup"><span data-stu-id="394d4-111">Generally additions to gRPC services and methods are non-breaking.</span></span> <span data-ttu-id="394d4-112">Nerozdělování znamená, že stávající klienti budou fungovat i nadále.</span><span class="sxs-lookup"><span data-stu-id="394d4-112">Non-breaking means existing clients continue to work.</span></span> <span data-ttu-id="394d4-113">Změna nebo odstranění služeb gRPC Services se mění.</span><span class="sxs-lookup"><span data-stu-id="394d4-113">Changing or deleting gRPC services are breaking changes.</span></span> <span data-ttu-id="394d4-114">Zásadní změny znamenají selhání stávajících klientů.</span><span class="sxs-lookup"><span data-stu-id="394d4-114">Breaking changes mean existing clients fail.</span></span>

<span data-ttu-id="394d4-115">Provádění nerozhodujících změn služby má několik výhod:</span><span class="sxs-lookup"><span data-stu-id="394d4-115">Making non-breaking changes to a service has a number of benefits:</span></span>

- <span data-ttu-id="394d4-116">Stávající klienti pokračují v běhu.</span><span class="sxs-lookup"><span data-stu-id="394d4-116">Existing clients continue to run.</span></span>
- <span data-ttu-id="394d4-117">Zabrání práci, která je součástí upozorňování klientů na zásadní změny, a jejich aktualizaci.</span><span class="sxs-lookup"><span data-stu-id="394d4-117">Avoids work involved with notifying clients of breaking changes, and updating them.</span></span>
- <span data-ttu-id="394d4-118">Musí být dokumentována a udržována pouze jedna verze služby.</span><span class="sxs-lookup"><span data-stu-id="394d4-118">Only one version of the service needs to be documented and maintained.</span></span>

<span data-ttu-id="394d4-119">Tento obsah se zaměřuje na to, jestli se změny ruší **v protokolu gRPC a v binární úrovni kompatibility .NET**.</span><span class="sxs-lookup"><span data-stu-id="394d4-119">This content focuses on whether changes are **breaking at a gRPC protocol and .NET binary compatibility level**.</span></span> <span data-ttu-id="394d4-120">Při provádění změn zvažte, jestli můžou starší klienti logicky pokračovat v práci.</span><span class="sxs-lookup"><span data-stu-id="394d4-120">When making changes, consider whether older clients can logically continue working.</span></span> <span data-ttu-id="394d4-121">Například přidání nového pole do zprávy žádosti:</span><span class="sxs-lookup"><span data-stu-id="394d4-121">For example, adding a new field to a request message:</span></span>

* <span data-ttu-id="394d4-122">Nejedná se o změnu v důsledku přerušení protokolu.</span><span class="sxs-lookup"><span data-stu-id="394d4-122">Is not a protocol breaking change.</span></span>
* <span data-ttu-id="394d4-123">Vrátí stav chyby na serveru, pokud není nové pole nastaveno pro původní klienty jako zásadní změnu.</span><span class="sxs-lookup"><span data-stu-id="394d4-123">Returning an error status on the server if the new field is not set makes it a breaking change for old clients.</span></span>

### <a name="non-breaking-changes"></a><span data-ttu-id="394d4-124">Neprůlomové změny</span><span class="sxs-lookup"><span data-stu-id="394d4-124">Non-breaking changes</span></span>

<span data-ttu-id="394d4-125">Tyto změny jsou nerozdělitelné na úrovni protokolu gRPC a na binární úrovni .NET.</span><span class="sxs-lookup"><span data-stu-id="394d4-125">These changes are non-breaking at a gRPC protocol level, and .NET binary level.</span></span>

- <span data-ttu-id="394d4-126">**Přidává se nová služba.**</span><span class="sxs-lookup"><span data-stu-id="394d4-126">**Adding a new service**</span></span>
- <span data-ttu-id="394d4-127">**Přidání nové metody do služby**</span><span class="sxs-lookup"><span data-stu-id="394d4-127">**Adding a new method to a service**</span></span>
- <span data-ttu-id="394d4-128">**Přidání pole do zprávy žádosti** – pole přidaná do zprávy požadavku jsou deserializována s [výchozí hodnotou](https://developers.google.com/protocol-buffers/docs/proto3#default) na serveru, pokud není nastavena.</span><span class="sxs-lookup"><span data-stu-id="394d4-128">**Adding a field to a request message** - Fields added to a request message are deserialized with the [default value](https://developers.google.com/protocol-buffers/docs/proto3#default) on the server when not set.</span></span> <span data-ttu-id="394d4-129">Pokud nechcete, aby služba byla neúspěšná, bude nutné, aby byla úspěšná, když ji starší klienti nenastaví.</span><span class="sxs-lookup"><span data-stu-id="394d4-129">To be non-breaking the service will need to succeed when it is not set by older clients.</span></span>
- <span data-ttu-id="394d4-130">**Přidání pole do zprávy odpovědi** – pole přidaná do zprávy odpovědi jsou deserializována do kolekce [neznámá pole](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) zprávy na klientovi.</span><span class="sxs-lookup"><span data-stu-id="394d4-130">**Adding a field to a response message** - Fields added to a response message are deserialized into the message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) collection on the client.</span></span>
- <span data-ttu-id="394d4-131">**Přidání hodnoty do** výčtového výčtového typu je serializováno jako číselná hodnota.</span><span class="sxs-lookup"><span data-stu-id="394d4-131">**Adding a value to an enum** - Enums are serialized as a numeric value.</span></span> <span data-ttu-id="394d4-132">Nové hodnoty výčtu jsou v klientovi deserializovatelné na hodnotu výčtu bez názvu výčtu.</span><span class="sxs-lookup"><span data-stu-id="394d4-132">New enum values are deserialized on the client to the enum value without an enum name.</span></span> <span data-ttu-id="394d4-133">Pokud chcete, aby starší klienti nemuseli fungovat, musí se správně spustit, když dostanou a nevýjimkou hodnoty.</span><span class="sxs-lookup"><span data-stu-id="394d4-133">To be non-breaking older clients will need to run correctly when they receive and unexcepted value.</span></span>

### <a name="binary-breaking-changes"></a><span data-ttu-id="394d4-134">Binární přerušující změny</span><span class="sxs-lookup"><span data-stu-id="394d4-134">Binary breaking changes</span></span>

<span data-ttu-id="394d4-135">Následující změny nejsou rozstupné na úrovni protokolu gRPC, ale pokud se upgradují na nejnovější verzi, je potřeba, aby byl klient aktualizovaný *. proto* se jedná o kontrakt nebo klientské sestavení .NET.</span><span class="sxs-lookup"><span data-stu-id="394d4-135">The following changes are non-breaking at a gRPC protocol level, but the client needs to be updated if it upgrades to the latest *.proto* contract or client .NET assembly.</span></span> <span data-ttu-id="394d4-136">Binární kompatibilita je důležitá, pokud plánujete publikovat knihovnu gRPC do NuGet.</span><span class="sxs-lookup"><span data-stu-id="394d4-136">Binary compatibility is important if you plan to publish a gRPC library to NuGet.</span></span>

- <span data-ttu-id="394d4-137">**Odebrání hodnot pole** z odebraného pole je deserializovatelné na [neznámá pole](https://developers.google.com/protocol-buffers/docs/proto3#unknowns)zprávy.</span><span class="sxs-lookup"><span data-stu-id="394d4-137">**Removing a field** - Values from a removed field are deserialized to a message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns).</span></span> <span data-ttu-id="394d4-138">Nejedná se o změnu gRPC protokolu, ale pokud se upgraduje na nejnovější verzi, je potřeba aktualizovat klienta.</span><span class="sxs-lookup"><span data-stu-id="394d4-138">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span> <span data-ttu-id="394d4-139">Je důležité, aby odebrané číslo pole v budoucnu nechtěně znovu nepoužívalo.</span><span class="sxs-lookup"><span data-stu-id="394d4-139">It is important that a removed field number isn't accidentally reused in the future.</span></span> <span data-ttu-id="394d4-140">Jedním ze způsobů, jak zajistit, aby k tomu nedocházelo, je zadání čísel a názvů odstraněných polí ve zprávě pomocí klíčového slova [`reserved`](https://developers.google.com/protocol-buffers/docs/proto3#reserved) Protobuf.</span><span class="sxs-lookup"><span data-stu-id="394d4-140">One way to make sure this doesn't happen is to specify deleted field numbers and names on the message using Protobuf's [`reserved`](https://developers.google.com/protocol-buffers/docs/proto3#reserved) keyword.</span></span>
- <span data-ttu-id="394d4-141">**Přejmenování** polí – názvy polí se používají pouze ve vygenerovaném kódu.</span><span class="sxs-lookup"><span data-stu-id="394d4-141">**Renaming a field** - Field names are only used in generated code.</span></span> <span data-ttu-id="394d4-142">Číslo pole se používá k identifikaci polí v síti.</span><span class="sxs-lookup"><span data-stu-id="394d4-142">The field number is used to identify fields on the network.</span></span> <span data-ttu-id="394d4-143">Klient bude muset být aktualizován, pokud se upgraduje na nejnovější kontrakt.</span><span class="sxs-lookup"><span data-stu-id="394d4-143">The client will need to be updated if it upgrades to the latest contract.</span></span>
- <span data-ttu-id="394d4-144">**Přejmenování** zpráv – názvy zpráv nejsou odesílány v síti, takže se nejedná o gRPC změnu protokolu, ale klient bude muset být aktualizován, pokud upgraduje na nejnovější kontrakt.</span><span class="sxs-lookup"><span data-stu-id="394d4-144">**Renaming a message** - Message names are not sent on the network so this isn't a gRPC protocol breaking change, but the client will need to be updated if it upgrades to the latest contract.</span></span>
- <span data-ttu-id="394d4-145">**Změna csharp_namespace** -změna `csharp_namespace` změní obor názvů vygenerovaných typů .NET.</span><span class="sxs-lookup"><span data-stu-id="394d4-145">**Changing csharp_namespace** - Changing `csharp_namespace` will change the namespace of generated .NET types.</span></span> <span data-ttu-id="394d4-146">Nejedná se o změnu gRPC protokolu, ale pokud se upgraduje na nejnovější verzi, je potřeba aktualizovat klienta.</span><span class="sxs-lookup"><span data-stu-id="394d4-146">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span>

### <a name="breaking-changes"></a><span data-ttu-id="394d4-147">Změny způsobující chyby</span><span class="sxs-lookup"><span data-stu-id="394d4-147">Breaking changes</span></span>

<span data-ttu-id="394d4-148">Jedná se o protokol a binární změny.</span><span class="sxs-lookup"><span data-stu-id="394d4-148">These are protocol and binary breaking changes.</span></span>

- <span data-ttu-id="394d4-149">**Změna datového typu pole** – Změna datového typu pole na [nekompatibilní typ](https://developers.google.com/protocol-buffers/docs/proto3#updating) způsobí chyby při deserializaci zprávy.</span><span class="sxs-lookup"><span data-stu-id="394d4-149">**Changing a field data type** - Changing a field's data type to an [incompatible type](https://developers.google.com/protocol-buffers/docs/proto3#updating) will cause errors when deserializing the message.</span></span> <span data-ttu-id="394d4-150">I v případě, že je nový datový typ kompatibilní, je pravděpodobně potřeba aktualizovat klienta, aby podporoval nový typ, pokud se upgraduje na nejnovější kontrakt.</span><span class="sxs-lookup"><span data-stu-id="394d4-150">Even if the new data type is compatible, it is likely the client will need to be updated to support the new type if it upgrades to the latest contract.</span></span>
- <span data-ttu-id="394d4-151">**Změna čísla pole** – číslo pole se používá k identifikaci polí v síti.</span><span class="sxs-lookup"><span data-stu-id="394d4-151">**Changing a field number** - The field number is used to identify fields on the network.</span></span>
- <span data-ttu-id="394d4-152">**Přejmenování balíčku, služby nebo metody** – gRPC používá k sestavení adresy URL název balíčku, název služby a název metody.</span><span class="sxs-lookup"><span data-stu-id="394d4-152">**Renaming a package, service or method** - gRPC uses the package name, service name and method name to build the URL.</span></span> <span data-ttu-id="394d4-153">Klient získá *Neimplementovaný* stav ze serveru.</span><span class="sxs-lookup"><span data-stu-id="394d4-153">The client gets an *UNIMPLEMENTED* status from the server.</span></span>
- <span data-ttu-id="394d4-154">**Odebrání služby nebo metody** – klient získá *Neimplementovaný* stav ze serveru při volání odebrané metody.</span><span class="sxs-lookup"><span data-stu-id="394d4-154">**Removing a service or method** - The client gets an *UNIMPLEMENTED* status from the server when calling the removed method.</span></span>

## <a name="version-number-services"></a><span data-ttu-id="394d4-155">Číslo verze služeb</span><span class="sxs-lookup"><span data-stu-id="394d4-155">Version number services</span></span>

<span data-ttu-id="394d4-156">Služby by se měly snažit, aby zůstaly zpětně kompatibilní se starými klienty.</span><span class="sxs-lookup"><span data-stu-id="394d4-156">Services should strive to remain backwards compatible with old clients.</span></span> <span data-ttu-id="394d4-157">Nakonec změny vaší aplikace mohou vyžadovat zásadní změny.</span><span class="sxs-lookup"><span data-stu-id="394d4-157">Eventually changes to your app may require breaking changes.</span></span> <span data-ttu-id="394d4-158">Poškození starých klientů a jejich vynucování spolu s vaší službou není dobrým uživatelským prostředím.</span><span class="sxs-lookup"><span data-stu-id="394d4-158">Breaking old clients and forcing them to be updated along with your service isn't a good user experience.</span></span> <span data-ttu-id="394d4-159">Způsob, jak udržet zpětnou kompatibilitu při provádění zásadních změn, je publikování více verzí služby.</span><span class="sxs-lookup"><span data-stu-id="394d4-159">A way to maintain backwards compatibility while making breaking changes is to publish multiple versions of a service.</span></span>

<span data-ttu-id="394d4-160">gRPC podporuje volitelný specifikátor [`package`](https://developers.google.com/protocol-buffers/docs/proto3#packages) , který funguje podobně jako obor názvů .NET.</span><span class="sxs-lookup"><span data-stu-id="394d4-160">gRPC supports an optional [`package`](https://developers.google.com/protocol-buffers/docs/proto3#packages) specifier, which functions much like a .NET namespace.</span></span> <span data-ttu-id="394d4-161">V takovém případě se `package` použije jako obor názvů .NET pro vygenerované typy .NET, pokud `option csharp_namespace` není nastaveno v souboru *..* .</span><span class="sxs-lookup"><span data-stu-id="394d4-161">In fact the `package` will be used as the .NET namespace for generated .NET types if `option csharp_namespace` is not set in the *.proto* file.</span></span> <span data-ttu-id="394d4-162">Balíček lze použít k zadání čísla verze vaší služby a jejích zpráv:</span><span class="sxs-lookup"><span data-stu-id="394d4-162">The package can be used to specify a version number for your service and its messages:</span></span>

[!code-protobuf[](versioning/sample/greet.v1.proto?highlight=3)]

<span data-ttu-id="394d4-163">Název balíčku je v kombinaci s názvem služby k identifikaci adresy služby.</span><span class="sxs-lookup"><span data-stu-id="394d4-163">The package name is combined with the service name to identify a service address.</span></span> <span data-ttu-id="394d4-164">Adresa služby umožňuje souběžně hostovat více verzí služby:</span><span class="sxs-lookup"><span data-stu-id="394d4-164">A service address allows multiple versions of a service to be hosted side-by-side:</span></span>

* `greet.v1.Greeter`
* `greet.v2.Greeter`

<span data-ttu-id="394d4-165">Implementace služby se správou verzí jsou zaregistrované v *Startup.cs*:</span><span class="sxs-lookup"><span data-stu-id="394d4-165">Implementations of the versioned service are registered in *Startup.cs*:</span></span>

```csharp
app.UseEndpoints(endpoints =>
{
    // Implements greet.v1.Greeter
    endpoints.MapGrpcService<GreeterServiceV1>();

    // Implements greet.v2.Greeter
    endpoints.MapGrpcService<GreeterServiceV2>();
});
```

<span data-ttu-id="394d4-166">Zahrnutím čísla verze do názvu balíčku získáte možnost publikovat verzi *v2* vaší služby s nezměněnými změnami, a to i nadále podporovat starší klienty, kteří volají verzi *v1* .</span><span class="sxs-lookup"><span data-stu-id="394d4-166">Including a version number in the package name gives you the opportunity to publish a *v2* version of your service with breaking changes, while continuing to support older clients who call the *v1* version.</span></span> <span data-ttu-id="394d4-167">Jakmile se klienti aktualizují, aby používali službu *v2* , můžete si odebrat starou verzi.</span><span class="sxs-lookup"><span data-stu-id="394d4-167">Once clients have updated to use the *v2* service you can choose to remove the old version.</span></span> <span data-ttu-id="394d4-168">Při plánování publikování více verzí služby:</span><span class="sxs-lookup"><span data-stu-id="394d4-168">When planning to publish multiple versions of a service:</span></span>

- <span data-ttu-id="394d4-169">Nepoužívejte závažné změny, pokud je to rozumné.</span><span class="sxs-lookup"><span data-stu-id="394d4-169">Avoid breaking changes if reasonable.</span></span>
- <span data-ttu-id="394d4-170">Neaktualizujte číslo verze, pokud neprovádíte zásadní změny.</span><span class="sxs-lookup"><span data-stu-id="394d4-170">Don't update the version number unless making breaking changes.</span></span>
- <span data-ttu-id="394d4-171">Aktualizujte číslo verze, když provedete průlomové změny.</span><span class="sxs-lookup"><span data-stu-id="394d4-171">Do update the version number when you make breaking changes.</span></span>

<span data-ttu-id="394d4-172">Publikování více verzí služby je duplicitní.</span><span class="sxs-lookup"><span data-stu-id="394d4-172">Publishing multiple versions of a service duplicates it.</span></span> <span data-ttu-id="394d4-173">Pokud chcete omezit duplicity, zvažte přesunutí obchodní logiky ze implementací služby do centralizovaného umístění, které je možné použít starými a novými implementacemi:</span><span class="sxs-lookup"><span data-stu-id="394d4-173">To reduce duplication, consider moving business logic from the service implementations to a centralized location that can be reused by the old and new implementations:</span></span>

[!code-csharp[](versioning/sample/GreeterServiceV1.cs?highlight=10,19)]

<span data-ttu-id="394d4-174">Služby a zprávy vygenerované s různými názvy balíčků jsou **různé typy rozhraní .NET**.</span><span class="sxs-lookup"><span data-stu-id="394d4-174">Services and messages generated with different package names are **different .NET types**.</span></span> <span data-ttu-id="394d4-175">Přesun obchodní logiky do centralizovaného umístění vyžaduje mapování zpráv na společné typy.</span><span class="sxs-lookup"><span data-stu-id="394d4-175">Moving business logic to a centralized location requires mapping messages to common types.</span></span>
