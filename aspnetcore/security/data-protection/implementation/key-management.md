---
title: Správa klíčů v ASP.NET Core
author: rick-anderson
description: Přečtěte si podrobnosti o implementaci rozhraní API pro správu klíčů ASP.NET Core Data Protection.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: c571222d734fa69183563aefa5cc6ce5a10e7612
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/06/2020
ms.locfileid: "78664708"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="d1183-103">Správa klíčů v ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="d1183-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="d1183-104">Systém ochrany dat automaticky spravuje dobu života hlavních klíčů, které slouží k ochraně a odemknutí datových částí.</span><span class="sxs-lookup"><span data-stu-id="d1183-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="d1183-105">Každý klíč může existovat v jednom ze čtyř fází:</span><span class="sxs-lookup"><span data-stu-id="d1183-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="d1183-106">Vytvořeno – klíč existuje ve službě Key Ring, ale ještě není aktivovaný.</span><span class="sxs-lookup"><span data-stu-id="d1183-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="d1183-107">Klíč by se neměl používat pro nové operace ochrany, dokud neuplyne dostatek času na to, že by měl mít možnost rozšířit na všechny počítače, které tento klíčový kanál využívají.</span><span class="sxs-lookup"><span data-stu-id="d1183-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="d1183-108">Aktivní – klíč existuje ve službě Key Ring a měl by se používat pro všechny nové operace ochrany.</span><span class="sxs-lookup"><span data-stu-id="d1183-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="d1183-109">Vypršela platnost – klíč spustil svou přirozenou životnost a neměl by se už používat pro nové operace ochrany.</span><span class="sxs-lookup"><span data-stu-id="d1183-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="d1183-110">Odvoláno – klíč je napadený a nesmí se používat pro nové operace ochrany.</span><span class="sxs-lookup"><span data-stu-id="d1183-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="d1183-111">Klíče pro vytváření, aktivní a vypršení platnosti se můžou používat k odemknutí příchozích datových částí.</span><span class="sxs-lookup"><span data-stu-id="d1183-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="d1183-112">Odvolané klíče ve výchozím nastavení se nedají použít k zrušení ochrany datových částí, ale vývojář aplikace může v případě potřeby [Toto chování přepsat](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) .</span><span class="sxs-lookup"><span data-stu-id="d1183-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="d1183-113">Vývojář se může rozhodnout odstranit klíč z klíčového prstence (například odstraněním odpovídajícího souboru ze systému souborů).</span><span class="sxs-lookup"><span data-stu-id="d1183-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="d1183-114">V tomto okamžiku se všechna data chráněná klíčem trvale nešifrují a neexistuje žádné nouzové přepsání, podobně jako u odvolaných klíčů.</span><span class="sxs-lookup"><span data-stu-id="d1183-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="d1183-115">Odstranění klíče je skutečně destruktivní chování, a proto systém ochrany dat zpřístupňuje žádné rozhraní API první třídy, které by tuto operaci provádělo.</span><span class="sxs-lookup"><span data-stu-id="d1183-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="d1183-116">Výchozí výběr klíče</span><span class="sxs-lookup"><span data-stu-id="d1183-116">Default key selection</span></span>

<span data-ttu-id="d1183-117">Když systém ochrany dat přečte z záložního úložiště klíč, pokusí se najít "výchozí" klíč ze služby Key Ring.</span><span class="sxs-lookup"><span data-stu-id="d1183-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="d1183-118">Výchozí klíč se používá pro nové operace ochrany.</span><span class="sxs-lookup"><span data-stu-id="d1183-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="d1183-119">Obecná heuristika znamená, že systém ochrany dat zvolí klíč s nejnovějším datem aktivace jako výchozí klíč.</span><span class="sxs-lookup"><span data-stu-id="d1183-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="d1183-120">(K dispozici je malý Fudge faktor, který umožňuje vyhodnotit časové zkosení mezi servery.) Pokud vypršela platnost klíče nebo odvolala, a pokud aplikace nevypne automatické generování klíčů, vygeneruje se nový klíč s okamžitou aktivací na základě [vypršení platnosti klíče a postupná](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) zásada.</span><span class="sxs-lookup"><span data-stu-id="d1183-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="d1183-121">Důvodem je, že systém ochrany dat vygeneruje nový klíč hned a nevrátí se zpět do jiného klíče, že by se nová generace klíčů měla považovat za implicitní vypršení všech klíčů, které byly aktivovány před novým klíčem.</span><span class="sxs-lookup"><span data-stu-id="d1183-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="d1183-122">Obecným nápadem je, že nové klíče byly nakonfigurované s různými algoritmy nebo mechanizmy při šifrování v klidovém režimu než staré klíče a systém by měl preferovat aktuální konfiguraci v případě vrácení zpět.</span><span class="sxs-lookup"><span data-stu-id="d1183-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="d1183-123">Došlo k výjimce.</span><span class="sxs-lookup"><span data-stu-id="d1183-123">There's an exception.</span></span> <span data-ttu-id="d1183-124">Pokud vývojář aplikace [zakázal automatické generování klíčů](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), musí systém ochrany dat zvolit něco jako výchozí klíč.</span><span class="sxs-lookup"><span data-stu-id="d1183-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="d1183-125">V tomto záložním scénáři systém zvolí neodvolán klíč s nejaktuálnějším datem aktivace s upřednostněním klíčů, které měly čas rozšířit na jiné počítače v clusteru.</span><span class="sxs-lookup"><span data-stu-id="d1183-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="d1183-126">Záložní systém může v důsledku toho ukončit výběr výchozího klíče s vypršenou platností.</span><span class="sxs-lookup"><span data-stu-id="d1183-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="d1183-127">Záložní systém nikdy nezvolí odvolaný klíč jako výchozí klíč, a pokud je klíčového prstence prázdný nebo byl odvolán každý klíč, dojde při inicializaci k chybě systému.</span><span class="sxs-lookup"><span data-stu-id="d1183-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="d1183-128">Vypršení platnosti klíče a vracení</span><span class="sxs-lookup"><span data-stu-id="d1183-128">Key expiration and rolling</span></span>

<span data-ttu-id="d1183-129">Když se vytvoří klíč, automaticky se mu zobrazí datum aktivace {Now + 2 dny} a datum vypršení platnosti {Now + 90 dní}.</span><span class="sxs-lookup"><span data-stu-id="d1183-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="d1183-130">Před dvěma dny před aktivací je klíčovým časem, který se má rozšířit přes systém.</span><span class="sxs-lookup"><span data-stu-id="d1183-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="d1183-131">To znamená, že umožňuje jiným aplikacím, které odkazují na záložní úložiště, sledovat klíč při příští automatické aktualizaci, což maximalizuje riziko, že když se klíčový kanál stane aktivní, rozšíří se na všechny aplikace, které ho můžou potřebovat použít.</span><span class="sxs-lookup"><span data-stu-id="d1183-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="d1183-132">Pokud vyprší platnost výchozího klíče do 2 dnů a pokud klíčového prstence ještě nemá klíč, který bude aktivní po vypršení platnosti výchozího klíče, pak systém ochrany dat automaticky zachová nový klíč do služby Key Ring.</span><span class="sxs-lookup"><span data-stu-id="d1183-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="d1183-133">Tento nový klíč má datum aktivace {výchozí datum vypršení platnosti klíče} a datum vypršení platnosti {Now + 90 dní}.</span><span class="sxs-lookup"><span data-stu-id="d1183-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="d1183-134">Díky tomu může systém pravidelně automaticky pravidelně vytvářet klíče bez přerušení služby.</span><span class="sxs-lookup"><span data-stu-id="d1183-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="d1183-135">Můžou nastat situace, kdy se klíč vytvoří s okamžitou aktivací.</span><span class="sxs-lookup"><span data-stu-id="d1183-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="d1183-136">Příkladem může být, že aplikace neběžela po dobu a platnost všech klíčů ve službě Key Ring vypršela.</span><span class="sxs-lookup"><span data-stu-id="d1183-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="d1183-137">V takovém případě se klíč udělí datum aktivace {Now} bez normálního prodlevy Aktivace 2 den.</span><span class="sxs-lookup"><span data-stu-id="d1183-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="d1183-138">Výchozí životnost klíče je 90 dní, ale je možné ji nakonfigurovat jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="d1183-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="d1183-139">Správce může změnit také výchozí systém, přestože explicitní volání `SetDefaultKeyLifetime` přepíše všechny zásady pro systém.</span><span class="sxs-lookup"><span data-stu-id="d1183-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="d1183-140">Výchozí životnost klíče nemůže být kratší než 7 dní.</span><span class="sxs-lookup"><span data-stu-id="d1183-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="d1183-141">Automatická aktualizace klíčového kruhu</span><span class="sxs-lookup"><span data-stu-id="d1183-141">Automatic key ring refresh</span></span>

<span data-ttu-id="d1183-142">Po inicializaci systému ochrany dat přečte klíčovou Ring z podkladového úložiště a uloží jej do paměti.</span><span class="sxs-lookup"><span data-stu-id="d1183-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="d1183-143">Tato mezipaměť umožňuje chránit a zrušit ochranu operací, aniž byste se museli zaběhnout do záložního úložiště.</span><span class="sxs-lookup"><span data-stu-id="d1183-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="d1183-144">Systém automaticky zkontroluje záložní úložiště, aby se změny projevily přibližně každých 24 hodin, nebo když vyprší aktuální výchozí klíč, podle toho, co nastane dřív.</span><span class="sxs-lookup"><span data-stu-id="d1183-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="d1183-145">Vývojáři by měli velmi zřídka používat rozhraní API pro správu klíčů přímo.</span><span class="sxs-lookup"><span data-stu-id="d1183-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="d1183-146">Systém ochrany dat provede automatickou správu klíčů, jak je popsáno výše.</span><span class="sxs-lookup"><span data-stu-id="d1183-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="d1183-147">Systém ochrany dat zpřístupňuje `IKeyManager` rozhraní, které lze použít ke kontrole a provádění změn ve službě Key Ring.</span><span class="sxs-lookup"><span data-stu-id="d1183-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="d1183-148">Systém DI, který poskytuje instanci `IDataProtectionProvider`, může také poskytnout instanci `IKeyManager` pro vaši spotřebu.</span><span class="sxs-lookup"><span data-stu-id="d1183-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="d1183-149">Alternativně můžete `IKeyManager` načíst přímo z `IServiceProvider` jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="d1183-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="d1183-150">Jakákoli operace, která upravuje klíč Ring (explicitní vytvoření nového klíče nebo zrušení odvolání), zruší platnost mezipaměti v paměti.</span><span class="sxs-lookup"><span data-stu-id="d1183-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="d1183-151">Další volání `Protect` nebo `Unprotect` způsobí, že systém ochrany dat znovu přečte klíč Ring a znovu vytvoří mezipaměť.</span><span class="sxs-lookup"><span data-stu-id="d1183-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="d1183-152">Následující ukázka ukazuje použití rozhraní `IKeyManager` ke kontrole a manipulaci s kroužkem klíčů, včetně odvolání existujících klíčů a vygenerování nového klíče ručně.</span><span class="sxs-lookup"><span data-stu-id="d1183-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

[!INCLUDE[about the series](~/includes/code-comments-loc.md)]

## <a name="key-storage"></a><span data-ttu-id="d1183-153">Úložiště klíčů</span><span class="sxs-lookup"><span data-stu-id="d1183-153">Key storage</span></span>

<span data-ttu-id="d1183-154">Systém ochrany dat má heuristickou metodu, která se pokusí odvodit příslušné klíčové umístění úložiště klíčů a automatické šifrování.</span><span class="sxs-lookup"><span data-stu-id="d1183-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="d1183-155">Mechanismus trvalosti klíčů je také možné nakonfigurovat vývojářem aplikace.</span><span class="sxs-lookup"><span data-stu-id="d1183-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="d1183-156">Následující dokumenty popisují implementace těchto mechanismů v krabicích:</span><span class="sxs-lookup"><span data-stu-id="d1183-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
