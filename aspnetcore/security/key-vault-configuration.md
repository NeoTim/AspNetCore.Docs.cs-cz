---
title: "Poskytovatel konfigurace služby Azure Key Vault"
author: guardrex
description: "Další informace o použití konfigurace zprostředkovatele služby Azure klíč trezoru pro konfiguraci aplikace pomocí dvojice název hodnota načíst za běhu."
keywords: ASP.NET Core, konfiguraci, Azure Key Vault
ms.author: riande
manager: wpickett
ms.date: 08/09/2017
ms.topic: article
ms.assetid: 0292bdae-b3ed-4637-bd67-19b9bb8b65cb
ms.prod: asp.net-core
uid: security/key-vault-configuration
ms.openlocfilehash: 352d125b9042c603b59ed9bda0e99b6a49c7ab9f
ms.sourcegitcommit: 8f42ab93402c1b8044815e1e48d0bb84c81f8b59
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 11/29/2017
---
# <a name="azure-key-vault-configuration-provider"></a><span data-ttu-id="fa20e-104">Poskytovatel konfigurace služby Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="fa20e-104">Azure Key Vault configuration provider</span></span>

<span data-ttu-id="fa20e-105">Podle [Luke Latham](https://github.com/guardrex) a [Andrew Stanton-Nurse](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="fa20e-105">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="fa20e-106">ASP.NET základní 2.x</span><span class="sxs-lookup"><span data-stu-id="fa20e-106">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="fa20e-107">Zobrazit nebo stáhnout ukázkový kód pro 2.x:</span><span class="sxs-lookup"><span data-stu-id="fa20e-107">View or download sample code for 2.x:</span></span>

* <span data-ttu-id="fa20e-108">[Základní ukázka](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) ([stažení](xref:tutorials/index#how-to-download-a-sample))-čte tajný hodnoty do aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-108">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values into an app.</span></span>
* <span data-ttu-id="fa20e-109">[Název klíče předponu ukázkové](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) ([stažení](xref:tutorials/index#how-to-download-a-sample)) – čtení tajný hodnoty pomocí předpony název klíče, který představuje verzi aplikace, což vám umožní načíst jinou sadu tajný hodnoty pro každou verzi aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-109">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="fa20e-110">ASP.NET základní 1.x</span><span class="sxs-lookup"><span data-stu-id="fa20e-110">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="fa20e-111">Zobrazit nebo stáhnout ukázkový kód pro 1.x:</span><span class="sxs-lookup"><span data-stu-id="fa20e-111">View or download sample code for 1.x:</span></span>

* <span data-ttu-id="fa20e-112">[Základní ukázka](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) ([stažení](xref:tutorials/index#how-to-download-a-sample))-čte tajný hodnoty do aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-112">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values into an app.</span></span>
* <span data-ttu-id="fa20e-113">[Název klíče předponu ukázkové](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) ([stažení](xref:tutorials/index#how-to-download-a-sample)) – čtení tajný hodnoty pomocí předpony název klíče, který představuje verzi aplikace, což vám umožní načíst jinou sadu tajný hodnoty pro každou verzi aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-113">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span> 

---

<span data-ttu-id="fa20e-114">Tento dokument vysvětluje, jak používat [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) poskytovatele konfigurace pro načtení hodnoty konfigurace aplikace z Azure Key Vault tajných klíčů.</span><span class="sxs-lookup"><span data-stu-id="fa20e-114">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load application configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="fa20e-115">Azure Key Vault je Cloudová služba, která pomáhá chránit kryptografické klíče a tajné klíče používané aplikace a služby.</span><span class="sxs-lookup"><span data-stu-id="fa20e-115">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="fa20e-116">Řízení přístupu k citlivým konfigurační data mezi obvyklé scénáře patří a splňuje požadavek na FIPS 140-2 Level 2 ověřit moduly hardwarového zabezpečení (HSM) při ukládání konfigurační data.</span><span class="sxs-lookup"><span data-stu-id="fa20e-116">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="fa20e-117">Tato funkce je k dispozici pro aplikace, které cílí ASP.NET Core 1.1 nebo vyšší.</span><span class="sxs-lookup"><span data-stu-id="fa20e-117">This feature is available for applications that target ASP.NET Core 1.1 or higher.</span></span>

## <a name="package"></a><span data-ttu-id="fa20e-118">Balíček</span><span class="sxs-lookup"><span data-stu-id="fa20e-118">Package</span></span>
<span data-ttu-id="fa20e-119">Chcete-li použít poskytovatele, přidejte odkaz na [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) balíčku.</span><span class="sxs-lookup"><span data-stu-id="fa20e-119">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="application-configuration"></a><span data-ttu-id="fa20e-120">Konfigurace aplikace</span><span class="sxs-lookup"><span data-stu-id="fa20e-120">Application configuration</span></span>
<span data-ttu-id="fa20e-121">Můžete si prostudovat zprostředkovatele s [ukázkové aplikace](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="fa20e-121">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="fa20e-122">Po vytvoření trezoru klíčů a vytvoření tajných klíčů v trezoru, ukázkových aplikací bezpečně načíst tajný hodnoty do jejich konfigurace a jejich zobrazení na webových stránkách.</span><span class="sxs-lookup"><span data-stu-id="fa20e-122">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="fa20e-123">Zprostředkovatel je přidán do `ConfigurationBuilder` s `AddAzureKeyVault` rozšíření.</span><span class="sxs-lookup"><span data-stu-id="fa20e-123">The provider is added to the `ConfigurationBuilder` with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="fa20e-124">V ukázkových aplikací rozšíření používá tři načíst z hodnoty konfigurace *appSettings.JSON určený* souboru.</span><span class="sxs-lookup"><span data-stu-id="fa20e-124">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="fa20e-125">Nastavení aplikace</span><span class="sxs-lookup"><span data-stu-id="fa20e-125">App Setting</span></span>    | <span data-ttu-id="fa20e-126">Popis</span><span class="sxs-lookup"><span data-stu-id="fa20e-126">Description</span></span>                    | <span data-ttu-id="fa20e-127">Příklad</span><span class="sxs-lookup"><span data-stu-id="fa20e-127">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="fa20e-128">Název Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="fa20e-128">Azure Key Vault name</span></span>           | <span data-ttu-id="fa20e-129">contosovault</span><span class="sxs-lookup"><span data-stu-id="fa20e-129">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="fa20e-130">Id aplikace Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="fa20e-130">Azure Active Directory App Id</span></span>  | <span data-ttu-id="fa20e-131">627e911e-43CC-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="fa20e-131">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="fa20e-132">Klíč aplikace Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="fa20e-132">Azure Active Directory App Key</span></span> | <span data-ttu-id="fa20e-133">g58K3dtg59o1Pa + e59v2Tx829w6VxTB2yv9sv/101di =</span><span class="sxs-lookup"><span data-stu-id="fa20e-133">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1&highlight=2,7-10)]

## <a name="creating-key-vault-secrets-and-loading-configuration-values-basic-sample"></a><span data-ttu-id="fa20e-134">Vytvoření trezoru klíčů tajných klíčů a načítání hodnoty konfigurace (basic – ukázka)</span><span class="sxs-lookup"><span data-stu-id="fa20e-134">Creating key vault secrets and loading configuration values (basic-sample)</span></span>
1. <span data-ttu-id="fa20e-135">Vytvoření trezoru klíčů a nastavení Azure Active Directory (Azure AD) pro aplikaci následující pokyny v [Začínáme s Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="fa20e-135">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="fa20e-136">Přidat tajné klíče do trezoru klíčů pomocí [modulu PowerShell trezoru klíč AzureRM](/powershell/module/azurerm.keyvault) dostupné z [Galerie prostředí PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), [REST API služby Azure Key Vault](/rest/api/keyvault/), nebo [Portál azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="fa20e-136">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="fa20e-137">Tajné klíče byly vytvořeny jako buď *ruční* nebo *certifikát* tajných klíčů.</span><span class="sxs-lookup"><span data-stu-id="fa20e-137">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="fa20e-138">*Certifikát* tajné klíče jsou certifikáty používané aplikace a služby, ale nejsou podporovány ve zprostředkovateli konfigurace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-138">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="fa20e-139">Měli byste použít *ruční* možnost vytvořit tajné klíče dvojice název hodnota pro použití se zprostředkovatelem konfigurace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-139">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="fa20e-140">Jednoduché tajné klíče jsou vytvořené jako dvojice název hodnota.</span><span class="sxs-lookup"><span data-stu-id="fa20e-140">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="fa20e-141">Azure Key Vault názvů tajných klíčů jsou omezeny na alfanumerické znaky a spojovníky.</span><span class="sxs-lookup"><span data-stu-id="fa20e-141">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
    * <span data-ttu-id="fa20e-142">Hierarchická hodnoty (konfigurační oddíly) použijte `--` (dvě pomlčky) jako oddělovač v ukázce.</span><span class="sxs-lookup"><span data-stu-id="fa20e-142">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="fa20e-143">Použití dvojteček, které se obvykle používají pro vymezení části z podklíč v [konfigurace ASP.NET Core](xref:fundamentals/configuration/index), nejsou povoleny v názvů tajných klíčů.</span><span class="sxs-lookup"><span data-stu-id="fa20e-143">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration/index), aren't allowed in secret names.</span></span> <span data-ttu-id="fa20e-144">Proto jsou dvě pomlčky používá a vzájemně zaměněny pro dvojtečkou při těchto tajných klíčů jsou načteny do konfigurace aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-144">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
    * <span data-ttu-id="fa20e-145">Vytvořte dvě *ruční* tajných klíčů s následující páry název hodnota.</span><span class="sxs-lookup"><span data-stu-id="fa20e-145">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="fa20e-146">První tajný klíč je jednoduchý název a hodnotu a druhý tajný klíč vytvoří tajná hodnota s části a podklíč v tajný název:</span><span class="sxs-lookup"><span data-stu-id="fa20e-146">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
      * <span data-ttu-id="fa20e-147">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="fa20e-147">`SecretName`: `secret_value_1`</span></span>
      * <span data-ttu-id="fa20e-148">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="fa20e-148">`Section--SecretName`: `secret_value_2`</span></span>
  * <span data-ttu-id="fa20e-149">Ukázková aplikace zaregistrujte v Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="fa20e-149">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="fa20e-150">Autorizovat aplikaci pro přístup k trezoru klíčů.</span><span class="sxs-lookup"><span data-stu-id="fa20e-150">Authorize the app to access the key vault.</span></span> <span data-ttu-id="fa20e-151">Při použití `Set-AzureRmKeyVaultAccessPolicy` rutiny prostředí PowerShell autorizovat aplikaci pro přístup k trezoru klíčů, zadejte `List` a `Get` přístup k tajných klíčů s `-PermissionsToKeys list,get`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-151">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToKeys list,get`.</span></span>
2. <span data-ttu-id="fa20e-152">Aktualizace aplikace služby *appSettings.JSON určený* souboru s hodnotami `Vault`, `ClientId`, a `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-152">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="fa20e-153">Spuštění ukázkové aplikace, která získává jeho hodnoty konfigurace z `IConfigurationRoot` se stejným názvem jako tajný název.</span><span class="sxs-lookup"><span data-stu-id="fa20e-153">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
  * <span data-ttu-id="fa20e-154">Hierarchická bez hodnoty: hodnota `SecretName` se získávají pomocí `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-154">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
  * <span data-ttu-id="fa20e-155">Hierarchická hodnoty (oddíly): použití `:` zápis (dvojtečka) nebo `GetSection` metoda rozšíření.</span><span class="sxs-lookup"><span data-stu-id="fa20e-155">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="fa20e-156">Použijte jednu z těchto přístupů k získání hodnoty konfigurace:</span><span class="sxs-lookup"><span data-stu-id="fa20e-156">Use either of these approaches to obtain the configuration value:</span></span>
    * `config["Section:SecretName"]`
    * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="fa20e-157">Při spuštění aplikace zobrazuje webová stránka načtená tajný hodnoty:</span><span class="sxs-lookup"><span data-stu-id="fa20e-157">When you run the app, a webpage shows the loaded secret values:</span></span>

![Okno prohlížeče zobrazující tajný hodnoty načíst prostřednictvím poskytovatele konfigurace Azure klíč trezoru](key-vault-configuration/_static/sample1.png)

## <a name="creating-prefixed-key-vault-secrets-and-loading-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="fa20e-159">Vytvoření tajných klíčů předponou trezoru klíčů a načítání hodnoty konfigurace (klíč název předpona – ukázka)</span><span class="sxs-lookup"><span data-stu-id="fa20e-159">Creating prefixed key vault secrets and loading configuration values (key-name-prefix-sample)</span></span>
<span data-ttu-id="fa20e-160">`AddAzureKeyVault`také poskytuje přetížení, které přijímá implementace `IKeyVaultSecretManager`, která umožňuje řídit způsob klíče tajné klíče trezoru se převedou na konfigurační klíče.</span><span class="sxs-lookup"><span data-stu-id="fa20e-160">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="fa20e-161">Například můžete implementovat rozhraní načíst tajný hodnot na základě předpony hodnoty, které poskytnete při spuštění aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-161">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="fa20e-162">To vám například umožňuje načíst tajné klíče založené na verzi aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-162">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="fa20e-163">Nepoužívejte předpony na tajné klíče trezoru klíčů, umístit do stejné trezoru klíčů tajné klíče pro víc aplikací nebo umístit prostředí tajné klíče (například *vývoj* verus *produkční* tajné klíče) do stejné trezor.</span><span class="sxs-lookup"><span data-stu-id="fa20e-163">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* verus *production* secrets) into the same vault.</span></span> <span data-ttu-id="fa20e-164">Doporučujeme různé aplikace a vývoj nebo produkční prostředí použít samostatné trezorů klíčů izolovat aplikace prostředí pro nejvyšší úroveň zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="fa20e-164">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="fa20e-165">Pomocí druhého ukázkovou aplikaci, vytvořte tajný klíč v trezoru klíčů pro `5000-AppSecret` (tečky nejsou povoleny v trezoru klíčů názvů tajných klíčů) představující tajný klíč aplikace pro 5.0.0.0 verzi vaší aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-165">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="fa20e-166">Pro jinou verzi, 5.1.0.0, vytvoříte tajný klíč pro `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-166">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="fa20e-167">Jednotlivé verze aplikace načítá vlastní tajná hodnota do jeho konfiguraci jako `AppSecret`, vypuzovacího vypnout verze načtenou tajný klíč.</span><span class="sxs-lookup"><span data-stu-id="fa20e-167">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="fa20e-168">Implementace tohoto příkladu je zobrazena níže:</span><span class="sxs-lookup"><span data-stu-id="fa20e-168">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=12)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="fa20e-169">`Load` Metoda je volána algoritmem zprostředkovatele, který iteruje tajné klíče trezoru najít ty, které mají předponu verze.</span><span class="sxs-lookup"><span data-stu-id="fa20e-169">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="fa20e-170">Když najde předponu verze s `Load`, používá algoritmus `GetKey` metoda vrátí název konfigurace tajný název.</span><span class="sxs-lookup"><span data-stu-id="fa20e-170">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="fa20e-171">Ji odstraní vypnout předponu verze z názvu tajného klíče a vrátí zbytek tajný název pro načítání do konfigurace aplikace dvojice název hodnota.</span><span class="sxs-lookup"><span data-stu-id="fa20e-171">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="fa20e-172">Při implementaci tohoto přístupu:</span><span class="sxs-lookup"><span data-stu-id="fa20e-172">When you implement this approach:</span></span>

1. <span data-ttu-id="fa20e-173">Tajné klíče trezoru klíčů jsou načteny.</span><span class="sxs-lookup"><span data-stu-id="fa20e-173">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="fa20e-174">Řetězec tajný klíč pro `5000-AppSecret` je nalezena shoda.</span><span class="sxs-lookup"><span data-stu-id="fa20e-174">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="fa20e-175">Verze, `5000` (s pomlčkou), se odstraní z název klíče a `AppSecret` načtení s tajná hodnota do konfigurace aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-175">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="fa20e-176">Můžete taky zadat vlastní `KeyVaultClient` implementace k `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-176">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="fa20e-177">Zadávání vlastního klienta můžete sdílet jednu instanci klienta mezi zprostředkovatele konfigurace a dalších částí vaší aplikace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-177">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="fa20e-178">Vytvoření trezoru klíčů a nastavení Azure Active Directory (Azure AD) pro aplikaci následující pokyny v [Začínáme s Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="fa20e-178">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="fa20e-179">Přidat tajné klíče do trezoru klíčů pomocí [modulu PowerShell trezoru klíč AzureRM](/powershell/module/azurerm.keyvault) dostupné z [Galerie prostředí PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), [REST API služby Azure Key Vault](/rest/api/keyvault/), nebo [Portál azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="fa20e-179">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="fa20e-180">Tajné klíče byly vytvořeny jako buď *ruční* nebo *certifikát* tajných klíčů.</span><span class="sxs-lookup"><span data-stu-id="fa20e-180">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="fa20e-181">*Certifikát* tajné klíče jsou certifikáty používané aplikace a služby, ale nejsou podporovány ve zprostředkovateli konfigurace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-181">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="fa20e-182">Měli byste použít *ruční* možnost vytvořit tajné klíče dvojice název hodnota pro použití se zprostředkovatelem konfigurace.</span><span class="sxs-lookup"><span data-stu-id="fa20e-182">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="fa20e-183">Hierarchická hodnoty (konfigurační oddíly) použijte `--` (dvě pomlčky) jako oddělovač.</span><span class="sxs-lookup"><span data-stu-id="fa20e-183">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
    * <span data-ttu-id="fa20e-184">Vytvořte dvě *ruční* tajných klíčů s následující páry název hodnota:</span><span class="sxs-lookup"><span data-stu-id="fa20e-184">Create two *Manual* secrets with the following name-value pairs:</span></span>
      * <span data-ttu-id="fa20e-185">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="fa20e-185">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
      * <span data-ttu-id="fa20e-186">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="fa20e-186">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
  * <span data-ttu-id="fa20e-187">Ukázková aplikace zaregistrujte v Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="fa20e-187">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="fa20e-188">Autorizovat aplikaci pro přístup k trezoru klíčů.</span><span class="sxs-lookup"><span data-stu-id="fa20e-188">Authorize the app to access the key vault.</span></span> <span data-ttu-id="fa20e-189">Při použití `Set-AzureRmKeyVaultAccessPolicy` rutiny prostředí PowerShell autorizovat aplikaci pro přístup k trezoru klíčů, zadejte `List` a `Get` přístup k tajných klíčů s `-PermissionsToKeys list,get`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-189">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToKeys list,get`.</span></span>
2. <span data-ttu-id="fa20e-190">Aktualizace aplikace služby *appSettings.JSON určený* souboru s hodnotami `Vault`, `ClientId`, a `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-190">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="fa20e-191">Spuštění ukázkové aplikace, která získává jeho hodnoty konfigurace z `IConfigurationRoot` se stejným názvem jako předponou tajný název.</span><span class="sxs-lookup"><span data-stu-id="fa20e-191">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="fa20e-192">V této ukázce předponu je verze aplikace, která jste zadali na `PrefixKeyVaultSecretManager` když jste přidali poskytovatel konfigurace Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="fa20e-192">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="fa20e-193">Hodnota `AppSecret` se získávají pomocí `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-193">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="fa20e-194">Webová stránka generované aplikace zobrazuje načíst hodnotu:</span><span class="sxs-lookup"><span data-stu-id="fa20e-194">The webpage generated by the app shows the loaded value:</span></span>

   ![Okno prohlížeče zobrazující tajná hodnota načíst prostřednictvím poskytovatele konfigurace Azure klíč trezoru, pokud je 5.0.0.0 verze aplikace](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="fa20e-196">Změna verze sestavení aplikace v souboru projektu z `5.0.0.0` k `5.1.0.0` a znovu spusťte aplikaci.</span><span class="sxs-lookup"><span data-stu-id="fa20e-196">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="fa20e-197">Tato doba tajná hodnota vrácená je `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-197">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="fa20e-198">Webová stránka generované aplikace zobrazuje načíst hodnotu:</span><span class="sxs-lookup"><span data-stu-id="fa20e-198">The webpage generated by the app shows the loaded value:</span></span>

   ![Okno prohlížeče zobrazující tajná hodnota načíst prostřednictvím poskytovatele konfigurace Azure klíč trezoru, pokud je 5.1.0.0 verze aplikace](key-vault-configuration/_static/sample2-2.png)

## <a name="controlling-access-to-the-clientsecret"></a><span data-ttu-id="fa20e-200">Řízení přístupu ke ClientSecret</span><span class="sxs-lookup"><span data-stu-id="fa20e-200">Controlling access to the ClientSecret</span></span>
<span data-ttu-id="fa20e-201">Použití [nástroj tajný klíč správce](xref:security/app-secrets) udržovat `ClientSecret` mimo vašeho projektu zdroj stromu.</span><span class="sxs-lookup"><span data-stu-id="fa20e-201">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="fa20e-202">Pomocí nástroje Správce tajný klíč, můžete přidružit konkrétní projekt tajné klíče aplikace a sdílet je ve více projektech.</span><span class="sxs-lookup"><span data-stu-id="fa20e-202">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="fa20e-203">Při vývoji aplikace rozhraní .NET Framework v prostředí, které podporuje certifikáty, můžete ověřovat do Azure Key Vault společně s certifikátem X.509.</span><span class="sxs-lookup"><span data-stu-id="fa20e-203">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="fa20e-204">Privátní klíč certifikátu X.509 spravuje operačního systému.</span><span class="sxs-lookup"><span data-stu-id="fa20e-204">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="fa20e-205">Další informace najdete v tématu [ověřit pomocí certifikátu místo tajný klíč klienta](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="fa20e-205">For more information, see [Authenticate with a Certificate instead of a Client Secret](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="fa20e-206">Použití `AddAzureKeyVault` přetížení, které přijímá `X509Certificate2`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-206">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2`.</span></span>

```csharp
var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates.Find(X509FindType.FindByThumbprint, config["CertificateThumbprint"], false);

builder.AddAzureKeyVault(
    config["Vault"],
    config["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(env.ApplicationName));
store.Close();

Configuration = builder.Build();
```

## <a name="reloading-secrets"></a><span data-ttu-id="fa20e-207">Opětovné načtení tajné klíče</span><span class="sxs-lookup"><span data-stu-id="fa20e-207">Reloading secrets</span></span>
<span data-ttu-id="fa20e-208">Tajné klíče ukládají do mezipaměti, dokud `IConfigurationRoot.Reload()` je volána.</span><span class="sxs-lookup"><span data-stu-id="fa20e-208">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="fa20e-209">Platnost vypršela, zakázané, a aplikace, dokud nejsou dodržovány aktualizované tajných klíčů v trezoru klíčů `Reload` se spustí.</span><span class="sxs-lookup"><span data-stu-id="fa20e-209">Expired, disabled, and updated secrets in the key vault are not respected by the application until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="fa20e-210">Zakázaná a vypršela platnost tajné klíče</span><span class="sxs-lookup"><span data-stu-id="fa20e-210">Disabled and expired secrets</span></span>
<span data-ttu-id="fa20e-211">Throw tajných klíčů zakázaná a vypršela platnost `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="fa20e-211">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="fa20e-212">Abyste zabránili vyvolání aplikace, nahraďte aplikace nebo aktualizovat zakázána nebo platnost tajný klíč.</span><span class="sxs-lookup"><span data-stu-id="fa20e-212">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="fa20e-213">Poradce při potížích</span><span class="sxs-lookup"><span data-stu-id="fa20e-213">Troubleshooting</span></span>
<span data-ttu-id="fa20e-214">Jakmile se aplikace se nepodaří načíst konfiguraci pomocí poskytovatele, chybová zpráva zapsány do [ASP.NET protokolování infrastruktury](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="fa20e-214">When the application fails to load configuration using the provider, an error message is written to the [ASP.NET Logging infrastructure](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="fa20e-215">Tyto podmínky zabrání konfiguraci z načítání:</span><span class="sxs-lookup"><span data-stu-id="fa20e-215">The following conditions will prevent configuration from loading:</span></span>
* <span data-ttu-id="fa20e-216">Aplikace v Azure Active Directory není správně nakonfigurován.</span><span class="sxs-lookup"><span data-stu-id="fa20e-216">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="fa20e-217">Trezor klíčů neexistuje v Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="fa20e-217">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="fa20e-218">Aplikace nemá oprávnění pro přístup k trezoru klíčů.</span><span class="sxs-lookup"><span data-stu-id="fa20e-218">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="fa20e-219">Zásady přístupu neobsahuje `Get` a `List` oprávnění.</span><span class="sxs-lookup"><span data-stu-id="fa20e-219">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="fa20e-220">V trezoru klíčů konfigurační data (dvojice název hodnota) je nesprávně s názvem, chybí, zakázána, nebo vypršela platnost.</span><span class="sxs-lookup"><span data-stu-id="fa20e-220">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="fa20e-221">Aplikace má nesprávný trezoru klíčů název (`Vault`), Id aplikace Azure AD (`ClientId`), nebo klíč služby Azure AD (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="fa20e-221">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="fa20e-222">Klíč služby Azure AD (`ClientSecret`) vypršela.</span><span class="sxs-lookup"><span data-stu-id="fa20e-222">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="fa20e-223">Konfigurační klíč (název) je nesprávný v aplikaci pro hodnotu, kterou se pokoušíte načíst.</span><span class="sxs-lookup"><span data-stu-id="fa20e-223">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="fa20e-224">Další zdroje</span><span class="sxs-lookup"><span data-stu-id="fa20e-224">Additional resources</span></span>
* [<span data-ttu-id="fa20e-225">Konfigurace</span><span class="sxs-lookup"><span data-stu-id="fa20e-225">Configuration</span></span>](xref:fundamentals/configuration/index)
* [<span data-ttu-id="fa20e-226">Microsoft Azure: Trezor klíčů</span><span class="sxs-lookup"><span data-stu-id="fa20e-226">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="fa20e-227">Microsoft Azure: Dokumentaci k trezoru klíčů</span><span class="sxs-lookup"><span data-stu-id="fa20e-227">Microsoft Azure: Key Vault Documentation</span></span>](https://docs.microsoft.com/azure/key-vault/)
* [<span data-ttu-id="fa20e-228">Klíče postup generování a přenos chráněných pomocí HSM pro Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="fa20e-228">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="fa20e-229">KeyVaultClient – třída</span><span class="sxs-lookup"><span data-stu-id="fa20e-229">KeyVaultClient Class</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
