---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Prevence útoků (proti útokům CSRF) padělání požadavku posílaného mezi weby v rozhraní ASP.NET Web API | Microsoft Docs
author: MikeWasson
description: Popisuje útoku (proti útokům CSRF) padělání požadavku posílaného mezi weby a jak provádět opatření proti proti útokům CSRF v rozhraní ASP.NET Web API.
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/12/2012
ms.topic: article
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5e7b24c697e0bb37f388341abd89609c76f6b64c
ms.sourcegitcommit: 356c8d394aaf384c834e9c90cabab43bfe36e063
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 06/26/2018
ms.locfileid: "36961234"
---
<a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-web-api"></a><span data-ttu-id="93e4a-103">Prevence útoků (proti útokům CSRF) padělání požadavku posílaného mezi weby v rozhraní ASP.NET Web API</span><span class="sxs-lookup"><span data-stu-id="93e4a-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET Web API</span></span>
====================
<span data-ttu-id="93e4a-104">podle [Wasson Jan](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="93e4a-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="93e4a-105">Proti útokům webů padělání požadavku (CSRF) je útok, kde škodlivé weby odešle požadavek na citlivé lokality, kde je uživatel momentálně přihlášen v</span><span class="sxs-lookup"><span data-stu-id="93e4a-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="93e4a-106">Tady je příklad útoku proti útokům CSRF:</span><span class="sxs-lookup"><span data-stu-id="93e4a-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="93e4a-107">Přihlášení uživatele do `www.example.com` ověřování pomocí formulářů.</span><span class="sxs-lookup"><span data-stu-id="93e4a-107">A user logs into `www.example.com` using forms authentication.</span></span>
2. <span data-ttu-id="93e4a-108">Server ověřuje uživatele.</span><span class="sxs-lookup"><span data-stu-id="93e4a-108">The server authenticates the user.</span></span> <span data-ttu-id="93e4a-109">Odpověď ze serveru obsahuje soubor cookie ověřování.</span><span class="sxs-lookup"><span data-stu-id="93e4a-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="93e4a-110">Bez protokolování uživatel navštíví škodlivý web.</span><span class="sxs-lookup"><span data-stu-id="93e4a-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="93e4a-111">Tento škodlivý lokalita obsahuje následující formuláře HTML:</span><span class="sxs-lookup"><span data-stu-id="93e4a-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="93e4a-112">Všimněte si, že akce formuláře požadavky na server, snadno napadnutelný, aby škodlivé weby.</span><span class="sxs-lookup"><span data-stu-id="93e4a-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="93e4a-113">Toto je část "webů" proti útokům CSRF.</span><span class="sxs-lookup"><span data-stu-id="93e4a-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="93e4a-114">Uživatel kliknutím na tlačítko pro odeslání.</span><span class="sxs-lookup"><span data-stu-id="93e4a-114">The user clicks the submit button.</span></span> <span data-ttu-id="93e4a-115">V prohlížeči zahrnuje ověřovacího souboru cookie s požadavkem.</span><span class="sxs-lookup"><span data-stu-id="93e4a-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="93e4a-116">Žádost se spustí na serveru s kontext ověřování uživatele a dělat vše, co ověřený uživatel může provádět.</span><span class="sxs-lookup"><span data-stu-id="93e4a-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="93e4a-117">I když tento příklad vyžaduje, aby uživatel klepnutím na tlačítko formuláře, na stránce škodlivého může stejným způsobem jako snadno spustit skript, který automaticky odešle formulář.</span><span class="sxs-lookup"><span data-stu-id="93e4a-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="93e4a-118">Kromě toho pomocí protokolu SSL nebrání útoku proti útokům CSRF protože škodlivé weby můžete odeslat požadavek "https://".</span><span class="sxs-lookup"><span data-stu-id="93e4a-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="93e4a-119">Obvykle je možné proti webové stránky, které používají soubory cookie pro ověřování, proti útokům CSRF útokům, protože prohlížeče odesílají všechny relevantní soubory cookie k cílovému webu.</span><span class="sxs-lookup"><span data-stu-id="93e4a-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="93e4a-120">Útoky proti útokům CSRF však nejsou omezeny na zneužitím soubory cookie.</span><span class="sxs-lookup"><span data-stu-id="93e4a-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="93e4a-121">Ověřování Basic a Digest jsou například také snadno napadnutelný.</span><span class="sxs-lookup"><span data-stu-id="93e4a-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="93e4a-122">Po přihlášení uživatele pomocí ověřování Basic nebo ověřování hodnotou hash.</span><span class="sxs-lookup"><span data-stu-id="93e4a-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="93e4a-123">v prohlížeči automaticky odesílá přihlašovací údaje, dokud ukončení relace.</span><span class="sxs-lookup"><span data-stu-id="93e4a-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="93e4a-124">Tokeny proti zfalšování</span><span class="sxs-lookup"><span data-stu-id="93e4a-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="93e4a-125">Aby se zabránilo útokům proti útokům CSRF, ASP.NET MVC používá tokeny proti zfalšování, označované taky jako *žádosti o ověření tokeny*.</span><span class="sxs-lookup"><span data-stu-id="93e4a-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="93e4a-126">Klient požádá o stránku HTML, který obsahuje formuláře.</span><span class="sxs-lookup"><span data-stu-id="93e4a-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="93e4a-127">Server obsahuje dva tokeny v odpovědi.</span><span class="sxs-lookup"><span data-stu-id="93e4a-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="93e4a-128">Jeden token se odešle jako soubor cookie.</span><span class="sxs-lookup"><span data-stu-id="93e4a-128">One token is sent as a cookie.</span></span> <span data-ttu-id="93e4a-129">Druhá je umístěn v skryté pole formuláře.</span><span class="sxs-lookup"><span data-stu-id="93e4a-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="93e4a-130">Tokeny jsou generovány náhodně tak, aby nežádoucí osoba nelze snadno uhodnout hodnoty.</span><span class="sxs-lookup"><span data-stu-id="93e4a-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="93e4a-131">Když klient odešle formulář, je potřeba poslat oba tokeny zpět na server.</span><span class="sxs-lookup"><span data-stu-id="93e4a-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="93e4a-132">Klient odešle token souboru cookie jako soubor cookie a odešle token formuláře uvnitř data formuláře.</span><span class="sxs-lookup"><span data-stu-id="93e4a-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="93e4a-133">(Klientský prohlížeč automaticky to provede, když uživatel odešle formulář.)</span><span class="sxs-lookup"><span data-stu-id="93e4a-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="93e4a-134">Pokud žádost neobsahuje oba tokeny, zakáže server žádost.</span><span class="sxs-lookup"><span data-stu-id="93e4a-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="93e4a-135">Tady je příklad formuláře HTML s tokenem skrytého:</span><span class="sxs-lookup"><span data-stu-id="93e4a-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="93e4a-136">Tokeny proti zfalšování fungovat, protože škodlivý stránky nelze přečíst tokeny uživatele z důvodu zásad stejného původu.</span><span class="sxs-lookup"><span data-stu-id="93e4a-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="93e4a-137">([Zásady stejného původu](http://www.w3.org/Security/wiki/Same_Origin_Policy) zabránit dokumenty, které jsou hostované na dvou různých lokalit v přístupu k obsahu druhé strany.</span><span class="sxs-lookup"><span data-stu-id="93e4a-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="93e4a-138">Proto v předchozím příkladu škodlivé stránky mohou odesílat žádosti example.com, ale nelze přečíst odpověď.)</span><span class="sxs-lookup"><span data-stu-id="93e4a-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="93e4a-139">Chcete zabránit útokům proti útokům CSRF, použijte tokeny proti zfalšování s libovolný protokol pro ověřování, kde bezobslužně prohlížeč odesílá přihlašovací údaje po přihlášení uživatele.</span><span class="sxs-lookup"><span data-stu-id="93e4a-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="93e4a-140">To zahrnuje protokoly ověřování na základě souborů cookie, jako je například ověřování pomocí formulářů, a také protokoly, jako je například ověřování Basic a Digest.</span><span class="sxs-lookup"><span data-stu-id="93e4a-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="93e4a-141">Pro žádné nonsafe metody (POST, PUT, DELETE) byste měli vyžadovat tokeny proti zfalšování.</span><span class="sxs-lookup"><span data-stu-id="93e4a-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="93e4a-142">Taky se ujistěte, že bezpečné metody (GET, HEAD) nemají žádné vedlejší účinky.</span><span class="sxs-lookup"><span data-stu-id="93e4a-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="93e4a-143">Kromě toho pokud povolíte podporu mezi doménami, například CORS nebo JSONP, pak i bezpečné metody, třeba GET jsou potenciálně bude zranitelný vůči útoku proti útokům CSRF se mu umožní načíst potenciálně citlivá data.</span><span class="sxs-lookup"><span data-stu-id="93e4a-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="93e4a-144">Tokeny proti zfalšování v architektuře ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="93e4a-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="93e4a-145">Přidat tokeny proti zfalšování na stránku Razor, použijte **HtmlHelper.AntiForgeryToken** pomocnou metodu:</span><span class="sxs-lookup"><span data-stu-id="93e4a-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="93e4a-146">Tato metoda přidá skryté pole formuláře a také nastaví token souboru cookie.</span><span class="sxs-lookup"><span data-stu-id="93e4a-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="93e4a-147">Ochrana proti útokům CSRF a AJAX</span><span class="sxs-lookup"><span data-stu-id="93e4a-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="93e4a-148">Tokenu formuláře může být problém pro požadavky AJAX, protože požadavek AJAX může odesílat data JSON, ne data formuláře HTML.</span><span class="sxs-lookup"><span data-stu-id="93e4a-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="93e4a-149">Jedno řešení je odeslat tokenů v vlastní hlavičku HTTP.</span><span class="sxs-lookup"><span data-stu-id="93e4a-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="93e4a-150">Následující kód používá syntaxi Razor ke generování tokenů a potom přidá tokenů na požadavek AJAX.</span><span class="sxs-lookup"><span data-stu-id="93e4a-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="93e4a-151">Tokeny jsou generovány na serveru voláním **AntiForgery.GetTokens**.</span><span class="sxs-lookup"><span data-stu-id="93e4a-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="93e4a-152">Při zpracovávání požadavku extrahuje tokeny z hlaviček požadavku.</span><span class="sxs-lookup"><span data-stu-id="93e4a-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="93e4a-153">Potom zavolejte **AntiForgery.Validate** metodu za účelem ověření tokenů.</span><span class="sxs-lookup"><span data-stu-id="93e4a-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="93e4a-154">**Ověřením** metoda vyvolá výjimku, pokud tokeny nejsou platné.</span><span class="sxs-lookup"><span data-stu-id="93e4a-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
