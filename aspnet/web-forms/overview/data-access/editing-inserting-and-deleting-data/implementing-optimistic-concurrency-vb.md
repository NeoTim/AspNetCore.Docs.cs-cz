---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
title: "Implementace optimistickou metodu souběžného (VB) | Microsoft Docs"
author: rick-anderson
description: "Pro webovou aplikaci, která umožňuje více uživatelům upravovat data existuje riziko, že dva uživatele může být úpravy stejná data ve stejnou dobu. V této tutori..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 07/17/2006
ms.topic: article
ms.assetid: 2646968c-2826-4418-b1d0-62610ed177e3
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
msc.type: authoredcontent
ms.openlocfilehash: a31ce101c3264d10ec80a45718d9222fc18c093c
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 01/24/2018
---
<a name="implementing-optimistic-concurrency-vb"></a><span data-ttu-id="a9a9f-104">Implementace optimistickou metodu souběžného (VB)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-104">Implementing Optimistic Concurrency (VB)</span></span>
====================
<span data-ttu-id="a9a9f-105">podle [Scott Meisnerová](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="a9a9f-106">[Stáhněte si ukázkovou aplikaci](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) nebo [stáhnout PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-106">[Download Sample App](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) or [Download PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span></span>

> <span data-ttu-id="a9a9f-107">Pro webovou aplikaci, která umožňuje více uživatelům upravovat data existuje riziko, že dva uživatele může být úpravy stejná data ve stejnou dobu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-107">For a web application that allows multiple users to edit data, there is the risk that two users may be editing the same data at the same time.</span></span> <span data-ttu-id="a9a9f-108">V tomto kurzu jsme budete implementovat řízení optimistickou metodu souběžného zpracování toto riziko.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-108">In this tutorial we'll implement optimistic concurrency control to handle this risk.</span></span>


## <a name="introduction"></a><span data-ttu-id="a9a9f-109">Úvod</span><span class="sxs-lookup"><span data-stu-id="a9a9f-109">Introduction</span></span>

<span data-ttu-id="a9a9f-110">Pro webové aplikace, které pouze povolit uživatelům zobrazit data, nebo pro ty, které zahrnují jenom jeden uživatel, který může měnit data neexistují hrozby dvou souběžných uživatelů náhodnému přepsání své změny.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-110">For web applications that only allow users to view data, or for those that include only a single user who can modify data, there's no threat of two concurrent users accidentally overwriting one another's changes.</span></span> <span data-ttu-id="a9a9f-111">Pro webové aplikace, které umožňují více uživatelům aktualizovat nebo odstranit data ale není potenciálně pro jednoho uživatele úpravy kolidovat s jinou souběžnou uživatele.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-111">For web applications that allow multiple users to update or delete data, however, there's the potential for one user's modifications to clash with another concurrent user's.</span></span> <span data-ttu-id="a9a9f-112">Bez žádné zásady souběžnosti na místě Pokud dva uživatelé jsou úpravy současně jeden záznam, uživatele, který potvrdí její změny poslední přepíše změny provedené při první.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-112">Without any concurrency policy in place, when two users are simultaneously editing a single record, the user who commits her changes last will override the changes made by the first.</span></span>

<span data-ttu-id="a9a9f-113">Představte si například, že dva uživatelé, Jisun a Sam, byly obě návštěvou stránky v naší aplikaci, která povolena návštěvníky aktualizovat a odstraňovat produkty pomocí ovládacího prvku GridView.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-113">For example, imagine that two users, Jisun and Sam, were both visiting a page in our application that allowed visitors to update and delete the products through a GridView control.</span></span> <span data-ttu-id="a9a9f-114">Obě klikněte na tlačítko Upravit v GridView přibližně ve stejnou dobu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-114">Both click the Edit button in the GridView around the same time.</span></span> <span data-ttu-id="a9a9f-115">Jisun změny názvu produktu "Chai čaj" a kliknutím na tlačítko Aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-115">Jisun changes the product name to "Chai Tea" and clicks the Update button.</span></span> <span data-ttu-id="a9a9f-116">Net výsledkem je `UPDATE` příkaz, který je odeslal do databáze, která nastaví *všechny* aktualizovatelné polí produktu (i když Jisun aktualizuje jenom jedno pole `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-116">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product's updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="a9a9f-117">V tuto chvíli databáze má hodnoty "Chai čaj," kategorie Nápoje dodavatele exotické kapaliny pro tento konkrétní produkt a tak dále.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-117">At this point in time, the database has the values "Chai Tea," the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="a9a9f-118">Však GridView na obrazovce Sam je stále zobrazena název produktu upravovat řádku GridView jako "Chai".</span><span class="sxs-lookup"><span data-stu-id="a9a9f-118">However, the GridView on Sam's screen still shows the product name in the editable GridView row as "Chai".</span></span> <span data-ttu-id="a9a9f-119">Několik sekund poté, co je Jisun změny byly potvrzeny, Sam aktualizace kategorie přísady a klikne na tlačítko Aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-119">A few seconds after Jisun's changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="a9a9f-120">To vede `UPDATE` příkaz odeslal do databáze, která nastaví název produktu a "Chai," `CategoryID` na odpovídající ID kategorie Nápoje a tak dále.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-120">This results in an `UPDATE` statement sent to the database that sets the product name to "Chai," the `CategoryID` to the corresponding Beverages category ID, and so on.</span></span> <span data-ttu-id="a9a9f-121">Být přepsán Jisun na změny v názvu produktu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-121">Jisun's changes to the product name have been overwritten.</span></span> <span data-ttu-id="a9a9f-122">Obrázek 1 graficky znázorňuje tuto řadu událostí.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-122">Figure 1 graphically depicts this series of events.</span></span>


<span data-ttu-id="a9a9f-123">[![Když dva uživatelé současně aktualizovat záznamů tam s potenciální pro jednoho uživatele změny přepsat jiného](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-123">[![When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span></span>

<span data-ttu-id="a9a9f-124">**Obrázek 1**: Pokud dva uživatelé současně aktualizovat existuje záznam s potenciální pro jeden uživatel změní na přepsání jiného ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-124">**Figure 1**: When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image3.png))</span></span>


<span data-ttu-id="a9a9f-125">Podobně pokud dva uživatelé navštěvují stránky, jeden uživatel může být in the midst of aktualizace záznamu, když je odstraněn jiným uživatelem.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-125">Similarly, when two users are visiting a page, one user might be in the midst of updating a record when it is deleted by another user.</span></span> <span data-ttu-id="a9a9f-126">Nebo mezi načte, když uživatel na stránce a při jejich klikněte na tlačítko odstranit, může mít jiný uživatel upravil obsah daného záznamu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-126">Or, between when a user loads a page and when they click the Delete button, another user may have modified the contents of that record.</span></span>

<span data-ttu-id="a9a9f-127">Existují tři [Kontrola souběžnosti](http://en.wikipedia.org/wiki/Concurrency_control) strategií, které jsou k dispozici:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-127">There are three [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) strategies available:</span></span>

- <span data-ttu-id="a9a9f-128">**Nedělat nic** -li souběžných uživatelů změnit stejný záznam, umožní poslední potvrzení win (výchozí nastavení)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-128">**Do Nothing** -if concurrent users are modifying the same record, let the last commit win (the default behavior)</span></span>
- <span data-ttu-id="a9a9f-129">[**Optimistickou metodu souběžného** ](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) -předpokládají, která při pravděpodobně souběžnosti konfliktu every teď a potom valná většina času takové nedojde ke konfliktu; proto pokud dojde ke konfliktu, jednoduše informujte uživatele, který jejich změny nelze uložit, protože byl změněn jiným uživatelem stejná data</span><span class="sxs-lookup"><span data-stu-id="a9a9f-129">[**Optimistic Concurrency**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) - assume that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise; therefore, if a conflict does arise, simply inform the user that their changes can't be saved because another user has modified the same data</span></span>
- <span data-ttu-id="a9a9f-130">**Pesimistické souběžnosti** -předpokládají, že je v konfliktu souběžnosti jsou běžné a že uživatelé nebudou tolerovat vrácení sdělili, jejich změny nebyly uloženy z důvodu souběžných aktivity jiného uživatele; proto když jeden uživatel spustí aktualizaci záznamu, uzamknout , a zabrání všichni ostatní uživatelé z úpravy nebo odstranění záznamů, dokud uživatel potvrdí jejich úpravy</span><span class="sxs-lookup"><span data-stu-id="a9a9f-130">**Pessimistic Concurrency** - assume that concurrency conflicts are commonplace and that users won't tolerate being told their changes weren't saved due to another user's concurrent activity; therefore, when one user starts updating a record, lock it, thereby preventing any other users from editing or deleting that record until the user commits their modifications</span></span>

<span data-ttu-id="a9a9f-131">Všechny naše kurzy doposud použili výchozí strategie řešení souběžnosti – konkrétně, jsme jste mohli poslední zápis win.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-131">All of our tutorials thus far have used the default concurrency resolution strategy - namely, we've let the last write win.</span></span> <span data-ttu-id="a9a9f-132">V tomto kurzu podíváme, jak implementovat optimistické řízení souběžného.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-132">In this tutorial we'll examine how to implement optimistic concurrency control.</span></span>

> [!NOTE]
> <span data-ttu-id="a9a9f-133">Podíváme nebude na příklady pesimistické souběžnosti tento kurz řady.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-133">We won't look at pessimistic concurrency examples in this tutorial series.</span></span> <span data-ttu-id="a9a9f-134">Pesimistické souběžnosti je zřídka použít, protože například uzamkne, není-li správně uvolní, když, můžete zabránit aktualizace dat jiných uživatelů.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-134">Pessimistic concurrency is rarely used because such locks, if not properly relinquished, can prevent other users from updating data.</span></span> <span data-ttu-id="a9a9f-135">Například pokud je uživatel uzamkne záznam pro úpravy a odešel dne odemknutí ho, žádný jiný uživatel bude moct aktualizovat záznamů, dokud původního uživatele, vrátí a dokončí jeho aktualizaci.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-135">For example, if a user locks a record for editing and then leaves for the day before unlocking it, no other user will be able to update that record until the original user returns and completes his update.</span></span> <span data-ttu-id="a9a9f-136">Proto v situacích, kdy je použít pesimistické souběžnosti, je obvykle vypršení časového limitu, která, pokud je dosaženo, zruší zámek.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-136">Therefore, in situations where pessimistic concurrency is used, there's typically a timeout that, if reached, cancels the lock.</span></span> <span data-ttu-id="a9a9f-137">Lístek prodeje webů, ke kterým Zamknout umístění konkrétní zasedací krátkou dobu, když uživatel dokončí proces pořadí, je příkladem řízení pesimistické souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-137">Ticket sales websites, which lock a particular seating location for short period while the user completes the order process, is an example of pessimistic concurrency control.</span></span>


## <a name="step-1-looking-at-how-optimistic-concurrency-is-implemented"></a><span data-ttu-id="a9a9f-138">Krok 1: Prohlížení jak optimistickou metodu souběžného je implementována.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-138">Step 1: Looking at How Optimistic Concurrency is Implemented</span></span>

<span data-ttu-id="a9a9f-139">Optimistické řízení souběžného funguje tak, že zajistíte, že bude aktualizován nebo odstraněn záznam má stejné hodnoty, stejně jako při aktualizaci nebo odstranění proces spuštění.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-139">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="a9a9f-140">Například při kliknutí na tlačítko Upravit v upravitelné GridView hodnoty záznamu se přečíst z databáze a zobrazují v textových polí a jiných webových ovládacích prvků.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-140">For example, when clicking the Edit button in an editable GridView, the record's values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="a9a9f-141">Tyto původní hodnoty se uloží prostřednictvím GridView.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-141">These original values are saved by the GridView.</span></span> <span data-ttu-id="a9a9f-142">Později až uživatel provede jeho změny a kliknutím na tlačítko Aktualizovat, původní hodnoty a nové hodnoty se odesílají na vrstvu obchodní logiky a pak na Data Access Layer.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-142">Later, after the user makes her changes and clicks the Update button, the original values plus the new values are sent to the Business Logic Layer, and then down to the Data Access Layer.</span></span> <span data-ttu-id="a9a9f-143">Data Access Layer musíte vydat příkaz SQL, který bude pouze aktualizovat záznam, pokud původní hodnoty, které uživatel začali upravovat jsou identické s hodnotami stále v databázi.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-143">The Data Access Layer must issue a SQL statement that will only update the record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="a9a9f-144">Obrázek 2 znázorňuje posloupnosti událostí.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-144">Figure 2 depicts this sequence of events.</span></span>


<span data-ttu-id="a9a9f-145">[![Pro aktualizaci nebo odstranění úspěšné původní hodnoty musí být rovna aktuální hodnot v databázi](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-145">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span></span>

<span data-ttu-id="a9a9f-146">**Obrázek 2**: pro aktualizaci nebo odstranění hodnotu úspěch, původní hodnoty musí být rovna hodnot v aktuální databázi ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-146">**Figure 2**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image6.png))</span></span>


<span data-ttu-id="a9a9f-147">Existují různé přístupy k implementaci optimistickou metodu souběžného (najdete v části [Petr A. Bromberg](http://peterbromberg.net/)na [Optmistic souběžnosti aktualizace logiku](http://www.eggheadcafe.com/articles/20050719.asp) pro stručný pohled na řadu možností).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-147">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/)'s [Optmistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="a9a9f-148">Datová sada zadali ADO.NET poskytuje jeden implementace, která se dá nakonfigurovat s právě značek zaškrtávací políčko.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-148">The ADO.NET Typed DataSet provides one implementation that can be configured with just the tick of a checkbox.</span></span> <span data-ttu-id="a9a9f-149">Povolování TableAdapter v datové sadě zadali rozšiřuje TableAdapter optimistickou metodu souběžného `UPDATE` a `DELETE` příkazy, které chcete zahrnout všechny původní hodnoty v porovnání `WHERE` klauzule.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-149">Enabling optimistic concurrency for a TableAdapter in the Typed DataSet augments the TableAdapter's `UPDATE` and `DELETE` statements to include a comparison of all of the original values in the `WHERE` clause.</span></span> <span data-ttu-id="a9a9f-150">Následující `UPDATE` prohlášení, například aktualizace název a cena produktu pouze v případě, že jsou stejné hodnoty, které byly původně načteny při aktualizaci záznamu v GridView hodnot v aktuální databázi.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-150">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="a9a9f-151">`@ProductName` a `@UnitPrice` parametry obsahovat nové hodnoty zadané uživatelem, zatímco `@original_ProductName` a `@original_UnitPrice` obsahují hodnoty, které byly původně načíst do GridView, pokud bylo stisknuto tlačítko Upravit:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-151">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample1.sql)]

> [!NOTE]
> <span data-ttu-id="a9a9f-152">To `UPDATE` příkaz je jednodušší čitelnější.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-152">This `UPDATE` statement has been simplified for readability.</span></span> <span data-ttu-id="a9a9f-153">V praxi `UnitPrice` změnami `WHERE` klauzule by složitější od `UnitPrice` může obsahovat `NULL` s a probíhá kontrola, zda `NULL = NULL` vždy vrátí hodnotu False (místo toho musíte použít `IS NULL`).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-153">In practice, the `UnitPrice` check in the `WHERE` clause would be more involved since `UnitPrice` can contain `NULL` s and checking if `NULL = NULL` always returns False (instead you must use `IS NULL`).</span></span>


<span data-ttu-id="a9a9f-154">Kromě použití různých základní `UPDATE` prohlášení, konfigurace TableAdapter použít optimistickou metodu souběžného zpracování také upraví podpis jeho DB přímé metody.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-154">In addition to using a different underlying `UPDATE` statement, configuring a TableAdapter to use optimistic concurrency also modifies the signature of its DB direct methods.</span></span> <span data-ttu-id="a9a9f-155">Odvolat z našich první kurz [ *vytváření Data Access Layer*](../introduction/creating-a-data-access-layer-cs.md), přímé metody DB byly ty, které přijímá seznam skalárních hodnot jako vstupní parametry (místo DataRow silného typu nebo DataTable instance).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-155">Recall from our first tutorial, [*Creating a Data Access Layer*](../introduction/creating-a-data-access-layer-cs.md), that DB direct methods were those that accepts a list of scalar values as input parameters (rather than a strongly-typed DataRow or DataTable instance).</span></span> <span data-ttu-id="a9a9f-156">Při použití optimistickou metodu souběžného přímé DB `Update()` a `Delete()` metody patří vstupní parametry pro původní hodnoty.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-156">When using optimistic concurrency, the DB direct `Update()` and `Delete()` methods include input parameters for the original values as well.</span></span> <span data-ttu-id="a9a9f-157">Kromě toho kód v BLL pro používání dávky aktualizovat vzoru ( `Update()` přetížení metody, které přijímají DataRows a DataTables spíše než skalární hodnoty) je třeba změnit také.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-157">Moreover, the code in the BLL for using the batch update pattern (the `Update()` method overloads that accept DataRows and DataTables rather than scalar values) must be changed as well.</span></span>

<span data-ttu-id="a9a9f-158">Spíše než rozšířit naše stávající TableAdapters na DAL použít optimistickou metodu souběžného (které by vyžadovaly změnu BLL zohlednit), můžeme místo vytvořit novou zadali datovou sadu s názvem `NorthwindOptimisticConcurrency`, do které přidáme `Products` TableAdapter, používá optimistickou metodu souběžného.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-158">Rather than extend our existing DAL's TableAdapters to use optimistic concurrency (which would necessitate changing the BLL to accommodate), let's instead create a new Typed DataSet named `NorthwindOptimisticConcurrency`, to which we'll add a `Products` TableAdapter that uses optimistic concurrency.</span></span> <span data-ttu-id="a9a9f-159">Následující, vytvoříme `ProductsOptimisticConcurrencyBLL` třídy vrstvu obchodní logiky, která má odpovídající změny pro podporu optimistickou metodu souběžného DAL.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-159">Following that, we'll create a `ProductsOptimisticConcurrencyBLL` Business Logic Layer class that has the appropriate modifications to support the optimistic concurrency DAL.</span></span> <span data-ttu-id="a9a9f-160">Po této základ je uveden, jsme budete moci vytvořit stránku ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-160">Once this groundwork has been laid, we'll be ready to create the ASP.NET page.</span></span>

## <a name="step-2-creating-a-data-access-layer-that-supports-optimistic-concurrency"></a><span data-ttu-id="a9a9f-161">Krok 2: Vytvoření Data Access Layer, který podporuje optimistickou metodu souběžného zpracování</span><span class="sxs-lookup"><span data-stu-id="a9a9f-161">Step 2: Creating a Data Access Layer That Supports Optimistic Concurrency</span></span>

<span data-ttu-id="a9a9f-162">Pokud chcete vytvořit novou sadu dat zadali, klikněte pravým tlačítkem na `DAL` složky v rámci `App_Code` složky a přidat novou datovou sadu s názvem `NorthwindOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-162">To create a new Typed DataSet, right-click on the `DAL` folder within the `App_Code` folder and add a new DataSet named `NorthwindOptimisticConcurrency`.</span></span> <span data-ttu-id="a9a9f-163">Jak jsme viděli z prvního kurzu, to tak bude přidán nový TableAdapter typové datové sady automaticky spuštěním Průvodce konfigurací TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-163">As we saw in the first tutorial, doing so will add a new TableAdapter to the Typed DataSet, automatically launching the TableAdapter Configuration Wizard.</span></span> <span data-ttu-id="a9a9f-164">Na první obrazovce jsme se výzva k zadání databáze se připojit k - připojit ke stejné databázi Northwind pomocí `NORTHWNDConnectionString` nastavení z `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-164">In the first screen, we're prompted to specify the database to connect to - connect to the same Northwind database using the `NORTHWNDConnectionString` setting from `Web.config`.</span></span>


<span data-ttu-id="a9a9f-165">[![Připojení do stejné databáze Northwind](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-165">[![Connect to the Same Northwind Database](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span></span>

<span data-ttu-id="a9a9f-166">**Obrázek 3**: připojení k databázi Northwind stejné ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-166">**Figure 3**: Connect to the Same Northwind Database ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image9.png))</span></span>


<span data-ttu-id="a9a9f-167">V dalším kroku jsme se zobrazí výzva, jak zadávat dotazy na data: prostřednictvím příkazu SQL ad-hoc novou uložené procedury nebo existující uložené procedury.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-167">Next, we are prompted as to how to query the data: through an ad-hoc SQL statement, a new stored procedure, or an existing stored procedure.</span></span> <span data-ttu-id="a9a9f-168">Vzhledem k tomu, že jsme použili SQL dotazů ad-hoc v našem původní DAL, tuto možnost použijte zde také.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-168">Since we used ad-hoc SQL queries in our original DAL, use this option here as well.</span></span>


<span data-ttu-id="a9a9f-169">[![Zadejte Data načíst pomocí příkazu SQL Ad-Hoc](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-169">[![Specify the Data to Retrieve Using an Ad-Hoc SQL Statement](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span></span>

<span data-ttu-id="a9a9f-170">**Obrázek 4**: byla Data určena k načtení příkazu SQL Ad-Hoc ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-170">**Figure 4**: Specify the Data to Retrieve Using an Ad-Hoc SQL Statement ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image12.png))</span></span>


<span data-ttu-id="a9a9f-171">Na následující obrazovce zadejte příkaz jazyka SQL sloužící k načtení informací o produktu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-171">On the following screen, enter the SQL query to use to retrieve the product information.</span></span> <span data-ttu-id="a9a9f-172">Umožňuje použít přesný stejný dotaz SQL použít pro `Products` TableAdapter z našich původní DAL, která vrátí všechny `Product` sloupce společně s názvy dodavatele a kategorii produktu:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-172">Let's use the exact same SQL query used for the `Products` TableAdapter from our original DAL, which returns all of the `Product` columns along with the product's supplier and category names:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample2.sql)]


<span data-ttu-id="a9a9f-173">[![V původní DAL použít stejný dotaz SQL z produktů TableAdapter](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-173">[![Use the Same SQL Query from the Products TableAdapter in the Original DAL](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span></span>

<span data-ttu-id="a9a9f-174">**Obrázek 5**: použijte stejný dotaz SQL z `Products` TableAdapter v původní DAL ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-174">**Figure 5**: Use the Same SQL Query from the `Products` TableAdapter in the Original DAL ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image15.png))</span></span>


<span data-ttu-id="a9a9f-175">Než budete pokračovat na další obrazovce, klikněte na tlačítko Upřesnit možnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-175">Before moving onto the next screen, click the Advanced Options button.</span></span> <span data-ttu-id="a9a9f-176">Pokud chcete, aby tento ovládací prvek TableAdapter společnosti využívají optimistickou metodu souběžného, stačí zaškrtněte políčko "Použít optimistickou metodu souběžného".</span><span class="sxs-lookup"><span data-stu-id="a9a9f-176">To have this TableAdapter employ optimistic concurrency control, simply check the "Use optimistic concurrency" checkbox.</span></span>


<span data-ttu-id="a9a9f-177">[![Povolit optimistické řízení souběžného zpracování pomocí kontroluje &quot;použít optimistickou metodu souběžného&quot; zaškrtávací políčko](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-177">[![Enable Optimistic Concurrency Control by Checking the &quot;Use optimistic concurrency&quot; CheckBox](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span></span>

<span data-ttu-id="a9a9f-178">**Obrázek 6**: Povolit optimistické řízení souběžného zpracování zaškrtnutím políčka "Použít optimistickou metodu souběžného" ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-178">**Figure 6**: Enable Optimistic Concurrency Control by Checking the "Use optimistic concurrency" CheckBox ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image18.png))</span></span>


<span data-ttu-id="a9a9f-179">Nakonec označte, že TableAdapter by měl použít vzory přístupu k dat, které vyplnění DataTable i vrátit DataTable; také znamenat, že by se měl vytvořit přímé metody DB.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-179">Lastly, indicate that the TableAdapter should use the data access patterns that both fill a DataTable and return a DataTable; also indicate that the DB direct methods should be created.</span></span> <span data-ttu-id="a9a9f-180">Změňte název metody návratový DataTable vzor z GetData GetProducts, která zrcadlení názvů jsme použili v našem původní DAL.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-180">Change the method name for the Return a DataTable pattern from GetData to GetProducts, so as to mirror the naming conventions we used in our original DAL.</span></span>


<span data-ttu-id="a9a9f-181">[![Mít TableAdapter využívat všechny přístupové vzorce dat](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-181">[![Have the TableAdapter Utilize All Data Access Patterns](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span></span>

<span data-ttu-id="a9a9f-182">**Obrázek 7**: mít TableAdapter využívat všechny přístup vzorky dat ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-182">**Figure 7**: Have the TableAdapter Utilize All Data Access Patterns ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image21.png))</span></span>


<span data-ttu-id="a9a9f-183">Po dokončení průvodce bude obsahovat návrháře DataSet silného typu `Products` DataTable a TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-183">After completing the wizard, the DataSet Designer will include a strongly-typed `Products` DataTable and TableAdapter.</span></span> <span data-ttu-id="a9a9f-184">Za chvíli přejmenovat DataTable z `Products` k `ProductsOptimisticConcurrency`, což lze provést tak, že pravým tlačítkem myši na záhlaví DataTable a výběr přejmenovat v místní nabídce.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-184">Take a moment to rename the DataTable from `Products` to `ProductsOptimisticConcurrency`, which you can do by right-clicking on the DataTable's title bar and choosing Rename from the context menu.</span></span>


<span data-ttu-id="a9a9f-185">[![DataTable a TableAdapter byly přidány do typové datové sady](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-185">[![A DataTable and TableAdapter Have Been Added to the Typed DataSet](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span></span>

<span data-ttu-id="a9a9f-186">**Obrázek 8**: A DataTable a TableAdapter byly přidány do typové datové sady ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-186">**Figure 8**: A DataTable and TableAdapter Have Been Added to the Typed DataSet ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image24.png))</span></span>


<span data-ttu-id="a9a9f-187">Pro informace o rozdílech mezi `UPDATE` a `DELETE` dotazuje mezi `ProductsOptimisticConcurrency` TableAdapter (který se používá optimistickou metodu souběžného) a TableAdapter produktů, (který nepodporuje), klikněte na TableAdapter a přejít do okna vlastností.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-187">To see the differences between the `UPDATE` and `DELETE` queries between the `ProductsOptimisticConcurrency` TableAdapter (which uses optimistic concurrency) and the Products TableAdapter (which doesn't), click on the TableAdapter and go to the Properties window.</span></span> <span data-ttu-id="a9a9f-188">V `DeleteCommand` a `UpdateCommand` vlastnosti `CommandText` podvlastnosti uvidíte skutečné syntaxe SQL, která je odeslána do databáze, pokud jsou vyvolány DAL aktualizace nebo odstranění související metody.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-188">In the `DeleteCommand` and `UpdateCommand` properties' `CommandText` subproperties you can see the actual SQL syntax that is sent to the database when the DAL's update or delete-related methods are invoked.</span></span> <span data-ttu-id="a9a9f-189">Pro `ProductsOptimisticConcurrency` TableAdapter `DELETE` je použít příkaz:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-189">For the `ProductsOptimisticConcurrency` TableAdapter the `DELETE` statement used is:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample3.sql)]

<span data-ttu-id="a9a9f-190">Zatímco `DELETE` prohlášení TableAdapter produktu v našem původní DAL je mnohem jednodušší:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-190">Whereas the `DELETE` statement for the Product TableAdapter in our original DAL is the much simpler:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample4.sql)]

<span data-ttu-id="a9a9f-191">Jak můžete vidět, `WHERE` klauzuli v `DELETE` příkaz pro TableAdapter, který používá optimistickou metodu souběžného obsahuje porovnání mezi jednotlivými `Product` tabulka je existující hodnoty ve sloupcích a původní hodnoty v době Rutina GridView (nebo DetailsView nebo FormView) byl poslední naplněno.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-191">As you can see, the `WHERE` clause in the `DELETE` statement for the TableAdapter that uses optimistic concurrency includes a comparison between each of the `Product` table's existing column values and the original values at the time the GridView (or DetailsView or FormView) was last populated.</span></span> <span data-ttu-id="a9a9f-192">Od všech polí jinak než `ProductID`, `ProductName`, a `Discontinued` může mít `NULL` kontroly, další parametry a hodnoty jsou zahrnuty správně porovnat `NULL` hodnoty ve `WHERE` klauzule.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-192">Since all fields other than `ProductID`, `ProductName`, and `Discontinued` can have `NULL` values, additional parameters and checks are included to correctly compare `NULL` values in the `WHERE` clause.</span></span>

<span data-ttu-id="a9a9f-193">Jsme nebude přidávat žádné další DataTables optimistické datovou sadu souběžnosti povolené v tomto kurzu naší stránce s ASP.NET se poskytuje pouze aktualizace a odstranění informací o produktu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-193">We won't be adding any additional DataTables to the optimistic concurrency-enabled DataSet for this tutorial, as our ASP.NET page will only provide updating and deleting product information.</span></span> <span data-ttu-id="a9a9f-194">Ale ještě musíme přidat `GetProductByProductID(productID)` metodu `ProductsOptimisticConcurrency` TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-194">However, we do still need to add the `GetProductByProductID(productID)` method to the `ProductsOptimisticConcurrency` TableAdapter.</span></span>

<span data-ttu-id="a9a9f-195">K tomu, klikněte pravým tlačítkem na záhlaví TableAdapter (oblasti vpravo nahoře `Fill` a `GetProducts` metoda názvy) a v místní nabídce vyberte Přidat dotazu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-195">To accomplish this, right-click on the TableAdapter's title bar (the area right above the `Fill` and `GetProducts` method names) and choose Add Query from the context menu.</span></span> <span data-ttu-id="a9a9f-196">Tím se spustí Průvodce konfigurací dotazu TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-196">This will launch the TableAdapter Query Configuration Wizard.</span></span> <span data-ttu-id="a9a9f-197">Jak se naše TableAdapter počáteční konfigurace, opt k vytvoření `GetProductByProductID(productID)` metoda příkazu SQL ad-hoc (viz obrázek 4).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-197">As with our TableAdapter's initial configuration, opt to create the `GetProductByProductID(productID)` method using an ad-hoc SQL statement (see Figure 4).</span></span> <span data-ttu-id="a9a9f-198">Vzhledem k tomu `GetProductByProductID(productID)` metoda vrátí informace o konkrétní produkt, znamenat, že tento dotaz `SELECT` dotaz na typ, který vrací řádky.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-198">Since the `GetProductByProductID(productID)` method returns information about a particular product, indicate that this query is a `SELECT` query type that returns rows.</span></span>


<span data-ttu-id="a9a9f-199">[![Označit jako typ dotazu &quot;vyberte, které vrací řádky&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-199">[![Mark the Query Type as a &quot;SELECT which returns rows&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span></span>

<span data-ttu-id="a9a9f-200">**Obrázek 9**: označte typ dotazu jako "`SELECT` která vrací řádky" ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-200">**Figure 9**: Mark the Query Type as a "`SELECT` which returns rows" ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image27.png))</span></span>


<span data-ttu-id="a9a9f-201">Na další obrazovce jsme se výzva k dotazu SQL pro použití s výchozím dotazem TableAdapter předem načtený.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-201">On the next screen we're prompted for the SQL query to use, with the TableAdapter's default query pre-loaded.</span></span> <span data-ttu-id="a9a9f-202">Posílení existující dotaz Zahrnout klauzuli `WHERE ProductID = @ProductID`, jak je znázorněno na obrázku 10.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-202">Augment the existing query to include the clause `WHERE ProductID = @ProductID`, as shown in Figure 10.</span></span>


<span data-ttu-id="a9a9f-203">[![Přidat WHERE klauzule předem načtený dotaz vrátit záznam určitý produkt](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-203">[![Add a WHERE Clause to the Pre-Loaded Query to Return a Specific Product Record](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span></span>

<span data-ttu-id="a9a9f-204">**Obrázek 10**: přidání `WHERE` klauzule Pre-Loaded dotaz vrátit záznam konkrétní produktu ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-204">**Figure 10**: Add a `WHERE` Clause to the Pre-Loaded Query to Return a Specific Product Record ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image30.png))</span></span>


<span data-ttu-id="a9a9f-205">Nakonec, změňte názvy generované metoda k `FillByProductID` a `GetProductByProductID`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-205">Finally, change the generated method names to `FillByProductID` and `GetProductByProductID`.</span></span>


<span data-ttu-id="a9a9f-206">[![Přejmenujte metody FillByProductID a GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-206">[![Rename the Methods to FillByProductID and GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span></span>

<span data-ttu-id="a9a9f-207">**Obrázek 11**: přejmenovat metody k `FillByProductID` a `GetProductByProductID` ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-207">**Figure 11**: Rename the Methods to `FillByProductID` and `GetProductByProductID` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image33.png))</span></span>


<span data-ttu-id="a9a9f-208">Pomocí tohoto průvodce dokončení TableAdapter teď obsahuje dvě metody pro načítání dat: `GetProducts()`, která vrátí *všechny* produkty; a `GetProductByProductID(productID)`, která vrací zadaný produkt.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-208">With this wizard complete, the TableAdapter now contains two methods for retrieving data: `GetProducts()`, which returns *all* products; and `GetProductByProductID(productID)`, which returns the specified product.</span></span>

## <a name="step-3-creating-a-business-logic-layer-for-the-optimistic-concurrency-enabled-dal"></a><span data-ttu-id="a9a9f-209">Krok 3: Vytvoření vrstvy obchodní logiky pro optimistické DAL povoleno souběžnosti</span><span class="sxs-lookup"><span data-stu-id="a9a9f-209">Step 3: Creating a Business Logic Layer for the Optimistic Concurrency-Enabled DAL</span></span>

<span data-ttu-id="a9a9f-210">Naše stávající `ProductsBLL` třída obsahuje příklady použití dávková aktualizace i přímé vzory DB.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-210">Our existing `ProductsBLL` class has examples of using both the batch update and DB direct patterns.</span></span> <span data-ttu-id="a9a9f-211">`AddProduct` Metoda a `UpdateProduct` přetížení i pomocí vzoru aktualizace batch předávání v `ProductRow` instance TableAdapter aktualizační metody.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-211">The `AddProduct` method and `UpdateProduct` overloads both use the batch update pattern, passing in a `ProductRow` instance to the TableAdapter's Update method.</span></span> <span data-ttu-id="a9a9f-212">`DeleteProduct` Metody na druhé straně používá DB vzor přímé volání TableAdapter `Delete(productID)` metoda.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-212">The `DeleteProduct` method, on the other hand, uses the DB direct pattern, calling the TableAdapter's `Delete(productID)` method.</span></span>

<span data-ttu-id="a9a9f-213">S novým `ProductsOptimisticConcurrency` TableAdapter, databáze přímé metody teď vyžadují, aby původní hodnoty předán také v.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-213">With the new `ProductsOptimisticConcurrency` TableAdapter, the DB direct methods now require that the original values also be passed in.</span></span> <span data-ttu-id="a9a9f-214">Například `Delete` metoda očekává teď deset vstupní parametry: původní `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, a `Discontinued`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-214">For example, the `Delete` method now expects ten input parameters: the original `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, and `Discontinued`.</span></span> <span data-ttu-id="a9a9f-215">Používá hodnoty těchto dalších vstupních parametrů v `WHERE` klauzuli `DELETE` příkaz odeslal do databáze, pouze pokud hodnoty aktuální databáze mapování až původního odstranění zadaný záznam.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-215">It uses these additional input parameters' values in `WHERE` clause of the `DELETE` statement sent to the database, only deleting the specified record if the database's current values map up to the original ones.</span></span>

<span data-ttu-id="a9a9f-216">Při podpis metody pro TableAdapter `Update` metoda použita ve vzorku aktualizace batch se nezměnilo, kód potřebné k zaznamenání původní a novými hodnotami.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-216">While the method signature for the TableAdapter's `Update` method used in the batch update pattern hasn't changed, the code needed to record the original and new values has.</span></span> <span data-ttu-id="a9a9f-217">Proto místo pokusí použít optimistickou metodu povoleno souběžnosti DAL pomocí našich stávajících `ProductsBLL` třídy, vytvoříme novou třídu vrstvu obchodní logiky pro práci s naší nové DAL.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-217">Therefore, rather than attempt to use the optimistic concurrency-enabled DAL with our existing `ProductsBLL` class, let's create a new Business Logic Layer class for working with our new DAL.</span></span>

<span data-ttu-id="a9a9f-218">Přidejte třídu s názvem `ProductsOptimisticConcurrencyBLL` k `BLL` složky v rámci `App_Code` složky.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-218">Add a class named `ProductsOptimisticConcurrencyBLL` to the `BLL` folder within the `App_Code` folder.</span></span>


![Přidání třídy ProductsOptimisticConcurrencyBLL ke složce BLL](implementing-optimistic-concurrency-vb/_static/image34.png)

<span data-ttu-id="a9a9f-220">**Obrázek 12**: Přidat `ProductsOptimisticConcurrencyBLL` třídy ke složce BLL</span><span class="sxs-lookup"><span data-stu-id="a9a9f-220">**Figure 12**: Add the `ProductsOptimisticConcurrencyBLL` Class to the BLL Folder</span></span>


<span data-ttu-id="a9a9f-221">Dál přidejte následující kód, který `ProductsOptimisticConcurrencyBLL` třídy:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-221">Next, add the following code to the `ProductsOptimisticConcurrencyBLL` class:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample5.vb)]

<span data-ttu-id="a9a9f-222">Všimněte si použití `NorthwindOptimisticConcurrencyTableAdapters` příkaz nad spuštění deklaraci třídy.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-222">Note the using `NorthwindOptimisticConcurrencyTableAdapters` statement above the start of the class declaration.</span></span> <span data-ttu-id="a9a9f-223">`NorthwindOptimisticConcurrencyTableAdapters` Obor názvů obsahuje `ProductsOptimisticConcurrencyTableAdapter` třídy, která poskytuje metody DAL.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-223">The `NorthwindOptimisticConcurrencyTableAdapters` namespace contains the `ProductsOptimisticConcurrencyTableAdapter` class, which provides the DAL's methods.</span></span> <span data-ttu-id="a9a9f-224">Také před deklaraci třídy najdete `System.ComponentModel.DataObject` atribut, který se dá pokyn, chcete-li zahrnout této třídy v rozevíracím seznamu Průvodce ObjectDataSource Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-224">Also before the class declaration you'll find the `System.ComponentModel.DataObject` attribute, which instructs Visual Studio to include this class in the ObjectDataSource wizard's drop-down list.</span></span>

<span data-ttu-id="a9a9f-225">`ProductsOptimisticConcurrencyBLL`Na `Adapter` vlastnost poskytuje rychlý přístup k instanci `ProductsOptimisticConcurrencyTableAdapter` třídy a dodržuje způsobem používaným v našem původní BLL třídy (`ProductsBLL`, `CategoriesBLL`a tak dále).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-225">The `ProductsOptimisticConcurrencyBLL`'s `Adapter` property provides quick access to an instance of the `ProductsOptimisticConcurrencyTableAdapter` class, and follows the pattern used in our original BLL classes (`ProductsBLL`, `CategoriesBLL`, and so on).</span></span> <span data-ttu-id="a9a9f-226">Nakonec `GetProducts()` metoda provede jednoduché volání DAL `GetProducts()` metodu a vrátí `ProductsOptimisticConcurrencyDataTable` objekt naplněný `ProductsOptimisticConcurrencyRow` instance pro každý produkt záznam v databázi.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-226">Finally, the `GetProducts()` method simply calls down into the DAL's `GetProducts()` method and returns a `ProductsOptimisticConcurrencyDataTable` object populated with a `ProductsOptimisticConcurrencyRow` instance for each product record in the database.</span></span>

## <a name="deleting-a-product-using-the-db-direct-pattern-with-optimistic-concurrency"></a><span data-ttu-id="a9a9f-227">Odstranění produktu pomocí vzoru přímé DB optimistickou metodu souběžného zpracování</span><span class="sxs-lookup"><span data-stu-id="a9a9f-227">Deleting a Product Using the DB Direct Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="a9a9f-228">Při použití vzoru DB přímé proti DAL, který používá optimistickou metodu souběžného, musí být předán nové a původní hodnota metody.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-228">When using the DB direct pattern against a DAL that uses optimistic concurrency, the methods must be passed the new and original values.</span></span> <span data-ttu-id="a9a9f-229">Pro odstranění, nejsou žádné nové hodnoty, takže musí být předán pouze původní hodnoty.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-229">For deleting, there are no new values, so only the original values need be passed in.</span></span> <span data-ttu-id="a9a9f-230">V našem BLL potom jsme musí přijmout všechny původní parametrů jako vstupní parametry.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-230">In our BLL, then, we must accept all of the original parameters as input parameters.</span></span> <span data-ttu-id="a9a9f-231">Umožňuje mít `DeleteProduct` metoda v `ProductsOptimisticConcurrencyBLL` třída použít metodu přímé DB.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-231">Let's have the `DeleteProduct` method in the `ProductsOptimisticConcurrencyBLL` class use the DB direct method.</span></span> <span data-ttu-id="a9a9f-232">To znamená, že tato metoda je nutné provést ve všech polích data deset produktu jako vstupní parametry a předejte tyto vrstvy Dal, jak je znázorněno v následujícím kódu:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-232">This means that this method needs to take in all ten product data fields as input parameters, and pass these to the DAL, as shown in the following code:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample6.vb)]

<span data-ttu-id="a9a9f-233">Pokud původní hodnoty - hodnoty, které byly naposledy načtené do GridView (nebo DetailsView nebo FormView) - liší od hodnoty v databázi, když uživatel klikne na tlačítko Odstranit `WHERE` klauzule nebude shodovat se záznam v databázi a žádné záznamy nebude mít vliv.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-233">If the original values - those values that were last loaded into the GridView (or DetailsView or FormView) - differ from the values in the database when the user clicks the Delete button the `WHERE` clause won't match up with any database record and no records will be affected.</span></span> <span data-ttu-id="a9a9f-234">Proto TableAdapter `Delete` metoda vrátí `0` a BLL `DeleteProduct` metoda vrátí `false`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-234">Hence, the TableAdapter's `Delete` method will return `0` and the BLL's `DeleteProduct` method will return `false`.</span></span>

## <a name="updating-a-product-using-the-batch-update-pattern-with-optimistic-concurrency"></a><span data-ttu-id="a9a9f-235">Aktualizace produktu pomocí vzoru aktualizace Batch optimistickou metodu souběžného zpracování</span><span class="sxs-lookup"><span data-stu-id="a9a9f-235">Updating a Product Using the Batch Update Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="a9a9f-236">Jak jsme uvedli dříve, TableAdapter `Update` metoda pro vzor aktualizace batch se stejným podpisem metoda bez ohledu na to, zda je vzhledem k optimistickou metodu souběžného.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-236">As noted earlier, the TableAdapter's `Update` method for the batch update pattern has the same method signature regardless of whether or not optimistic concurrency is employed.</span></span> <span data-ttu-id="a9a9f-237">Konkrétně `Update` metoda očekává DataRow, pole DataRows, DataTable nebo typové datové sady.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-237">Namely, the `Update` method expects a DataRow, an array of DataRows, a DataTable, or a Typed DataSet.</span></span> <span data-ttu-id="a9a9f-238">Neexistují žádné další vstupní parametry pro zadání původní hodnoty.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-238">There are no additional input parameters for specifying the original values.</span></span> <span data-ttu-id="a9a9f-239">To je možné, protože DataTable uchovává informace o původní a upravené hodnoty pro jeho DataRow(s).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-239">This is possible because the DataTable keeps track of the original and modified values for its DataRow(s).</span></span> <span data-ttu-id="a9a9f-240">Když DAL problémy jeho `UPDATE` příkaz, `@original_ColumnName` parametry se naplní původní hodnoty DataRow, zatímco `@ColumnName` parametry se naplní DataRow změny hodnot.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-240">When the DAL issues its `UPDATE` statement, the `@original_ColumnName` parameters are populated with the DataRow's original values, whereas the `@ColumnName` parameters are populated with the DataRow's modified values.</span></span>

<span data-ttu-id="a9a9f-241">V `ProductsBLL` – třída (který se používá naše původní, optimistickou metodu souběžného zpracování DAL), při použití vzoru aktualizace batch aktualizovat informace o produktu našem kódu, provede následující posloupnost událostí:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-241">In the `ProductsBLL` class (which uses our original, non-optimistic concurrency DAL), when using the batch update pattern to update product information our code performs the following sequence of events:</span></span>

1. <span data-ttu-id="a9a9f-242">Přečtěte si informace o aktuální databáze produktu do `ProductRow` pomocí TableAdapter `GetProductByProductID(productID)` – metoda</span><span class="sxs-lookup"><span data-stu-id="a9a9f-242">Read the current database product information into a `ProductRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="a9a9f-243">Přiřazení nové hodnoty, které mají `ProductRow` instance z kroku 1</span><span class="sxs-lookup"><span data-stu-id="a9a9f-243">Assign the new values to the `ProductRow` instance from Step 1</span></span>
3. <span data-ttu-id="a9a9f-244">Volání TableAdapter `Update` předávání v případě metody `ProductRow` instance</span><span class="sxs-lookup"><span data-stu-id="a9a9f-244">Call the TableAdapter's `Update` method, passing in the `ProductRow` instance</span></span>

<span data-ttu-id="a9a9f-245">Toto pořadí kroků, ale nebude podporovat správně optimistickou metodu souběžného protože `ProductRow` zadané v kroku 1 je vyplněný přímo z databáze, což znamená, že původní hodnoty používané DataRow jsou ty, které momentálně existují v databáze a není na ty, které byly vázány na GridView na začátku procesu úprav.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-245">This sequence of steps, however, won't correctly support optimistic concurrency because the `ProductRow` populated in Step 1 is populated directly from the database, meaning that the original values used by the DataRow are those that currently exist in the database, and not those that were bound to the GridView at the start of the editing process.</span></span> <span data-ttu-id="a9a9f-246">Místo toho, když pomocí optimistickou metodu souběžného zpracování povolenou DAL, je potřeba změnit `UpdateProduct` přetížení metody použít následující kroky:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-246">Instead, when using an optimistic concurrency-enabled DAL, we need to alter the `UpdateProduct` method overloads to use the following steps:</span></span>

1. <span data-ttu-id="a9a9f-247">Přečtěte si informace o aktuální databáze produktu do `ProductsOptimisticConcurrencyRow` pomocí TableAdapter `GetProductByProductID(productID)` – metoda</span><span class="sxs-lookup"><span data-stu-id="a9a9f-247">Read the current database product information into a `ProductsOptimisticConcurrencyRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="a9a9f-248">Přiřazení *původní* hodnoty k `ProductsOptimisticConcurrencyRow` instance z kroku 1</span><span class="sxs-lookup"><span data-stu-id="a9a9f-248">Assign the *original* values to the `ProductsOptimisticConcurrencyRow` instance from Step 1</span></span>
3. <span data-ttu-id="a9a9f-249">Volání `ProductsOptimisticConcurrencyRow` instance `AcceptChanges()` metoda, která nastaví DataRow, že jeho aktuální hodnoty jsou "" původního</span><span class="sxs-lookup"><span data-stu-id="a9a9f-249">Call the `ProductsOptimisticConcurrencyRow` instance's `AcceptChanges()` method, which instructs the DataRow that its current values are the "original" ones</span></span>
4. <span data-ttu-id="a9a9f-250">Přiřazení *nové* hodnoty k `ProductsOptimisticConcurrencyRow` instance</span><span class="sxs-lookup"><span data-stu-id="a9a9f-250">Assign the *new* values to the `ProductsOptimisticConcurrencyRow` instance</span></span>
5. <span data-ttu-id="a9a9f-251">Volání TableAdapter `Update` předávání v případě metody `ProductsOptimisticConcurrencyRow` instance</span><span class="sxs-lookup"><span data-stu-id="a9a9f-251">Call the TableAdapter's `Update` method, passing in the `ProductsOptimisticConcurrencyRow` instance</span></span>

<span data-ttu-id="a9a9f-252">Krok 1 čtení ve všech hodnot v aktuální databázi pro záznam zadaná produktu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-252">Step 1 reads in all of the current database values for the specified product record.</span></span> <span data-ttu-id="a9a9f-253">Tento krok je nadbytečné v `UpdateProduct` přetížení, která aktualizuje *všechny* sloupců produktu (jako tyto hodnoty budou přepsána v kroku 2), ale je nezbytné pro tyto přetížení, kde jsou pouze podmnožinu hodnoty ve sloupcích předaná jako vstupní parametry.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-253">This step is superfluous in the `UpdateProduct` overload that updates *all* of the product columns (as these values are overwritten in Step 2), but is essential for those overloads where only a subset of the column values are passed in as input parameters.</span></span> <span data-ttu-id="a9a9f-254">Po přiřazení původní hodnoty `ProductsOptimisticConcurrencyRow` instance, `AcceptChanges()` metoda je volána, který označuje aktuální hodnoty DataRow jako původní hodnoty, které mají být používány `@original_ColumnName` parametry v `UPDATE` příkaz.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-254">Once the original values have been assigned to the `ProductsOptimisticConcurrencyRow` instance, the `AcceptChanges()` method is called, which marks the current DataRow values as the original values to be used in the `@original_ColumnName` parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="a9a9f-255">V dalším kroku nové hodnoty parametrů jsou přiřazeny k `ProductsOptimisticConcurrencyRow` a nakonec `Update` metoda je volána, předávání v DataRow.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-255">Next, the new parameter values are assigned to the `ProductsOptimisticConcurrencyRow` and, finally, the `Update` method is invoked, passing in the DataRow.</span></span>

<span data-ttu-id="a9a9f-256">Následující kód ukazuje `UpdateProduct` přetížení, které přijímá všechna data produktu polí jako vstupní parametry.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-256">The following code shows the `UpdateProduct` overload that accepts all product data fields as input parameters.</span></span> <span data-ttu-id="a9a9f-257">Když není tady, zobrazené `ProductsOptimisticConcurrencyBLL` třídy součástí staženého souboru pro tento kurz obsahuje také `UpdateProduct` přetížení, které přijímá jenom produktu název a cena jako vstupní parametry.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-257">While not shown here, the `ProductsOptimisticConcurrencyBLL` class included in the download for this tutorial also contains an `UpdateProduct` overload that accepts just the product's name and price as input parameters.</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample7.vb)]

## <a name="step-4-passing-the-original-and-new-values-from-the-aspnet-page-to-the-bll-methods"></a><span data-ttu-id="a9a9f-258">Krok 4: Předávání původní a novými hodnotami ze stránky ASP.NET BLL metody</span><span class="sxs-lookup"><span data-stu-id="a9a9f-258">Step 4: Passing the Original and New Values From the ASP.NET Page to the BLL Methods</span></span>

<span data-ttu-id="a9a9f-259">DAL a BLL dokončení zbývá vytvořit stránku ASP.NET, který můžete využít logice optimistickou metodu souběžného založená na systému.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-259">With the DAL and BLL complete, all that remains is to create an ASP.NET page that can utilize the optimistic concurrency logic built in to the system.</span></span> <span data-ttu-id="a9a9f-260">Konkrétně data ovládací prvek webu (GridView, DetailsView nebo FormView) musí mějte na paměti, že jeho původní hodnoty a ObjectDataSource musí projít obě sady hodnot pro vrstvu obchodní logiky.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-260">Specifically, the data Web control (the GridView, DetailsView, or FormView) must remember its original values and the ObjectDataSource must pass both sets of values to the Business Logic Layer.</span></span> <span data-ttu-id="a9a9f-261">Kromě toho musí být nakonfigurované stránku ASP.NET pro pohodlné zpracování porušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-261">Furthermore, the ASP.NET page must be configured to gracefully handle concurrency violations.</span></span>

<span data-ttu-id="a9a9f-262">Začněte otevřením `OptimisticConcurrency.aspx` stránku `EditInsertDelete` složky a přidání GridView návrháře nastavení jeho `ID` vlastnost, která má `ProductsGrid`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-262">Start by opening the `OptimisticConcurrency.aspx` page in the `EditInsertDelete` folder and adding a GridView to the Designer, setting its `ID` property to `ProductsGrid`.</span></span> <span data-ttu-id="a9a9f-263">Z prvku GridView inteligentních značek, opt k vytvoření nové ObjectDataSource s názvem `ProductsOptimisticConcurrencyDataSource`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-263">From the GridView's smart tag, opt to create a new ObjectDataSource named `ProductsOptimisticConcurrencyDataSource`.</span></span> <span data-ttu-id="a9a9f-264">Vzhledem k tomu, že chceme, aby tento ObjectDataSource používat DAL, který podporuje optimistickou metodu souběžného, nakonfigurujte ho na používání `ProductsOptimisticConcurrencyBLL` objektu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-264">Since we want this ObjectDataSource to use the DAL that supports optimistic concurrency, configure it to use the `ProductsOptimisticConcurrencyBLL` object.</span></span>


<span data-ttu-id="a9a9f-265">[![Mít použití ObjectDataSource ProductsOptimisticConcurrencyBLL objekt](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-265">[![Have the ObjectDataSource Use the ProductsOptimisticConcurrencyBLL Object](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span></span>

<span data-ttu-id="a9a9f-266">**Obrázek 13**: mít použití ObjectDataSource `ProductsOptimisticConcurrencyBLL` objektu ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-266">**Figure 13**: Have the ObjectDataSource Use the `ProductsOptimisticConcurrencyBLL` Object ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image37.png))</span></span>


<span data-ttu-id="a9a9f-267">Vyberte `GetProducts`, `UpdateProduct`, a `DeleteProduct` metody z rozevíracího seznamu v průvodci.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-267">Choose the `GetProducts`, `UpdateProduct`, and `DeleteProduct` methods from drop-down lists in the wizard.</span></span> <span data-ttu-id="a9a9f-268">Pro metodu UpdateProduct použijte přetížení, které přijímá všechna pole data produktu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-268">For the UpdateProduct method, use the overload that accepts all of the product's data fields.</span></span>

## <a name="configuring-the-objectdatasource-controls-properties"></a><span data-ttu-id="a9a9f-269">Konfigurace vlastností ovládacího prvku ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="a9a9f-269">Configuring the ObjectDataSource Control's Properties</span></span>

<span data-ttu-id="a9a9f-270">Po dokončení průvodce, ObjectDataSource deklarativní by měl vypadat následovně:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-270">After completing the wizard, the ObjectDataSource's declarative markup should look like the following:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample8.aspx)]

<span data-ttu-id="a9a9f-271">Jak je vidět `DeleteParameters` kolekce obsahuje `Parameter` instance pro každý deset vstupní parametry v `ProductsOptimisticConcurrencyBLL` třídy `DeleteProduct` metoda.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-271">As you can see, the `DeleteParameters` collection contains a `Parameter` instance for each of the ten input parameters in the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method.</span></span> <span data-ttu-id="a9a9f-272">Podobně `UpdateParameters` kolekce obsahuje `Parameter` instance pro každý vstupní parametry v `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-272">Likewise, the `UpdateParameters` collection contains a `Parameter` instance for each of the input parameters in `UpdateProduct`.</span></span>

<span data-ttu-id="a9a9f-273">Pro tyto předchozí návodů, které se podílejí úprava dat, doporučujeme odebrat ObjectDataSource `OldValuesParameterFormatString` vlastnost v tomto okamžiku, protože tato vlastnost určuje, že metoda BLL očekává staré (nebo původní) hodnoty, které mají být předán, jakož i s novými hodnotami.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-273">For those previous tutorials that involved data modification, we'd remove the ObjectDataSource's `OldValuesParameterFormatString` property at this point, since this property indicates that the BLL method expects the old (or original) values to be passed in as well as the new values.</span></span> <span data-ttu-id="a9a9f-274">Kromě toho tato vlastnost hodnota označuje názvy vstupních parametrů pro původní hodnoty.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-274">Furthermore, this property value indicates the input parameter names for the original values.</span></span> <span data-ttu-id="a9a9f-275">Vzhledem k tomu, že jsme se předávání do BLL v původní hodnoty, proveďte *není* odebrat tuto vlastnost.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-275">Since we are passing in the original values into the BLL, do *not* remove this property.</span></span>

> [!NOTE]
> <span data-ttu-id="a9a9f-276">Hodnota `OldValuesParameterFormatString` vlastnost musí být mapována na vstupní parametr názvy v BLL, které očekávají původní hodnoty.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-276">The value of the `OldValuesParameterFormatString` property must map to the input parameter names in the BLL that expect the original values.</span></span> <span data-ttu-id="a9a9f-277">Vzhledem k tomu, že jsme pojmenovali tyto parametry `original_productName`, `original_supplierID`a tak dále můžete nechat `OldValuesParameterFormatString` hodnotu vlastnosti jako `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-277">Since we named these parameters `original_productName`, `original_supplierID`, and so on, you can leave the `OldValuesParameterFormatString` property value as `original_{0}`.</span></span> <span data-ttu-id="a9a9f-278">Pokud však tyto metody BLL vstupní parametry měl názvy jako `old_productName`, `old_supplierID`a tak dále, je potřeba aktualizovat `OldValuesParameterFormatString` vlastnost `old_{0}`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-278">If, however, the BLL methods' input parameters had names like `old_productName`, `old_supplierID`, and so on, you'd need to update the `OldValuesParameterFormatString` property to `old_{0}`.</span></span>


<span data-ttu-id="a9a9f-279">Neexistuje jeden nastavení konečné vlastnosti, které musí být provedeny v pořadí pro ObjectDataSource správně metody BLL předat původní hodnoty.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-279">There's one final property setting that needs to be made in order for the ObjectDataSource to correctly pass the original values to the BLL methods.</span></span> <span data-ttu-id="a9a9f-280">Má ObjectDataSource [vlastnost ConflictDetection](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) lze přiřadit k [jednu ze dvou hodnot](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span><span class="sxs-lookup"><span data-stu-id="a9a9f-280">The ObjectDataSource has a [ConflictDetection property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) that can be assigned to [one of two values](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span></span>

- <span data-ttu-id="a9a9f-281">`OverwriteChanges`-Výchozí hodnota. Tyto metody BLL původní vstupní parametry neodesílá původní hodnoty</span><span class="sxs-lookup"><span data-stu-id="a9a9f-281">`OverwriteChanges` - the default value; does not send the original values to the BLL methods' original input parameters</span></span>
- <span data-ttu-id="a9a9f-282">`CompareAllValues`-odesílat původní hodnoty na BLL metody; Tuto možnost zvolte, pokud používáte optimistickou metodu souběžného zpracování</span><span class="sxs-lookup"><span data-stu-id="a9a9f-282">`CompareAllValues` - does send the original values to the BLL methods; choose this option when using optimistic concurrency</span></span>

<span data-ttu-id="a9a9f-283">Za chvíli nastavit `ConflictDetection` vlastnost `CompareAllValues`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-283">Take a moment to set the `ConflictDetection` property to `CompareAllValues`.</span></span>

## <a name="configuring-the-gridviews-properties-and-fields"></a><span data-ttu-id="a9a9f-284">Konfigurace prvku GridView vlastnosti a pole</span><span class="sxs-lookup"><span data-stu-id="a9a9f-284">Configuring the GridView's Properties and Fields</span></span>

<span data-ttu-id="a9a9f-285">S vlastnostmi ObjectDataSource správně nakonfigurovány zaměřme na nastavení GridView.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-285">With the ObjectDataSource's properties properly configured, let's turn our attention to setting up the GridView.</span></span> <span data-ttu-id="a9a9f-286">Nejprve vzhledem k tomu, že chceme GridView pro podporu úpravy a odstranění, klikněte na zaškrtávací políčka Povolit úpravy a Povolit odstranění z prvku GridView inteligentních značek.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-286">First, since we want the GridView to support editing and deleting, click the Enable Editing and Enable Deleting checkboxes from the GridView's smart tag.</span></span> <span data-ttu-id="a9a9f-287">Bude přidáno CommandField jejichž `ShowEditButton` a `ShowDeleteButton` jsou nastaveny na `true`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-287">This will add a CommandField whose `ShowEditButton` and `ShowDeleteButton` are both set to `true`.</span></span>

<span data-ttu-id="a9a9f-288">Když vázána `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, GridView obsahuje pole pro každou z produktu datová pole.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-288">When bound to the `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, the GridView contains a field for each of the product's data fields.</span></span> <span data-ttu-id="a9a9f-289">Při takové GridView lze upravovat, je ale cokoli přijatelné činnost koncového uživatele.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-289">While such a GridView can be edited, the user experience is anything but acceptable.</span></span> <span data-ttu-id="a9a9f-290">`CategoryID` a `SupplierID` BoundFields vykreslí jako textová pole, nutnosti uživatele k zadání čísla ID příslušnou kategorii a dodavatele.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-290">The `CategoryID` and `SupplierID` BoundFields will render as TextBoxes, requiring the user to enter the appropriate category and supplier as ID numbers.</span></span> <span data-ttu-id="a9a9f-291">Bude žádné formátování pro číselná pole a zajistit, že zadaný název produktu a, do jednotkové ceny jednotek na skladě, jednotky v pořadí a změnit pořadí úrovně hodnoty jsou obě správné číselné hodnoty a jsou větší než nebo roven žádné ověřovací ovládací prvky na nulu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-291">There will be no formatting for the numeric fields and no validation controls to ensure that the product's name has been supplied and that the unit price, units in stock, units on order, and reorder level values are both proper numeric values and are greater than or equal to zero.</span></span>

<span data-ttu-id="a9a9f-292">Jak již bylo zmíněno *přidání ověřovací ovládací prvky pro úpravy a vkládání rozhraní* a *přizpůsobení rozhraní pro úpravu dat* kurzy, uživatelské rozhraní lze přizpůsobit pomocí Nahraďte BoundFields TemplateFields.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-292">As we discussed in the *Adding Validation Controls to the Editing and Inserting Interfaces* and *Customizing the Data Modification Interface* tutorials, the user interface can be customized by replacing the BoundFields with TemplateFields.</span></span> <span data-ttu-id="a9a9f-293">Tato rutina GridView a jeho úpravy rozhraní jste došlo následujícími způsoby:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-293">I've modified this GridView and its editing interface in the following ways:</span></span>

- <span data-ttu-id="a9a9f-294">Odebrat `ProductID`, `SupplierName`, a `CategoryName` BoundFields</span><span class="sxs-lookup"><span data-stu-id="a9a9f-294">Removed the `ProductID`, `SupplierName`, and `CategoryName` BoundFields</span></span>
- <span data-ttu-id="a9a9f-295">Převést `ProductName` BoundField na pole TemplateField a přidání ovládacího prvku RequiredFieldValidation.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-295">Converted the `ProductName` BoundField to a TemplateField and added a RequiredFieldValidation control.</span></span>
- <span data-ttu-id="a9a9f-296">Převést `CategoryID` a `SupplierID` BoundFields k TemplateFields a upravit úpravy rozhraní používá DropDownLists namísto textových polí.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-296">Converted the `CategoryID` and `SupplierID` BoundFields to TemplateFields, and adjusted the editing interface to use DropDownLists rather than TextBoxes.</span></span> <span data-ttu-id="a9a9f-297">V těchto TemplateFields `ItemTemplates`, `CategoryName` a `SupplierName` se zobrazují datová pole.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-297">In these TemplateFields' `ItemTemplates`, the `CategoryName` and `SupplierName` data fields are displayed.</span></span>
- <span data-ttu-id="a9a9f-298">Převést `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, a `ReorderLevel` BoundFields TemplateFields a přidání ovládacích prvků CompareValidator.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-298">Converted the `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, and `ReorderLevel` BoundFields to TemplateFields and added CompareValidator controls.</span></span>

<span data-ttu-id="a9a9f-299">Vzhledem k tomu, že jste již jak provést tyto úlohy v předchozí kurzech zkontrolují, jsme I budete právě seznamu zde konečné deklarativní syntaxi a nechte implementace z hlediska.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-299">Since we've already examined how to accomplish these tasks in previous tutorials, I'll just list the final declarative syntax here and leave the implementation as practice.</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample9.aspx)]

<span data-ttu-id="a9a9f-300">Nemohli jsme velmi brzy bude dosaženo s příklad plně funkční.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-300">We're very close to having a fully-working example.</span></span> <span data-ttu-id="a9a9f-301">Existuje však několik odlišnosti, které budou ovládat nahoru a nám způsobit problémy.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-301">However, there are a few subtleties that will creep up and cause us problems.</span></span> <span data-ttu-id="a9a9f-302">Kromě toho potřebujeme ještě některé rozhraní, která upozorní uživatele, když došlo k narušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-302">Additionally, we still need some interface that alerts the user when a concurrency violation has occurred.</span></span>

> [!NOTE]
> <span data-ttu-id="a9a9f-303">Aby dat ovládací prvek webu správně předat původní hodnoty ObjectDataSource (které jsou potom předána BLL), je důležité, prvku GridView `EnableViewState` je nastavena na `true` (výchozí).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-303">In order for a data Web control to correctly pass the original values to the ObjectDataSource (which are then passed to the BLL), it's vital that the GridView's `EnableViewState` property is set to `true` (the default).</span></span> <span data-ttu-id="a9a9f-304">Pokud zakážete stav zobrazení, jsou v postback ztraceny původní hodnoty.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-304">If you disable view state, the original values are lost on postback.</span></span>


## <a name="passing-the-correct-original-values-to-the-objectdatasource"></a><span data-ttu-id="a9a9f-305">Předání správné původní hodnoty ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="a9a9f-305">Passing the Correct Original Values to the ObjectDataSource</span></span>

<span data-ttu-id="a9a9f-306">Existuje několik možných problémů s způsob, jakým GridView nebyl nakonfigurován.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-306">There are a couple of problems with the way the GridView has been configured.</span></span> <span data-ttu-id="a9a9f-307">Pokud ObjectDataSource `ConflictDetection` je nastavena na `CompareAllValues` (jako je náš), když ObjectDataSource `Update()` nebo `Delete()` metody jsou vyvolány GridView (nebo DetailsView nebo FormView), ObjectDataSource pokusí zkopírovat Rutina GridView na původní hodnoty do její odpovídající `Parameter` instance.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-307">If the ObjectDataSource's `ConflictDetection` property is set to `CompareAllValues` (as is ours), when the ObjectDataSource's `Update()` or `Delete()` methods are invoked by the GridView (or DetailsView or FormView), the ObjectDataSource attempts to copy the GridView's original values into its appropriate `Parameter` instances.</span></span> <span data-ttu-id="a9a9f-308">Odkazovat zpět na obrázku 2 pro grafické reprezentace tohoto procesu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-308">Refer back to Figure 2 for a graphical representation of this process.</span></span>

<span data-ttu-id="a9a9f-309">Konkrétně GridView původní hodnoty přiřazené hodnoty v příkazech obousměrné vazby dat pokaždé, když data je vázána GridView.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-309">Specifically, the GridView's original values are assigned the values in the two-way databinding statements each time the data is bound to the GridView.</span></span> <span data-ttu-id="a9a9f-310">Proto je důležité, že všechny požadované původní hodnoty jsou zachyceny pomocí obousměrné vazby dat a že jsou k dispozici ve formátu, převést.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-310">Therefore, it's essential that the required original values all are captured via two-way databinding and that they are provided in a convertible format.</span></span>

<span data-ttu-id="a9a9f-311">Pokud chcete zjistit, proč je důležité, pozorně najdete na naší stránce v prohlížeči.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-311">To see why this is important, take a moment to visit our page in a browser.</span></span> <span data-ttu-id="a9a9f-312">Podle očekávání, GridView uvádí každý produkt pomocí tlačítka Upravit a odstranit v levém sloupci.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-312">As expected, the GridView lists each product with an Edit and Delete button in the leftmost column.</span></span>


<span data-ttu-id="a9a9f-313">[![Produkty jsou uvedeny v GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-313">[![The Products are Listed in a GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span></span>

<span data-ttu-id="a9a9f-314">**Obrázek 14**: produkty jsou uvedeny v GridView ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-314">**Figure 14**: The Products are Listed in a GridView ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image40.png))</span></span>


<span data-ttu-id="a9a9f-315">Pokud kliknete na tlačítko Odstranit pro některý z produktů, `FormatException` je vyvolána výjimka.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-315">If you click the Delete button for any product, a `FormatException` is thrown.</span></span>


<span data-ttu-id="a9a9f-316">[![Probíhá pokus o odstranění produktu výsledky v FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-316">[![Attempting to Delete Any Product Results in a FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span></span>

<span data-ttu-id="a9a9f-317">**Obrázek 15**: Probíhá pokus o odstranění Any produktu výsledky v `FormatException` ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-317">**Figure 15**: Attempting to Delete Any Product Results in a `FormatException` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image43.png))</span></span>


<span data-ttu-id="a9a9f-318">`FormatException` Se vyvolá, když ObjectDataSource se pokusí přečíst v původním `UnitPrice` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-318">The `FormatException` is raised when the ObjectDataSource attempts to read in the original `UnitPrice` value.</span></span> <span data-ttu-id="a9a9f-319">Vzhledem k tomu `ItemTemplate` má `UnitPrice` formátu měny (`<%# Bind("UnitPrice", "{0:C}") %>`), obsahuje symbol měny, jako je 19,95.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-319">Since the `ItemTemplate` has the `UnitPrice` formatted as a currency (`<%# Bind("UnitPrice", "{0:C}") %>`), it includes a currency symbol, like $19.95.</span></span> <span data-ttu-id="a9a9f-320">`FormatException` Nastane jako ObjectDataSource pokusí převést tento řetězec do `decimal`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-320">The `FormatException` occurs as the ObjectDataSource attempts to convert this string into a `decimal`.</span></span> <span data-ttu-id="a9a9f-321">Chcete-li tento problém obejít, máme několik možností:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-321">To circumvent this problem, we have a number of options:</span></span>

- <span data-ttu-id="a9a9f-322">Odebrat měna formátování z `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-322">Remove the currency formatting from the `ItemTemplate`.</span></span> <span data-ttu-id="a9a9f-323">To znamená místo použití `<%# Bind("UnitPrice", "{0:C}") %>`, jednoduše použijte `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-323">That is, instead of using `<%# Bind("UnitPrice", "{0:C}") %>`, simply use `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="a9a9f-324">Nevýhodou tohoto objektu je, že cenu už formátována.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-324">The downside of this is that the price is no longer formatted.</span></span>
- <span data-ttu-id="a9a9f-325">Zobrazení `UnitPrice` ve formátu měny v `ItemTemplate`, ale použít `Eval` – klíčové slovo chcete dosáhnout.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-325">Display the `UnitPrice` formatted as a currency in the `ItemTemplate`, but use the `Eval` keyword to accomplish this.</span></span> <span data-ttu-id="a9a9f-326">Odvolat, `Eval` provede datové jednosměrné vazby.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-326">Recall that `Eval` performs one-way databinding.</span></span> <span data-ttu-id="a9a9f-327">Musíme poskytují `UnitPrice` hodnotu pro původní hodnoty, proto budeme potřebovat stále příkaz obousměrný datové vazby v `ItemTemplate`, ale to se může v ovládacím prvku popisek webového jehož `Visible` je nastavena na `false`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-327">We still need to provide the `UnitPrice` value for the original values, so we'll still need a two-way databinding statement in the `ItemTemplate`, but this can be placed in a Label Web control whose `Visible` property is set to `false`.</span></span> <span data-ttu-id="a9a9f-328">V ItemTemplate jsme použít následující kód:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-328">We could use the following markup in the ItemTemplate:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample10.aspx)]

- <span data-ttu-id="a9a9f-329">Odebrat měna formátování z `ItemTemplate`pomocí `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-329">Remove the currency formatting from the `ItemTemplate`, using `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="a9a9f-330">V prvku GridView `RowDataBound` obslužné rutiny události, prostřednictvím kódu programu přístup k webu popisek řízení v rámci kterého `UnitPrice` hodnota se zobrazí a nastavit jeho `Text` vlastnost formátovaný verzi.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-330">In the GridView's `RowDataBound` event handler, programmatically access the Label Web control within which the `UnitPrice` value is displayed and set its `Text` property to the formatted version.</span></span>
- <span data-ttu-id="a9a9f-331">Ponechejte `UnitPrice` formátu měny.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-331">Leave the `UnitPrice` formatted as a currency.</span></span> <span data-ttu-id="a9a9f-332">V prvku GridView `RowDeleting` obslužné rutiny události, nahraďte existující původní `UnitPrice` hodnotu (19,95 USD) s k skutečné desetinnou hodnotu pomocí `Decimal.Parse`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-332">In the GridView's `RowDeleting` event handler, replace the existing original `UnitPrice` value ($19.95) with an actual decimal value using `Decimal.Parse`.</span></span> <span data-ttu-id="a9a9f-333">Jsme viděli, jak provést něco podobného jako v `RowUpdating` obslužné rutiny událostí v [ *zpracování BLL - a výjimky na úrovni DAL na stránku ASP.NET* ](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) kurzu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-333">We saw how to accomplish something similar in the `RowUpdating` event handler in the [*Handling BLL- and DAL-Level Exceptions in an ASP.NET Page*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial.</span></span>

<span data-ttu-id="a9a9f-334">Moje například se rozhodli se druhý přístup přidání skrytá webové popisek řízení jehož `Text` vlastnost je obousměrný data vázaná na neformátovaný `UnitPrice` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-334">For my example I chose to go with the second approach, adding a hidden Label Web control whose `Text` property is two-way data bound to the unformatted `UnitPrice` value.</span></span>

<span data-ttu-id="a9a9f-335">Po řešení tohoto problému, zkuste to znovu kliknutím na tlačítko Odstranit pro některý z produktů.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-335">After solving this problem, try clicking the Delete button for any product again.</span></span> <span data-ttu-id="a9a9f-336">Tentokrát získáte `InvalidOperationException` kdy pokusí vyvolat BLL ObjectDataSource `UpdateProduct` metoda.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-336">This time you'll get an `InvalidOperationException` when the ObjectDataSource attempts to invoke the BLL's `UpdateProduct` method.</span></span>


<span data-ttu-id="a9a9f-337">[![ObjectDataSource nelze najít metodu s vstupní parametry chce odeslání](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-337">[![The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span></span>

<span data-ttu-id="a9a9f-338">**Obrázek 16**: ObjectDataSource nelze najít metodu s vstupní parametry chce odeslání ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-338">**Figure 16**: The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image46.png))</span></span>


<span data-ttu-id="a9a9f-339">Prohlížení zpráv v výjimky, je zřejmé, že ObjectDataSource chce vyvolání BLL `DeleteProduct` metoda, která zahrnuje `original_CategoryName` a `original_SupplierName` vstupní parametry.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-339">Looking at the exception's message, it's clear that the ObjectDataSource wants to invoke a BLL `DeleteProduct` method that includes `original_CategoryName` and `original_SupplierName` input parameters.</span></span> <span data-ttu-id="a9a9f-340">Důvodem je, že `ItemTemplate` s pro `CategoryID` a `SupplierID` TemplateFields aktuálně obsahovat obousměrné vazby příkazy s `CategoryName` a `SupplierName` datová pole.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-340">This is because the `ItemTemplate` s for the `CategoryID` and `SupplierID` TemplateFields currently contain two-way Bind statements with the `CategoryName` and `SupplierName` data fields.</span></span> <span data-ttu-id="a9a9f-341">Místo toho je potřeba zahrnout `Bind` příkazy s `CategoryID` a `SupplierID` datová pole.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-341">Instead, we need to include `Bind` statements with the `CategoryID` and `SupplierID` data fields.</span></span> <span data-ttu-id="a9a9f-342">K tomu, nahraďte existující příkazy vazby s `Eval` příkazy a poté přidejte skrytý popisek ovládací prvky, jejichž `Text` vlastnosti je vázána na `CategoryID` a `SupplierID` datových polí pomocí obousměrné vazby dat, jak je znázorněno níže:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-342">To accomplish this, replace the existing Bind statements with `Eval` statements, and then add hidden Label controls whose `Text` properties are bound to the `CategoryID` and `SupplierID` data fields using two-way databinding, as shown below:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample11.aspx)]

<span data-ttu-id="a9a9f-343">Tyto změny se nám, teď moct úspěšně odstranit a upravit informace o produktu!</span><span class="sxs-lookup"><span data-stu-id="a9a9f-343">With these changes, we are now able to successfully delete and edit product information!</span></span> <span data-ttu-id="a9a9f-344">V kroku 5 podíváme jak ověřit, jestli se porušení souběžnosti detekovaly.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-344">In Step 5 we'll look at how to verify that concurrency violations are being detected.</span></span> <span data-ttu-id="a9a9f-345">Ale prozatím trvat několik minut a zkuste to aktualizaci a odstraňování několik záznamů zajistit, že aktualizace a odstranění pro jednoho uživatele funguje podle očekávání.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-345">But for now, take a few minutes to try updating and deleting a few records to ensure that updating and deleting for a single user works as expected.</span></span>

## <a name="step-5-testing-the-optimistic-concurrency-support"></a><span data-ttu-id="a9a9f-346">Krok 5: Testování podporu optimistickou metodu souběžného zpracování</span><span class="sxs-lookup"><span data-stu-id="a9a9f-346">Step 5: Testing the Optimistic Concurrency Support</span></span>

<span data-ttu-id="a9a9f-347">Chcete-li ověřit, že porušení souběžnosti probíhá zjištěné (nikoli výsledné v datech slepě přepsáním), je potřeba otevřít dvě okna prohlížeče na tuto stránku.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-347">In order to verify that concurrency violations are being detected (rather than resulting in data being blindly overwritten), we need to open two browser windows to this page.</span></span> <span data-ttu-id="a9a9f-348">V obou případech prohlížeče klikněte na tlačítko Upravit pro Chai.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-348">In both browser instances, click on the Edit button for Chai.</span></span> <span data-ttu-id="a9a9f-349">V právě jeden z prohlížečů, změňte název na "Chai čaj" a kliknutím na tlačítko Aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-349">Then, in just one of the browsers, change the name to "Chai Tea" and click Update.</span></span> <span data-ttu-id="a9a9f-350">Aktualizace by měla být úspěšné a vrátit GridView do předem úpravy stavu, s "Chai čaj" jako nový název produktu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-350">The update should succeed and return the GridView to its pre-editing state, with "Chai Tea" as the new product name.</span></span>

<span data-ttu-id="a9a9f-351">V jiných okno instance prohlížeče ale textového pole název produktu stále zobrazuje "Chai".</span><span class="sxs-lookup"><span data-stu-id="a9a9f-351">In the other browser window instance, however, the product name TextBox still shows "Chai".</span></span> <span data-ttu-id="a9a9f-352">V této druhé okno prohlížeče, aktualizovat `UnitPrice` k `25.00`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-352">In this second browser window, update the `UnitPrice` to `25.00`.</span></span> <span data-ttu-id="a9a9f-353">Bez podpory optimistickou metodu souběžného kliknutím na tlačítko Aktualizovat v druhé instance prohlížeče by změnit název produktu zpět na "Chai", čímž přepsání změny provedené při první instance prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-353">Without optimistic concurrency support, clicking update in the second browser instance would change the product name back to "Chai", thereby overwriting the changes made by the first browser instance.</span></span> <span data-ttu-id="a9a9f-354">S optimistickou metodu souběžného těmto nekompatibilitám, ale kliknutím na tlačítko Aktualizovat na druhou instanci prohlížeče výsledkem [dbconcurrencyexception –](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-354">With optimistic concurrency employed, however, clicking the Update button in the second browser instance results in a [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span></span>


<span data-ttu-id="a9a9f-355">[![Když se detekuje narušení souběžného zpracování, je vyvolána dbconcurrencyexception –](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-355">[![When a Concurrency Violation is Detected, a DBConcurrencyException is Thrown](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span></span>

<span data-ttu-id="a9a9f-356">**Obrázek 17**: Pokud porušení souběžnosti se zjistí, `DBConcurrencyException` je vyvolána ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-356">**Figure 17**: When a Concurrency Violation is Detected, a `DBConcurrencyException` is Thrown ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image49.png))</span></span>


<span data-ttu-id="a9a9f-357">`DBConcurrencyException` Se pouze vyvolá, když se využívá vzor aktualizace batch DAL.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-357">The `DBConcurrencyException` is only thrown when the DAL's batch update pattern is utilized.</span></span> <span data-ttu-id="a9a9f-358">Vzor přímé DB nevyvolá výjimku, jenom označuje, že měla vliv na žádné řádky.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-358">The DB direct pattern does not raise an exception, it merely indicates that no rows were affected.</span></span> <span data-ttu-id="a9a9f-359">Pro znázornění je vrátí rutina GridView obou instancí prohlížeč stavu předem úpravy.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-359">To illustrate this, return both browser instances' GridView to their pre-editing state.</span></span> <span data-ttu-id="a9a9f-360">V dalším kroku v první řadě prohlížeče, klikněte na tlačítko Upravit a změňte název produktu z "Chai čaj" do "Chai" a kliknutím na tlačítko Aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-360">Next, in the first browser instance, click the Edit button and change the product name from "Chai Tea" back to "Chai" and click Update.</span></span> <span data-ttu-id="a9a9f-361">V okně prohlížeče druhý klikněte na tlačítko Odstranit pro Chai.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-361">In the second browser window, click the Delete button for Chai.</span></span>

<span data-ttu-id="a9a9f-362">Po kliknutí na tlačítko odstranit, je stránka odeslána zpět, GridView vyvolá ObjectDataSource `Delete()` metoda a ObjectDataSource volání `ProductsOptimisticConcurrencyBLL` třídy `DeleteProduct` metodu předáním podél původní hodnoty.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-362">Upon clicking Delete, the page posts back, the GridView invokes the ObjectDataSource's `Delete()` method, and the ObjectDataSource calls down into the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method, passing along the original values.</span></span> <span data-ttu-id="a9a9f-363">Původní `ProductName` hodnotu pro druhou instanci prohlížeče je "Chai čaj", která se neshoduje s aktuálním `ProductName` hodnota v databázi.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-363">The original `ProductName` value for the second browser instance is "Chai Tea", which doesn't match up with the current `ProductName` value in the database.</span></span> <span data-ttu-id="a9a9f-364">Proto `DELETE` prohlášení vydané k databázi ovlivňuje nulový počet řádků, protože neexistuje žádný záznam v databázi, `WHERE` splňuje klauzule.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-364">Therefore the `DELETE` statement issued to the database affects zero rows since there's no record in the database that the `WHERE` clause satisfies.</span></span> <span data-ttu-id="a9a9f-365">`DeleteProduct` Metoda vrátí `false` a data ObjectDataSource je odrážejí na GridView.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-365">The `DeleteProduct` method returns `false` and the ObjectDataSource's data is rebound to the GridView.</span></span>

<span data-ttu-id="a9a9f-366">Z hlediska koncového uživatele kliknutím na tlačítko Odstranit pro čaj Chai v okně prohlížeče druhý způsobeno obrazovky, flash a při vracející se zpět, produkt je stále existuje, ale nyní je uveden jako "Chai" (produktu změnu názvu provedené první prohlížeče instance).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-366">From the end user's perspective, clicking on the Delete button for Chai Tea in the second browser window caused the screen to flash and, upon coming back, the product is still there, although now it's listed as "Chai" (the product name change made by the first browser instance).</span></span> <span data-ttu-id="a9a9f-367">Pokud uživatel klikne na tlačítko Odstranit znovu, bude odstranění úspěšné, jako je původní GridView `ProductName` hodnota ("Chai") se teď odpovídá s hodnotou v databázi.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-367">If the user clicks the Delete button again, the Delete will succeed, as the GridView's original `ProductName` value ("Chai") now matches up with the value in the database.</span></span>

<span data-ttu-id="a9a9f-368">V obou případech činnost koncového uživatele je daleko od ideálu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-368">In both of these cases, the user experience is far from ideal.</span></span> <span data-ttu-id="a9a9f-369">Jsme jasně nechcete, aby se uživateli zobrazí podrobnosti o nitty-gritty `DBConcurrencyException` výjimka při použití vzoru aktualizace dávky.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-369">We clearly don't want to show the user the nitty-gritty details of the `DBConcurrencyException` exception when using the batch update pattern.</span></span> <span data-ttu-id="a9a9f-370">A chování při použití vzoru přímé DB je poněkud matoucí, protože uživatelé příkaz se nezdařil, ale žádná přesné informace o důvod, proč se.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-370">And the behavior when using the DB direct pattern is somewhat confusing as the users command failed, but there was no precise indication of why.</span></span>

<span data-ttu-id="a9a9f-371">Chcete-li vyřešit tyto dva problémy, můžeme vytvořit popisek webové ovládací prvky na stránce, které poskytují vysvětlení k proto aktualizaci nebo odstranění se nezdařilo.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-371">To remedy these two issues, we can create Label Web controls on the page that provide an explanation to why an update or delete failed.</span></span> <span data-ttu-id="a9a9f-372">Pro aktualizaci vzor batch, můžeme určit, jestli `DBConcurrencyException` došlo k výjimce v obslužné rutině události po úrovni prvku GridView zobrazení upozornění popisek podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-372">For the batch update pattern, we can determine whether or not a `DBConcurrencyException` exception occurred in the GridView's post-level event handler, displaying the warning label as needed.</span></span> <span data-ttu-id="a9a9f-373">Pro metodu přímé DB jsme můžete zkontrolovat návratovou hodnotu metody BLL (což je `true` Pokud byl vliv na jeden řádek, `false` jinak) a zobrazit informační zpráva podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-373">For the DB direct method, we can examine the return value of the BLL method (which is `true` if one row was affected, `false` otherwise) and display an informational message as needed.</span></span>

## <a name="step-6-adding-informational-messages-and-displaying-them-in-the-face-of-a-concurrency-violation"></a><span data-ttu-id="a9a9f-374">Krok 6: Přidání informační zprávy a jejich zobrazení při krátkodobém narušení souběžného zpracování</span><span class="sxs-lookup"><span data-stu-id="a9a9f-374">Step 6: Adding Informational Messages and Displaying Them in the Face of a Concurrency Violation</span></span>

<span data-ttu-id="a9a9f-375">Když dojde k narušení souběžnosti, chování vystavených závisí na jestli použila DAL dávková aktualizace nebo přímé vzor DB.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-375">When a concurrency violation occurs, the behavior exhibited depends on whether the DAL's batch update or DB direct pattern was used.</span></span> <span data-ttu-id="a9a9f-376">Naše kurz používá obě vzory, se vzorkem aktualizace batch používá pro aktualizaci a přímé vzor DB použít pro odstranění.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-376">Our tutorial uses both patterns, with the batch update pattern being used for updating and the DB direct pattern used for deleting.</span></span> <span data-ttu-id="a9a9f-377">Pokud chcete začít, umožňuje přidání dvě popisek na naší stránce, která vysvětlují, že při pokusu o odstranění nebo aktualizaci dat došlo k narušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-377">To get started, let's add two Label Web controls to our page that explain that a concurrency violation occurred when attempting to delete or update data.</span></span> <span data-ttu-id="a9a9f-378">Nastavení ovládacího prvku popisek `Visible` a `EnableViewState` vlastnosti, které chcete `false`; to způsobí, že je jako skryté na každé stránce, navštivte, s výjimkou pro ty konkrétní stránky navštíví kde jejich `Visible` prostřednictvím kódu programu je vlastnost nastavena na `true`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-378">Set the Label control's `Visible` and `EnableViewState` properties to `false`; this will cause them to be hidden on each page visit except for those particular page visits where their `Visible` property is programmatically set to `true`.</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample12.aspx)]

<span data-ttu-id="a9a9f-379">Kromě nastavení jejich `Visible`, `EnabledViewState`, a `Text` vlastností, I taky nastavili `CssClass` vlastnost `Warning`, což způsobí, že popisek elementu na velká, red, kurzíva, tučné písmo.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-379">In addition to setting their `Visible`, `EnabledViewState`, and `Text` properties, I've also set the `CssClass` property to `Warning`, which causes the Label's to be displayed in a large, red, italic, bold font.</span></span> <span data-ttu-id="a9a9f-380">Tato šablon stylů CSS `Warning` třída byla definována a přidají se do Styles.css zpět v *zkoumání události spojené s vložení, aktualizace a odstranění* kurzu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-380">This CSS `Warning` class was defined and added to Styles.css back in the *Examining the Events Associated with Inserting, Updating, and Deleting* tutorial.</span></span>

<span data-ttu-id="a9a9f-381">Po přidání tyto popisky, by měla vypadat podobně jako na obrázku 18 návrháře v sadě Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-381">After adding these Labels, the Designer in Visual Studio should look similar to Figure 18.</span></span>


<span data-ttu-id="a9a9f-382">[![Byly přidány dva ovládací prvky popisek na stránku](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-382">[![Two Label Controls Have Been Added to the Page](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span></span>

<span data-ttu-id="a9a9f-383">**Obrázek 18**: dva popisek – ovládací prvky byly přidány na stránku ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-383">**Figure 18**: Two Label Controls Have Been Added to the Page ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image52.png))</span></span>


<span data-ttu-id="a9a9f-384">Pomocí těchto popisek webových prvků zavedené, je vše připraveno prozkoumat určení při souběžnosti došlo k narušení, na který bodu odpovídající popisek `Visible` může být nastavena `true`, zobrazení informační zpráva.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-384">With these Label Web controls in place, we're ready to examine how to determine when a concurrency violation has occurred, at which point the appropriate Label's `Visible` property can be set to `true`, displaying the informational message.</span></span>

## <a name="handling-concurrency-violations-when-updating"></a><span data-ttu-id="a9a9f-385">Při aktualizaci zpracování porušení souběžnosti</span><span class="sxs-lookup"><span data-stu-id="a9a9f-385">Handling Concurrency Violations When Updating</span></span>

<span data-ttu-id="a9a9f-386">Nejprve podíváme, jak pracovat s porušení souběžnosti při použití vzoru aktualizace dávky.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-386">Let's first look at how to handle concurrency violations when using the batch update pattern.</span></span> <span data-ttu-id="a9a9f-387">Vzhledem k tomu, že takové porušení službou batch aktualizovat vzor Příčina `DBConcurrencyException` výjimka, která je vyvolána, je potřeba přidat kód pro naše stránka ASP.NET k určení zda `DBConcurrencyException` během procesu aktualizace došlo k výjimce.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-387">Since such violations with the batch update pattern cause a `DBConcurrencyException` exception to be thrown, we need to add code to our ASP.NET page to determine whether a `DBConcurrencyException` exception occurred during the update process.</span></span> <span data-ttu-id="a9a9f-388">Pokud ano, by měl zobrazit zprávu vysvětlením uživatele, jejich změny nebyly uloženy, protože jiný uživatel měl stejná data mezi upravovat, když se spouští úpravy záznamu a při kliknutí na tlačítko Aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-388">If so, we should display a message to the user explaining that their changes were not saved because another user had modified the same data between when they started editing the record and when they clicked the Update button.</span></span>

<span data-ttu-id="a9a9f-389">Jak jsme viděli v *zpracování BLL - a výjimky na úrovni DAL na stránku ASP.NET* kurz, takové výjimky můžete zjistil a potlačena v po úrovně obslužných rutin ovládacího prvku webového data.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-389">As we saw in the *Handling BLL- and DAL-Level Exceptions in an ASP.NET Page* tutorial, such exceptions can be detected and suppressed in the data Web control's post-level event handlers.</span></span> <span data-ttu-id="a9a9f-390">Proto je potřeba vytvořit obslužnou rutinu události pro prvku GridView `RowUpdated` událost, která ověří, zda se `DBConcurrencyException` byla vyvolána výjimka.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-390">Therefore, we need to create an event handler for the GridView's `RowUpdated` event that checks if a `DBConcurrencyException` exception has been thrown.</span></span> <span data-ttu-id="a9a9f-391">Tuto obslužnou rutinu události je předán odkaz na všechny výjimky, která byla vygenerována během procesu aktualizace, jak je znázorněno v případě, že obslužná rutina kódu níže:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-391">This event handler is passed a reference to any exception that was raised during the updating process, as shown in the event handler code below:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample13.vb)]

<span data-ttu-id="a9a9f-392">V face z `DBConcurrencyException` zobrazí této obslužné rutiny události výjimky, `UpdateConflictMessage` popisek ovládacího prvku a znamená, že byla zpracována výjimka.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-392">In the face of a `DBConcurrencyException` exception, this event handler displays the `UpdateConflictMessage` Label control and indicates that the exception has been handled.</span></span> <span data-ttu-id="a9a9f-393">S tímto kódem na místě, když při aktualizaci záznamu, dojde k narušení souběžnosti uživatele změny jsou ztraceny, vzhledem k tomu, že by přepsání jiné uživatelské úpravy ve stejnou dobu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-393">With this code in place, when a concurrency violation occurs when updating a record, the user's changes are lost, since they would have overwritten another user's modifications at the same time.</span></span> <span data-ttu-id="a9a9f-394">GridView zejména, je vrácena do stavu před úpravy a vázána na aktuální data databáze.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-394">In particular, the GridView is returned to its pre-editing state and bound to the current database data.</span></span> <span data-ttu-id="a9a9f-395">Tím dojde k aktualizaci GridView řádek s změny jiného uživatele, které byly dříve nejsou viditelné.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-395">This will update the GridView row with the other user's changes, which were previously not visible.</span></span> <span data-ttu-id="a9a9f-396">Kromě toho `UpdateConflictMessage` popisek – ovládací prvek vysvětluje uživateli, co se právě stalo.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-396">Additionally, the `UpdateConflictMessage` Label control will explain to the user what just happened.</span></span> <span data-ttu-id="a9a9f-397">Tato posloupnost událostí, které je popsané v 19 obrázek.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-397">This sequence of events is detailed in Figure 19.</span></span>


<span data-ttu-id="a9a9f-398">[![Uživatel s aktualizace jsou ztraceny stěně narušení souběžného zpracování](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-398">[![A User s Updates are Lost in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span></span>

<span data-ttu-id="a9a9f-399">**Obrázek 19**: uživatele A s aktualizace jsou ztraceny stěně narušení souběžnosti ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-399">**Figure 19**: A User s Updates are Lost in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image55.png))</span></span>


> [!NOTE]
> <span data-ttu-id="a9a9f-400">Alternativně místo GridView vrácením předem úpravy stavu, jsme může nechat GridView ve stavu úprav nastavením `KeepInEditMode` vlastnost předána-in `GridViewUpdatedEventArgs` objekt, který má hodnotu true.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-400">Alternatively, rather than returning the GridView to the pre-editing state, we could leave the GridView in its editing state by setting the `KeepInEditMode` property of the passed-in `GridViewUpdatedEventArgs` object to true.</span></span> <span data-ttu-id="a9a9f-401">Pokud pořídíte tento přístup, ale být jistý, se svázat data, která mají GridView (vyvoláním jeho `DataBind()` metoda) tak, aby do rozhraní úpravy jsou načteny hodnoty jiný uživatel.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-401">If you take this approach, however, be certain to rebind the data to the GridView (by invoking its `DataBind()` method) so that the other user's values are loaded into the editing interface.</span></span> <span data-ttu-id="a9a9f-402">Kód k dispozici ke stažení v tomto kurzu má tyto dva řádky kódu `RowUpdated` obslužné rutiny události komentované; jednoduše zrušte komentář u tyto řádky kódu tak, aby měl GridView zůstat v režimu úprav po porušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-402">The code available for download with this tutorial has these two lines of code in the `RowUpdated` event handler commented out; simply uncomment these lines of code to have the GridView remain in edit mode after a concurrency violation.</span></span>


## <a name="responding-to-concurrency-violations-when-deleting"></a><span data-ttu-id="a9a9f-403">Při odstraňování neodpovídá na požadavky porušení souběžnosti</span><span class="sxs-lookup"><span data-stu-id="a9a9f-403">Responding to Concurrency Violations When Deleting</span></span>

<span data-ttu-id="a9a9f-404">Přímé vzor DB už není žádná výjimka vyvolaná při krátkodobém narušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-404">With the DB direct pattern, there is no exception raised in the face of a concurrency violation.</span></span> <span data-ttu-id="a9a9f-405">Místo toho příkaz database jednoduše ovlivňuje žádné záznamy, jako klauzule WHERE se neshoduje s žádným záznamem.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-405">Instead, the database statement simply affects no records, as the WHERE clause does not match with any record.</span></span> <span data-ttu-id="a9a9f-406">Všechny metody úpravy dat vytvořené v BLL byly navrženy tak, aby mohly vrátit logickou hodnotu udávající, zda jejich vliv na přesně jeden záznam.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-406">All of the data modification methods created in the BLL have been designed such that they return a Boolean value indicating whether or not they affected precisely one record.</span></span> <span data-ttu-id="a9a9f-407">Proto, pokud chcete zjistit, pokud došlo k narušení souběžnosti při odstraňování záznamu, jsme Zkontrolujte návratovou hodnotu BLL `DeleteProduct` metoda.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-407">Therefore, to determine if a concurrency violation occurred when deleting a record, we can examine the return value of the BLL's `DeleteProduct` method.</span></span>

<span data-ttu-id="a9a9f-408">Návratovou hodnotu metody BLL může být prověřen v prvku ObjectDataSource po úrovně obslužných rutin prostřednictvím `ReturnValue` vlastnost `ObjectDataSourceStatusEventArgs` objekt předaný do obslužné rutiny události.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-408">The return value for a BLL method can be examined in the ObjectDataSource's post-level event handlers through the `ReturnValue` property of the `ObjectDataSourceStatusEventArgs` object passed into the event handler.</span></span> <span data-ttu-id="a9a9f-409">Vzhledem k tomu, že jsme zájem o určení návratovou hodnotou z `DeleteProduct` metody, je potřeba vytvořit obslužnou rutinu události pro ObjectDataSource `Deleted` událostí.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-409">Since we are interested in determining the return value from the `DeleteProduct` method, we need to create an event handler for the ObjectDataSource's `Deleted` event.</span></span> <span data-ttu-id="a9a9f-410">`ReturnValue` Vlastnost je typu `object` a může být `null` Pokud došlo k výjimce a metodu byl přerušen dříve, než ji může vrátit hodnotu.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-410">The `ReturnValue` property is of type `object` and can be `null` if an exception was raised and the method was interrupted before it could return a value.</span></span> <span data-ttu-id="a9a9f-411">Proto jsme měli nejdřív zajistit, aby `ReturnValue` vlastnost není `null` a je logická hodnota.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-411">Therefore, we should first ensure that the `ReturnValue` property is not `null` and is a Boolean value.</span></span> <span data-ttu-id="a9a9f-412">Za předpokladu, že tato kontrola proběhne, ukážeme `DeleteConflictMessage` popisku řízení, pokud `ReturnValue` je `false`.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-412">Assuming this check passes, we show the `DeleteConflictMessage` Label control if the `ReturnValue` is `false`.</span></span> <span data-ttu-id="a9a9f-413">Můžete to provést pomocí následujícího kódu:</span><span class="sxs-lookup"><span data-stu-id="a9a9f-413">This can be accomplished by using the following code:</span></span>


[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample14.vb)]

<span data-ttu-id="a9a9f-414">Při krátkodobém narušení souběžného zpracování požadavku na odstranění uživatele zrušeny.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-414">In the face of a concurrency violation, the user's delete request is canceled.</span></span> <span data-ttu-id="a9a9f-415">Aktualizovat GridView zobrazující, že změny, které došlo k chybě pro tento záznam mezi tím, kdy uživatel načíst stránku a zadá při kliknutí na tlačítko Odstranit.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-415">The GridView is refreshed, showing the changes that occurred for that record between the time the user loaded the page and when he clicked the Delete button.</span></span> <span data-ttu-id="a9a9f-416">Když je porušení pravidel ukáže, `DeleteConflictMessage` popisek zobrazený, která vysvětluje, co došlo jenom (viz obrázek 20).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-416">When such a violation transpires, the `DeleteConflictMessage` Label is shown, explaining what just happened (see Figure 20).</span></span>


<span data-ttu-id="a9a9f-417">[![Uživatel s odstranění je zrušena při krátkodobém narušení souběžného zpracování](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-417">[![A User s Delete is Canceled in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span></span>

<span data-ttu-id="a9a9f-418">**Obrázek 20**: uživatele A s odstranění je zrušeno při krátkodobém narušení souběžnosti ([Kliknutím zobrazit obrázek v plné velikosti](implementing-optimistic-concurrency-vb/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="a9a9f-418">**Figure 20**: A User s Delete is Canceled in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image58.png))</span></span>


## <a name="summary"></a><span data-ttu-id="a9a9f-419">Souhrn</span><span class="sxs-lookup"><span data-stu-id="a9a9f-419">Summary</span></span>

<span data-ttu-id="a9a9f-420">Příležitosti pro concurrency porušení existovat v každé aplikaci, která umožňuje víc souběžných uživatelům aktualizovat nebo odstranit data.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-420">Opportunities for concurrency violations exist in every application that allows multiple, concurrent users to update or delete data.</span></span> <span data-ttu-id="a9a9f-421">Pokud tato porušování nejsou pozornost u, když se dva uživatelé současně aktualizace stejná data, kdo získá v poslední zápis "wins", přepsal jiný uživatel změní změny.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-421">If such violations are not accounted for, when two users simultaneously update the same data whoever gets in the last write "wins," overwriting the other user's changes changes.</span></span> <span data-ttu-id="a9a9f-422">Alternativně můžete vývojářům implementovat buď kontrola optimistickou metodu nebo pesimistické souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-422">Alternatively, developers can implement either optimistic or pessimistic concurrency control.</span></span> <span data-ttu-id="a9a9f-423">Optimistické řízení souběžného předpokládá, že porušení souběžnosti jsou jen zřídka a jednoduše zakáže aktualizace nebo odstranění příkaz, který by představovalo narušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-423">Optimistic concurrency control assumes that concurrency violations are infrequent and simply disallows an update or delete command that would constitute a concurrency violation.</span></span> <span data-ttu-id="a9a9f-424">Kontrola souběžnosti pesimistické předpokládá, že tento souběžnosti porušení často dochází a jednoduše odmítat jeden uživatel aktualizovat nebo odstranit příkaz není platný.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-424">Pessimistic concurrency control assumes that concurrency violations are frequent and simply rejecting one user's update or delete command is not acceptable.</span></span> <span data-ttu-id="a9a9f-425">S řízení pesimistické souběžnosti aktualizace záznamu zahrnuje zamykání, a zabrání všichni ostatní uživatelé z úpravy nebo odstranění záznamu je uzamčena.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-425">With pessimistic concurrency control, updating a record involves locking it, thereby preventing any other users from modifying or deleting the record while it is locked.</span></span>

<span data-ttu-id="a9a9f-426">Typové datové sady v rozhraní .NET poskytuje funkce pro podporu optimistické řízení souběžného.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-426">The Typed DataSet in .NET provides functionality for supporting optimistic concurrency control.</span></span> <span data-ttu-id="a9a9f-427">Konkrétně `UPDATE` a `DELETE` příkazy vydané do databáze zahrnout všechny sloupce tabulky, a zajistí tak, že aktualizace nebo odstranění pouze dojde v případě záznam na aktuální data shoduje s původní data uživatel měl při provedením jejich aktualizaci nebo odstranění.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-427">In particular, the `UPDATE` and `DELETE` statements issued to the database include all of the table's columns, thereby ensuring that the update or delete will only occur if the record's current data matches with the original data the user had when performing their update or delete.</span></span> <span data-ttu-id="a9a9f-428">Jakmile DAL byl nakonfigurován pro podporu optimistickou metodu souběžného, je potřeba aktualizovat BLL metody.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-428">Once the DAL has been configured to support optimistic concurrency, the BLL methods need to be updated.</span></span> <span data-ttu-id="a9a9f-429">Kromě toho stránku ASP.NET, který zavolá BLL musí být nakonfigurované tak, aby ObjectDataSource načte původní hodnoty z jeho ovládací prvek webu dat a předává je do BLL.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-429">Additionally, the ASP.NET page that calls down into the BLL must be configured such that the ObjectDataSource retrieves the original values from its data Web control and passes them down into the BLL.</span></span>

<span data-ttu-id="a9a9f-430">Jak jsme viděli v tomto kurzu, implementace optimistické řízení souběžného ve webové aplikaci ASP.NET zahrnuje aktualizaci DAL a BLL a přidání podpory do stránky ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-430">As we saw in this tutorial, implementing optimistic concurrency control in an ASP.NET web application involves updating the DAL and BLL and adding support in the ASP.NET page.</span></span> <span data-ttu-id="a9a9f-431">Zda přidané činnost je vhodné investice čas a úsilí, závisí na vaší aplikace.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-431">Whether or not this added work is a wise investment of your time and effort depends on your application.</span></span> <span data-ttu-id="a9a9f-432">Pokud máte zřídka souběžných uživatelů aktualizace dat, nebo data, která se aktualizují se liší od sebe navzájem, pak souběžnosti ovládací prvek není klíče problém.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-432">If you infrequently have concurrent users updating data, or the data they are updating is different from one another, then concurrency control is not a key issue.</span></span> <span data-ttu-id="a9a9f-433">Pokud ale pravidelně máte více uživatelů na svém webu práce se stejnými daty, Kontrola souběžnosti pomáhají zabránit jeden uživatel aktualizace nebo odstranění bezděčně přepsání jiné osoby.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-433">If, however, you routinely have multiple users on your site working with the same data, concurrency control can help prevent one user's updates or deletes from unwittingly overwriting another's.</span></span>

<span data-ttu-id="a9a9f-434">Radostí programování!</span><span class="sxs-lookup"><span data-stu-id="a9a9f-434">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="a9a9f-435">O autorovi</span><span class="sxs-lookup"><span data-stu-id="a9a9f-435">About the Author</span></span>

<span data-ttu-id="a9a9f-436">[Scott Meisnerová](http://www.4guysfromrolla.com/ScottMitchell.shtml), Autor sedm ASP/ASP.NET knih a zakladatele z [4GuysFromRolla.com](http://www.4guysfromrolla.com), pracuje s technologií Microsoft Web od 1998.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="a9a9f-437">Scott funguje jako nezávislé poradce, trainer a zapisovače.</span><span class="sxs-lookup"><span data-stu-id="a9a9f-437">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="a9a9f-438">Jeho nejnovější seznam k [ *Edice nakladatelství Sams naučit sami technologii ASP.NET 2.0 za 24 hodin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-438">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="a9a9f-439">Dosažitelný v [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) nebo prostřednictvím svého blogu, který najdete na [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="a9a9f-439">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="a9a9f-440">[Předchozí](customizing-the-data-modification-interface-vb.md)
[další](adding-client-side-confirmation-when-deleting-vb.md)</span><span class="sxs-lookup"><span data-stu-id="a9a9f-440">[Previous](customizing-the-data-modification-interface-vb.md)
[Next](adding-client-side-confirmation-when-deleting-vb.md)</span></span>
