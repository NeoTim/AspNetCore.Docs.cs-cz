---
uid: mvc/overview/security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages
title: Prevence XSRF/proti útokům CSRF v architektuře ASP.NET MVC a webových stránek | Microsoft Docs
author: Rick-Anderson
description: Padělání požadavku posílaného mezi weby (také označované jako XSRF nebo proti útokům CSRF) je útok na hostované webové aplikace, při kterém se škodlivý web mohou mít vliv Interakti...
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/14/2013
ms.topic: article
ms.assetid: aadc5fa4-8215-4fc7-afd5-bcd2ef879728
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages
msc.type: authoredcontent
ms.openlocfilehash: 6cf30daa7ed966b11405cec715c5bc803b567249
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 04/10/2018
---
<a name="xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages"></a><span data-ttu-id="5b11b-103">Prevence XSRF/proti útokům CSRF v architektuře ASP.NET MVC a webových stránek</span><span class="sxs-lookup"><span data-stu-id="5b11b-103">XSRF/CSRF Prevention in ASP.NET MVC and Web Pages</span></span>
====================
<span data-ttu-id="5b11b-104">podle [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="5b11b-104">by [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="5b11b-105">Padělání (také označované jako XSRF nebo proti útokům CSRF) je útok na hostované webové aplikace, které můžete vytvořit web ovlivnit interakce mezi klientského prohlížeče a webu důvěryhodný prohlížeč tohoto webů požadavek.</span><span class="sxs-lookup"><span data-stu-id="5b11b-105">Cross-site request forgery (also known as XSRF or CSRF) is an attack against web-hosted applications whereby a malicious web site can influence the interaction between a client browser and a web site trusted by that browser.</span></span> <span data-ttu-id="5b11b-106">Tyto útoky jsou možné, protože webových prohlížečů bude odesílat tokeny ověřování automaticky s každou žádost na web.</span><span class="sxs-lookup"><span data-stu-id="5b11b-106">These attacks are made possible because web browsers will send authentication tokens automatically with every request to a web site.</span></span> <span data-ttu-id="5b11b-107">V kanonickém tvaru příkladu je soubor cookie ověřování, jako je například ASP. Lístek ověřování pomocí formulářů pro Asp.net.</span><span class="sxs-lookup"><span data-stu-id="5b11b-107">The canonical example is an authentication cookie, such as ASP.NET's Forms Authentication ticket.</span></span> <span data-ttu-id="5b11b-108">Tyto útoky však může být cílem weby, které používají všechny trvalé ověřovací mechanismus (například ověřování systému Windows, Basic a tak dále).</span><span class="sxs-lookup"><span data-stu-id="5b11b-108">However, web sites which use any persistent authentication mechanism (such as Windows Authentication, Basic, and so forth) can be targeted by these attacks.</span></span>
> 
> <span data-ttu-id="5b11b-109">Útok XSRF se liší od útoky phishing.</span><span class="sxs-lookup"><span data-stu-id="5b11b-109">An XSRF attack is distinct from a phishing attack.</span></span> <span data-ttu-id="5b11b-110">Útoky phishing vyžadovat interakci z napadeného.</span><span class="sxs-lookup"><span data-stu-id="5b11b-110">Phishing attacks require interaction from the victim.</span></span> <span data-ttu-id="5b11b-111">V útoku phishing škodlivý web bude napodobovat cílového webu a napadené je oklamat do poskytování útočník citlivé informace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-111">In a phishing attack, a malicious web site will mimic the target web site, and the victim is fooled into providing sensitive information to the attacker.</span></span> <span data-ttu-id="5b11b-112">Při útoku XSRF není často žádná interakce potřebné z napadeného.</span><span class="sxs-lookup"><span data-stu-id="5b11b-112">In an XSRF attack, there is often no interaction necessary from the victim.</span></span> <span data-ttu-id="5b11b-113">Místo toho je útočník spoléhat na prohlížeči všechny relevantní soubory cookie automaticky odesílání do cílového webu.</span><span class="sxs-lookup"><span data-stu-id="5b11b-113">Rather, the attacker is relying on the browser automatically sending all relevant cookies to the destination web site.</span></span>
> 
> <span data-ttu-id="5b11b-114">Další informace najdete v tématu [otevřete projekt webové aplikace zabezpečení](https://www.owasp.org/index.php/Main_Page)(OWASP) [XSRF](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)).</span><span class="sxs-lookup"><span data-stu-id="5b11b-114">For more information, see the [Open Web Application Security Project](https://www.owasp.org/index.php/Main_Page)(OWASP) [XSRF](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)).</span></span>


## <a name="anatomy-of-an-attack"></a><span data-ttu-id="5b11b-115">Anatomie útoku</span><span class="sxs-lookup"><span data-stu-id="5b11b-115">Anatomy of an attack</span></span>

<span data-ttu-id="5b11b-116">Chcete-li provede XSRF útok, zvažte uživatel, který chce provést některé online bankovnictví transakce.</span><span class="sxs-lookup"><span data-stu-id="5b11b-116">To walk through an XSRF attack, consider a user who wants to perform some online banking transactions.</span></span> <span data-ttu-id="5b11b-117">Tento uživatel navštíví nejprve WoodgroveBank.com a protokoly, za bod, který bude obsahovat hlavičku odpovědi svůj soubor cookie pro ověřování:</span><span class="sxs-lookup"><span data-stu-id="5b11b-117">This user first visits WoodgroveBank.com and logs in, at which point the response header will contain her authentication cookie:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample1.cmd)]

<span data-ttu-id="5b11b-118">Ověřovacího souboru cookie je soubor cookie relace, a proto jej bude automaticky vymazán prohlížeč při ukončení procesu prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="5b11b-118">Because the authentication cookie is a session cookie, it will be automatically cleared by the browser when the browser process exits.</span></span> <span data-ttu-id="5b11b-119">Do té doby, ale prohlížeč bude obsahovat automaticky souborů cookie u každé žádosti o WoodgroveBank.com. Uživatel se teď chce přenosu 1 000 USD na jiný účet, tak, aby Jana vyplňování formuláře na webu bankovnictví a prohlížeč provede tento požadavek na server:</span><span class="sxs-lookup"><span data-stu-id="5b11b-119">However, until that time, the browser will automatically include the cookie with each request to WoodgroveBank.com. The user now wants to transfer $1000 to another account, so she fills out a form on the banking site, and the browser makes this request to the server:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample2.cmd)]

<span data-ttu-id="5b11b-120">Protože tato operace má vedlejším účinkem (inicializuje peněžní transakci), se rozhodli webu bankovní vyžadují HTTP POST, aby bylo možné spustit tuto operaci.</span><span class="sxs-lookup"><span data-stu-id="5b11b-120">Because this operation has a side effect (it initiates a monetary transaction), the banking site has chosen to require an HTTP POST in order to initiate this operation.</span></span> <span data-ttu-id="5b11b-121">Server přečte ověřovací token ze žádosti, vyhledá číslo účtu aktuálního uživatele, ověří, že existují dostatečné prostředky a poté zahájí transakce do cílového účtu.</span><span class="sxs-lookup"><span data-stu-id="5b11b-121">The server reads the authentication token from the request, looks up the current user's account number, verifies that sufficient funds exist, and then initiates the transaction into the destination account.</span></span>

<span data-ttu-id="5b11b-122">Jí online bankovnictví dokončení, uživatel přejde mimo lokalitu bankovnictví a navštíví jiných umístění na webu.</span><span class="sxs-lookup"><span data-stu-id="5b11b-122">Her online banking complete, the user navigates away from the banking site and visits other locations on the web.</span></span> <span data-ttu-id="5b11b-123">Jednu z těchto lokalit – fabrikam.com – zahrnuje následující kód na stránce vložených v rámci &lt;iframe&gt;:</span><span class="sxs-lookup"><span data-stu-id="5b11b-123">One of those sites – fabrikam.com – includes the following markup on a page embedded within an &lt;iframe&gt;:</span></span>

[!code-html[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample3.html)]

<span data-ttu-id="5b11b-124">Které způsobí, že prohlížeč pro vytvoření této žádosti:</span><span class="sxs-lookup"><span data-stu-id="5b11b-124">Which then causes the browser to make this request:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample4.cmd)]

<span data-ttu-id="5b11b-125">Útočník zneužívá skutečnost, že uživatel může mít stále platný ověřovací token pro cílový webový server, a uživatel používá malé fragment kódu jazyka Javascript v prohlížeči, aby HTTP POST do cílové lokality automaticky.</span><span class="sxs-lookup"><span data-stu-id="5b11b-125">The attacker is exploiting the fact that the user might still have a valid authentication token for the target web site, and she is using a small snippet of Javascript to cause the browser to make an HTTP POST to the target site automatically.</span></span> <span data-ttu-id="5b11b-126">Pokud ověřovací token je stále platné, bude webu bankovní zahájení přenosu 250 do účet útočníkem.</span><span class="sxs-lookup"><span data-stu-id="5b11b-126">If the authentication token is still valid, the banking site will initiate a transfer of $250 into the account of the attacker's choosing.</span></span>

### <a name="ineffective-mitigations"></a><span data-ttu-id="5b11b-127">Neúčinná způsoby zmírnění rizik</span><span class="sxs-lookup"><span data-stu-id="5b11b-127">Ineffective mitigations</span></span>

<span data-ttu-id="5b11b-128">Je zajímavé Všimněte si, že uvedený scénář, bylo skutečnost, že WoodgroveBank.com se přistupuje přes protokol SSL a měl soubor cookie ověřování pouze SSL dostatek zabránit útokům.</span><span class="sxs-lookup"><span data-stu-id="5b11b-128">It is interesting to note that in the above scenario, the fact that WoodgroveBank.com was being accessed via SSL and had an SSL-only authentication cookie was insufficient to thwart the attack.</span></span> <span data-ttu-id="5b11b-129">Je možné zadat útočník [schéma identifikátoru URI](http://en.wikipedia.org/wiki/URI_scheme) (https) v její &lt;formuláře&gt; elementu a prohlížeč bude nadále odesílat neprošlé soubory cookie k cílovému webu, tak dlouho, dokud tyto soubory cookie jsou konzistentní s identifikátorem URI schéma zamýšleného cílového.</span><span class="sxs-lookup"><span data-stu-id="5b11b-129">The attacker is able to specify the [URI scheme](http://en.wikipedia.org/wiki/URI_scheme) (https) in her &lt;form&gt; element, and the browser will continue to send unexpired cookies to the target site as long as those cookies are consistent with the URI scheme of the intended target.</span></span>

<span data-ttu-id="5b11b-130">Jeden může uvádějí, které uživatel by neměl jednoduše naleznete umístěné na serverech, jako návštěvou pouze důvěryhodných serverů je pomáhá zůstat online bezpečné.</span><span class="sxs-lookup"><span data-stu-id="5b11b-130">One could argue that the user should simply not visit untrusted sites, as visiting only trusted sites is helps to remain safe online.</span></span> <span data-ttu-id="5b11b-131">Je některé založená na to, ale bohužel tuto žádost není vždy reálné.</span><span class="sxs-lookup"><span data-stu-id="5b11b-131">There is some truth to this, but unfortunately this advice is not always practical.</span></span> <span data-ttu-id="5b11b-132">Možná uživatele "důvěřuje" místní zprávy lokality ConsolidatedMessenger.</span><span class="sxs-lookup"><span data-stu-id="5b11b-132">Perhaps the user "trusts" the local news site ConsolidatedMessenger.</span></span> <span data-ttu-id="5b11b-133">ConsolidatedMessenger.com a vloží do návštěvu, která místo lokality, ale této lokality musí XSS ohrožení zabezpečení, která umožňuje útočníkovi vložení stejné fragment kódu, který byl spuštěn na fabrikam.com.</span><span class="sxs-lookup"><span data-stu-id="5b11b-133">ConsolidatedMessenger.com and goes to visit that site instead, but that site has an XSS vulnerability which allows an attacker to inject the same snippet of code that was running on fabrikam.com.</span></span>

<span data-ttu-id="5b11b-134">Můžete ověřit, že mají příchozí požadavky [odkazující server záhlaví](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) odkazující na doménu.</span><span class="sxs-lookup"><span data-stu-id="5b11b-134">You can verify that incoming requests have a [Referer header](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) referencing your domain.</span></span> <span data-ttu-id="5b11b-135">To se zastaví požadavky bezděčně odeslané z domény třetí strany.</span><span class="sxs-lookup"><span data-stu-id="5b11b-135">This will stop requests unwittingly submitted from a third-party domain.</span></span> <span data-ttu-id="5b11b-136">Ale někteří uživatelé zakažte záhlaví odkazující server svého prohlížeče z důvodů ochrany osobních údajů a útočník může někdy zfalšovat této hlavičky, pokud napadené má určitá nezabezpečené nainstalovaný software.</span><span class="sxs-lookup"><span data-stu-id="5b11b-136">However, some people disable their browser's Referer header for privacy reasons, and attackers can sometimes spoof that header if the victim has certain insecure software installed.</span></span> <span data-ttu-id="5b11b-137">Ověření [odkazující server záhlaví](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) nepovažuje zabezpečený přístup k ochrana před útoky XSRF.</span><span class="sxs-lookup"><span data-stu-id="5b11b-137">Verifying the [Referer header](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) is not considered a secure approach to preventing XSRF attacks.</span></span>

## <a name="web-stack-runtime-xsrf-mitigations"></a><span data-ttu-id="5b11b-138">Způsoby zmírnění rizik webové XSRF Runtime zásobníku</span><span class="sxs-lookup"><span data-stu-id="5b11b-138">Web Stack Runtime XSRF mitigations</span></span>

<span data-ttu-id="5b11b-139">Modul Runtime ASP.NET Web zásobníku používá jeho variantě [tokenu vzor synchronizátor](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern) se chránit před útoky XSRF.</span><span class="sxs-lookup"><span data-stu-id="5b11b-139">The ASP.NET Web Stack Runtime uses a variant of the [synchronizer token pattern](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern) to defend against XSRF attacks.</span></span> <span data-ttu-id="5b11b-140">Obecná forma vzoru synchronizátor tokenu je, že dva anti-XSRF tokeny jsou odeslána na server s každou HTTP POST (kromě ověřovací token): jeden token souboru cookie a druhý jako hodnotu formuláře.</span><span class="sxs-lookup"><span data-stu-id="5b11b-140">The general form of the synchronizer token pattern is that two anti-XSRF tokens are submitted to the server with each HTTP POST (In addition to the authentication token): one token as a cookie, and the other as a form value.</span></span> <span data-ttu-id="5b11b-141">Hodnoty tokenu generované modulem runtime ASP.NET nejsou deterministickou nebo předvídatelný uživatelem se zlými úmysly.</span><span class="sxs-lookup"><span data-stu-id="5b11b-141">The token values generated by the ASP.NET runtime are not deterministic or predictable by an attacker.</span></span> <span data-ttu-id="5b11b-142">Tokeny jsou odeslány, serveru umožňuje v případě požadavku pokračujte pouze v případě, že oba tokeny předat kontrolu porovnání.</span><span class="sxs-lookup"><span data-stu-id="5b11b-142">When the tokens are submitted, the server will allow the request to proceed only if both tokens pass a comparison check.</span></span>

<span data-ttu-id="5b11b-143">Požadavek ověřování XSRF *token relace* se ukládají jako souboru cookie HTTP a aktuálně obsahuje následující informace v jeho datové části:</span><span class="sxs-lookup"><span data-stu-id="5b11b-143">The XSRF request verification *session token* is stored as an HTTP cookie and currently contains the following information in its payload:</span></span>

- <span data-ttu-id="5b11b-144">Token zabezpečení skládající se z náhodné identifikátor 128-bit.</span><span class="sxs-lookup"><span data-stu-id="5b11b-144">A security token, consisting of a random 128-bit identifier.</span></span>   
 <span data-ttu-id="5b11b-145">Následující obrázek ukazuje XSRF žádosti o ověření relace token zobrazí pomocí nástrojů pro vývojáře Internet Explorer F12: (Poznámka: Toto je aktuální implementace a je předmět, i pravděpodobně, chcete-li změnit.)</span><span class="sxs-lookup"><span data-stu-id="5b11b-145">The following image shows the XSRF request verification session token displayed with the Internet Explorer F12 developer tools: (Note this is the current implementation and is subject, even likely, to change.)</span></span>

![](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/_static/image1.png)

<span data-ttu-id="5b11b-146">*Pole token* se ukládají jako `<input type="hidden" />` a obsahuje následující informace v jeho datové části:</span><span class="sxs-lookup"><span data-stu-id="5b11b-146">The *field token* is stored as an `<input type="hidden" />` and contains the following information in its payload:</span></span>

- <span data-ttu-id="5b11b-147">Uživatelské jméno přihlášeného uživatele (Pokud ověřený).</span><span class="sxs-lookup"><span data-stu-id="5b11b-147">The logged-in user's username (if authenticated).</span></span>
- <span data-ttu-id="5b11b-148">Žádná další data poskytované [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx).</span><span class="sxs-lookup"><span data-stu-id="5b11b-148">Any additional data provided by an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx).</span></span>

<span data-ttu-id="5b11b-149">Datových částí tokeny anti-XSRF se šifrovaný a podepsaný, tak při použití nástroje pro zjištění tokeny nelze zobrazit uživatelské jméno.</span><span class="sxs-lookup"><span data-stu-id="5b11b-149">The payloads of the anti-XSRF tokens are encrypted and signed, so you can't view the username when using tools to examine the tokens.</span></span> <span data-ttu-id="5b11b-150">Pokud je webová aplikace je cílem technologii ASP.NET 4.0, šifrovací služby jsou poskytovány [MachineKey.Encode](https://msdn.microsoft.com/library/system.web.security.machinekey.encode.aspx) rutiny.</span><span class="sxs-lookup"><span data-stu-id="5b11b-150">When the web application is targeting ASP.NET 4.0, cryptographic services are provided by the [MachineKey.Encode](https://msdn.microsoft.com/library/system.web.security.machinekey.encode.aspx) routine.</span></span> <span data-ttu-id="5b11b-151">Když webové aplikace je cílení na technologii ASP.NET 4.5 nebo vyšší, kryptografické služby jsou poskytovány [MachineKey.Protect](https://msdn.microsoft.com/library/system.web.security.machinekey.protect(v=vs.110)) rutiny, který nabízí lepší výkon, rozšíření a zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="5b11b-151">When the web application is targeting ASP.NET 4.5 or higher, cryptographic services are provided by the [MachineKey.Protect](https://msdn.microsoft.com/library/system.web.security.machinekey.protect(v=vs.110)) routine, which offers better performance, extensibility, and security.</span></span> <span data-ttu-id="5b11b-152">Zjistit že následující příspěvky další podrobnosti:</span><span class="sxs-lookup"><span data-stu-id="5b11b-152">See the following blog posts for more details:</span></span>

- [<span data-ttu-id="5b11b-153">Kryptografických vylepšení v technologii ASP.NET 4.5, pt. 1</span><span class="sxs-lookup"><span data-stu-id="5b11b-153">Cryptographic Improvements in ASP.NET 4.5, pt. 1</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/22/cryptographic-improvements-in-asp-net-4-5-pt-1.aspx)
- [<span data-ttu-id="5b11b-154">Kryptografických vylepšení v technologii ASP.NET 4.5, pt. 2</span><span class="sxs-lookup"><span data-stu-id="5b11b-154">Cryptographic Improvements in ASP.NET 4.5, pt. 2</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/23/cryptographic-improvements-in-asp-net-4-5-pt-2.aspx)
- [<span data-ttu-id="5b11b-155">Kryptografických vylepšení v technologii ASP.NET 4.5, pt. 3</span><span class="sxs-lookup"><span data-stu-id="5b11b-155">Cryptographic Improvements in ASP.NET 4.5, pt. 3</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/24/cryptographic-improvements-in-asp-net-4-5-pt-3.aspx)

## <a name="generating-the-tokens"></a><span data-ttu-id="5b11b-156">Generování tokenů</span><span class="sxs-lookup"><span data-stu-id="5b11b-156">Generating the tokens</span></span>

<span data-ttu-id="5b11b-157">Ke generování tokenů anti-XSRF, volání [ @Html.AntiForgeryToken ](https://msdn.microsoft.com/library/dd470175.aspx) metoda ze zobrazení MVC nebo @AntiForgery.GetHtml() ze stránky Razor.</span><span class="sxs-lookup"><span data-stu-id="5b11b-157">To generate the anti-XSRF tokens, call the [@Html.AntiForgeryToken](https://msdn.microsoft.com/library/dd470175.aspx) method from an MVC view or @AntiForgery.GetHtml() from a Razor page.</span></span> <span data-ttu-id="5b11b-158">Modul runtime pak provede následující kroky:</span><span class="sxs-lookup"><span data-stu-id="5b11b-158">The runtime will then perform the following steps:</span></span>

1. <span data-ttu-id="5b11b-159">Pokud aktuální žádost HTTP již obsahuje token anti-XSRF relace (soubor cookie anti-XSRF \_ \_RequestVerificationToken), se z něj extrahuje token zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="5b11b-159">If the current HTTP request already contains an anti-XSRF session token (the anti-XSRF cookie \_\_RequestVerificationToken), the security token is extracted from it.</span></span> <span data-ttu-id="5b11b-160">Pokud požadavek HTTP neobsahuje token anti-XSRF relace nebo pokud extrakce tokenu zabezpečení se nezdařila, vygeneruje se nový token anti-XSRF náhodné.</span><span class="sxs-lookup"><span data-stu-id="5b11b-160">If the HTTP request does not contain an anti-XSRF session token or if extraction of the security token fails, a new random anti-XSRF token will be generated.</span></span>
2. <span data-ttu-id="5b11b-161">Token anti-XSRF pole je generována pomocí tokenu zabezpečení z kroku (1) a totožnosti aktuálně přihlášeného uživatele.</span><span class="sxs-lookup"><span data-stu-id="5b11b-161">An anti-XSRF field token is generated using the security token from step (1) above and the identity of the current logged-in user.</span></span> <span data-ttu-id="5b11b-162">(Další informace o určení identity uživatele, najdete v článku **[scénáře s podporou speciální](#_Scenarios_with_special)** části.) Kromě toho pokud [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/jj158328(v=vs.111).aspx) je nakonfigurována, bude volat modulu runtime jeho [GetAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.getadditionaldata(v=vs.111).aspx) metoda a zahrnout do pole token vrácený řetězec.</span><span class="sxs-lookup"><span data-stu-id="5b11b-162">(For more information on determining user identity, see the **[Scenarios with special support](#_Scenarios_with_special)** section below.) Additionally, if an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/jj158328(v=vs.111).aspx) is configured, the runtime will call its [GetAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.getadditionaldata(v=vs.111).aspx) method and include the returned string in the field token.</span></span> <span data-ttu-id="5b11b-163">(Viz **[konfigurace a rozšíření](#_Configuration_and_extensibility)** části Další informace.)</span><span class="sxs-lookup"><span data-stu-id="5b11b-163">(See the **[Configuration and extensibility](#_Configuration_and_extensibility)** section for more information.)</span></span>
3. <span data-ttu-id="5b11b-164">Pokud nový token anti-XSRF se vygeneroval v kroku (1), token novou relaci pro ji obsahují se vytvoří a bude přidán ke kolekci souborů cookie odchozí HTTP.</span><span class="sxs-lookup"><span data-stu-id="5b11b-164">If a new anti-XSRF token was generated in step (1), a new session token will be created to contain it and will be added to the outbound HTTP cookies collection.</span></span> <span data-ttu-id="5b11b-165">Pole tokenu z kroku (2) bude uzavřen do `<input type="hidden" />` elementu a tento kód HTML se vrátí hodnotu, která `Html.AntiForgeryToken()` nebo `AntiForgery.GetHtml()`.</span><span class="sxs-lookup"><span data-stu-id="5b11b-165">The field token from step (2) will be wrapped in an `<input type="hidden" />` element, and this HTML markup will be the return value of `Html.AntiForgeryToken()` or `AntiForgery.GetHtml()`.</span></span>

## <a name="validating-the-tokens"></a><span data-ttu-id="5b11b-166">Ověřování tokenů</span><span class="sxs-lookup"><span data-stu-id="5b11b-166">Validating the tokens</span></span>

<span data-ttu-id="5b11b-167">K ověření příchozí tokeny anti-XSRF, zahrnuje Vývojář [ValidateAntiForgeryToken](https://msdn.microsoft.com/library/system.web.mvc.validateantiforgerytokenattribute(VS.108).aspx) atribut na jeho akce MVC nebo řadiče nebo volání she `@AntiForgery.Validate()` z jeho stránky Razor.</span><span class="sxs-lookup"><span data-stu-id="5b11b-167">To validate the incoming anti-XSRF tokens, the developer includes a [ValidateAntiForgeryToken](https://msdn.microsoft.com/library/system.web.mvc.validateantiforgerytokenattribute(VS.108).aspx) attribute on her MVC action or controller, or she calls `@AntiForgery.Validate()` from her Razor page.</span></span> <span data-ttu-id="5b11b-168">Modul runtime provede následující kroky:</span><span class="sxs-lookup"><span data-stu-id="5b11b-168">The runtime will perform the following steps:</span></span>

1. <span data-ttu-id="5b11b-169">Příchozí token relace a pole token se čtou a token anti-XSRF extrahovat z každé.</span><span class="sxs-lookup"><span data-stu-id="5b11b-169">The incoming session token and field token are read and the anti-XSRF token extracted from each.</span></span> <span data-ttu-id="5b11b-170">Anti-XSRF tokeny musí být identické za krok (2) v rutině generace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-170">The anti-XSRF tokens must be identical per step (2) in the generation routine.</span></span>
2. <span data-ttu-id="5b11b-171">Pokud je aktuální uživatel ověřen, svoje uživatelské jméno se porovná s uživatelským jménem, uložené v tokenu pole.</span><span class="sxs-lookup"><span data-stu-id="5b11b-171">If the current user is authenticated, her username is compared with the username stored in the field token.</span></span> <span data-ttu-id="5b11b-172">Uživatelských jménech se musí shodovat.</span><span class="sxs-lookup"><span data-stu-id="5b11b-172">The usernames must match.</span></span>
3. <span data-ttu-id="5b11b-173">Pokud [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) je nakonfigurován, volání modulu runtime jeho *ValidateAdditionalData* metoda.</span><span class="sxs-lookup"><span data-stu-id="5b11b-173">If an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) is configured, the runtime calls its *ValidateAdditionalData* method.</span></span> <span data-ttu-id="5b11b-174">Metoda musí vrátit logickou hodnotu *true*.</span><span class="sxs-lookup"><span data-stu-id="5b11b-174">The method must return the Boolean value *true*.</span></span>

<span data-ttu-id="5b11b-175">V případě úspěšného ověření požadavku je povoleno pokračovat.</span><span class="sxs-lookup"><span data-stu-id="5b11b-175">If validation succeeds, the request is allowed to proceed.</span></span> <span data-ttu-id="5b11b-176">Pokud ověření selže, vyvolá výjimku rozhraní *HttpAntiForgeryException*.</span><span class="sxs-lookup"><span data-stu-id="5b11b-176">If validation fails, the framework will throw an *HttpAntiForgeryException*.</span></span>

## <a name="failure-conditions"></a><span data-ttu-id="5b11b-177">Podmínky při selhání</span><span class="sxs-lookup"><span data-stu-id="5b11b-177">Failure conditions</span></span>

<span data-ttu-id="5b11b-178">Od verze ASP.NET Web zásobníku Runtime v2, všechny *HttpAntiForgeryException* , je vyvolána při ověření bude obsahovat podrobné informace o chybě.</span><span class="sxs-lookup"><span data-stu-id="5b11b-178">Starting with The ASP.NET Web Stack Runtime v2, any *HttpAntiForgeryException* that is thrown during validation will contain detailed information about what went wrong.</span></span> <span data-ttu-id="5b11b-179">Aktuálně definovaných selhání podmínky jsou:</span><span class="sxs-lookup"><span data-stu-id="5b11b-179">The currently defined failure conditions are:</span></span>

- <span data-ttu-id="5b11b-180">Token relace nebo tokenu formuláře se nenachází v požadavku.</span><span class="sxs-lookup"><span data-stu-id="5b11b-180">The session token or form token is not present in the request.</span></span>
- <span data-ttu-id="5b11b-181">Token relace nebo tokenu formuláře nečitelná.</span><span class="sxs-lookup"><span data-stu-id="5b11b-181">The session token or form token is unreadable.</span></span> <span data-ttu-id="5b11b-182">Nejpravděpodobnější příčinou je farmou neodpovídající verzemi ASP.NET Web zásobníku Runtime nebo farmy kde &lt;machineKey&gt; element v souboru Web.config se liší mezi počítači.</span><span class="sxs-lookup"><span data-stu-id="5b11b-182">The most likely cause of this is a farm running mismatched versions of The ASP.NET Web Stack Runtime or a farm where the &lt;machineKey&gt; element in Web.config differs between machines.</span></span> <span data-ttu-id="5b11b-183">Můžete například nástroj Fiddler k manipulaci s buď token anti-XSRF vynutit výjimku.</span><span class="sxs-lookup"><span data-stu-id="5b11b-183">You can use a tool such as Fiddler to force this exception by tampering with either anti-XSRF token.</span></span>
- <span data-ttu-id="5b11b-184">Token relace a pole token byly vzájemně zaměněny.</span><span class="sxs-lookup"><span data-stu-id="5b11b-184">The session token and field token were swapped.</span></span>
- <span data-ttu-id="5b11b-185">Token relace a pole token obsahovat tokeny neodpovídající zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="5b11b-185">The session token and field token contain mismatched security tokens.</span></span>
- <span data-ttu-id="5b11b-186">Vložená do tokenu pole uživatelské jméno neodpovídá uživatelské jméno aktuálního přihlášeného uživatele.</span><span class="sxs-lookup"><span data-stu-id="5b11b-186">The username embedded within the field token does not match the current logged-in user's username.</span></span>
- <span data-ttu-id="5b11b-187">*[IAntiForgeryAdditionalDataProvider.ValidateAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.validateadditionaldata(v=vs.111).aspx)* metoda vrátí *false*.</span><span class="sxs-lookup"><span data-stu-id="5b11b-187">The *[IAntiForgeryAdditionalDataProvider.ValidateAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.validateadditionaldata(v=vs.111).aspx)* method returned *false*.</span></span>

<span data-ttu-id="5b11b-188">Anti-XSRF zařízení může také provést další kontrolu během ověření nebo generování tokenů a selhání během těchto kontrol může vést k výjimkám hlášeny.</span><span class="sxs-lookup"><span data-stu-id="5b11b-188">The anti-XSRF facilities may also perform additional checking during token generation or validation, and failures during these checks may result in exceptions being thrown.</span></span> <span data-ttu-id="5b11b-189">Najdete v článku [WIF / ACS / založené na deklaracích identity ověřování](#_WIF_ACS) a **[konfigurace a rozšíření](#_Configuration_and_extensibility)** částech Další informace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-189">See the [WIF / ACS / claims-based authentication](#_WIF_ACS) and **[Configuration and extensibility](#_Configuration_and_extensibility)** sections for more information.</span></span>

<a id="_Scenarios_with_special"></a>

## <a name="scenarios-with-special-support"></a><span data-ttu-id="5b11b-190">Scénáře s speciální podpory</span><span class="sxs-lookup"><span data-stu-id="5b11b-190">Scenarios with special support</span></span>

### <a name="anonymous-authentication"></a><span data-ttu-id="5b11b-191">Anonymní ověření</span><span class="sxs-lookup"><span data-stu-id="5b11b-191">Anonymous authentication</span></span>

<span data-ttu-id="5b11b-192">Systém anti-XSRF obsahuje speciální podporu pro anonymní uživatele, kde "anonymní" je definován jako uživatel, kde *IIdentity.IsAuthenticated* vlastnost vrátí *false*.</span><span class="sxs-lookup"><span data-stu-id="5b11b-192">The anti-XSRF system contains special support for anonymous users, where "anonymous" is defined as a user where the *IIdentity.IsAuthenticated* property returns *false*.</span></span> <span data-ttu-id="5b11b-193">Scénáře patří ochranu XSRF na přihlašovací stránku (dříve, než je uživatel ověřený) a schémat vlastní ověřování, kde aplikace používá mechanismus jiné než *identita* k identifikaci uživatelů.</span><span class="sxs-lookup"><span data-stu-id="5b11b-193">Scenarios include providing XSRF protection to the login page (before the user is authenticated) and custom authentication schemes where the application uses a mechanism other than *IIdentity* to identify users.</span></span>

<span data-ttu-id="5b11b-194">Pro tyto scénáře podporovat odvolat, aby tokeny relace a pole jsou spojena tokeny zabezpečení, které je plné krytí identifikátor náhodně generované 128-bit.</span><span class="sxs-lookup"><span data-stu-id="5b11b-194">To support these scenarios, recall that the session and field tokens are joined by a security token, which is a 128-bit randomly-generated opaque identifier.</span></span> <span data-ttu-id="5b11b-195">Tento token zabezpečení slouží ke sledování relace pro jednotlivé uživatele v Jana přejde lokality, takže ho efektivně slouží účel anonymní identifikátor.</span><span class="sxs-lookup"><span data-stu-id="5b11b-195">This security token is used to track an individual user's session as she navigates the site, so it effectively serves the purpose of an anonymous identifier.</span></span> <span data-ttu-id="5b11b-196">Prázdný řetězec se používá namísto uživatelské jméno pro generování a ověřování rutiny, které jsou popsané výše.</span><span class="sxs-lookup"><span data-stu-id="5b11b-196">An empty string is used in place of the username for the generation and validation routines described above.</span></span>

<a id="_WIF_ACS"></a>

### <a name="wif--acs--claims-based-authentication"></a><span data-ttu-id="5b11b-197">WIF / ACS / založené na deklaracích identity ověřování</span><span class="sxs-lookup"><span data-stu-id="5b11b-197">WIF / ACS / claims-based authentication</span></span>

<span data-ttu-id="5b11b-198">Za normálních okolností *identita* založená na rozhraní .NET Framework třídy mají vlastnost který *IIdentity.Name* je dostačující k jednoznačné identifikaci určitého uživatele v rámci konkrétní aplikace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-198">Normally, the *IIdentity* classes built in to the .NET Framework have the property that *IIdentity.Name* is sufficient to uniquely identify a particular user within a particular application.</span></span> <span data-ttu-id="5b11b-199">Například *FormsIdentity.Name* vrátí uživatelské jméno uložené v databázi členství (které je jedinečné pro všechny aplikace, v závislosti na tom, že databáze), *WindowsIdentity.Name* vrátí kvalifikovaný domény identity uživatele a tak dále.</span><span class="sxs-lookup"><span data-stu-id="5b11b-199">For example, *FormsIdentity.Name* returns the username stored in the membership database (which is unique for all applications depending on that database), *WindowsIdentity.Name* returns the domain-qualified identity of the user, and so on.</span></span> <span data-ttu-id="5b11b-200">Tyto systémy poskytují nejenom ověřování; budou také *identifikovat* uživatelům aplikace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-200">These systems provide not only authentication; they also *identify* users to an application.</span></span>

<span data-ttu-id="5b11b-201">Ověřování na základě deklarace identity, na druhé straně, nemusí nutně vyžadovat identifikace určitého uživatele.</span><span class="sxs-lookup"><span data-stu-id="5b11b-201">Claims-based authentication, on the other hand, does not necessarily require identifying a particular user.</span></span> <span data-ttu-id="5b11b-202">Místo toho *ClaimsPrincipal* a *ClaimsIdentity* typů jsou spojeny s sadu *deklarace identity* instance, kde jednotlivé deklaracích může být "je 18 + let" nebo " je správce"na jakoukoli jinou.</span><span class="sxs-lookup"><span data-stu-id="5b11b-202">Instead, the *ClaimsPrincipal* and *ClaimsIdentity* types are associated with a set of *Claim* instances, where the individual claims might be "is 18+ years of age" or "is an administrator" to anything else.</span></span> <span data-ttu-id="5b11b-203">Vzhledem k tomu, že uživatel nutně nezjistila, nemůžete použít modul runtime *ClaimsIdentity.Name* vlastnost jako jedinečný identifikátor pro tento konkrétní uživatel.</span><span class="sxs-lookup"><span data-stu-id="5b11b-203">Since the user hasn't necessarily been identified, the runtime cannot use the *ClaimsIdentity.Name* property as a unique identifier for this particular user.</span></span> <span data-ttu-id="5b11b-204">Tým služby zaznamenal reálného příklady kde *ClaimsIdentity.Name* vrátí *null*, vrátí (zobrazení) popisný název, nebo v opačném případě vrátí řetězec, který není vhodné používat jako jedinečný identifikátor pro uživatele.</span><span class="sxs-lookup"><span data-stu-id="5b11b-204">The team has seen real-world examples where *ClaimsIdentity.Name* returns *null*, returns a friendly (display) name, or otherwise returns a string that isn't appropriate for use as a unique identifier for the user.</span></span>

<span data-ttu-id="5b11b-205">Mnoho nasazení, které používají ověřování založené na deklaracích pomocí [služby Řízení přístupu Azure](https://msdn.microsoft.com/library/windowsazure/gg429786.aspx) (ACS) na konkrétní.</span><span class="sxs-lookup"><span data-stu-id="5b11b-205">Many of deployments which use claims-based authentication are using [Azure Access Control Service](https://msdn.microsoft.com/library/windowsazure/gg429786.aspx) (ACS) in particular.</span></span> <span data-ttu-id="5b11b-206">ACS umožňuje vývojáři ke konfiguraci jednotlivých *zprostředkovatelů identity* (například ADFS, poskytovatele Microsoft Account OpenID zprostředkovatelé třeba Yahoo! atd.), a vrátí zprostředkovatelů identity *název identifikátory*.</span><span class="sxs-lookup"><span data-stu-id="5b11b-206">ACS allows the developer to configure individual *identity providers* (such as ADFS, the Microsoft Account provider, OpenID providers like Yahoo!, etc.), and the identity providers return *name identifiers*.</span></span> <span data-ttu-id="5b11b-207">Tyto identifikátory název může obsahovat identifikovatelné osobní informace (PII) jako e-mailovou adresu, nebo může být anonymní jako identifikátoru PPID (Private Personal).</span><span class="sxs-lookup"><span data-stu-id="5b11b-207">These name identifiers may contain Personally Identifiable Information (PII) like an email address, or they could be anonymized like a Private Personal Identifier (PPID).</span></span> <span data-ttu-id="5b11b-208">Bez ohledu na to, řazené kolekce členů (zprostředkovatele identity, identifikátor jména) dostatečně slouží jako token příslušné sledování pro určitého uživatele při Jana je procházení webu, tak modulem Runtime ASP.NET webových protokolů můžete použít řazenou kolekci členů místo uživatelské jméno při generování a ověřování tokenů anti-XSRF pole.</span><span class="sxs-lookup"><span data-stu-id="5b11b-208">Regardless, the tuple (identity provider, name identifier) sufficiently serves as an appropriate tracking token for a particular user while she is browsing the site, so the ASP.NET Web Stack Runtime can use the tuple in place of the username when generating and validating anti-XSRF field tokens.</span></span> <span data-ttu-id="5b11b-209">Konkrétní identifikátory URI pro zprostředkovatele identity a identifikátor jména jsou:</span><span class="sxs-lookup"><span data-stu-id="5b11b-209">The particular URIs for the identity provider and the name identifier are :</span></span>

- `http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider`
- `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier`

<span data-ttu-id="5b11b-210">(Toto [stránky dokumentace služby ACS](https://msdn.microsoft.com/library/windowsazure/gg185971.aspx) Další informace.)</span><span class="sxs-lookup"><span data-stu-id="5b11b-210">(see this [ACS doc page](https://msdn.microsoft.com/library/windowsazure/gg185971.aspx) for more info.)</span></span>

<span data-ttu-id="5b11b-211">Při generování nebo ověření tokenu, bude modulem Runtime ASP.NET Web zásobníku v době běhu zkuste vazby pro typy:</span><span class="sxs-lookup"><span data-stu-id="5b11b-211">When generating or validating a token, the ASP.NET Web Stack Runtime will at runtime try binding to the types:</span></span>

- <span data-ttu-id="5b11b-212">`Microsoft.IdentityModel.Claims.IClaimsIdentity, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35` (Pro sadu SDK WIF.)</span><span class="sxs-lookup"><span data-stu-id="5b11b-212">`Microsoft.IdentityModel.Claims.IClaimsIdentity, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35` (For the WIF SDK.)</span></span>
- <span data-ttu-id="5b11b-213">`System.Security.Claims.ClaimsIdentity` (For .NET 4.5).</span><span class="sxs-lookup"><span data-stu-id="5b11b-213">`System.Security.Claims.ClaimsIdentity` (For .NET 4.5).</span></span>

<span data-ttu-id="5b11b-214">Pokud tyto typy existují a pokud aktuální uživatel *IIIIdentity* implementuje nebo podtřídy jednu z těchto typů, anti-XSRF zařízení bude používat (zprostředkovatele identity, identifikátor jména) řazené kolekce členů namísto uživatelského jména, při generování a ověřování tokenů.</span><span class="sxs-lookup"><span data-stu-id="5b11b-214">If these types exist, and if the current user's *IIIIdentity* implements or subclasses one of these types, the anti-XSRF facility will use the (identity provider, name identifier) tuple in place of the username when generating and validating the tokens.</span></span> <span data-ttu-id="5b11b-215">Pokud je k dispozici žádný takový řazené kolekce členů, požadavek se nezdaří s chybou popisující pro vývojáře, jak nakonfigurovat systém anti-XSRF a zjistěte, konkrétní založené na deklaracích ověřovací mechanismus používá.</span><span class="sxs-lookup"><span data-stu-id="5b11b-215">If no such tuple is present, the request will fail with an error describing to the developer how to configure the anti-XSRF system to understand the particular claims-based authentication mechanism in use.</span></span> <span data-ttu-id="5b11b-216">Najdete v článku **[konfigurace a rozšíření](#_Configuration_and_extensibility)** části Další informace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-216">See the **[Configuration and extensibility](#_Configuration_and_extensibility)** section for more information.</span></span>

### <a name="oauth--openid-authentication"></a><span data-ttu-id="5b11b-217">OAuth / OpenID ověřování</span><span class="sxs-lookup"><span data-stu-id="5b11b-217">OAuth / OpenID authentication</span></span>

<span data-ttu-id="5b11b-218">Nakonec anti-XSRF zařízení má zvláštní podporu pro aplikace, které používají ověřování OAuth nebo OpenID.</span><span class="sxs-lookup"><span data-stu-id="5b11b-218">Finally, the anti-XSRF facility has special support for applications which use OAuth or OpenID authentication.</span></span> <span data-ttu-id="5b11b-219">Tato podpora se na základě heuristiky: Pokud aktuální *IIdentity.Name* začíná http:// nebo https://, pak bude provedeno porovnání uživatelské jméno pomocí pořadí porovnávače spíše než porovnávače OrdinalIgnoreCase výchozí.</span><span class="sxs-lookup"><span data-stu-id="5b11b-219">This support is heuristic-based: if the current *IIdentity.Name* begins with http:// or https://, then username comparisons will be done using an Ordinal comparer rather than the default OrdinalIgnoreCase comparer.</span></span>

<a id="_Configuration_and_extensibility"></a>

## <a name="configuration-and-extensibility"></a><span data-ttu-id="5b11b-220">Konfigurace a rozšíření</span><span class="sxs-lookup"><span data-stu-id="5b11b-220">Configuration and extensibility</span></span>

<span data-ttu-id="5b11b-221">Vývojáři v některých případech může být vhodné přesnější kontrolou nad anti-XSRF generování a ověřování chování.</span><span class="sxs-lookup"><span data-stu-id="5b11b-221">Occasionally, developers may want tighter control over the anti-XSRF generation and validation behaviors.</span></span> <span data-ttu-id="5b11b-222">Například možná není žádoucí, MVC a webové stránky pomocné výchozí chování automaticky přidat do odpovědi soubory cookie protokolu HTTP a vývojáři mohou chtít zachovat tokeny jinde.</span><span class="sxs-lookup"><span data-stu-id="5b11b-222">For example, perhaps the MVC and Web Pages helpers' default behavior of automatically adding HTTP cookies to the response is undesirable, and the developer may wish to persist the tokens elsewhere.</span></span> <span data-ttu-id="5b11b-223">Existují dvě rozhraní API, abyste toto:</span><span class="sxs-lookup"><span data-stu-id="5b11b-223">There exist two APIs to assist with this:</span></span>

`AntiForgery.GetTokens(string oldCookieToken, out string newCookieToken, out string formToken);`  
`AntiForgery.Validate(string cookieToken, string formToken);`

<span data-ttu-id="5b11b-224">*GetTokens* metoda přijímá jako vstup existující XSRF žádosti o ověření relace tokenu (který může mít hodnotu null) a vytváří jako výstup pole token a nové relace tokenu XSRF žádosti o ověření.</span><span class="sxs-lookup"><span data-stu-id="5b11b-224">The *GetTokens* method takes as input an existing XSRF request verification session token (which may be null) and produces as output a new XSRF request verification session token and field token.</span></span> <span data-ttu-id="5b11b-225">Tokeny jsou jednoduše neprůhledného řetězce s žádné decoration; *formToken* hodnota nebude pro instanci měl být uzavřen do &lt;vstupní&gt; značky.</span><span class="sxs-lookup"><span data-stu-id="5b11b-225">The tokens are simply opaque strings with no decoration; the *formToken* value will for instance not be wrapped in an &lt;input&gt; tag.</span></span> <span data-ttu-id="5b11b-226">*NewCookieToken* , může mít hodnotu null; Pokud k tomu dojde, pak se *oldCookieToken* hodnota je stále platný a nový soubor cookie odpovědi musí být nastavena.</span><span class="sxs-lookup"><span data-stu-id="5b11b-226">The *newCookieToken* value may be null; if this occurs, then the *oldCookieToken* value is still valid and no new response cookie need be set.</span></span> <span data-ttu-id="5b11b-227">Volající *GetTokens* zodpovídá za uchování všechny potřebné odpovědi soubory cookie nebo generování všechny potřebné značky *GetTokens* metoda sama nijak nezmění jako vedlejším účinkem odpověď.</span><span class="sxs-lookup"><span data-stu-id="5b11b-227">The caller of *GetTokens* is responsible for persisting any necessary response cookies or generating any necessary markup; the *GetTokens* method itself will not alter the response as a side effect.</span></span> <span data-ttu-id="5b11b-228">*Ověřením* metoda přijímá příchozí relace a pole tokeny a spouští logiku zmíněnými ověření nad nimi.</span><span class="sxs-lookup"><span data-stu-id="5b11b-228">The *Validate* method takes the incoming session and field tokens and runs the aforementioned validation logic over them.</span></span>

### <a name="antiforgeryconfig"></a><span data-ttu-id="5b11b-229">AntiForgeryConfig</span><span class="sxs-lookup"><span data-stu-id="5b11b-229">AntiForgeryConfig</span></span>

<span data-ttu-id="5b11b-230">Vývojář může konfigurovat systém anti-XSRF z aplikace\_spustit.</span><span class="sxs-lookup"><span data-stu-id="5b11b-230">The developer may configure the anti-XSRF system from Application\_Start.</span></span> <span data-ttu-id="5b11b-231">Konfigurace je programový.</span><span class="sxs-lookup"><span data-stu-id="5b11b-231">Configuration is programmatic.</span></span> <span data-ttu-id="5b11b-232">Vlastnosti statických *AntiForgeryConfig* typu jsou popsané níže.</span><span class="sxs-lookup"><span data-stu-id="5b11b-232">The properties of the static *AntiForgeryConfig* type are described below.</span></span> <span data-ttu-id="5b11b-233">Většina uživatelů použití deklarací identity budou chtít nastavit vlastnost UniqueClaimTypeIdentifier.</span><span class="sxs-lookup"><span data-stu-id="5b11b-233">Most users using claims will want to set the UniqueClaimTypeIdentifier property.</span></span>

| <span data-ttu-id="5b11b-234">**Vlastnost**</span><span class="sxs-lookup"><span data-stu-id="5b11b-234">**Property**</span></span> | <span data-ttu-id="5b11b-235">**Popis**</span><span class="sxs-lookup"><span data-stu-id="5b11b-235">**Description**</span></span> |
| --- | --- |
| <span data-ttu-id="5b11b-236">**AdditionalDataProvider**</span><span class="sxs-lookup"><span data-stu-id="5b11b-236">**AdditionalDataProvider**</span></span> | <span data-ttu-id="5b11b-237">[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) , poskytuje dodatečná data během generování tokenů a odebírá další data během ověření tokenu.</span><span class="sxs-lookup"><span data-stu-id="5b11b-237">An [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) that provides additional data during token generation and consumes additional data during token validation.</span></span> <span data-ttu-id="5b11b-238">Výchozí hodnota je *null*.</span><span class="sxs-lookup"><span data-stu-id="5b11b-238">The default value is *null*.</span></span> <span data-ttu-id="5b11b-239">Další informace najdete v tématu [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) části.</span><span class="sxs-lookup"><span data-stu-id="5b11b-239">For more information, see the [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) section.</span></span> |
| <span data-ttu-id="5b11b-240">**CookieName**</span><span class="sxs-lookup"><span data-stu-id="5b11b-240">**CookieName**</span></span> | <span data-ttu-id="5b11b-241">Řetězec, který poskytuje název souboru cookie HTTP, který se používá k ukládání tokenu anti-XSRF relace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-241">A string that provides the name of the HTTP cookie that is used to store the anti-XSRF session token.</span></span> <span data-ttu-id="5b11b-242">Pokud tato hodnota není nastavená, název budou automaticky generovány podle nasazené virtuální cestu aplikace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-242">If this value is not set, a name will be automatically generated based on the application's deployed virtual path.</span></span> <span data-ttu-id="5b11b-243">Výchozí hodnota je *null*.</span><span class="sxs-lookup"><span data-stu-id="5b11b-243">The default value is *null*.</span></span> |
| <span data-ttu-id="5b11b-244">**requireSsl**</span><span class="sxs-lookup"><span data-stu-id="5b11b-244">**RequireSsl**</span></span> | <span data-ttu-id="5b11b-245">Logická hodnota, která určuje, jestli tokeny anti-XSRF se vyžadují k odeslání přes kanál zabezpečené protokolem SSL.</span><span class="sxs-lookup"><span data-stu-id="5b11b-245">A Boolean that dictates whether the anti-XSRF tokens are required to be submitted over an SSL-secured channel.</span></span> <span data-ttu-id="5b11b-246">Pokud je tato hodnota *true*, všechny soubory cookie automaticky generované bude mít nastaven příznak "zabezpečení" a rozhraní API anti-XSRF vyvolá výjimku, pokud je volána v rámci žádosti, které není odeslána prostřednictvím protokolu SSL.</span><span class="sxs-lookup"><span data-stu-id="5b11b-246">If this value is *true*, any automatically-generated cookies will have the "secure" flag set, and the anti-XSRF APIs will throw if called from within a request that is not submitted via SSL.</span></span> <span data-ttu-id="5b11b-247">Výchozí hodnota je *false*.</span><span class="sxs-lookup"><span data-stu-id="5b11b-247">The default value is *false*.</span></span> |
| <span data-ttu-id="5b11b-248">**SuppressIdentityHeuristicChecks**</span><span class="sxs-lookup"><span data-stu-id="5b11b-248">**SuppressIdentityHeuristicChecks**</span></span> | <span data-ttu-id="5b11b-249">Logická hodnota, která určuje, zda by měl systém anti-XSRF deaktivovat podporuje založené na deklaracích identity.</span><span class="sxs-lookup"><span data-stu-id="5b11b-249">A Boolean that dictates whether the anti-XSRF system should deactivate its support for claims-based identities.</span></span> <span data-ttu-id="5b11b-250">Pokud je tato hodnota *true*, systém bude předpokládat, že *IIdentity.Name* je vhodné pro použití jako identifikátor jedinečná uživatelská a nebude pokoušet zvláštní případ *IClaimsIdentity*nebo *ClClaimsIdentity* jak je popsáno v [WIF / ACS / založené na deklaracích identity ověřování](#_WIF_ACS) části.</span><span class="sxs-lookup"><span data-stu-id="5b11b-250">If this value is *true*, the system will assume that *IIdentity.Name* is appropriate for use as a unique per-user identifier and will not try to special-case *IClaimsIdentity* or *ClClaimsIdentity* as described in the [WIF / ACS / claims-based authentication](#_WIF_ACS) section.</span></span> <span data-ttu-id="5b11b-251">Výchozí hodnota je `false`.</span><span class="sxs-lookup"><span data-stu-id="5b11b-251">The default value is `false`.</span></span> |
| <span data-ttu-id="5b11b-252">**UniqueClaimTypeIdentifier**</span><span class="sxs-lookup"><span data-stu-id="5b11b-252">**UniqueClaimTypeIdentifier**</span></span> | <span data-ttu-id="5b11b-253">Řetězec, který určuje, které deklarace identity typu je vhodná pro použití jako identifikátor jedinečný jednotlivé uživatele.</span><span class="sxs-lookup"><span data-stu-id="5b11b-253">A string that indicates which claim type is appropriate for use as a unique per-user identifier.</span></span> <span data-ttu-id="5b11b-254">Pokud tato hodnota je sada a aktuální *identita* je založené na deklaracích, systém se pokusí o extrahování deklarace identity typu určeného *UniqueClaimTypeIdentifier*, a budou použity s odpovídající hodnotou místo při generování token pole uživatelské jméno.</span><span class="sxs-lookup"><span data-stu-id="5b11b-254">If this value is set and the current *IIdentity* is claims-based, the system will attempt to extract a claim of the type specified by *UniqueClaimTypeIdentifier*, and the corresponding value will be used in place of the user's username when generating the field token.</span></span> <span data-ttu-id="5b11b-255">Pokud není nalezen typ deklarace identity, systém nesplní žádost.</span><span class="sxs-lookup"><span data-stu-id="5b11b-255">If the claim type is not found, the system will fail the request.</span></span> <span data-ttu-id="5b11b-256">Výchozí hodnota je *null*, což naznačuje, že systém má použít (zprostředkovatele identity, identifikátor jména) podle předchozích pokynů namísto uživatelského jména uživatele řazené kolekce členů.</span><span class="sxs-lookup"><span data-stu-id="5b11b-256">The default value is *null*, which indicates that the system should use the (identity provider, name identifier) tuple as previously described in place of the user's username.</span></span> |

<a id="_IAntiForgeryAdditionalDataProvider"></a>

### <a name="iantiforgeryadditionaldataprovider"></a><span data-ttu-id="5b11b-257">IAntiForgeryAdditionalDataProvider</span><span class="sxs-lookup"><span data-stu-id="5b11b-257">IAntiForgeryAdditionalDataProvider</span></span>

<span data-ttu-id="5b11b-258">*[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx)* typ mohou vývojáři rozšířit chování systému anti-XSRF odezvy další data v každý token.</span><span class="sxs-lookup"><span data-stu-id="5b11b-258">The *[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx)* type allows developers to extend the behavior of the anti-XSRF system by round-tripping additional data in each token.</span></span> <span data-ttu-id="5b11b-259">*GetAdditionalData* metoda je volána pokaždé, když se vygeneruje token pole a vložené návratovou hodnotu v rámci vygenerovaný token.</span><span class="sxs-lookup"><span data-stu-id="5b11b-259">The *GetAdditionalData* method is called each time a field token is generated, and the return value is embedded within the generated token.</span></span> <span data-ttu-id="5b11b-260">Implementátor může vrátit časové razítko, hodnotu nonce nebo jakoukoli jinou hodnotu, které Jana, které z této metody.</span><span class="sxs-lookup"><span data-stu-id="5b11b-260">An implementer could return a timestamp, a nonce, or any other value she wishes from this method.</span></span>

<span data-ttu-id="5b11b-261">Podobně *ValidateAdditionalData* metoda je volána pokaždé, když se ověří token pole a je "Další data" řetězec, který byl vložen v rámci token předaný metodě.</span><span class="sxs-lookup"><span data-stu-id="5b11b-261">Similarly, the *ValidateAdditionalData* method is called each time a field token is validated, and the "additional data" string that was embedded within the token is passed to the method.</span></span> <span data-ttu-id="5b11b-262">Rutiny ověřování může implementovat vypršení časového limitu (kontrolou aktuální čas na dobu, která byla uložená, když byl vytvořen token), hodnotu nonce zaškrtnutím rutiny nebo jakékoliv potřeby logiku.</span><span class="sxs-lookup"><span data-stu-id="5b11b-262">The validation routine could implement a timeout (by checking the current time against the time that was stored when the token was created), a nonce checking routine, or any other desired logic.</span></span>

## <a name="design-decisions-and-security-considerations"></a><span data-ttu-id="5b11b-263">Rozhodnutí o návrhu a aspekty zabezpečení</span><span class="sxs-lookup"><span data-stu-id="5b11b-263">Design decisions and security considerations</span></span>

<span data-ttu-id="5b11b-264">Token zabezpečení, který odkazuje tokeny relace a pole je technicky nutné pouze při pokusu o chránit anonymní / neověřené uživatele před útoky XSRF.</span><span class="sxs-lookup"><span data-stu-id="5b11b-264">The security token that links the session and field tokens is technically only necessary when trying to protect anonymous / unauthenticated users against XSRF attacks.</span></span> <span data-ttu-id="5b11b-265">Pokud je uživatel ověřený, ověřovací token samotné (pravděpodobně z důvodu odeslaná ve formátu souboru cookie) by se použil jako jednu polovinu synchronizátora token pár.</span><span class="sxs-lookup"><span data-stu-id="5b11b-265">When the user is authenticated, the authentication token itself (presumably submitted in the form of a cookie) could be used as one half of a synchronizer token pair.</span></span> <span data-ttu-id="5b11b-266">Ale existují scénáře platné pro ochranu přihlašovací stránky zasažení neověřené uživatele a logiku anti-XSRF byl učiněn jednodušší vždy generování a ověřování tokenu zabezpečení, i pro ověřené uživatele.</span><span class="sxs-lookup"><span data-stu-id="5b11b-266">However, there are valid scenarios for protecting login pages hit by unauthenticated users, and the anti-XSRF logic was made simpler by always generating and validating the security token, even for authenticated users.</span></span> <span data-ttu-id="5b11b-267">Také poskytuje některé další ochrany v případě, že token pole někdy dojde k narušení uživatelem se zlými úmysly, jako nastavení nebo uhodnutí token relace by být jiné mezní útočníkovi překonat.</span><span class="sxs-lookup"><span data-stu-id="5b11b-267">It also does provide some additional protection in the event that a field token is ever compromised by an attacker, as setting or guessing the session token would be another hurdle for the attacker to overcome.</span></span>

<span data-ttu-id="5b11b-268">Vývojáři měli při více aplikací, které jsou hostované v jedné doméně buďte opatrní.</span><span class="sxs-lookup"><span data-stu-id="5b11b-268">Developers should use caution when multiple applications are hosted in a single domain.</span></span> <span data-ttu-id="5b11b-269">Například i když *example1.cloudapp.net* a *example2.cloudapp.net* jsou různých hostitelích, je vztah implicitní vztah důvěryhodnosti mezi všechny hostitele pod  *\*. cloudapp.net* domény.</span><span class="sxs-lookup"><span data-stu-id="5b11b-269">For example, even though *example1.cloudapp.net* and *example2.cloudapp.net* are different hosts, there is an implicit trust relationship between all hosts under the *\*.cloudapp.net* domain.</span></span> <span data-ttu-id="5b11b-270">Tento vztah důvěryhodnosti implicitní [umožňuje potenciálně nedůvěryhodní hostitelé ovlivnit navzájem své soubory cookie](http://stackoverflow.com/questions/9636857/how-can-asp-net-or-asp-net-mvc-be-protected-from-related-domain-cookie-attacks) (stejného původu zásady, které řídí požadavky AJAX nemusí platit pro soubory cookie HTTP).</span><span class="sxs-lookup"><span data-stu-id="5b11b-270">This implicit trust relationship [allows potentially untrusted hosts to affect each other's cookies](http://stackoverflow.com/questions/9636857/how-can-asp-net-or-asp-net-mvc-be-protected-from-related-domain-cookie-attacks) (the same-origin policies that govern AJAX requests do not necessarily apply to HTTP cookies).</span></span> <span data-ttu-id="5b11b-271">Modul Runtime ASP.NET Web zásobníku poskytuje některé zmírnění v tom, že uživatelské jméno se vloží do pole tokenu, tak i v případě, že škodlivý subdoména je možné přepsat token relace nelze vygenerovat token pro daného uživatele platné pole.</span><span class="sxs-lookup"><span data-stu-id="5b11b-271">The ASP.NET Web Stack Runtime provides some mitigation in that the username is embedded into the field token, so even if a malicious subdomain is able to overwrite a session token it will be unable to generate a valid field token for the user.</span></span> <span data-ttu-id="5b11b-272">Ale pokud je hostováno v takovém prostředí rutiny předdefinované anti-XSRF stále nelze bránit proti zneužití relace nebo přihlášení XSRF.</span><span class="sxs-lookup"><span data-stu-id="5b11b-272">However, when hosted in such an environment the built-in anti-XSRF routines still cannot defend against session hijacking or login XSRF.</span></span>

<span data-ttu-id="5b11b-273">Rutiny anti-XSRF aktuálně není bránit proti [útoků typu clickjacking](https://www.owasp.org/index.php/Clickjacking).</span><span class="sxs-lookup"><span data-stu-id="5b11b-273">The anti-XSRF routines currently do not defend against [clickjacking](https://www.owasp.org/index.php/Clickjacking).</span></span> <span data-ttu-id="5b11b-274">Aplikace, které chcete chránit proti útoků typu clickjacking mohou snadno to provedete odesláním X-Frame-Options: Hlavička SAMEORIGIN s každá odpověď.</span><span class="sxs-lookup"><span data-stu-id="5b11b-274">Applications that wish to defend themselves against clickjacking may easily do so by sending an X-Frame-Options: SAMEORIGIN header with each response.</span></span> <span data-ttu-id="5b11b-275">Tuto hlavičku podporuje všechny poslední prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="5b11b-275">This header is supported by all recent browsers.</span></span> <span data-ttu-id="5b11b-276">Další informace najdete v tématu [IE blog](https://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx), [SDL blog](https://blogs.msdn.com/b/sdl/archive/2009/02/05/clickjacking-defense-in-ie8.aspx), a [OWASP](https://www.owasp.org/index.php/Clickjacking).</span><span class="sxs-lookup"><span data-stu-id="5b11b-276">For more information, see the [IE blog](https://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx), the [SDL blog](https://blogs.msdn.com/b/sdl/archive/2009/02/05/clickjacking-defense-in-ie8.aspx), and [OWASP](https://www.owasp.org/index.php/Clickjacking).</span></span> <span data-ttu-id="5b11b-277">Modulem Runtime ASP.NET Web zásobníku může v některých zkontrolujte budoucí verze MVC a webových stránek anti-XSRF Pomocníci automaticky nastavit tuto hlavičku tak, aby aplikace automaticky chráněny před tento útok.</span><span class="sxs-lookup"><span data-stu-id="5b11b-277">The ASP.NET Web Stack Runtime may in some future release make the MVC and Web Pages anti-XSRF helpers automatically set this header so that applications are automatically protected against this attack.</span></span>

<span data-ttu-id="5b11b-278">Vývojáři webů by měly být nadále Ujistěte se, že není ohrožena útoky XSS své lokality.</span><span class="sxs-lookup"><span data-stu-id="5b11b-278">Web developers should continue to ensure that their site is not vulnerable to XSS attacks.</span></span> <span data-ttu-id="5b11b-279">Útoky XSS jsou velmi mocné a úspěšné zneužití by také zalomit Runtime ASP.NET Web zásobníku obrany před útoky XSRF.</span><span class="sxs-lookup"><span data-stu-id="5b11b-279">XSS attacks are very powerful, and a successful exploit would also break the ASP.NET Web Stack Runtime defenses against XSRF attacks.</span></span>

## <a name="acknowledgment"></a><span data-ttu-id="5b11b-280">Potvrzení</span><span class="sxs-lookup"><span data-stu-id="5b11b-280">Acknowledgment</span></span>

<span data-ttu-id="5b11b-281">[@LeviBroderick](https://twitter.com/LeviBroderick), který velkou část ASP.NET bezpečnostní kód napsali hromadným tyto informace.</span><span class="sxs-lookup"><span data-stu-id="5b11b-281">[@LeviBroderick](https://twitter.com/LeviBroderick), who wrote much of the ASP.NET security code the bulk of this information.</span></span>
