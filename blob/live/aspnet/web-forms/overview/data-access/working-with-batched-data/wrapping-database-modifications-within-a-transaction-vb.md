---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
title: "Zabalení změny databáze v rámci transakce (VB) | Microsoft Docs"
author: rick-anderson
description: "V tomto kurzu je první čtyři, který zjistí aktualizaci, odstranění a vložení dávky data. V tomto kurzu jsme zjistěte, jak povolit databázové transakce..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/26/2007
ms.topic: article
ms.assetid: 7d821db5-6cbb-4b38-af14-198f9155fc82
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
msc.type: authoredcontent
ms.openlocfilehash: 53887e2cf7b9a60596e2aca16fd1717799ab04f4
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 11/10/2017
---
<a name="wrapping-database-modifications-within-a-transaction-vb"></a><span data-ttu-id="1bb84-104">Zabalení změny databáze v rámci transakce (VB)</span><span class="sxs-lookup"><span data-stu-id="1bb84-104">Wrapping Database Modifications within a Transaction (VB)</span></span>
====================
<span data-ttu-id="1bb84-105">podle [Scott Meisnerová](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="1bb84-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="1bb84-106">[Stáhněte si kód](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) nebo [stáhnout PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="1bb84-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span></span>

> <span data-ttu-id="1bb84-107">V tomto kurzu je první čtyři, který zjistí aktualizaci, odstranění a vložení dávky data.</span><span class="sxs-lookup"><span data-stu-id="1bb84-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="1bb84-108">V tomto kurzu jsme zjistěte, jak povolit databázové transakce batch změny prováděné jako atomickou operaci, která zajistí, že buď všechny kroky úspěch nebo neúspěch všechny kroky.</span><span class="sxs-lookup"><span data-stu-id="1bb84-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="1bb84-109">Úvod</span><span class="sxs-lookup"><span data-stu-id="1bb84-109">Introduction</span></span>

<span data-ttu-id="1bb84-110">Jak jsme viděli začínající [přehled o vložení, aktualizace a odstranění dat](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) kurzu GridView poskytuje integrovanou podporu pro úpravy na úrovni řádků a odstranění.</span><span class="sxs-lookup"><span data-stu-id="1bb84-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="1bb84-111">Pomocí několika kliknutí myší je možné vytvořit rozhraní úpravy bohaté dat bez nutnosti psaní řádek kódu, tak dlouho, dokud se obsah s úpravy a odstraňování na základě na řádek.</span><span class="sxs-lookup"><span data-stu-id="1bb84-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="1bb84-112">Ale v některých případech to není dostatečné a je potřeba uživatelům poskytnout možnost upravit nebo odstranit dávky záznamů.</span><span class="sxs-lookup"><span data-stu-id="1bb84-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="1bb84-113">Například většina webových e-mailové klienty pomocí mřížky seznam každou zprávu kde každý řádek obsahuje zaškrtávací políčko společně s informacemi s e-mailu (předmět, odesílatele a tak dále).</span><span class="sxs-lookup"><span data-stu-id="1bb84-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="1bb84-114">Toto rozhraní umožňuje uživatelům odstranit více zpráv tak, že je a potom klikněte na tlačítko Odstranit vybrané zprávy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="1bb84-115">Úpravy rozhraní batch je ideální v situacích, kde uživatelé běžně upravovat mnoho různých záznamů.</span><span class="sxs-lookup"><span data-stu-id="1bb84-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="1bb84-116">Místo vynucení uživateli klikněte na tlačítko Upravit, proveďte jejich změnu a pak kliknutím na tlačítko Aktualizovat pro každý záznam, který má být změněn, dávce úpravy rozhraní vykreslí každý řádek s jeho úpravy rozhraní.</span><span class="sxs-lookup"><span data-stu-id="1bb84-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="1bb84-117">Uživatel můžete rychle změnit sadu řádků, které se musí změnit a poté tyto změny uložit kliknutím tlačítko Aktualizovat vše.</span><span class="sxs-lookup"><span data-stu-id="1bb84-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="1bb84-118">V této sadě kurzy podíváme, jak vytvořit rozhraní pro vkládání, úpravy a odstraňování dávky data.</span><span class="sxs-lookup"><span data-stu-id="1bb84-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="1bb84-119">Při provádění operací batch ho s důležité určit, zda by mělo být možné pro některé operace v dávce úspěšné ostatní při selhání.</span><span class="sxs-lookup"><span data-stu-id="1bb84-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="1bb84-120">Vezměte v úvahu dávky odstraňování rozhraní – které dojde, pokud byla úspěšně odstraněna první vybraný záznam, ale druhý selže, můžete, kvůli narušení omezení pro cizí klíč?</span><span class="sxs-lookup"><span data-stu-id="1bb84-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="1bb84-121">Musí být první odstranění záznamu s vrácena zpět nebo je přijatelné pro první záznam zůstat odstraněné?</span><span class="sxs-lookup"><span data-stu-id="1bb84-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="1bb84-122">Pokud chcete, aby dávkové operace jsou považovány za [atomické operace](http://en.wikipedia.org/wiki/Atomic_operation), jeden kde buď všechny kroky úspěšné, nebo všechny kroky nezdaří a Data Access Layer musí být rozšíření, zahrnují podporu pro [databáze transakce](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="1bb84-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="1bb84-123">Databázové transakce zaručit nedělitelnost pro sadu `INSERT`, `UPDATE`, a `DELETE` příkazy provést pod pojmem transakce a jsou funkce podporuje většinu systémy moderní databáze.</span><span class="sxs-lookup"><span data-stu-id="1bb84-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="1bb84-124">V tomto kurzu budeme zabývat postup rozšíření DAL použít databázové transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="1bb84-125">Další kurzy prozkoumá implementující webové stránky pro dávkové vložení, aktualizace a odstranění rozhraní.</span><span class="sxs-lookup"><span data-stu-id="1bb84-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="1bb84-126">Umožňují s začít!</span><span class="sxs-lookup"><span data-stu-id="1bb84-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="1bb84-127">Při změně dat v transakci batch, není potřeba vždy nedělitelnost.</span><span class="sxs-lookup"><span data-stu-id="1bb84-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="1bb84-128">V některých případech může být přijatelná některé změny dat úspěšné a jiné v stejné dávce selže, jako např. kdy odstranění sadu e-mailů z klienta e-mailové zprávy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="1bb84-129">Pokud je tam s zpracování chyb databáze se v polovině prostřednictvím odstranění, ho s pravděpodobně přijatelné, zůstaly odstraněné záznamy zpracovat bez chyby.</span><span class="sxs-lookup"><span data-stu-id="1bb84-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="1bb84-130">V takových případech DAL nemusí být upravena pro podporu databázové transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="1bb84-131">Existují další batch operaci scénáře, ale kde nedělitelnost je životně důležité.</span><span class="sxs-lookup"><span data-stu-id="1bb84-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="1bb84-132">Pokud zákazník přesune jeho prostředků z jednoho účtu bank na jiný, musí být provedeny dvě operace: fondů musí být odečtena od první účet a pak přidá do druhého.</span><span class="sxs-lookup"><span data-stu-id="1bb84-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="1bb84-133">Banka nemusí paměti, že prvním krokem úspěšné, ale druhý krok nezdaří, může být svým zákazníkům understandably nespokojený.</span><span class="sxs-lookup"><span data-stu-id="1bb84-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="1bb84-134">I doporučujeme absolvování tohoto kurzu a implementovat vylepšení podpory transakcí databáze i v případě, že neplánujete na jejich používání v dávkového vložení, aktualizace a odstranění rozhraní, které jsme budete vytvářet v následujících kurzech tři vrstvy Dal.</span><span class="sxs-lookup"><span data-stu-id="1bb84-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="1bb84-135">Přehled transakcí</span><span class="sxs-lookup"><span data-stu-id="1bb84-135">An Overview of Transactions</span></span>

<span data-ttu-id="1bb84-136">Většina databáze zahrnují podporu pro *transakce*, která umožňují více příkazů databáze byly seskupeny do jedné logické jednotky práce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="1bb84-137">Databáze příkazy, které tvoří transakce je zaručeno bylo atomické, což znamená, že buď všechny příkazy selžou nebo všechny bude úspěšné.</span><span class="sxs-lookup"><span data-stu-id="1bb84-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="1bb84-138">Obecně platí transakce jsou implementovány pomocí příkazů SQL pomocí následujícího vzorce:</span><span class="sxs-lookup"><span data-stu-id="1bb84-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="1bb84-139">Upozornění na zahájení transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="1bb84-140">Spouštění příkazů jazyka SQL, které tvoří transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="1bb84-141">Pokud dojde k chybě v jednom z příkazy z kroku 2, vrácení transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="1bb84-142">Pokud všechny příkazy z kroku 2 dokončeno bez chyb, potvrzení transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="1bb84-143">Příkazy SQL použít k vytvoření, potvrzení a vrácení transakce lze zadat ručně při psaní skriptů SQL nebo vytváření uložené procedury nebo prostřednictvím programový znamená pomocí ADO.NET nebo třídy v [ `System.Transactions` obor názvů](https://msdn.microsoft.com/en-us/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="1bb84-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/en-us/library/system.transactions.aspx).</span></span> <span data-ttu-id="1bb84-144">V tomto kurzu pouze vyzkoušíme Správa transakcí použitím technologie ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="1bb84-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="1bb84-145">V budoucích kurzu se podíváme na tom, jak pomocí uložených procedur v Data Access Layer, po kterých jsme budete prozkoumat příkazy SQL pro vytváření, vrácení zpět a potvrzením transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="1bb84-146">Do té doby najdete [Správa transakcí v SQL serveru uložené procedury](http://www.4guysfromrolla.com/webtech/080305-1.shtml) Další informace.</span><span class="sxs-lookup"><span data-stu-id="1bb84-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="1bb84-147">[ `TransactionScope` Třída](https://msdn.microsoft.com/en-us/library/system.transactions.transactionscope.aspx) v `System.Transactions` obor názvů umožňuje vývojářům prostřednictvím kódu programu zalomit řadu příkazy v oboru transakce a zahrnuje podporu pro komplexní transakce, které zahrnují více zdrojů, například dvou různých databází nebo dokonce heterogenní typy úložiště dat, jako jsou databáze Microsoft SQL Server, databáze Oracle a webové služby.</span><span class="sxs-lookup"><span data-stu-id="1bb84-147">The [`TransactionScope` class](https://msdn.microsoft.com/en-us/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="1bb84-148">I jste se rozhodli použít ADO.NET transakce v tomto kurzu místo `TransactionScope` třída protože ADO.NET je specifičtější pro databázové transakce a v mnoha případech je mnohem méně náročné.</span><span class="sxs-lookup"><span data-stu-id="1bb84-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="1bb84-149">Kromě toho, v některých případech `TransactionScope` třída používá Coordinator služby (Microsoft Distributed transakci MSDTC).</span><span class="sxs-lookup"><span data-stu-id="1bb84-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="1bb84-150">Konfigurace, implementaci a výkonu problémům okolního služby MSDTC je téma místo specializované a pokročilých a nad rámec těchto kurzů.</span><span class="sxs-lookup"><span data-stu-id="1bb84-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="1bb84-151">Při práci s poskytovatel Sqlclienta v ADO.NET, transakce se spouští pomocí volání [ `SqlConnection` třída](https://msdn.microsoft.com/en-US/library/system.data.sqlclient.sqlconnection.aspx) s [ `BeginTransaction` metoda](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), která vrátí [ `SqlTransaction` objekt](https://msdn.microsoft.com/en-US/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="1bb84-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/en-US/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/en-US/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="1bb84-152">Příkazy úpravy dat umístěných v rámci způsob vytvoření transakce `try...catch` bloku.</span><span class="sxs-lookup"><span data-stu-id="1bb84-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="1bb84-153">Pokud dojde k chybě v příkazu v `try` blokovat spuštění přenosů, aby se `catch` bloku, kde můžete transakce vrácena zpět prostřednictvím `SqlTransaction` objekt s [ `Rollback` metoda](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="1bb84-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="1bb84-154">Pokud všechny příkazy úspěšně dokončil, volání `SqlTransaction` objekt s [ `Commit` metoda](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqltransaction.commit.aspx) na konci `try` bloku potvrdí transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="1bb84-155">Následující fragment kódu ukazuje tento vzor.</span><span class="sxs-lookup"><span data-stu-id="1bb84-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="1bb84-156">V tématu [zachování konzistence databáze s transakcemi](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) pro další syntaxe a příklady použití transakcí s ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="1bb84-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample1.vb)]

<span data-ttu-id="1bb84-157">Ve výchozím nastavení nepoužívejte TableAdapters v datové sadě zadali transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="1bb84-158">Kvůli zajištění podpory pro transakce musíme posílení třídy TableAdapter zahrnout další metody, které používají výše vzorec k provedení řady příkazy Úpravy dat v rámci oboru transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="1bb84-159">V kroku 2 vidíte použití částečné třídy k přidání těchto metod.</span><span class="sxs-lookup"><span data-stu-id="1bb84-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="1bb84-160">Krok 1: Vytvoření pracovní s dávkové Data webové stránky</span><span class="sxs-lookup"><span data-stu-id="1bb84-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="1bb84-161">Než začneme zkoumat postupy k posílení DAL pro podporu databázové transakce, umožní s nejprve vytvořit webových stránek ASP.NET, které je nutné zadat pro účely tohoto kurzu a tři, které budou následovat chvíli trvat.</span><span class="sxs-lookup"><span data-stu-id="1bb84-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="1bb84-162">Nejprve přidejte novou složku s názvem `BatchData` a poté přidejte následující stránky ASP.NET přidružení každou stránku s `Site.master` stránky předlohy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![Přidání stránky ASP.NET pro kurzy související SqlDataSource](wrapping-database-modifications-within-a-transaction-vb/_static/image1.gif)

<span data-ttu-id="1bb84-164">**Obrázek 1**: Přidání stránky ASP.NET pro kurzy související SqlDataSource</span><span class="sxs-lookup"><span data-stu-id="1bb84-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="1bb84-165">Stejně jako u jiných složkách `Default.aspx` použije `SectionLevelTutorialListing.ascx` uživatelský ovládací prvek seznam kurzy v příslušném oddílu.</span><span class="sxs-lookup"><span data-stu-id="1bb84-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="1bb84-166">Proto přidat tento uživatelský ovládací prvek pro `Default.aspx` přetažením z Průzkumníka řešení na stránku s zobrazení návrhu.</span><span class="sxs-lookup"><span data-stu-id="1bb84-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="1bb84-167">[![Přidání SectionLevelTutorialListing.ascx uživatelského ovládacího prvku do Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="1bb84-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span></span>

<span data-ttu-id="1bb84-168">**Obrázek 2**: Přidat `SectionLevelTutorialListing.ascx` uživatelského ovládacího prvku na `Default.aspx` ([Kliknutím zobrazit obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="1bb84-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span></span>


<span data-ttu-id="1bb84-169">Nakonec přidejte tyto čtyři stránky jako položky na `Web.sitemap` souboru.</span><span class="sxs-lookup"><span data-stu-id="1bb84-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="1bb84-170">Konkrétně, přidejte následující kód po vlastní nastavení mapy webu `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="1bb84-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample2.xml)]

<span data-ttu-id="1bb84-171">Po aktualizaci `Web.sitemap`, pozorně Zobrazit kurzy web prostřednictvím prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="1bb84-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="1bb84-172">V nabídce na levé straně teď obsahuje položky pro práci s kurzy dávkové data.</span><span class="sxs-lookup"><span data-stu-id="1bb84-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![Mapy webu nyní obsahuje položky pro práci s kurzy dávkové dat](wrapping-database-modifications-within-a-transaction-vb/_static/image3.gif)

<span data-ttu-id="1bb84-174">**Obrázek 3**: mapy webu nyní obsahuje položky pro práci s kurzy dávkové dat</span><span class="sxs-lookup"><span data-stu-id="1bb84-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="1bb84-175">Krok 2: Aktualizace Data Access Layer pro podporu databázové transakce</span><span class="sxs-lookup"><span data-stu-id="1bb84-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="1bb84-176">Jak již bylo zmíněno zpět v první kurz [vytváření Data Access Layer](../introduction/creating-a-data-access-layer-vb.md), typové datové sady v našem DAL se skládá z DataTables a TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="1bb84-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="1bb84-177">DataTables obsahovat data, zatímco TableAdapters poskytují funkce pro čtení dat z databáze do DataTables, chcete-li aktualizovat databázi s změny provedené DataTables a tak dále.</span><span class="sxs-lookup"><span data-stu-id="1bb84-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="1bb84-178">Odvolat, že TableAdapters poskytovat dva vzory pro aktualizace dat, který uvedené jako dávková aktualizace a DB-Direct.</span><span class="sxs-lookup"><span data-stu-id="1bb84-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="1bb84-179">S vzoru dávková aktualizace je předán TableAdapter datovou sadu, DataTable nebo kolekce DataRows.</span><span class="sxs-lookup"><span data-stu-id="1bb84-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="1bb84-180">Tato data je výčet a pro každou vložit, upravit nebo odstranit řádek, `InsertCommand`, `UpdateCommand`, nebo `DeleteCommand` se spustí.</span><span class="sxs-lookup"><span data-stu-id="1bb84-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="1bb84-181">S použitím vzoru názvů DB přímo TableAdapter místo toho předá hodnot sloupců, které jsou nezbytné pro vložení, aktualizaci nebo odstranění jeden záznam.</span><span class="sxs-lookup"><span data-stu-id="1bb84-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="1bb84-182">DB přímá metoda vzor použije tyto hodnoty předané provést odpovídající `InsertCommand`, `UpdateCommand`, nebo `DeleteCommand` příkaz.</span><span class="sxs-lookup"><span data-stu-id="1bb84-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="1bb84-183">Bez ohledu na aktualizace vzoru používá automaticky generovaný metody TableAdapters nepoužívejte transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="1bb84-184">Ve výchozím nastavení je každý insert, update nebo delete provádí TableAdapter považována za jedné diskrétní operace.</span><span class="sxs-lookup"><span data-stu-id="1bb84-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="1bb84-185">Představte si například, že nějaký kód v BLL používá vzor DB přímo k vložit deset záznamů do databáze.</span><span class="sxs-lookup"><span data-stu-id="1bb84-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="1bb84-186">Tento kód by volání TableAdapter s `Insert` metoda desetkrát.</span><span class="sxs-lookup"><span data-stu-id="1bb84-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="1bb84-187">Pokud prvních pět vložení úspěšné, ale ten šesté způsobil výjimku, prvních pět vložené záznamy by zůstat v databázi.</span><span class="sxs-lookup"><span data-stu-id="1bb84-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="1bb84-188">Podobně pokud vzor dávková aktualizace se používá k provádění vložení, aktualizace a odstranění na vložené, upravit a odstranit řádků v DataTable, pokud první několik změn bylo úspěšné, ale novější verzi došlo k chybě, tyto starší úpravy, Dokončit by zůstat v databázi.</span><span class="sxs-lookup"><span data-stu-id="1bb84-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="1bb84-189">V některých scénářích chceme, aby byla zajištěna nedělitelnost celé řady úpravy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="1bb84-190">K tomu TableAdapter jsme musí ručně rozšířit přidáním nových metod, které jsou spouštěny `InsertCommand`, `UpdateCommand`, a `DeleteCommand` s pod pojmem transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="1bb84-191">V [vytváření Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) jsme se podívali na pomocí [částečné třídy](http://en.wikipedia.org/wiki/Partial_type) rozšířit funkce DataTables v rámci typové datové sady.</span><span class="sxs-lookup"><span data-stu-id="1bb84-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="1bb84-192">Tento postup můžete použít taky s TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="1bb84-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="1bb84-193">Typové datové sady `Northwind.xsd` se nachází v `App_Code` složku s `DAL` podsložky.</span><span class="sxs-lookup"><span data-stu-id="1bb84-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="1bb84-194">Vytvořit podsložku v `DAL` složku s názvem `TransactionSupport` a přidejte nový soubor třídy s názvem `ProductsTableAdapter.TransactionSupport.vb` (viz obrázek 4).</span><span class="sxs-lookup"><span data-stu-id="1bb84-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.vb` (see Figure 4).</span></span> <span data-ttu-id="1bb84-195">Tento soubor bude obsahovat částečné implementace `ProductsTableAdapter` , který obsahuje metody pro provedení změny dat pomocí transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![Přidat složku s názvem TransactionSupport a soubor třídy s názvem ProductsTableAdapter.TransactionSupport.vb](wrapping-database-modifications-within-a-transaction-vb/_static/image4.gif)

<span data-ttu-id="1bb84-197">**Obrázek 4**: Přidat složku s názvem `TransactionSupport` a soubor třídy s názvem`ProductsTableAdapter.TransactionSupport.vb`</span><span class="sxs-lookup"><span data-stu-id="1bb84-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.vb`</span></span>


<span data-ttu-id="1bb84-198">Zadejte následující kód do `ProductsTableAdapter.TransactionSupport.vb` souboru:</span><span class="sxs-lookup"><span data-stu-id="1bb84-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.vb` file:</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample3.vb)]

<span data-ttu-id="1bb84-199">`Partial` – Klíčové slovo v deklaraci třídy označuje kompilátoru, které jsou členy přidat do mají být přidány do `ProductsTableAdapter` třídy v `NorthwindTableAdapters` oboru názvů.</span><span class="sxs-lookup"><span data-stu-id="1bb84-199">The `Partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="1bb84-200">Poznámka: `Imports System.Data.SqlClient` příkaz v horní části souboru.</span><span class="sxs-lookup"><span data-stu-id="1bb84-200">Note the `Imports System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="1bb84-201">Vzhledem k tomu, že TableAdapter byla nakonfigurovaná pro použití poskytovatele SqlClient, interně používá [ `SqlDataAdapter` ](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqldataadapter.aspx) objekt, který chcete vydat jeho příkazů do databáze.</span><span class="sxs-lookup"><span data-stu-id="1bb84-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="1bb84-202">V důsledku toho je potřeba použít `SqlTransaction` třída zahájíte transakce a pak ji zapište nebo vrátit zpět.</span><span class="sxs-lookup"><span data-stu-id="1bb84-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="1bb84-203">Pokud používáte úložiště dat než ze systému Microsoft SQL Server, budete muset použít příslušného poskytovatele.</span><span class="sxs-lookup"><span data-stu-id="1bb84-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="1bb84-204">Tyto metody poskytují stavební bloky potřebné ke spuštění, vrácení zpět a potvrzení transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="1bb84-205">Jsou označeny `Public`, je pro použití v rámci povolení `ProductsTableAdapter`, z jiné třídy v DAL, nebo z jiné vrstvy architektury, jako je například BLL.</span><span class="sxs-lookup"><span data-stu-id="1bb84-205">They are marked `Public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="1bb84-206">`BeginTransaction`Otevře interní TableAdapter s `SqlConnection` (v případě potřeby), začne transakce a přiřadí ji k `Transaction` vlastnost a připojí k interní transakce `SqlDataAdapter` s `SqlCommand` objekty.</span><span class="sxs-lookup"><span data-stu-id="1bb84-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="1bb84-207">`CommitTransaction`a `RollbackTransaction` volání `Transaction` objekt s `Commit` a `Rollback` metody, v uvedeném pořadí, před jeho zavřením interní `Connection` objektu.</span><span class="sxs-lookup"><span data-stu-id="1bb84-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="1bb84-208">Krok 3: Přidání metody pro aktualizace a odstranění dat pod pojmem transakce</span><span class="sxs-lookup"><span data-stu-id="1bb84-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="1bb84-209">Pomocí těchto metod dokončení jsme re připraveni přidejte metody do `ProductsDataTable` nebo BLL, které provádějí řadu příkazů pod pojmem transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="1bb84-210">Následující metodu vzoru aktualizovat Batch používá k aktualizaci `ProductsDataTable` instance pomocí transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="1bb84-211">Spuštění transakce voláním `BeginTransaction` metoda a pak používá `Try...Catch` bloku k vydávání dat úpravy příkazy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `Try...Catch` block to issue the data modification statements.</span></span> <span data-ttu-id="1bb84-212">Pokud volání `Adapter` objekt s `Update` metoda za následek výjimku, provádění bude přenášet do `catch` blok, kde transakce bude vrácena zpět a znovu došlo k výjimce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="1bb84-213">Odvolat, který `Update` metoda implementuje vzor dávková aktualizace vytyčením řádky zadaných `ProductsDataTable` a provádění nezbytné `InsertCommand`, `UpdateCommand`, a `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="1bb84-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="1bb84-214">Pokud některá z těchto příkazů dojde k chybě, transakce je vrácena zpět, vrátí zpět předchozí úpravy provedené v průběhu životního cyklu s transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="1bb84-215">Má `Update` příkaz dokončeno bez chyb, transakce se potvrdí jako celek.</span><span class="sxs-lookup"><span data-stu-id="1bb84-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample4.vb)]

<span data-ttu-id="1bb84-216">Přidat `UpdateWithTransaction` metodu `ProductsTableAdapter` třídu v rámci třídu v `ProductsTableAdapter.TransactionSupport.vb`.</span><span class="sxs-lookup"><span data-stu-id="1bb84-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.vb`.</span></span> <span data-ttu-id="1bb84-217">Případně, tato metoda nebylo možné přidat do vrstvu obchodní logiky s `ProductsBLL` se několik syntaktických mírně.</span><span class="sxs-lookup"><span data-stu-id="1bb84-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="1bb84-218">Konkrétně, klíčové slovo `Me` v `Me.BeginTransaction()`, `Me.CommitTransaction()`, a `Me.RollbackTransaction()` by bylo potřeba nahradí `Adapter` (který odvolat `Adapter` je název vlastnosti v `ProductsBLL` typu `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="1bb84-218">Namely, the keyword `Me` in `Me.BeginTransaction()`, `Me.CommitTransaction()`, and `Me.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="1bb84-219">`UpdateWithTransaction` Metoda používá vzor dávková aktualizace, ale řadu DB přímé volání lze také v rámci oboru transakce, jak ukazuje následující metoda.</span><span class="sxs-lookup"><span data-stu-id="1bb84-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="1bb84-220">`DeleteProductsWithTransaction` Metoda přijímá jako vstup `List(Of T)` typu `Integer`, které jsou `ProductID` s odstranit.</span><span class="sxs-lookup"><span data-stu-id="1bb84-220">The `DeleteProductsWithTransaction` method accepts as input a `List(Of T)` of type `Integer`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="1bb84-221">Metoda inicializuje transakci prostřednictvím volání `BeginTransaction` a pak na `Try` blokovat, prochází seznamu zadaný vzor DB přímé volání `Delete` metoda pro každou `ProductID` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="1bb84-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `Try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="1bb84-222">Pokud žádné z volání `Delete` řízení selže, se převede do `Catch` blok, kde transakce je vrácena zpět a znovu došlo k výjimce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-222">If any of the calls to `Delete` fails, control is transferred to the `Catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="1bb84-223">Pokud veškerá volání `Delete` úspěšné, pak je transakce potvrzena.</span><span class="sxs-lookup"><span data-stu-id="1bb84-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="1bb84-224">Přidejte tuto metodu za účelem `ProductsBLL` třídy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample5.vb)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="1bb84-225">Provádění transakcí v celém více objektů TableAdapters</span><span class="sxs-lookup"><span data-stu-id="1bb84-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="1bb84-226">Kód související transakci zkontrolován v tomto kurzu umožňuje více příkazů proti `ProductsTableAdapter` považován za atomické operace.</span><span class="sxs-lookup"><span data-stu-id="1bb84-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="1bb84-227">Ale co když provádění více úprav jiných databázových tabulek musí být provedeny atomicky?</span><span class="sxs-lookup"><span data-stu-id="1bb84-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="1bb84-228">Například při odstraňování kategorii, může první chceme přiřazení jeho aktuální produktů na některé další kategorie.</span><span class="sxs-lookup"><span data-stu-id="1bb84-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="1bb84-229">Tyto dva kroky přeřazení produkty a odstraňování kategorii musí provést, protože atomické operace.</span><span class="sxs-lookup"><span data-stu-id="1bb84-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="1bb84-230">Ale `ProductsTableAdapter` obsahuje pouze metody pro úpravu `Products` tabulky a `CategoriesTableAdapter` obsahuje pouze metody pro úpravu `Categories` tabulky.</span><span class="sxs-lookup"><span data-stu-id="1bb84-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="1bb84-231">Jak tedy můžete zahrnovat transakce obou TableAdapters?</span><span class="sxs-lookup"><span data-stu-id="1bb84-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="1bb84-232">Jednou z možností je přidání metody do `CategoriesTableAdapter` s názvem `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` a mít dané metody volání uložené procedury, která znovu přiřadí produkty i odstraní kategorii v rámci oboru transakce definované v rámci uložené procedury.</span><span class="sxs-lookup"><span data-stu-id="1bb84-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="1bb84-233">Podíváme tom, jak začít, potvrzení a vrácení transakce v uložené procedury v budoucnu kurzu.</span><span class="sxs-lookup"><span data-stu-id="1bb84-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="1bb84-234">Další možností je vytvořit v DAL, který obsahuje pomocnou třídu `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` metoda.</span><span class="sxs-lookup"><span data-stu-id="1bb84-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="1bb84-235">Tato metoda by vytvořit instanci `CategoriesTableAdapter` a `ProductsTableAdapter` a nastavte tyto dvě TableAdapters `Connection` vlastnosti na stejnou `SqlConnection` instance.</span><span class="sxs-lookup"><span data-stu-id="1bb84-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="1bb84-236">Na tento bod kterékoli dvě TableAdapters by zahájení transakce s volání `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="1bb84-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="1bb84-237">TableAdapters metody pro přeřazení produkty nebo kategorie odstranění by být volána v `Try...Catch` blok s transakce potvrzena nebo vrácena zpět podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="1bb84-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `Try...Catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="1bb84-238">Krok 4: Přidání`UpdateWithTransaction`metodu pro vrstvu obchodní logiky</span><span class="sxs-lookup"><span data-stu-id="1bb84-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="1bb84-239">V kroku 3 jsme přidali `UpdateWithTransaction` metodu `ProductsTableAdapter` v DAL.</span><span class="sxs-lookup"><span data-stu-id="1bb84-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="1bb84-240">Jsme měli přidat odpovídající metodu BLL.</span><span class="sxs-lookup"><span data-stu-id="1bb84-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="1bb84-241">Při prezentační vrstvy může volat přímo do vrstvy DAL k vyvolání `UpdateWithTransaction` metoda, tyto kurzy mít strived k definování vrstveného architekturu, která insulates DAL od prezentační vrstvy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="1bb84-242">Proto behooves nám pokračujte tento přístup.</span><span class="sxs-lookup"><span data-stu-id="1bb84-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="1bb84-243">Otevřete `ProductsBLL` třídy souboru a přidejte metodu s názvem `UpdateWithTransaction` této jednoduše volání dolů odpovídající metoda DAL.</span><span class="sxs-lookup"><span data-stu-id="1bb84-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="1bb84-244">Měla by existovat teď dvě nové metody v `ProductsBLL`: `UpdateWithTransaction`, který jste právě přidali, a `DeleteProductsWithTransaction`, který byl přidán v kroku 3.</span><span class="sxs-lookup"><span data-stu-id="1bb84-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample6.vb)]

> [!NOTE]
> <span data-ttu-id="1bb84-245">Tyto metody nezahrnují `DataObjectMethodAttribute` přiřazené většinu metod v atributu `ProductsBLL` třídy, protože jsme budete vyvolání tyto metody přímo z třídy kódu stránky ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="1bb84-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="1bb84-246">Odvolat, `DataObjectMethodAttribute` se používá k příznak, jaké metody by se měla objevit v ObjectDataSource s zdroj dat konfigurace průvodce a jaké kartě (SELECT, UPDATE, INSERT nebo DELETE).</span><span class="sxs-lookup"><span data-stu-id="1bb84-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="1bb84-247">Vzhledem k tomu, že GridView nemá žádné integrovanou podporu pro dávku úpravy nebo odstranění, jsme budete muset tyto metody vyvolání prostřednictvím kódu programu, místo použití bez kódu deklarativní přístup.</span><span class="sxs-lookup"><span data-stu-id="1bb84-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="1bb84-248">Krok 5: Atomicky aktualizace dat databáze od prezentační vrstvy</span><span class="sxs-lookup"><span data-stu-id="1bb84-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="1bb84-249">Pro ilustraci o tom, že transakce má při aktualizaci dávky záznamů, umožňují s vytvoření uživatelského rozhraní, které jsou uvedeny všechny produkty v GridView a zahrnují tlačítko webu řídit, která po kliknutí na pouze Změna přiřazení produkty `CategoryID` hodnoty.</span><span class="sxs-lookup"><span data-stu-id="1bb84-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="1bb84-250">Konkrétně, opětovné přiřazení kategorie proběhne tak, aby první několik produkty jsou přiřazeny platná `CategoryID` hodnotu, zatímco ostatní záměrně jsou přiřazené neexistující `CategoryID` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="1bb84-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="1bb84-251">Pokud jsme pokus o aktualizaci databáze s produktem, s jehož `CategoryID` neodpovídá existující kategorii s `CategoryID`, dojde k porušení omezení cizího klíče a k výjimce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="1bb84-252">Co jsme najdete v tomto příkladu je, že při použití transakce výjimky vyvolané z porušení omezení pro cizí klíč způsobí předchozí platné `CategoryID` změny vrátit zpět.</span><span class="sxs-lookup"><span data-stu-id="1bb84-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="1bb84-253">Pokud nepoužíváte transakce, ale změny do počáteční kategorií zůstane.</span><span class="sxs-lookup"><span data-stu-id="1bb84-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="1bb84-254">Začněte otevřením `Transactions.aspx` stránku `BatchData` složku a přetáhněte GridView z panelu nástrojů na návrháře.</span><span class="sxs-lookup"><span data-stu-id="1bb84-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="1bb84-255">Nastavte její `ID` k `Products` a z jeho inteligentních značek navázat jej na nové ObjectDataSource s názvem `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="1bb84-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="1bb84-256">Konfigurace ObjectDataSource načítat data z `ProductsBLL` třídu s `GetProducts` metoda.</span><span class="sxs-lookup"><span data-stu-id="1bb84-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="1bb84-257">Tato akce se GridView jen pro čtení, tak nastavte rozevírací seznamy v aktualizaci, vložení a odstraní karty na (žádný) a klikněte na tlačítko Dokončit.</span><span class="sxs-lookup"><span data-stu-id="1bb84-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="1bb84-258">[![Konfigurace ObjectDataSource lze pomocí této metody GetProducts ProductsBLL třídu s](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="1bb84-258">[![Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span></span>

<span data-ttu-id="1bb84-259">**Obrázek 5**: Konfigurace ObjectDataSource pro použití `ProductsBLL` třídu s `GetProducts` – metoda ([Kliknutím zobrazit obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="1bb84-259">**Figure 5**: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span></span>


<span data-ttu-id="1bb84-260">[![Nastavte rozevírací seznamy v aktualizaci UPDATE, INSERT a odstranit karty na (žádný)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="1bb84-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span></span>

<span data-ttu-id="1bb84-261">**Obrázek 6**: rozevíracího seznamu jsou uvedeny ve UPDATE, INSERT a odstranit karty na hodnotu (žádná) ([Kliknutím zobrazit obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="1bb84-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span></span>


<span data-ttu-id="1bb84-262">Po dokončení průvodce Konfigurace zdroje dat se vytvoří sada Visual Studio BoundFields a vlastnost CheckBoxField pro produkt datová pole.</span><span class="sxs-lookup"><span data-stu-id="1bb84-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="1bb84-263">Odeberte všechna tyto pole s výjimkou `ProductID`, `ProductName`, `CategoryID`, a `CategoryName` a přejmenujte `ProductName` a `CategoryName` BoundFields `HeaderText` vlastnosti produktu a kategorie, v uvedeném pořadí.</span><span class="sxs-lookup"><span data-stu-id="1bb84-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="1bb84-264">Ze inteligentní značky zaškrtnutí políčka Povolit stránkování.</span><span class="sxs-lookup"><span data-stu-id="1bb84-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="1bb84-265">Po provedení změny, rutina GridView a ObjectDataSource s deklarativní by měl vypadat následovně:</span><span class="sxs-lookup"><span data-stu-id="1bb84-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample7.aspx)]

<span data-ttu-id="1bb84-266">Dál přidejte tři ovládací prvky webového tlačítko výše GridView.</span><span class="sxs-lookup"><span data-stu-id="1bb84-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="1bb84-267">Na první tlačítko s Text – vlastnost nastavena na aktualizaci mřížky, druhý s do upravit kategorií (transakce s) a třetí jeden s do upravit kategorií (bez transakce).</span><span class="sxs-lookup"><span data-stu-id="1bb84-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample8.aspx)]

<span data-ttu-id="1bb84-268">Zobrazení návrhu v sadě Visual Studio v tomto okamžiku by mělo vypadat jako na uvedené na obrázku 7 snímku obrazovky.</span><span class="sxs-lookup"><span data-stu-id="1bb84-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="1bb84-269">[![Tato stránka obsahuje GridView a ovládací prvky webového tři tlačítka](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="1bb84-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span></span>

<span data-ttu-id="1bb84-270">**Obrázek 7**: Tato stránka obsahuje GridView a tři ovládací prvky webového tlačítko ([Kliknutím zobrazit obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="1bb84-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span></span>


<span data-ttu-id="1bb84-271">Vytváření obslužných rutin událostí pro všechny tři tlačítka s `Click` události a použijte následující kód:</span><span class="sxs-lookup"><span data-stu-id="1bb84-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample9.vb)]

<span data-ttu-id="1bb84-272">Aktualizace tlačítko s `Click` obslužné rutiny události znovu data, která mají GridView jednoduše připojí voláním `Products` GridView s `DataBind` metoda.</span><span class="sxs-lookup"><span data-stu-id="1bb84-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="1bb84-273">Druhá obslužná rutina události pouze Změna přiřazení produkty `CategoryID` s a použije metodu nové transakce z BLL k provedení databáze aktualizuje pod pojmem transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="1bb84-274">Všimněte si, že každý produkt s `CategoryID` nahodile nastavena na stejnou hodnotu jako jeho `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="1bb84-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="1bb84-275">To se bez problémů fungují pro první několik produkty, vzhledem k tomu, že mají tyto produkty `ProductID` hodnoty, které mají na platné `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="1bb84-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="1bb84-276">Ale jednou `ProductID` s počáteční získání příliš velký, tento náhodný překrytí `ProductID` s a `CategoryID` s již nepoužívá.</span><span class="sxs-lookup"><span data-stu-id="1bb84-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="1bb84-277">Třetí `Click` obslužné rutiny události aktualizace produktů `CategoryID` s stejným způsobem, ale odešle aktualizace do databáze pomocí `ProductsTableAdapter` s výchozí `Update` metoda.</span><span class="sxs-lookup"><span data-stu-id="1bb84-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="1bb84-278">To `Update` metoda nezalamuje řadu příkazů v rámci transakce, tak před první chyba porušení omezení cizího klíče došlo k provedení těchto změn bude zachována.</span><span class="sxs-lookup"><span data-stu-id="1bb84-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="1bb84-279">Chcete-li toto chování ilustrují, navštivte tuto stránku prostřednictvím prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="1bb84-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="1bb84-280">Nejdřív měli vidět na první stránku dat, jak je znázorněno na obrázku 8.</span><span class="sxs-lookup"><span data-stu-id="1bb84-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="1bb84-281">Potom klikněte na tlačítko Upravit kategorií (transakce s).</span><span class="sxs-lookup"><span data-stu-id="1bb84-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="1bb84-282">Tato akce způsobí zpětné volání a pokus o aktualizaci všechny produkty `CategoryID` hodnoty, ale bude mít za následek narušení omezení cizího klíče (viz obrázek 9).</span><span class="sxs-lookup"><span data-stu-id="1bb84-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="1bb84-283">[![Produkty jsou zobrazeny v stránkovatelné GridView](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="1bb84-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span></span>

<span data-ttu-id="1bb84-284">**Obrázek 8**: produkty jsou zobrazeny v stránkovatelné GridView ([Kliknutím zobrazit obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="1bb84-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span></span>


<span data-ttu-id="1bb84-285">[![Opětovné přiřazování kategorií výsledky v narušení omezení pro cizí klíč](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="1bb84-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span></span>

<span data-ttu-id="1bb84-286">**Obrázek 9**: opětovné přiřazování kategorií výsledky v narušení omezení pro cizí klíč ([Kliknutím zobrazit obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="1bb84-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span></span>


<span data-ttu-id="1bb84-287">Nyní stiskněte váš prohlížeč s tlačítko Zpět a potom klikněte na tlačítko Aktualizovat mřížky.</span><span class="sxs-lookup"><span data-stu-id="1bb84-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="1bb84-288">Při aktualizaci dat byste měli vidět přesně stejný výstup, jak je znázorněno na obrázku 8.</span><span class="sxs-lookup"><span data-stu-id="1bb84-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="1bb84-289">To znamená, i když některé produkty `CategoryID` s byly změněné na právní hodnoty a aktualizována v databázi, že byly vráceny zpět v případě, že došlo k porušení omezení pro cizí klíč.</span><span class="sxs-lookup"><span data-stu-id="1bb84-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="1bb84-290">Zkuste nyní klepnutím na tlačítko Upravit kategorií (bez transakce).</span><span class="sxs-lookup"><span data-stu-id="1bb84-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="1bb84-291">Tato akce způsobí ke stejné chybě porušení omezení pro cizí klíč (viz obrázek 9), ale v tuto chvíli těchto produktů jejichž `CategoryID` hodnoty byly změněny na právního hodnota nebude vrácena zpět.</span><span class="sxs-lookup"><span data-stu-id="1bb84-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="1bb84-292">Stiskněte váš prohlížeč s tlačítko Zpět a potom na tlačítko Aktualizovat mřížky.</span><span class="sxs-lookup"><span data-stu-id="1bb84-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="1bb84-293">Jak ukazuje obrázek 10, `CategoryID` s produkty prvních 8 byl znovu přiřazen.</span><span class="sxs-lookup"><span data-stu-id="1bb84-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="1bb84-294">Například na obrázku 8, měl změn `CategoryID` 1, ale v obrázek 10 it s byla přeřazena na 2.</span><span class="sxs-lookup"><span data-stu-id="1bb84-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="1bb84-295">[![Některé hodnoty CategoryID produkty nebyly aktualizovány při jiné byly](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="1bb84-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span></span>

<span data-ttu-id="1bb84-296">**Obrázek 10**: některá produkty `CategoryID` hodnoty nebyly aktualizovány při jiné byly ([Kliknutím zobrazit obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="1bb84-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="1bb84-297">Souhrn</span><span class="sxs-lookup"><span data-stu-id="1bb84-297">Summary</span></span>

<span data-ttu-id="1bb84-298">Ve výchozím nastavení metod TableAdapter s není zalomen příkazy spuštění databáze v rámci oboru transakce, ale s malým množstvím pracovní jsme přidejte metody, které se vytvoří, potvrzení a vrácení transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="1bb84-299">V tomto kurzu jsme vytvořili v těchto tří metod `ProductsTableAdapter` – třída: `BeginTransaction`, `CommitTransaction`, a `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="1bb84-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="1bb84-300">Jsme viděli, jak používat tyto metody spolu s `Try...Catch` blok atomic aby řadu dat úpravy příkazy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-300">We saw how to use these methods along with a `Try...Catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="1bb84-301">Konkrétně jsme vytvořili `UpdateWithTransaction` metoda v `ProductsTableAdapter`, který používá vzor dávková aktualizace provést požadované změny zadané řádky `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="1bb84-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="1bb84-302">Jsme přidali i `DeleteProductsWithTransaction` metodu `ProductsBLL` třídy v BLL, které přijímá `List` z `ProductID` hodnoty jako vstup a volá metodu vzor DB-Direct `Delete` pro každou `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="1bb84-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="1bb84-303">Obě metody spuštění vytvořením transakci a pak provádění příkazů úpravy dat v rámci `Try...Catch` bloku.</span><span class="sxs-lookup"><span data-stu-id="1bb84-303">Both methods start by creating a transaction and then executing the data modification statements within a `Try...Catch` block.</span></span> <span data-ttu-id="1bb84-304">Pokud dojde k výjimce transakce je vrácena zpět, v opačném případě je potvrzená.</span><span class="sxs-lookup"><span data-stu-id="1bb84-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="1bb84-305">Krok 5 zobrazené účinku transakční dávce aktualizace versus batch aktualizace, které nevrátil použít transakce.</span><span class="sxs-lookup"><span data-stu-id="1bb84-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="1bb84-306">V následujících třech kurzech jsme stavějí foundation umístěné v tomto kurzu a vytvoření uživatelského rozhraní pro provádění dávková aktualizace, odstranění a vložení.</span><span class="sxs-lookup"><span data-stu-id="1bb84-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="1bb84-307">Radostí programování!</span><span class="sxs-lookup"><span data-stu-id="1bb84-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="1bb84-308">Další čtení</span><span class="sxs-lookup"><span data-stu-id="1bb84-308">Further Reading</span></span>

<span data-ttu-id="1bb84-309">Další informace o tématech popsané v tomto kurzu najdete v následujících zdrojích informací:</span><span class="sxs-lookup"><span data-stu-id="1bb84-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="1bb84-310">Zachování konzistence databáze s transakce</span><span class="sxs-lookup"><span data-stu-id="1bb84-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="1bb84-311">Správa transakcí v systému SQL Server uložené procedury</span><span class="sxs-lookup"><span data-stu-id="1bb84-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="1bb84-312">Transakce, umožněno:`System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="1bb84-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="1bb84-313">TransactionScope a DataAdapters</span><span class="sxs-lookup"><span data-stu-id="1bb84-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="1bb84-314">Použití Oracle databázové transakce v rozhraní .NET</span><span class="sxs-lookup"><span data-stu-id="1bb84-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="1bb84-315">O autorovi</span><span class="sxs-lookup"><span data-stu-id="1bb84-315">About the Author</span></span>

<span data-ttu-id="1bb84-316">[Scott Meisnerová](http://www.4guysfromrolla.com/ScottMitchell.shtml), Autor sedm ASP/ASP.NET knih a zakladatele z [4GuysFromRolla.com](http://www.4guysfromrolla.com), pracuje s technologií Microsoft Web od 1998.</span><span class="sxs-lookup"><span data-stu-id="1bb84-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="1bb84-317">Scott funguje jako nezávislé poradce, trainer a zapisovače.</span><span class="sxs-lookup"><span data-stu-id="1bb84-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="1bb84-318">Jeho nejnovější seznam k [ *Edice nakladatelství Sams naučit sami technologii ASP.NET 2.0 za 24 hodin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="1bb84-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="1bb84-319">Dosažitelný v [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) nebo prostřednictvím svého blogu, který najdete na [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="1bb84-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="1bb84-320">Zvláštní poděkování</span><span class="sxs-lookup"><span data-stu-id="1bb84-320">Special Thanks To</span></span>

<span data-ttu-id="1bb84-321">Tento kurz řady byla zkontrolovány uživatelem mnoho užitečné kontrolorů.</span><span class="sxs-lookup"><span data-stu-id="1bb84-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="1bb84-322">Vést kontroloři v tomto kurzu se Dave Gardner Hilton Giesenow a Teresy Murphy.</span><span class="sxs-lookup"><span data-stu-id="1bb84-322">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="1bb84-323">Kontrola Moje nadcházející články MSDN máte zájem?</span><span class="sxs-lookup"><span data-stu-id="1bb84-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="1bb84-324">Pokud ano, vyřaďte mi řádek v [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="1bb84-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="1bb84-325">[Předchozí](batch-inserting-cs.md)
[další](batch-updating-vb.md)</span><span class="sxs-lookup"><span data-stu-id="1bb84-325">[Previous](batch-inserting-cs.md)
[Next](batch-updating-vb.md)</span></span>
